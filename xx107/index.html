<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>LEUVENFLYERS â€“ Campaign XX107 (Map)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Icons+Outlined&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    :root{
      --brand:#0e3450;
      --brand-alt:#133d5d;
      --accent:#2563eb;
      --accent-alt:#1d4ed8;
      --accent-soft:#eff6ff;
      --success:#1e8e46;
      --warning:#e4a400;
      --danger:#c62828;
      --danger-soft:#fde7e7;
      --ink-900:#0f1a22;
      --ink-800:#1d2c35;
      --ink-700:#2f4451;
      --ink-600:#4a5d69;
      --ink-500:#667883;
      --ink-400:#8b99a2;
      --ink-300:#b5c0c7;
      --ink-200:#d6dde1;
      --ink-100:#e9eef1;
      --ink-050:#f5f7f9;
      --surface:#ffffff;
      --surface-elev:#ffffffee;
      --panel-border:rgba(15,26,34,0.10);
      --radius-sm:6px;
      --radius-md:10px;
      --shadow-sm:0 1px 2px rgba(15,26,34,0.06),0 1px 3px rgba(15,26,34,0.10);
      --shadow-md:0 4px 10px -2px rgba(15,26,34,.12),0 2px 4px rgba(15,26,34,.08);
      --focus-ring:0 0 0 3px rgba(37,99,235,0.45);
      --transition:150ms cubic-bezier(.4,0,.2,1);
      --footer-h:34px;
      --chip-h:30px;
      --header-row-gap:4px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{
      width:100%;height:100%;overflow:hidden;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:12px;line-height:1.35;
      background:var(--ink-050);color:var(--ink-700);
      -webkit-font-smoothing:antialiased;
    }
    body{display:flex;flex-direction:column;}
    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}

    .topbar{
      position:fixed;top:0;left:0;right:0;
      display:flex;flex-direction:column;
      background:linear-gradient(90deg,var(--brand) 0%,var(--brand-alt) 90%);
      color:#fff;z-index:600;
      padding:6px 10px 8px;
      gap:var(--header-row-gap);
      box-shadow:0 2px 8px -2px rgba(0,0,0,.4);
    }
    .topbar-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;width:100%;}
    .brand-block{display:flex;align-items:center;gap:8px;min-width:0;flex:1;}
    .brand-icon{font-size:18px;flex-shrink:0;}
    .brand-title{font-size:13px;font-weight:600;letter-spacing:.4px;white-space:nowrap;}
    .campaign-badge{font-size:10px;font-weight:600;background:rgba(255,255,255,0.18);padding:2px 8px;border-radius:999px;letter-spacing:.4px;display:inline-flex;align-items:center;gap:4px;}
    .metrics-scroll{display:flex;align-items:center;gap:6px;overflow-x:auto;padding:2px 0 2px 2px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
    .metrics-scroll::-webkit-scrollbar{display:none;}
    .metric-chip{
      flex:0 0 auto;display:inline-flex;align-items:center;gap:4px;
      height:var(--chip-h);background:rgba(255,255,255,0.14);
      padding:4px 10px 4px 8px;border-radius:8px;font-size:11px;font-weight:500;
      border:1px solid rgba(255,255,255,0.22);backdrop-filter:blur(8px);color:#fff;line-height:1;position:relative;
    }
    .metric-chip .material-icons-outlined{font-size:15px;opacity:.9;}
    .metric-chip .value{font-weight:600;min-width:34px;text-align:right;}
    @media (max-width:420px){
      .metric-chip{padding:4px 6px;flex-direction:column;gap:2px;min-width:54px;height:48px;font-size:9px;}
      .metric-chip .material-icons-outlined{font-size:16px;}
      .metric-chip .value{font-size:11px;}
    }
    .right-controls{display:flex;align-items:center;gap:6px;flex:0 0 auto;}
    .header-progress-text{
      font-size:10.5px;font-weight:600;letter-spacing:.4px;
      padding:0 6px 0 0;display:inline-flex;align-items:center;
      color:#fff;opacity:.9;
    }
    button.icon-btn{
      height:var(--chip-h);width:var(--chip-h);
      background:rgba(255,255,255,0.14);border:1px solid rgba(255,255,255,0.22);
      backdrop-filter:blur(8px);color:#fff;border-radius:8px;font-size:11px;
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
      transition:var(--transition);position:relative;
    }
    button.icon-btn .material-icons-outlined{font-size:18px;}
    button.icon-btn:hover{background:rgba(255,255,255,0.22);}
    button.icon-btn:focus-visible{outline:none;box-shadow:var(--focus-ring);}
    .recent-focus-btn{
      background:rgba(255,255,255,0.14);border:1px solid rgba(255,255,255,0.25);
      color:#fff;border-radius:8px;width:var(--chip-h);height:var(--chip-h);
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
      transition:var(--transition);margin-left:0;
    }
    .recent-focus-btn:hover{background:rgba(255,255,255,0.24);}
    .recent-focus-btn:focus-visible{outline:none;box-shadow:var(--focus-ring);}
    .recent-focus-btn .material-icons-outlined{font-size:18px;}

    .notif-badge{
      position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;
      font-size:9px;font-weight:600;line-height:1;padding:1px 5px;border-radius:999px;
      box-shadow:0 0 0 1px rgba(0,0,0,.25);display:none;
    }

    .notifications{
      position:fixed;top:calc(var(--topbar-total-height) + 4px);right:10px;width:300px;
      background:var(--surface-elev);border:1px solid var(--panel-border);border-radius:12px;
      box-shadow:var(--shadow-md);backdrop-filter:blur(14px) saturate(140%);
      display:none;flex-direction:column;overflow:hidden;animation:dropIn .18s ease;z-index:650;
    }
    .notifications.scroll-after-4 .notif-list{
      max-height:240px;
      overflow-y:auto;
    }
    @keyframes dropIn{from{transform:translateY(-6px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .notif-header{padding:10px 14px 6px;font-size:11px;font-weight:600;color:var(--accent);letter-spacing:.4px;}
    .notif-list{overflow-y:hidden;flex:1;}
    .notif-item{
      display:flex;gap:10px;padding:10px 14px;font-size:11px;border-top:1px solid rgba(0,0,0,0.05);
      cursor:pointer;align-items:flex-start;transition:var(--transition);background:transparent;
    }
    .notif-item:first-child{border-top:none;}
    .notif-item:hover{background:var(--ink-050);}
    .notif-item:active{background:var(--accent-soft);}
    .notif-icon{width:24px;height:24px;border-radius:6px;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:15px;flex-shrink:0;}
    .notif-msg{flex:1;color:var(--ink-600);line-height:1.3;}
    .notif-item[data-zone]::after{content:"View";font-size:9px;font-weight:600;color:var(--accent);align-self:center;margin-left:6px;opacity:.55;}
    .notif-item[data-zone]:hover::after{opacity:1;}
    .notif-empty{padding:18px 14px;font-size:11px;color:var(--ink-500);}
    .notif-footer{padding:6px 12px 8px;font-size:10px;color:var(--ink-400);text-align:right;border-top:1px solid rgba(0,0,0,.05);}

    #map{
      position:absolute;top:var(--topbar-total-height);left:0;right:0;bottom:var(--footer-h);
      background:#ffffff;transition:top .25s ease;
    }
    .map-visual-dimmer .leaflet-tile{filter:brightness(.93) saturate(.9) contrast(1.02);transition:filter .4s ease;}
    .map-visual-dimmer.zoomed-in .leaflet-tile{filter:brightness(.98) saturate(.98) contrast(1.04);}
    .leaflet-control-zoom{
      margin-top:calc(var(--topbar-total-height) + 12px)!important;
      border:1px solid var(--panel-border)!important;
      box-shadow:var(--shadow-sm)!important;
    }
    .leaflet-control-zoom a{
      background:var(--surface)!important;color:var(--ink-700)!important;border:none!important;
      transition:var(--transition);
    }
    .leaflet-control-zoom a:hover{background:var(--ink-050)!important;}

    .leaflet-div-icon.zone-label-wrapper{background:transparent!important;border:none!important;}
    .zone-label{
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(4px);
      border:1px solid rgba(0,0,0,0.15);
      border-radius:14px;
      padding:2px 8px 3px;
      font-size:11px;
      font-weight:600;
      color:#0e3450;
      line-height:1;
      box-shadow:0 1px 4px rgba(0,0,0,0.25);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:24px;
    }

    @keyframes zoneFlash{
      0%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(37,99,235,0));}
      40%{stroke-width:4;filter:drop-shadow(0 0 6px rgba(37,99,235,.85));}
      100%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(37,99,235,0));}
    }
    .leaflet-interactive.flash-highlight{animation:zoneFlash 1.3s ease-in-out 1;}

    .footer{
      position:fixed;left:0;right:0;bottom:0;height:var(--footer-h);
      background:var(--surface-elev);backdrop-filter:blur(10px);
      border-top:1px solid var(--panel-border);
      display:flex;align-items:center;justify-content:center;
      padding:0 12px;font-size:11px;color:var(--ink-700);z-index:560;letter-spacing:.35px;
      font-weight:600;
      text-transform:none;
    }

    .modal{display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;}
    .modal-content{
      background:var(--surface);border-radius:16px;padding:12px 12px 8px;
      box-shadow:0 18px 42px -10px rgba(0,0,0,.35),0 0 0 1px var(--panel-border);
      max-width:92vw;max-height:92vh;position:relative;display:flex;flex-direction:column;gap:8px;
    }
    .modal-content img{max-width:85vw;max-height:75vh;border-radius:12px;box-shadow:var(--shadow-md);}
    .modal-close{
      position:absolute;top:6px;right:8px;background:var(--danger-soft);border:none;color:var(--danger);
      width:30px;height:30px;display:flex;align-items:center;justify-content:center;
      font-size:18px;border-radius:10px;cursor:pointer;transition:var(--transition);
    }
    .modal-close:hover{filter:brightness(1.05);}
    .modal-close:focus-visible{outline:none;box-shadow:var(--focus-ring);}

    ::-webkit-scrollbar{width:10px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--ink-200);border-radius:10px;border:2px solid transparent;background-clip:padding-box;}
    ::-webkit-scrollbar-thumb:hover{background:var(--ink-300);}
    @media (max-width:340px){
      .brand-title{font-size:12px;}
      .campaign-badge{display:none;}
      .metric-chip{min-width:50px;}
      .header-progress-text{display:none;}
    }

    #loadingOverlay{
      position:fixed;inset:0;z-index:1000;
      background:linear-gradient(135deg,#0e3450,#133d5d);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:#fff;padding:30px 20px;text-align:center;
      font-size:13px;letter-spacing:.4px;
    }
    #loadingOverlay.fade-out{animation:fadeOut .6s ease forwards;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .loader{
      width:50px;height:50px;margin-bottom:16px;
      border:4px solid rgba(255,255,255,0.25);
      border-top:4px solid #fff;border-radius:50%;
      animation:spin 1s linear infinite;
    }
    .mini-hint{margin-top:12px;font-size:11px;opacity:.85;line-height:1.4;}
    @keyframes fadeOut{to{opacity:0;visibility:hidden;}}

    /* Path (Walk) Visualization */
    .path-endpoint{
      font-size:9px;
      font-weight:700;
      letter-spacing:.5px;
      line-height:1;
      padding:4px 6px 5px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      box-shadow:0 2px 6px -2px rgba(0,0,0,.4),0 0 0 1px rgba(255,255,255,0.4);
      backdrop-filter:blur(4px);
      font-family:inherit;
    }
    .path-endpoint.start{background:#c62828;}
    .path-endpoint.end{background:#1e8e46;}

    /* Focus Mode Additions */
    .zone-focus-btn{
      margin-top:10px;
      border:none;
      background:#0e3450;
      color:#fff;
      font-size:10px;
      font-weight:600;
      padding:6px 14px;
      border-radius:20px;
      cursor:pointer;
      letter-spacing:.5px;
      box-shadow:0 2px 6px -2px rgba(0,0,0,.3);
    }
    .zone-focus-btn:hover{background:#12435f;}
    .zone-focus-btn:active{transform:scale(.95);}

    .exit-focus-btn{
      background:#0e3450;
      color:#fff;
      border:none;
      padding:6px 14px 7px;
      border-radius:24px;
      font-size:11px;
      font-weight:600;
      letter-spacing:.5px;
      cursor:pointer;
      box-shadow:0 4px 10px -3px rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .exit-focus-btn span{font-size:16px;}
    .exit-focus-btn:hover{background:#12435f;}
    .exit-focus-btn:active{transform:scale(.95);}
    .focus-exit-control{
      padding:6px 8px;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(8px);
      border:1px solid var(--panel-border);
      border-radius:14px;
      box-shadow:var(--shadow-md);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    body.zone-focus-active #map{
      background:#fff;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" aria-live="polite">
    <div class="loader" aria-hidden="true"></div>
    <div><strong>Please wait</strong>, full data & map are loading...</div>
    <div class="mini-hint">
      Once loaded we will automatically zoom into the most recently <strong>completed zone</strong>.<br/>
      You can still pan / pinch after that.
    </div>
  </div>

  <header class="topbar" id="topbar">
    <div class="topbar-row primary-row">
      <div class="brand-block">
        <span class="material-icons-outlined brand-icon">map</span>
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
          <span class="brand-title">LEUVENFLYERS</span>
          <span class="campaign-badge">Campaign XX107</span>
        </div>
      </div>
      <div class="right-controls">
        <span class="header-progress-text">View Progress</span>
        <button id="recentBtn" class="recent-focus-btn" title="Zoom to most recent completed zone" aria-label="Zoom to most recent completed zone">
          <span class="material-icons-outlined">my_location</span>
        </button>
        <!-- Share Location (toggle) -->
        <button id="locateBtn" class="icon-btn" title="Share my location (toggle)" aria-label="Share my location">
          <span class="material-icons-outlined">location_searching</span>
        </button>
        <button id="notifBtn" class="icon-btn" aria-label="Notifications">
          <span class="material-icons-outlined">notifications</span>
          <span id="notifBadge" class="notif-badge"></span>
        </button>
      </div>
    </div>
    <div class="topbar-row metrics-row">
      <div class="metrics-scroll" id="metricsScroll" aria-label="Campaign metrics">
        <div class="metric-chip" title="Total Flyers">
          <span class="material-icons-outlined">inventory_2</span>
          <span class="value" id="flyersTotal">0</span>
        </div>
        <div class="metric-chip" title="Completed / Verified Flyers">
          <span class="material-icons-outlined">task_alt</span>
          <span class="value" id="flyersDistributed">0</span>
        </div>
        <div class="metric-chip" id="qrCounter" style="cursor:pointer;" title="QR Scan Count">
          <span class="material-icons-outlined">qr_code_scanner</span>
          <span class="value" id="qrScanCount">0</span>
        </div>
      </div>
    </div>
  </header>

  <div id="notificationsPanel" class="notifications" role="dialog" aria-label="Notifications">
    <div class="notif-header">Notifications</div>
    <div id="notifList" class="notif-list"></div>
    <div id="notifFooter" class="notif-footer"></div>
  </div>

  <div id="map" class="map-visual-dimmer" aria-label="Distribution Map"></div>

  <footer class="footer">
    <div>click on any polygon to view the details</div>
  </footer>

  <div id="imgModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <button id="modalCloseBtn" class="modal-close" aria-label="Close preview">&times;</button>
      <img id="modalImg" alt="Proof preview">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* Firebase Configs */
    const campaignFirebaseConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const polygonsFirebaseConfig = {
      apiKey: "AIzaSyBHRyOy3hNcWarK8Zk34MWrv_tIYKM7mXM",
      authDomain: "leuvenflyers-23584.firebaseapp.com",
      databaseURL: "https://leuvenflyers-23584-default-rtdb.firebaseio.com",
      projectId: "leuvenflyers-23584",
      storageBucket: "leuvenflyers-23584.firebasestorage.app",
      messagingSenderId: "1077790950414",
      appId: "1:1077790950414:web:036fafe06df86f41ed285f"
    };

    const campaignApp = initializeApp(campaignFirebaseConfig, 'campaignApp');
    const db = getDatabase(campaignApp);
    const polygonsApp = initializeApp(polygonsFirebaseConfig,'polygonsApp');
    const polygonsDb = getDatabase(polygonsApp);

    /* DOM Elements */
    const flyersTotalEl = document.getElementById('flyersTotal');
    const flyersDistributedEl = document.getElementById('flyersDistributed');
    const qrScanCountEl = document.getElementById('qrScanCount');
    const qrCounter = document.getElementById('qrCounter');
    const notifBtn = document.getElementById('notifBtn');
    const notifPanel = document.getElementById('notificationsPanel');
    const notifList = document.getElementById('notifList');
    const notifBadge = document.getElementById('notifBadge');
    const notifFooter = document.getElementById('notifFooter');
    const topbar = document.getElementById('topbar');
    const mapEl = document.getElementById('map');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const recentBtn = document.getElementById('recentBtn');
    const locateBtn = document.getElementById('locateBtn');

    /* State */
    const TOTAL_FLYERS = 20000;
    flyersTotalEl.textContent = TOTAL_FLYERS.toLocaleString();

    let map;
    let polygonLayers = [];
    let labelMarkers = [];
    let polygonMeta = [];
    let polygonsByZone = new Map();
    let proofMarkers = [];
    let pathLayers = [];  // {line,start,end,zone}
    let zoneData = [];
    let qrScans = [];
    let notificationsArr = [];
    const completedNotified = new Set();
    const completedTimestamps = {};
    let firstFullLoad = true;

    /* Focus Mode State */
    let focusedZone = null;
    let focusControl = null;

    /* Geolocation State */
    let geolocWatchId = null;
    let userLocationMarker = null;
    let userLocationFollowOnce = true;

    function setHeaderHeightVar(){
      const h = topbar.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--topbar-total-height', h + 'px');
      mapEl.style.top = h + 'px';
      notifPanel.style.top = (h + 4) + 'px';
    }
    new ResizeObserver(setHeaderHeightVar).observe(topbar);
    window.addEventListener('orientationchange',()=>setTimeout(setHeaderHeightVar,350));
    window.addEventListener('resize',setHeaderHeightVar);

    /* Notifications (zone-only display) */
    function addNotification(icon, message, key){
      if(key && notificationsArr.some(n=>n.key===key)) return;
      const zMatch = /Zone\s+(\d+)/i.exec(message);
      const zone = zMatch? parseInt(zMatch[1],10) : null;
      notificationsArr.unshift({
        key: key || ('k_'+Date.now()+'_'+Math.random().toString(36).slice(2)),
        icon, message, zone, ts: Date.now()
      });
      renderNotifications();
    }
    function renderNotifications(){
      notifList.innerHTML='';
      const zoneOnly = notificationsArr.filter(n => Number.isInteger(n.zone));
      if(!zoneOnly.length){
        notifList.innerHTML='<div class="notif-empty">No zone notifications yet.</div>';
        notifFooter.textContent='';
        notifBadge.style.display='none';
        notifPanel.classList.remove('scroll-after-4');
        return;
      }
      zoneOnly.slice(0,60).forEach(n=>{
        const item=document.createElement('div');
        item.className='notif-item';
        item.dataset.zone = n.zone;
        item.innerHTML=`
          <div class="notif-icon"><span class="material-icons-outlined">${n.icon}</span></div>
          <div class="notif-msg">${n.message}</div>`;
        item.addEventListener('click',()=>{
          if(n.zone) focusZone(n.zone);
          notifPanel.style.display='none';
        });
        notifList.appendChild(item);
      });
      notifBadge.textContent=zoneOnly.length;
      notifBadge.style.display='inline-block';
      notifFooter.textContent=`${zoneOnly.length} zone notifications`;
      notifPanel.classList.toggle('scroll-after-4', zoneOnly.length>4);
    }
    notifBtn.addEventListener('click',e=>{
      e.stopPropagation();
      const open = notifPanel.style.display==='flex';
      notifPanel.style.display=open?'none':'flex';
      if(!open){
        setHeaderHeightVar();
        renderNotifications();
      }
    });
    document.addEventListener('click',e=>{
      if(!notifPanel.contains(e.target) && !notifBtn.contains(e.target)){
        notifPanel.style.display='none';
      }
    });

    /* Map Init */
    document.addEventListener('DOMContentLoaded',()=>{
      setHeaderHeightVar();
      map = L.map('map',{zoomControl:true, attributionControl:false})
        .setView([50.85,4.35],13);

      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        {maxZoom:20, attribution:'&copy; OpenStreetMap & CARTO'}
      ).addTo(map);

      // pane for user location marker (above others)
      map.createPane('userLocationPane');
      map.getPane('userLocationPane').style.zIndex = 700;

      map.on('zoomend',()=>{
        const z=map.getZoom();
        mapEl.classList.toggle('zoomed-in', z>=15);
      });

      loadPolygons().then(()=>{
        listenZoneStatuses();
        listenProofs();
        listenQrScans();
        listenPaths();  // dotted lines
      });

      setupFocusControl();
      setupGeolocation();
    });

    /* Polygons */
    async function loadPolygons(){
      try{
        const snap = await get(ref(polygonsDb,'polygons'));
        if(!snap.exists()) { hideLoader(); return; }

        polygonLayers.forEach(p=>map.removeLayer(p));
        labelMarkers.forEach(m=>map.removeLayer(m));
        polygonLayers=[];labelMarkers=[];polygonMeta=[];polygonsByZone.clear();

        let allCoords=[];
        snap.forEach(child=>{
          const raw = child.val();
          if(!raw || typeof raw!=='object') return;

          const coordsArr = Object.keys(raw)
            .filter(k => !isNaN(Number(k)))
            .sort((a,b)=>Number(a)-Number(b))
            .map(k => {
              const pt=raw[k];
              return Array.isArray(pt) && pt.length===2
                ? [pt[0], pt[1]]
                : [pt.lat, pt.lng];
            })
            .filter(pt => Array.isArray(pt) && typeof pt[0]==='number' && typeof pt[1]==='number');

          if(!coordsArr.length) return;

          let zoneNum = raw.zoneNumber;
          if(zoneNum===undefined || zoneNum===null || zoneNum===''){
            zoneNum = polygonLayers.length + 1;
          } else {
            zoneNum = parseInt(zoneNum,10);
            if(isNaN(zoneNum)) zoneNum = polygonLayers.length + 1;
          }

          const poly=L.polygon(coordsArr,{
            color:'#1976d2',
            weight:1,
            fillColor:'#2196f3',
            fillOpacity:.26
          }).addTo(map);

          poly.bindPopup(`<div style="font-size:11px;">Zone ${zoneNum}<br/>Loading status...</div>`);

          const index = polygonLayers.length;
          polygonLayers.push(poly);
          polygonMeta.push({layer:poly, zoneNumber:zoneNum});
          polygonsByZone.set(zoneNum, index);

          allCoords = allCoords.concat(coordsArr);

          const center=poly.getBounds().getCenter();
          const label=L.marker(center,{
            icon:L.divIcon({
              className:'zone-label-wrapper',
              html:zoneNumberLabelHtml(zoneNum),
              iconSize:[34,24],
              iconAnchor:[17,12]
            }),
            interactive:false
          }).addTo(map);
          labelMarkers.push(label);
        });

        if(allCoords.length){
          map.fitBounds(L.latLngBounds(allCoords).pad(0.12));
        }
      }catch(e){
        console.error('Polygon load error',e);
      } finally {
        hideLoader();
      }
    }

    function zoneNumberLabelHtml(z){
      return `<div class="zone-label">${z}</div>`;
    }

    /* Zone Status Logic */
    function safeInt(v){const n=parseInt(v);return isNaN(n)?0:n;}
    function statusMeta(status){
      switch(status){
        case 'completed': return {text:'Done',short:'Done',cls:'status-completed',color:'#2e7d32',icon:'task_alt'};
        case 'inprogress': return {text:'Active',short:'Actv',cls:'status-inprogress',color:'#f9a825',icon:'play_arrow'};
        default: return {text:'Pending',short:'Pend',cls:'status-pending',color:'#d32f2f',icon:'hourglass_empty'};
      }
    }

    function listenZoneStatuses(){
      onValue(ref(db,'campaigns/XX107/zone_statuses'), snap=>{
        const val = snap.val();
        let zones=[];
        if(Array.isArray(val)) zones=val;
        else if(val && typeof val==='object') {
          const entries = Object.entries(val).sort((a,b)=>{
            const na=parseInt(a[0],10), nb=parseInt(b[0],10);
            if(!isNaN(na) && !isNaN(nb)) return na-nb;
            return 0;
          });
          zones = entries.map(e=>e[1]);
        }
        zoneData=zones;
        updateZonesVisual();
      });
    }

    function updateZonesVisual(){
      let distributed=0;
      let newlyCompleted = [];

      zoneData.forEach((z, idx)=>{
        const zoneNum = idx+1;
        const polyIndex = polygonsByZone.get(zoneNum);
        if(polyIndex===undefined) return;
        const poly = polygonLayers[polyIndex];
        if(!poly) return;

        const flyers = safeInt(z.flyers);
        if(z.status==='completed') distributed+=flyers;
        const meta=statusMeta(z.status);

        // Skip styling if in focus mode (polygons hidden)
        if(focusedZone===null){
          poly.setStyle({fillColor:meta.color, fillOpacity:.38, color:'#1976d2', weight:1});
        }

        const gpsLink=z.gpsProof || z.gpsUrl;
        const proofImage=z.proofImage;

        if(z.status==='completed' && !completedNotified.has(zoneNum)){
          completedNotified.add(zoneNum);
          completedTimestamps[zoneNum] = Date.now();
          newlyCompleted.push(zoneNum);
          addNotification('task_alt',`Zone ${zoneNum} completed!`,`zone-${zoneNum}-done`);
        }

        let popupHTML=`
          <div style="text-align:center;">
            <strong style="display:flex;justify-content:center;align-items:center;gap:4px;color:#0e3450;font-size:12px;">
              <span class="material-icons-outlined" style="font-size:14px;color:#1976d2;">layers</span>Zone ${zoneNum}
            </strong>
            <div style="margin-top:6px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">mail</span>
                Flyers: <strong>${flyers || '-'}</strong>
              </span>
            </div>
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">info</span>
                Status: <strong>${meta.text}</strong>
              </span>
            </div>`;

        if(gpsLink){
          popupHTML+=`
            <div style="margin-top:8px;">
              <a href="${gpsLink}" target="_blank" rel="noopener"
                style="background:#1976d2;color:#fff;font-size:10px;padding:5px 12px;border-radius:18px;
                display:inline-flex;align-items:center;gap:6px;text-decoration:none;
                box-shadow:0 2px 6px -2px rgba(0,0,0,.25);">
                <span class="material-icons-outlined" style="font-size:14px;">assistant_navigation</span>GPS Route
              </a>
            </div>`;
        }
        if(proofImage){
          popupHTML+=`
            <div style="margin-top:10px;">
              <img src="${proofImage}" alt="Proof" class="popup-img-thumb" data-proof="${proofImage}"
                style="max-width:90px;border-radius:8px;cursor:pointer;border:1px solid #d9e2e8;">
            </div>`;
        }

        // Focus button
        popupHTML+=`
          <button class="zone-focus-btn" data-focus-zone="${zoneNum}" type="button">
            Focus
          </button>
        </div>`;

        poly.bindPopup(popupHTML);
      });

      flyersDistributedEl.textContent = distributed.toLocaleString();

      if(firstFullLoad){
        firstFullLoad = false;
        hideLoader();
        focusRecentCompletedZones(true);
      } else if(newlyCompleted.length){
        focusRecentCompletedZones(true);
      }
    }

    function focusRecentCompletedZones(onlyLast=false){
      const completed = Object.entries(completedTimestamps)
        .sort((a,b)=>b[1]-a[1])
        .map(entry=>parseInt(entry[0],10));
      if(!completed.length) return;
      if(onlyLast){
        focusZone(completed[0]);
      }
    }

    window.focusZone = function(zoneNum){
      const polyIndex = polygonsByZone.get(zoneNum);
      if(polyIndex===undefined) return;
      const poly = polygonLayers[polyIndex];
      if(!poly) return;
      const bounds=poly.getBounds();
      map.fitBounds(bounds.pad(0.4));
      setTimeout(()=>{
        map.flyTo(bounds.getCenter(), Math.max(map.getZoom(),15), {duration:.55});
        poly.fire('click');
        const path=poly._path;
        if(path){
          path.classList.add('flash-highlight');
          setTimeout(()=>path.classList.remove('flash-highlight'),1300);
        }
      },350);
    };

    recentBtn.addEventListener('click',()=>focusRecentCompletedZones(true));

    /* Proof pins */
    function listenProofs(){
      onValue(ref(db,'campaigns/XX107/proofs'), snap=>{
        proofMarkers.forEach(m=>map.removeLayer(m));
        proofMarkers=[];
        const val=snap.val();
        if(!val) return;
        for(const k in val){
          const p=val[k];
          if(typeof p.lat==='number' && typeof p.lng==='number' && p.url){
            const iconHtml=`
              <span class="material-icons-outlined" style="display:block;font-size:16px;color:#1976d2;
                text-shadow:0 0 4px #fff;margin-bottom:2px;">photo_camera</span>
              <img src="${p.url}" alt="Proof" style="width:30px;height:30px;object-fit:cover;border-radius:8px;
                border:2px solid #1976d2;box-shadow:0 2px 6px -2px rgba(0,0,0,.35);" />`;
            const icon=L.divIcon({
              html:iconHtml,className:'custom-img-pin',
              iconSize:[36,48],iconAnchor:[18,44]
            });
            const marker=L.marker([p.lat,p.lng],{icon}).addTo(map);
            marker.bindPopup(`
              <div style="text-align:center;">
                <img src="${p.url}" class="popup-img-thumb" data-proof="${p.url}" style="max-width:100px;border-radius:10px;
                  border:1px solid #d9e2e8;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.15);" alt="Proof">
                ${p.timestamp?`<div style="margin-top:6px;font-size:10px;color:#4a5d69;display:flex;gap:4px;justify-content:center;align-items:center;">
                  <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">schedule</span>${formatDateTime(p.timestamp)}
                </div>`:''}
              </div>`);
            marker.on('popupopen',()=>{
              setTimeout(()=>{
                const img=document.querySelector('.leaflet-popup .popup-img-thumb[data-proof]');
                if(img) img.addEventListener('click',()=>showModal(p.url));
              },60);
            });
            proofMarkers.push(marker);
          }
        }
        applyFocusFiltering(); // ensure focus mode respects changes
      });
    }

    /* QR scans */
    function listenQrScans(){
      onValue(ref(db,'qr_scans'), snap=>{
        qrScans=[];
        const val=snap.val();
        if(val){
          for(const k in val){
            const s=val[k];
            if(s.promoCode==='XX107') qrScans.push({...s,id:k});
          }
          qrScans.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
        }
        qrScanCountEl.textContent=qrScans.length.toString();
      });
      qrCounter.addEventListener('click',()=>{
        if(!qrScans.length){alert('No scans yet.');return;}
        alert('QR Scans:\n'+qrScans.map((s,i)=>{
          const t=s.timestamp?formatDateTime(s.timestamp):'n/a';
          return `#${i+1} - ${t}`;
        }).join('\n'));
      });
    }

    /* Paths (dotted) */
    function listenPaths(){
      onValue(ref(db,'campaigns/XX107/paths'), snap=>{
        pathLayers.forEach(pl=>{
          if(pl.line) map.removeLayer(pl.line);
          if(pl.start) map.removeLayer(pl.start);
          if(pl.end) map.removeLayer(pl.end);
        });
        pathLayers = [];

        if(!snap.exists()) { applyFocusFiltering(); return; }

        snap.forEach(child=>{
          const val = child.val();
          if(!val || !Array.isArray(val.points) || val.points.length < 2) return;
          const latlngs = val.points
            .filter(p=>typeof p.lat==='number' && typeof p.lng==='number')
            .map(p=>L.latLng(p.lat,p.lng));
          if(latlngs.length < 2) return;

          const line = L.polyline(latlngs,{
            color:'#0f1a22',
            weight:3,
            opacity:0.65,
            dashArray:'6,6',
            lineCap:'round',
            lineJoin:'round'
          }).addTo(map);

          const startLatLng = latlngs[0];
          const endLatLng = latlngs[latlngs.length-1];

          const startMarker = L.marker(startLatLng,{
            icon: L.divIcon({
              className:'path-start-icon',
              html:`<div class="path-endpoint start">START</div>`,
              iconSize:[50,20],
              iconAnchor:[25,10]
            }),
            interactive:false
          }).addTo(map);

          const endMarker = L.marker(endLatLng,{
            icon: L.divIcon({
              className:'path-end-icon',
              html:`<div class="path-endpoint end">END</div>`,
              iconSize:[42,20],
              iconAnchor:[21,10]
            }),
            interactive:false
          }).addTo(map);

          line.on('mouseover',()=> line.setStyle({weight:5, opacity:0.9}));
          line.on('mouseout',()=> line.setStyle({weight:3, opacity:0.65}));

          let popup = `<div style="font-size:11px;line-height:1.3;">
              <strong style="display:flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:14px;color:#1976d2;">route</span>
                Path (${latlngs.length} pts)
              </strong>`;
          if(typeof val.zone === 'number'){
            popup += `<div style="margin-top:4px;">Zone: <strong>${(val.zone+1) || val.zone}</strong></div>`;
          }
          if(val.timestamp){
            popup += `<div style="margin-top:2px;display:flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">schedule</span>
                ${formatDateTime(val.timestamp)}
              </div>`;
          }
          popup += '</div>';
          line.bindPopup(popup);

          const zoneNumForPath = (typeof val.zone==='number') ? (val.zone+1) : null;

          pathLayers.push({
            line,
            start:startMarker,
            end:endMarker,
            zone: zoneNumForPath
          });
        });

        applyFocusFiltering();
      });
    }

    /* Focus Mode Implementation */
    function setupFocusControl(){
      focusControl = L.control({position:'topleft'});
      focusControl.onAdd = function(){
        const div = L.DomUtil.create('div','focus-exit-control');
        div.style.display='none';
        div.innerHTML = `<button type="button" id="exitFocusBtn" class="exit-focus-btn">
            <span class="material-icons-outlined">layers_clear</span>Show All
          </button>`;
        return div;
      };
      focusControl.addTo(map);
      map.on('popupopen', e=>{
        const btn = e.popup.getElement().querySelector('.zone-focus-btn');
        if(btn){
          btn.addEventListener('click',()=>{
            const z = parseInt(btn.getAttribute('data-focus-zone'),10);
            if(!isNaN(z)) enterFocusMode(z);
          });
        }
        const imgBtn = e.popup.getElement().querySelector('.popup-img-thumb[data-proof]');
        if(imgBtn){
          imgBtn.addEventListener('click',()=>showModal(imgBtn.getAttribute('data-proof')));
        }
      });
      map.on('popupclose',()=>{ /* no-op */ });

      document.addEventListener('click',e=>{
        if(e.target && e.target.id==='exitFocusBtn'){
          exitFocusMode();
        }
      });
    }

    function enterFocusMode(zoneNum){
      focusedZone = zoneNum;
      document.body.classList.add('zone-focus-active');
      // Hide all polygons & labels
      polygonLayers.forEach(p=>map.removeLayer(p));
      labelMarkers.forEach(m=>map.removeLayer(m));
      // Hide proof markers (keeping paths only)
      proofMarkers.forEach(pm=>map.removeLayer(pm));
      applyFocusFiltering();
      showFocusExit(true);
      // Determine bounds of paths in this zone
      const zonePaths = pathLayers.filter(pl=>pl.zone===zoneNum);
      if(zonePaths.length){
        let all = [];
        zonePaths.forEach(pl=>{
          all = all.concat(pl.line.getLatLngs());
        });
        if(all.length){
          map.fitBounds(L.latLngBounds(all).pad(0.2));
        }
      }
    }

    function exitFocusMode(){
      focusedZone = null;
      document.body.classList.remove('zone-focus-active');
      // Re-add polygons, labels, proofs
      polygonLayers.forEach(p=>p.addTo(map));
      labelMarkers.forEach(m=>m.addTo(map));
      proofMarkers.forEach(pm=>pm.addTo(map));
      applyFocusFiltering();
      showFocusExit(false);
    }

    function showFocusExit(show){
      const ctrl = document.querySelector('.focus-exit-control');
      if(ctrl) ctrl.style.display = show ? 'block' : 'none';
    }

    function applyFocusFiltering(){
      if(focusedZone===null){
        // Show all path layers
        pathLayers.forEach(pl=>{
          if(!map.hasLayer(pl.line)) pl.line.addTo(map);
          if(pl.start && !map.hasLayer(pl.start)) pl.start.addTo(map);
          if(pl.end && !map.hasLayer(pl.end)) pl.end.addTo(map);
        });
        return;
      }
      // Only show path layers of focused zone
      pathLayers.forEach(pl=>{
        const shouldShow = pl.zone===focusedZone;
        if(shouldShow){
          if(!map.hasLayer(pl.line)) pl.line.addTo(map);
          if(pl.start && !map.hasLayer(pl.start)) pl.start.addTo(map);
          if(pl.end && !map.hasLayer(pl.end)) pl.end.addTo(map);
        } else {
          if(map.hasLayer(pl.line)) map.removeLayer(pl.line);
          if(pl.start && map.hasLayer(pl.start)) map.removeLayer(pl.start);
          if(pl.end && map.hasLayer(pl.end)) map.removeLayer(pl.end);
        }
      });
    }

    /* Modal / utility */
    function formatDateTime(ts){
      const d=new Date(ts);
      const pad=n=>n<10?'0'+n:n;
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    window.showModal=function(src){
      const modal=document.getElementById('imgModal');
      const img=document.getElementById('modalImg');
      img.src=src;
      modal.style.display='flex';
      document.body.style.overflow='hidden';
    };

    function hideLoader(){
      if(!loadingOverlay) return;
      loadingOverlay.classList.add('fade-out');
      setTimeout(()=>loadingOverlay.remove(),650);
    }

    /* ============== Geolocation ============== */
    function setupGeolocation(){
      if(!('geolocation' in navigator)){
        console.warn('Geolocation is not supported by this browser.');
        return;
      }

      // Toggle share/stop on click
      locateBtn.addEventListener('click', ()=>{
        if(geolocWatchId === null) startLocationWatch();
        else stopLocationWatch();
      });
    }

    function setLocateBtnActive(active){
      const icon = locateBtn.querySelector('.material-icons-outlined');
      if(active){
        icon.textContent = 'location_on';
        locateBtn.title = 'Stop sharing my location';
        locateBtn.setAttribute('aria-label','Stop sharing my location');
      }else{
        icon.textContent = 'location_searching';
        locateBtn.title = 'Share my location';
        locateBtn.setAttribute('aria-label','Share my location');
      }
    }

    function startLocationWatch(){
      if(geolocWatchId !== null) return; // already running
      if(!navigator.geolocation){
        alert('Geolocation not available in this browser.');
        return;
      }
      userLocationFollowOnce = true;
      geolocWatchId = navigator.geolocation.watchPosition(
        pos=>{
          const { latitude, longitude } = pos.coords;
          const latlng = [latitude, longitude];
          if(!userLocationMarker){
            // Red dot with black border
            userLocationMarker = L.circleMarker(latlng, {
              pane: 'userLocationPane',
              radius: 7,
              color: '#000',       // black border
              weight: 2,
              fillColor: '#ff2d2d',// red fill
              fillOpacity: 1
            }).addTo(map);
            if(userLocationFollowOnce){
              map.flyTo(latlng, Math.max(map.getZoom(), 15), { duration: .5 });
              userLocationFollowOnce = false;
            }
          } else {
            userLocationMarker.setLatLng(latlng);
          }
        },
        err=>{
          let msg = 'Unable to get your location.';
          if(err && typeof err.code === 'number'){
            if(err.code === 1) msg = 'Location permission denied. Please enable it in your browser settings.';
            else if(err.code === 2) msg = 'Location unavailable.';
            else if(err.code === 3) msg = 'Location request timed out.';
          }
          alert(msg);
          stopLocationWatch(true);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 15000
        }
      );
      setLocateBtnActive(true);
    }

    function stopLocationWatch(silent=false){
      if(geolocWatchId !== null){
        try{ navigator.geolocation.clearWatch(geolocWatchId); }catch(_){}
        geolocWatchId = null;
      }
      if(userLocationMarker){
        try{ map.removeLayer(userLocationMarker); }catch(_){}
        userLocationMarker = null;
      }
      setLocateBtnActive(false);
      if(!silent){
        // No notification; keep notifications zone-only
      }
    }

    window.addEventListener('beforeunload', ()=> stopLocationWatch(true));
    /* ============ End Geolocation ============ */

  </script>

  <script>
    /* Modal basic JS (non-module) */
    const modal=document.getElementById('imgModal');
    const modalCloseBtn=document.getElementById('modalCloseBtn');
    function hideModal(){
      modal.style.display='none';
      document.getElementById('modalImg').src='';
      document.body.style.overflow='';
    }
    modalCloseBtn.addEventListener('click',hideModal);
    modal.addEventListener('click',e=>{ if(e.target===modal) hideModal(); });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') hideModal(); });

    window.addEventListener('resize',()=> {
      const topbar=document.getElementById('topbar');
      const panel=document.getElementById('notificationsPanel');
      if(panel.style.display==='flex'){
        panel.style.top = (topbar.getBoundingClientRect().height+4)+'px';
      }
    });
  </script>
</body>
</html>
