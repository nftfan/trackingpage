
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Zone Tracker (Simplified)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/and.json">
  <link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
  <link rel="apple-touch-startup-image" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
:root {
  --clr-primary:#2563eb;
  --clr-primary-dark:#1d4ed8;
  --clr-danger:#dc2626;
  --clr-success:#059669;
  --clr-muted:#64748b;
  --clr-bg:#ffffff;
  --clr-bg-alt:#f1f5f9;
  --clr-border:#e2e8f0;
  --radius-sm:10px;
  --radius:16px;
  --shadow:0 4px 12px rgba(15,23,42,.12);
  --tap-min:44px;
  --font-xs:clamp(11px,2.4vw,12px);
  --font-sm:clamp(12px,2.6vw,14px);
  --font-md:clamp(14px,2.9vw,16px);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--clr-bg);
  color:#0f172a;
  min-height:100dvh;
  overflow:hidden;
}
.app-header{
  position:fixed;
  top:0;left:0;right:0;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  background:#ffffffee;
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--clr-border);
  z-index:60;
}
.brand{
  display:flex;align-items:center;gap:10px;
  font-weight:700;letter-spacing:.5px;
  color:var(--clr-primary);font-size:16px;
}
.brand-icon{
  width:30px;height:30px;border-radius:10px;
  background:linear-gradient(135deg,var(--clr-primary),var(--clr-primary-dark));
  display:flex;align-items:center;justify-content:center;
  font-size:14px;color:#fff;font-weight:600;
  box-shadow:0 2px 4px rgba(0,0,0,.15);
}
#main{
  position:relative;
  padding-top:44px;
  height:100dvh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.main-tabs{
  position:fixed;
  top:44px;left:0;right:0;
  display:flex;
  background:var(--clr-bg);
  border-bottom:1px solid var(--clr-border);
  z-index:55;
  height:48px;
}
.main-tab-btn{
  flex:1;
  background:transparent;
  border:none;
  font-weight:600;
  font-size:var(--font-sm);
  color:var(--clr-muted);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:2px;cursor:pointer;position:relative;
}
.main-tab-btn .material-icons{font-size:20px;}
.main-tab-btn.active{color:var(--clr-primary);}
.main-tab-btn.active::after{
  content:"";position:absolute;bottom:0;left:18%;right:18%;height:3px;
  background:var(--clr-primary);border-radius:3px 3px 0 0;
}
.tab-panels{
  position:absolute;
  top:92px;left:0;right:0;bottom:0;
  overflow:hidden;
}
.tab-panel{position:absolute;inset:0;display:none;}
.tab-panel.active{display:block;}
#mapPanel{background:#dbe3ec;}
#map{width:100%;height:100%;}
.manage-scroll{
  position:absolute;inset:0;
  overflow-y:auto;
  padding:16px 16px 120px;
  scrollbar-width:thin;
  scrollbar-color:var(--clr-border) transparent;
}
.manage-scroll::-webkit-scrollbar{width:6px;}
.manage-scroll::-webkit-scrollbar-thumb{background:var(--clr-border);border-radius:3px;}
.section{
  background:var(--clr-bg);
  border:1px solid var(--clr-border);
  padding:16px 16px 18px;
  border-radius:var(--radius);
  box-shadow:0 2px 6px rgba(0,0,0,.06);
  margin-bottom:18px;
}
.section h3{
  margin:0 0 14px;
  font-size:var(--font-md);
  color:var(--clr-primary);
  letter-spacing:.4px;
  font-weight:700;
  display:flex;align-items:center;gap:6px;
}
.row{display:flex;gap:12px;margin-bottom:16px;}
.row > div{flex:1;}
label{
  font-size:var(--font-xs);font-weight:600;
  display:block;margin:0 0 4px;letter-spacing:.4px;
}
input,select{
  width:100%;font-size:var(--font-sm);
  padding:12px 14px;
  border:1px solid var(--clr-border);
  border-radius:var(--radius-sm);
  background:var(--clr-bg-alt);
  outline:none;
  transition:border-color .18s,background .18s;
}
input:focus,select:focus{
  border-color:var(--clr-primary);
  background:#fff;
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}
.zone-box{
  border:1px solid var(--clr-border);
  padding:16px 14px 14px;
  border-radius:var(--radius);
  background:linear-gradient(160deg,#fff,#f5f9ff);
  box-shadow:0 2px 5px rgba(0,0,0,.05);
  margin-top:4px;
  display:none;
}
.zone-head{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
}
.zone-head-title{font-size:var(--font-md);font-weight:700;color:#1e293b;}
.badge{
  font-size:var(--font-xs);padding:6px 12px;
  border-radius:24px;font-weight:600;line-height:1;
  display:inline-flex;align-items:center;gap:6px;
}
.badge.pending{background:rgba(220,38,38,.14);color:var(--clr-danger);}
.badge.completed{background:rgba(37,99,235,.14);color:var(--clr-primary);}
/* Tip box now yellow */
.work-hint{
  font-size:var(--font-xs);
  font-weight:600;
  background:#fff6a8; /* soft yellow */
  border:1px solid #e5d35c;
  padding:10px 12px;
  border-radius:var(--radius-sm);
  margin:0 0 12px;
  line-height:1.4;
  color:#3a3500;
}
.work-hint strong{color:#b45309;}
/* Buttons */
.btn-grid{
  display:grid;
  grid-template-columns:1fr; /* only one button now */
  gap:10px;
  margin-bottom:16px;
}
.action-btn{
  font-size:var(--font-sm);
  font-weight:600;
  padding:14px 10px;
  border:none;
  border-radius:var(--radius-sm);
  background:var(--clr-success);
  color:#fff;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  gap:8px;
  min-height:var(--tap-min);
  line-height:1.1;
  box-shadow:0 2px 4px rgba(5,150,105,.35);
  transition:transform .15s,background .18s;
}
.action-btn:active{transform:scale(.95);}
.action-btn:disabled{opacity:.55;transform:none;}
.action-btn .material-icons{font-size:20px;}
.form-row{
  display:flex;align-items:center;gap:14px;margin-bottom:12px;
}
.form-row label{flex:0 0 70px;margin:0;}
.form-row input{flex:1;}
.link{
  font-size:var(--font-xs);
  color:var(--clr-primary);
  text-decoration:none;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:4px;
  margin-top:2px;
}
#saveMsg,#campaignMsg{
  font-size:var(--font-xs);
  font-weight:600;
  margin-top:6px;
  display:none;
}
#saveMsg{color:var(--clr-success);}
#campaignMsg.success{color:var(--clr-success);}
#campaignMsg.err{color:var(--clr-danger);}
/* FABs */
.fab{
  position:fixed;
  right:16px;
  width:64px;
  height:64px;
  border-radius:50%;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:600;
  font-size:14px;
  gap:4px;
  box-shadow:0 6px 16px -2px rgba(0,0,0,.3),0 2px 6px rgba(0,0,0,.18);
  cursor:pointer;
  z-index:70;
  background:linear-gradient(135deg,var(--clr-primary),var(--clr-primary-dark));
  transition:transform .2s;
}
.fab:active{transform:scale(.92);}
#addProofFab{bottom:96px;}
#saveFab{bottom:20px;background:#0f172a;}
.map-tab-active .hide-when-map{display:none;}
/* Modal */
.modal-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:120;
}
.modal{
  width:100%;max-width:520px;
  background:var(--clr-bg);
  border-radius:24px;
  border:1px solid var(--clr-border);
  padding:24px 22px 28px;
  box-shadow:0 8px 28px -4px rgba(0,0,0,.35);
  max-height:90dvh;
  margin:16px;
  display:flex;flex-direction:column;
  animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{transform:translateY(18px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal h3{margin:0;font-size:var(--font-md);font-weight:700;color:var(--clr-primary);}
.close-btn{
  width:44px;height:44px;border-radius:50%;border:none;
  background:var(--clr-bg-alt);
  color:var(--clr-muted);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
}
.close-btn:active{transform:scale(.9);}
.file-actions{display:flex;gap:12px;margin:0 0 16px;}
.file-actions button{
  flex:1;padding:12px 8px;font-size:14px;border:none;
  border-radius:var(--radius-sm);
  background:var(--clr-primary);color:#fff;font-weight:600;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;
}
.file-actions button:active{transform:scale(.95);}
#proofFileInput{display:none;}
#proofPreview{
  width:100%;max-height:250px;object-fit:cover;
  border:1px solid var(--clr-border);border-radius:var(--radius);
  margin:4px 0 14px;display:none;background:#fff;
}
#proofUploadStatus{
  font-size:var(--font-xs);
  font-weight:600;
  display:none;
  margin:6px 0 4px;
  color:var(--clr-primary);
}
#proofUploadStatus.ok{color:var(--clr-success);}
#proofUploadStatus.err{color:var(--clr-danger);}
.alert{
  font-size:var(--font-xs);font-weight:600;
  padding:10px 12px;border-radius:var(--radius-sm);
  display:none;margin:8px 0 0;line-height:1.3;
}
.alert.error{background:rgba(220,38,38,.17);color:var(--clr-danger);}
.alert.success{background:rgba(5,150,105,.18);color:var(--clr-success);}
.submit-row{display:flex;gap:12px;margin-top:16px;}
.submit-row button{
  flex:1;padding:14px;border:none;border-radius:var(--radius-sm);
  font-size:14px;font-weight:600;
  background:var(--clr-primary);color:#fff;cursor:pointer;
  transition:transform .15s;
}
.submit-row button.outline{background:#fff;color:var(--clr-primary);border:1px solid var(--clr-primary);}
.submit-row button:active{transform:scale(.95);}
.leaflet-label-zone{
  background:rgba(37,99,235,.9);
  color:#fff;
  font-size:11px;
  font-weight:600;
  padding:2px 6px;
  border-radius:6px;
  pointer-events:none;
}
@media (min-width:700px){
  #addProofFab,#saveFab{right:28px;}
  .manage-scroll{padding:24px 40px 140px;}
  .section{padding:20px 24px 24px;}
}
</style>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <div class="brand-icon">ZT</div>
    <span>Zone Tracker</span>
  </div>
</header>

<main id="main">
  <div class="main-tabs" role="tablist">
    <button class="main-tab-btn active" data-tab="mapPanel" role="tab" aria-selected="true">
      <span class="material-icons">map</span>
      Map
    </button>
    <button class="main-tab-btn" data-tab="managePanel" role="tab" aria-selected="false">
      <span class="material-icons">dashboard_customize</span>
      Manage
    </button>
  </div>

  <div class="tab-panels">
    <div id="mapPanel" class="tab-panel active" role="tabpanel" aria-label="Map">
      <div id="map" aria-label="Campaign map"></div>
    </div>

    <div id="managePanel" class="tab-panel" role="tabpanel" aria-label="Manage Zones">
      <div class="manage-scroll">
        <div class="section">
          <h3><span class="material-icons" style="font-size:18px;">flag</span> Campaign</h3>
          <div class="row">
            <div>
              <label for="campaignIdInput">Campaign ID</label>
              <input id="campaignIdInput" type="text" placeholder="Enter ID" autocomplete="off">
              <div id="campaignMsg"></div>
            </div>
            <div>
              <label for="zoneSelect">Zone</label>
              <select id="zoneSelect" aria-label="Select Zone"></select>
            </div>
          </div>

            <div id="zoneBox" class="zone-box">
              <div class="zone-head">
                <div class="zone-head-title" id="zoneTitle">Zone</div>
                <div id="zoneStatusBadge" class="badge pending">
                  <span class="material-icons">pending</span>
                  <span>Pending</span>
                </div>
              </div>

              <div class="work-hint">
                <strong>Tip:</strong> Open your walk tracker app before marking complete.
              </div>

              <div class="btn-grid">
                <!-- Only Complete button kept -->
                <button id="toggleCompleteBtn" class="action-btn" type="button">
                  <span class="material-icons">check_circle</span>
                  Complete
                </button>
              </div>

              <div class="form-row">
                <label for="flyersInput">Flyers</label>
                <input id="flyersInput" type="number" min="0" placeholder="0" inputmode="numeric">
              </div>
              <div class="form-row">
                <label for="gpsUrlInput">GPS URL</label>
                <input id="gpsUrlInput" type="url" placeholder="https://">
              </div>
              <a id="gpsOpenLink" class="link" href="#" target="_blank" rel="noopener" style="display:none;">
                <span class="material-icons" style="font-size:14px;">open_in_new</span>
                Open GPS
              </a>

              <div id="saveMsg">
                <span class="material-icons" style="font-size:14px;vertical-align:middle;margin-right:4px;">check_circle</span>
                Saved
              </div>
            </div>
        </div>

        <!-- Proofs section removed as requested -->

      </div>
    </div>
  </div>
</main>

<!-- FABs -->
<button id="addProofFab" class="fab hide-when-map" title="Add Photo Proof">
  <span class="material-icons">add_a_photo</span>
</button>
<button id="saveFab" class="fab hide-when-map" title="Save Campaign">
  <span class="material-icons">save</span>
</button>

<!-- Proof Modal (kept so user can still add photos if desired) -->
<div id="proofModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="proofModalTitle">
  <div class="modal" id="proofModal">
    <header>
      <h3 id="proofModalTitle">Photo Proof</h3>
      <button class="close-btn" id="closeProofModalBtn" aria-label="Close proof modal">
        <span class="material-icons">close</span>
      </button>
    </header>

    <div class="file-actions">
      <button id="takePhotoBtn" type="button">
        <span class="material-icons">camera_alt</span>
        Take Photo
      </button>
      <button id="pickPhotoBtn" type="button">
        <span class="material-icons">photo_library</span>
        Gallery
      </button>
    </div>
    <input id="proofFileInput" type="file" accept="image/*" capture="environment">
    <img id="proofPreview" alt="Selected proof preview" loading="lazy">

    <label for="proofUrlInput">Or Image URL</label>
    <input id="proofUrlInput" type="url" placeholder="https://image-url.com">
    <div id="proofUploadStatus"></div>
    <div id="proofErrorMsg" class="alert error"></div>
    <div id="proofSuccessMsg" class="alert success">
      <span class="material-icons" style="font-size:14px;vertical-align:middle;margin-right:4px;">check_circle</span>
      Uploaded
    </div>

    <div class="submit-row">
      <button id="proofSubmitBtn" type="button">Submit</button>
      <button id="clearProofBtn" class="outline" type="button">Clear</button>
    </div>
  </div>
</div>

<template id="markerIconTpl">
  <svg viewBox="0 0 24 24" width="20" height="20" fill="#2563eb" stroke="white" stroke-width="1.5">
    <path d="M12 2.75a7.25 7.25 0 0 0-7.25 7.25c0 4.7 5.85 10.91 7.08 12.18.1.1.24.16.38.16s.28-.06.38-.16c1.23-1.27 7.08-7.49 7.08-12.18A7.25 7.25 0 0 0 12 2.75Zm0 10.5a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z"/>
  </svg>
</template>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Cloudinary */
const CLOUDINARY_CLOUD_NAME="dvndw130d";
const CLOUDINARY_UPLOAD_PRESET="unsigned_nft";
const CLOUDINARY_UPLOAD_URL=`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
async function uploadToCloudinary(file,statusEl){
  if(!file) throw new Error("No file");
  statusEl.style.display='block';
  statusEl.textContent='Uploading...';
  statusEl.classList.remove('ok','err');
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",CLOUDINARY_UPLOAD_PRESET);
  const resp=await fetch(CLOUDINARY_UPLOAD_URL,{method:"POST",body:fd});
  const data=await resp.json();
  if(!data.secure_url){
    statusEl.classList.add('err');
    statusEl.textContent='Upload failed';
    throw new Error("Upload failed");
  }
  statusEl.classList.add('ok');
  statusEl.textContent='Uploaded';
  setTimeout(()=>statusEl.style.display='none',1500);
  return data.secure_url;
}

/* Firebase */
const campaignConfig={
  apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
  authDomain:"trackingclients.firebaseapp.com",
  projectId:"trackingclients",
  storageBucket:"trackingclients.appspot.com",
  messagingSenderId:"27490943622",
  appId:"1:27490943622:web:d6c87547aa5df440508707",
  databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
};
const polygonsConfig={
  apiKey:"AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
  authDomain:"nftfanactive.firebaseapp.com",
  databaseURL:"https://nftfanactive-default-rtdb.firebaseio.com",
  projectId:"nftfanactive",
  storageBucket:"nftfanactive.appspot.com",
  messagingSenderId:"311309982791",
  appId:"1:311309982791:web:3e55bba6b78feb57ea6562"
};
const campaignApp=initializeApp(campaignConfig);
const campaignDb=getDatabase(campaignApp);
const polygonsApp=initializeApp(polygonsConfig,'polys');
const polygonsDb=getDatabase(polygonsApp);

/* Tabs */
const mainTabs=document.querySelectorAll('.main-tab-btn');
let mapInitialized=false;
let map, zonePolys=[];
mainTabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.classList.contains('active')) return;
    mainTabs.forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');});
    btn.classList.add('active');btn.setAttribute('aria-selected','true');
    const targetId=btn.dataset.tab;
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(targetId).classList.add('active');
    const mapActive=targetId==='mapPanel';
    document.documentElement.classList.toggle('map-tab-active',mapActive);
    if(mapActive && mapInitialized) setTimeout(()=>map.invalidateSize(),120);
    if(mapActive && !mapInitialized){initMap();mapInitialized=true;}
  });
});

/* DOM */
const campaignIdInput=document.getElementById('campaignIdInput');
const campaignMsg=document.getElementById('campaignMsg');
const zoneSelect=document.getElementById('zoneSelect');
const zoneBox=document.getElementById('zoneBox');
const zoneTitle=document.getElementById('zoneTitle');
const zoneStatusBadge=document.getElementById('zoneStatusBadge');
const flyersInput=document.getElementById('flyersInput');
const gpsUrlInput=document.getElementById('gpsUrlInput');
const gpsOpenLink=document.getElementById('gpsOpenLink');
const toggleCompleteBtn=document.getElementById('toggleCompleteBtn');
const saveMsg=document.getElementById('saveMsg');
const addProofFab=document.getElementById('addProofFab');
const saveFab=document.getElementById('saveFab');

/* Proof modal elements */
const proofModalBackdrop=document.getElementById('proofModalBackdrop');
const closeProofModalBtn=document.getElementById('closeProofModalBtn');
const proofFileInput=document.getElementById('proofFileInput');
const takePhotoBtn=document.getElementById('takePhotoBtn');
const pickPhotoBtn=document.getElementById('pickPhotoBtn');
const proofPreview=document.getElementById('proofPreview');
const proofUrlInput=document.getElementById('proofUrlInput');
const proofSubmitBtn=document.getElementById('proofSubmitBtn');
const clearProofBtn=document.getElementById('clearProofBtn');
const proofErrorMsg=document.getElementById('proofErrorMsg');
const proofSuccessMsg=document.getElementById('proofSuccessMsg');
const proofUploadStatus=document.getElementById('proofUploadStatus');

/* State */
let ZONES=0, zoneData=[], polygonsLoaded=false, pendingCampaign=null;
let selected=0, loadedCampaignId='';
function defaultZone(){return {status:'pending',flyers:'',gpsUrl:''};}
function ensureLen(){
  if(zoneData.length<ZONES) for(let i=zoneData.length;i<ZONES;i++) zoneData.push(defaultZone());
  if(zoneData.length>ZONES) zoneData=zoneData.slice(0,ZONES);
}
function isValidUrl(u){try{const x=new URL(u);return['http:','https:'].includes(x.protocol);}catch{return false;}}
function renderSelect(){
  zoneSelect.innerHTML='';
  for(let i=0;i<ZONES;i++){
    const z=zoneData[i];
    const icon=(z.status==='completed')?'âœ…':'ðŸ”´';
    const opt=document.createElement('option');
    opt.value=i;opt.textContent=`${icon} Z${i+1}`;
    zoneSelect.appendChild(opt);
  }
  zoneBox.style.display=ZONES?'block':'none';
  if(ZONES) zoneSelect.value=selected;
}
function updatePanel(){
  if(!ZONES) return;
  const z=zoneData[selected];
  zoneTitle.textContent='Zone '+(selected+1);
  zoneStatusBadge.className='badge '+(z.status==='completed'?'completed':'pending');
  zoneStatusBadge.innerHTML = (z.status==='completed'
      ? '<span class="material-icons">check_circle</span><span>Completed</span>'
      : '<span class="material-icons">pending</span><span>Pending</span>');
  toggleCompleteBtn.disabled = z.status==='completed';
  toggleCompleteBtn.innerHTML = z.status==='completed'
    ? '<span class="material-icons">check_circle</span>Completed'
    : '<span class="material-icons">check_circle</span>Complete';
  flyersInput.value=z.flyers||'';
  gpsUrlInput.value=z.gpsUrl||'';
  if(isValidUrl(z.gpsUrl)){gpsOpenLink.href=z.gpsUrl;gpsOpenLink.style.display='inline-flex';}
  else gpsOpenLink.style.display='none';
  colorPolys();
}
function selectZone(i){
  if(!ZONES)return;
  if(i<0)i=0;if(i>=ZONES)i=ZONES-1;
  selected=i;zoneSelect.value=selected;updatePanel();
}
function colorPolys(){
  if(!mapInitialized)return;
  zoneData.forEach((z,i)=>{
    if(!zonePolys[i])return;
    const col=(z.status==='completed')?'#2563eb':'#dc2626';
    zonePolys[i].setStyle({
      fillColor:col,
      color:i===selected?'#000':col,
      weight:i===selected?3:2,
      fillOpacity:(z.status==='completed'?0.4:0.35)
    });
  });
}

/* Map */
function initMap(){
  map=L.map('map',{zoomControl:false}).setView([50.85,4.35],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  L.control.zoom({position:'bottomright'}).addTo(map);
  loadPolygons();
  if('geolocation' in navigator){
    let userMarker=null;
    navigator.geolocation.watchPosition(p=>{
      const loc=[p.coords.latitude,p.coords.longitude];
      if(!userMarker){
        userMarker=L.circleMarker(loc,{radius:7,color:'#000',fillColor:'#000',fillOpacity:.95}).addTo(map);
      }else userMarker.setLatLng(loc);
      userLatLng=loc;
    },console.warn,{enableHighAccuracy:true});
  }
}

async function loadPolygons(){
  const snap=await get(ref(polygonsDb,'polygons'));
  zonePolys.forEach(p=>map.removeLayer(p));zonePolys=[];
  if(!snap.exists()){ZONES=0;renderSelect();return;}
  let all=[],idx=0;
  snap.forEach(ch=>{
    const arr=ch.val();
    if(!Array.isArray(arr)||!arr.length)return;
    const coords=arr.map(pt=>[pt.lat,pt.lng]);
    const poly=L.polygon(coords,{color:'#dc2626',fillColor:'#dc2626',fillOpacity:.35,weight:2}).addTo(map);
    poly.on('click',()=>selectZone(idx));
    zonePolys.push(poly);
    all.push(...coords);
    const center=poly.getBounds().getCenter();
    L.marker(center,{
      icon:L.divIcon({
        className:'leaflet-label-zone',
        html:`<div style="background:rgba(37,99,235,.9);padding:2px 6px;border-radius:6px;color:#fff;font-size:11px;font-weight:600;">Z${idx+1}</div>`,
        iconSize:[32,18],iconAnchor:[16,9]
      }),
      interactive:false
    }).addTo(map);
    idx++;
  });
  if(all.length) map.fitBounds(L.latLngBounds(all).pad(0.08));
  ZONES=zonePolys.length;
  polygonsLoaded=true;
  ensureLen();
  renderSelect();
  selectZone(0);
  if(pendingCampaign){await loadCampaign(pendingCampaign);pendingCampaign=null;}
}

/* Campaign save/load */
async function saveAll(){
  const id=campaignIdInput.value.trim();
  if(!id){
    campaignMsg.textContent='Enter ID';
    campaignMsg.className='err';
    campaignMsg.style.display='block';
    return;
  }
  await set(ref(campaignDb,`campaigns/${id}/zone_statuses`),zoneData);
  loadedCampaignId=id;
  localStorage.setItem('lastCampaignId',id);
  saveMsg.style.display='block';
  setTimeout(()=>saveMsg.style.display='none',1500);
}
async function loadCampaign(id){
  if(!id)return;
  if(!polygonsLoaded){pendingCampaign=id;return;}
  const snap=await get(ref(campaignDb,`campaigns/${id}/zone_statuses`));
  if(snap.exists()){
    const data=snap.val();
    zoneData=[];
    for(let i=0;i<ZONES;i++){
      zoneData.push({...defaultZone(),...(Array.isArray(data)?data[i]:(data[i]||{}))});
    }
    campaignMsg.textContent='Loaded';
    campaignMsg.className='success';
  }else{
    zoneData=Array.from({length:ZONES},defaultZone);
    campaignMsg.textContent='New';
    campaignMsg.className='err';
  }
  campaignMsg.style.display='block';
  setTimeout(()=>campaignMsg.style.display='none',1600);
  renderSelect();
  selectZone(0);
  loadedCampaignId=id;
}

/* Inputs */
let debounceTimer=null;
campaignIdInput.addEventListener('input',()=>{
  const v=campaignIdInput.value.trim();
  if(v===loadedCampaignId) return;
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>loadCampaign(v),420);
});
campaignIdInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){e.preventDefault();loadCampaign(campaignIdInput.value.trim());}
});
zoneSelect.addEventListener('change',()=>{selected=+zoneSelect.value;updatePanel();});
flyersInput.addEventListener('input',()=>{zoneData[selected].flyers=flyersInput.value;renderSelect();});
gpsUrlInput.addEventListener('input',()=>{
  zoneData[selected].gpsUrl=gpsUrlInput.value.trim();
  if(isValidUrl(zoneData[selected].gpsUrl)){gpsOpenLink.href=zoneData[selected].gpsUrl;gpsOpenLink.style.display='inline-flex';}
  else gpsOpenLink.style.display='none';
});
toggleCompleteBtn.addEventListener('click',()=>{
  const z=zoneData[selected];
  if(z.status==='completed') return;
  z.status='completed';
  updatePanel();renderSelect();
});
saveFab.addEventListener('click',saveAll);

/* Proof modal (still available) */
let userLatLng=null;
function openProofModal(){
  proofModalBackdrop.style.display='flex';
  proofUrlInput.value='';
  proofFileInput.value='';
  proofPreview.style.display='none';
  proofErrorMsg.style.display='none';
  proofSuccessMsg.style.display='none';
  proofUploadStatus.style.display='none';
  setTimeout(()=>proofUrlInput.focus(),120);
}
function closeProofModal(){proofModalBackdrop.style.display='none';}
addProofFab.addEventListener('click',openProofModal);
closeProofModalBtn.addEventListener('click',closeProofModal);
proofModalBackdrop.addEventListener('click',e=>{if(e.target===proofModalBackdrop)closeProofModal();});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && proofModalBackdrop.style.display==='flex') closeProofModal();
});
takePhotoBtn.addEventListener('click',()=>{
  proofFileInput.setAttribute('capture','environment');
  proofFileInput.click();
});
pickPhotoBtn.addEventListener('click',()=>{
  proofFileInput.removeAttribute('capture');
  proofFileInput.click();
});
proofFileInput.addEventListener('change',()=>{
  proofSuccessMsg.style.display='none';
  proofErrorMsg.style.display='none';
  proofUploadStatus.style.display='none';
  const file=proofFileInput.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      proofPreview.src=e.target.result;
      proofPreview.style.display='block';
    };
    reader.readAsDataURL(file);
  } else proofPreview.style.display='none';
});
function showError(msg){
  proofErrorMsg.textContent=msg;
  proofErrorMsg.style.display='block';
  proofSuccessMsg.style.display='none';
}
function showSuccess(msg){
  proofSuccessMsg.innerHTML='<span class="material-icons" style="font-size:14px;vertical-align:middle;margin-right:4px;">check_circle</span>'+msg;
  proofSuccessMsg.style.display='block';
  proofErrorMsg.style.display='none';
}
function validImageUrl(u){return isValidUrl(u);}

proofSubmitBtn.addEventListener('click',async()=>{
  proofErrorMsg.style.display='none';
  proofSuccessMsg.style.display='none';
  const id=campaignIdInput.value.trim();
  if(!id){showError('No campaign ID');return;}
  if(!userLatLng){showError('Location not ready');return;}
  let finalUrl='';
  const file=proofFileInput.files[0];
  const pasted=proofUrlInput.value.trim();
  try{
    if(file){
      finalUrl=await uploadToCloudinary(file,proofUploadStatus);
    } else if(pasted){
      if(!validImageUrl(pasted)){showError('Invalid URL');return;}
      finalUrl=pasted;
    } else {showError('Select image or enter URL');return;}
    // Store proof (even though list hidden)
    await push(ref(campaignDb,`campaigns/${id}/proofs`),{
      url:finalUrl,
      lat:userLatLng[0],
      lng:userLatLng[1],
      timestamp:Date.now()
    });
    showSuccess('Photo uploaded');
    proofFileInput.value='';
    proofUrlInput.value='';
    proofPreview.style.display='none';
    proofUploadStatus.style.display='none';
    setTimeout(()=>closeProofModal(),1000);
  }catch(e){
    console.error(e);
    showError('Upload failed');
  }
});
clearProofBtn.addEventListener('click',()=>{
  proofFileInput.value='';
  proofPreview.style.display='none';
  proofUrlInput.value='';
  proofErrorMsg.style.display='none';
  proofSuccessMsg.style.display='none';
  proofUploadStatus.style.display='none';
});

/* Restore last campaign */
const stored=localStorage.getItem('lastCampaignId');
if(stored){campaignIdInput.value=stored;loadCampaign(stored);}

/* Resize */
window.addEventListener('resize',()=>{if(mapInitialized) map.invalidateSize();});

/* Init map (Map tab default) */
initMap();mapInitialized=true;
</script>
</body>
</html>
