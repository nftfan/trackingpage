<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zone Tracker + Photo Proof</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --clr-primary:#2563eb;
      --clr-primary-accent:#1d4ed8;
      --clr-danger:#dc2626;
      --clr-warn:#d97706;
      --clr-success:#059669;
      --clr-muted:#64748b;
      --clr-bg:#ffffff;
      --clr-bg-alt:#f1f5f9;
      --clr-border:#d9e0e7;
      --radius-sm:4px;
      --radius:8px;
      --shadow:0 2px 4px rgba(15,23,42,.08);
      --tap-min:44px;
      --font-xs: clamp(10px, 2.5vw, 11px);
      --font-sm: clamp(11px, 2.7vw, 13px);
      --font-md: clamp(12px, 3vw, 14px);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --clr-bg:#0f172a;
        --clr-bg-alt:#1e293b;
        --clr-border:#334155;
        --clr-muted:#94a3b8;
        --shadow:0 2px 4px rgba(0,0,0,.55);
      }
      body {color:#f1f5f9;}
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--clr-bg);
      color:#0f172a;
      line-height:1.35;
      min-height:100vh;
      overflow:hidden;
    }
    body.dark { background:var(--clr-bg); }

    /* Layout */
    .app {
      display:flex;
      flex-direction:column;
      height:100dvh;
      width:100%;
      position:relative;
      overflow:hidden;
    }
    #map {
      flex:0 0 auto;
      height:52dvh;
      width:100%;
      background:#e2e8f0;
    }
    /* Bottom sheet panel */
    .panel {
      position:relative;
      flex:1;
      background:var(--clr-bg);
      border-top:1px solid var(--clr-border);
      border-radius:16px 16px 0 0;
      box-shadow:0 -4px 10px -2px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      touch-action:pan-y;
    }
    .grabber {
      width:54px;
      height:5px;
      border-radius:3px;
      background:var(--clr-border);
      margin:6px auto 4px;
    }
    .panel-scroll {
      flex:1;
      overflow-y:auto;
      padding:0 12px 78px;
      scrollbar-width:thin;
      scrollbar-color:var(--clr-border) transparent;
    }
    .panel-scroll::-webkit-scrollbar { width:6px; }
    .panel-scroll::-webkit-scrollbar-thumb { background:var(--clr-border); border-radius:3px; }

    h2 {
      font-size:var(--font-sm);
      margin:4px 0 8px;
      text-align:center;
      color:var(--clr-primary);
      font-weight:700;
      letter-spacing:.3px;
    }

    label {
      font-size:var(--font-xs);
      font-weight:600;
      display:block;
      margin:0 0 4px;
    }
    input, select {
      width:100%;
      font-size:var(--font-sm);
      padding:8px 10px;
      border:1px solid var(--clr-border);
      border-radius:var(--radius-sm);
      background:var(--clr-bg-alt);
      color:inherit;
      outline:none;
      transition:border-color .18s, background .18s;
    }
    input:focus, select:focus {
      border-color:var(--clr-primary);
      background:#fff;
      box-shadow:0 0 0 3px rgba(37,99,235,.18);
    }

    .row { display:flex; gap:8px; margin-bottom:10px; }
    .row.tight { gap:6px; margin-bottom:6px; }
    .row > div { flex:1; }

    .zone-box {
      background:var(--clr-bg-alt);
      border:1px solid var(--clr-border);
      border-radius:var(--radius);
      padding:10px 12px;
      margin-bottom:12px;
      box-shadow:var(--shadow);
    }
    .zone-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .zone-head-title {
      font-size:var(--font-sm);
      font-weight:700;
      letter-spacing:.4px;
    }
    .badge {
      font-size:var(--font-xs);
      padding:4px 10px;
      border-radius:20px;
      font-weight:600;
      letter-spacing:.4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:var(--clr-border);
      color:#0f172a;
    }
    .badge.pending { background:rgba(220,38,38,.15); color:var(--clr-danger); }
    .badge.completed { background:rgba(37,99,235,.15); color:var(--clr-primary); }
    .badge.working { background:rgba(217,119,6,.2); color:var(--clr-warn); }

    .btn-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-bottom:10px;
    }

    button {
      font-size:var(--font-sm);
      font-weight:600;
      padding:10px 12px;
      border-radius:var(--radius-sm);
      border:1px solid transparent;
      background:var(--clr-primary);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:var(--tap-min);
      line-height:1.1;
      letter-spacing:.3px;
      transition:background .18s, transform .15s, box-shadow .15s;
      touch-action:manipulation;
    }
    button.secondary {
      background:var(--clr-muted);
    }
    button.outline {
      background:var(--clr-bg);
      color:var(--clr-primary);
      border-color:var(--clr-primary);
    }
    button.warn { background:var(--clr-warn); }
    button.danger { background:var(--clr-danger); }
    button.success { background:var(--clr-success); }
    button:active { transform:scale(.96); }
    button:focus-visible { box-shadow:0 0 0 3px rgba(37,99,235,.4); outline:none; }

    .mini-nav { display:flex; gap:8px; margin:4px 0 10px; }
    .mini-nav button { flex:1; padding:10px 0; }

    .pair { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .pair label { flex:0 0 70px; margin:0; }

    .link {
      font-size:var(--font-xs);
      color:var(--clr-primary-accent);
      text-decoration:none;
      font-weight:600;
      display:inline-block;
      margin-top:4px;
    }

    .save-bar {
      position:absolute;
      left:0; right:0; bottom:0;
      display:flex;
      gap:10px;
      padding:12px 14px calc(14px + env(safe-area-inset-bottom));
      background:linear-gradient(to top, rgba(255,255,255,.96), rgba(255,255,255,.9) 60%);
      backdrop-filter: blur(6px);
      border-top:1px solid var(--clr-border);
    }
    @media (prefers-color-scheme: dark) {
      .save-bar {
        background:linear-gradient(to top, rgba(15,23,42,.94), rgba(15,23,42,.8) 60%);
      }
    }
    .save-bar button { flex:1; font-size:var(--font-md); }

    #saveMsg, #campaignMsg {
      font-size:var(--font-xs);
      font-weight:600;
      margin-top:6px;
      display:none;
    }
    #saveMsg { color:var(--clr-success); }
    #campaignMsg.success { color:var(--clr-success); }
    #campaignMsg.err { color:var(--clr-danger); }

    /* Proof thumbnails */
    .proofs-wrapper { margin:4px 0 12px; }
    .proofs-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .proofs-header h3 {
      margin:0;
      font-size:var(--font-sm);
      font-weight:700;
      letter-spacing:.4px;
      color:#1e293b;
    }
    @media (prefers-color-scheme: dark){
      .proofs-header h3 { color:#f1f5f9; }
    }
    #proofsList {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      max-height:120px;
      overflow-y:auto;
    }
    .proof-thumb {
      width:64px;
      height:64px;
      object-fit:cover;
      border:1px solid var(--clr-border);
      border-radius:6px;
      background:#fff;
      cursor:pointer;
      transition:box-shadow .18s, transform .18s;
    }
    .proof-thumb:hover { box-shadow:0 0 0 3px rgba(37,99,235,.35); transform:translateY(-2px); }
    .proof-thumb:active { transform:scale(.95); }

    /* Modal */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding:0;
    }
    .modal {
      width:100%;
      max-width:540px;
      background:var(--clr-bg);
      border-radius:18px 18px 0 0;
      border:1px solid var(--clr-border);
      padding:16px 16px calc(20px + env(safe-area-inset-bottom));
      box-shadow:0 -4px 18px -2px rgba(0,0,0,.25);
      animation:slideUp .32s cubic-bezier(.33,.99,.44,1.05);
      max-height:90dvh;
      display:flex;
      flex-direction:column;
    }
    @keyframes slideUp {
      from { transform:translateY(30px); opacity:0; }
      to { transform:translateY(0); opacity:1; }
    }
    .modal header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .modal h3 {
      margin:0;
      font-size:var(--font-md);
      font-weight:700;
      letter-spacing:.5px;
      color:var(--clr-primary);
    }
    .close-btn {
      background:var(--clr-bg-alt);
      border:1px solid var(--clr-border);
      width:40px;
      height:40px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      cursor:pointer;
      color:var(--clr-muted);
    }
    .close-btn:active { transform:scale(.9); }

    .file-actions {
      display:flex;
      gap:8px;
      margin:4px 0 8px;
    }
    .file-actions button { flex:1; }

    #proofPreview {
      width:100%;
      max-height:240px;
      object-fit:cover;
      border:1px solid var(--clr-border);
      border-radius:10px;
      display:none;
      margin:4px 0 10px;
      background:#fff;
    }
    #proofUploadStatus {
      font-size:var(--font-xs);
      font-weight:600;
      display:none;
      margin:4px 0 2px;
    }
    #proofUploadStatus.up { color:var(--clr-primary); }
    #proofUploadStatus.err { color:var(--clr-danger); }
    #proofUploadStatus.ok { color:var(--clr-success); }

    .alert {
      font-size:var(--font-xs);
      font-weight:600;
      padding:8px 10px;
      border-radius:var(--radius-sm);
      display:none;
      margin:6px 0 4px;
      letter-spacing:.3px;
    }
    .alert.error { background:rgba(220,38,38,.14); color:var(--clr-danger); }
    .alert.success { background:rgba(5,150,105,.14); color:var(--clr-success); }

    .submit-row {
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .submit-row button { flex:1; }

    /* Desktop / large layout */
    @media (min-width: 880px) {
      .app {
        flex-direction:row;
      }
      #map { height:100%; flex:1; }
      .panel {
        position:relative;
        border-radius:0;
        border-left:1px solid var(--clr-border);
        border-top:none;
        width:410px;
      }
      .modal { border-radius:20px; max-width:460px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div id="map" role="region" aria-label="Map with zones"></div>
    <div class="panel" id="sheet">
      <div class="grabber" aria-hidden="true"></div>
      <div class="panel-scroll" id="panelScroll">
        <h2>Zones</h2>
        <div class="row">
          <div>
            <label for="campaignIdInput">Campaign ID</label>
            <input id="campaignIdInput" type="text" placeholder="ID" autocomplete="off" inputmode="text">
            <div id="campaignMsg"></div>
          </div>
          <div>
            <label for="zoneSelect">Zone</label>
            <select id="zoneSelect" aria-label="Zone select"></select>
          </div>
        </div>

        <div class="mini-nav">
          <button id="prevZoneBtn" class="outline" aria-label="Previous zone">â—€</button>
          <button id="focusBtn" class="outline" aria-label="Focus selected zone">Focus</button>
          <button id="nextZoneBtn" class="outline" aria-label="Next zone">â–¶</button>
        </div>

        <div id="zoneBox" class="zone-box" style="display:none;">
          <div class="zone-head">
            <div class="zone-head-title" id="zoneTitle">Zone</div>
            <div id="zoneStatusBadge" class="badge pending">Pending</div>
          </div>
          <div class="btn-grid">
            <button id="toggleWorkBtn" class="warn" type="button">Work</button>
            <button id="toggleCompleteBtn" class="success" type="button">Complete</button>
            <button id="resetBtn" class="danger" type="button">Reset</button>
          </div>
          <div class="pair">
            <label for="flyersInput">Flyers</label>
            <input id="flyersInput" type="number" min="0" placeholder="0" inputmode="numeric">
          </div>
            <div class="pair">
            <label for="gpsUrlInput">GPS URL</label>
            <input id="gpsUrlInput" type="url" placeholder="https://">
          </div>
          <a id="gpsOpenLink" class="link" href="#" target="_blank" rel="noopener" style="display:none;">Open GPS</a>
        </div>

        <div class="proofs-wrapper">
          <div class="proofs-header">
            <h3>Proofs</h3>
            <button id="openProofModalBtn" class="outline" type="button" style="flex:0 0 auto;padding:6px 12px;font-size:var(--font-xs);min-height:auto;">Add</button>
          </div>
          <div id="proofsList" aria-live="polite"></div>
        </div>

        <div id="saveMsg">Saved!</div>
      </div>

      <div class="save-bar">
        <button id="quickCameraBtn" class="success" type="button">Quick Photo</button>
        <button id="saveAllBtn" class="primary" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Proof Modal -->
  <div id="proofModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="proofModalTitle">
    <div class="modal" id="proofModal">
      <header>
        <h3 id="proofModalTitle">Photo Proof</h3>
        <button class="close-btn" id="closeProofModalBtn" aria-label="Close proof modal">Ã—</button>
      </header>

      <div class="file-actions">
        <button id="takePhotoBtn" class="outline" type="button">Take Photo</button>
        <button id="pickPhotoBtn" class="outline" type="button">Pick Image</button>
      </div>
      <input id="proofFileInput" type="file" accept="image/*" capture="environment" style="display:none;">
      <img id="proofPreview" alt="Selected proof preview" loading="lazy">
      <label for="proofUrlInput">Or Image URL</label>
      <input id="proofUrlInput" type="url" placeholder="https://image" autocomplete="off" inputmode="url">

      <div id="proofUploadStatus"></div>
      <div id="proofErrorMsg" class="alert error"></div>
      <div id="proofSuccessMsg" class="alert success">Uploaded</div>

      <div class="submit-row">
        <button id="proofSubmitBtn" class="primary" type="button">Submit</button>
        <button id="clearProofBtn" class="secondary" type="button">Clear</button>
      </div>
    </div>
  </div>

  <template id="markerIconTpl">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="#2563eb" stroke="white" stroke-width="1.5">
      <path d="M12 2.75a7.25 7.25 0 0 0-7.25 7.25c0 4.7 5.85 10.91 7.08 12.18.1.1.24.16.38.16s.28-.06.38-.16c1.23-1.27 7.08-7.49 7.08-12.18A7.25 7.25 0 0 0 12 2.75Zm0 10.5a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z"/>
    </svg>
  </template>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* ---------- Cloudinary Settings ---------- */
    const CLOUDINARY_CLOUD_NAME = "dvndw130d";          // CHANGE if needed
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_nft";    // CHANGE to your unsigned preset
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    const ENABLE_CLIENT_RESIZE = true;
    const RESIZE_MAX_WIDTH = 1280;
    const RESIZE_QUALITY = 0.82; // JPEG quality

    async function maybeResizeImage(file){
      if(!ENABLE_CLIENT_RESIZE) return file;
      if(!/^image\//.test(file.type)) return file;
      const img = await new Promise((res,rej)=>{
        const url = URL.createObjectURL(file);
        const i = new Image();
        i.onload=()=>{res(i); URL.revokeObjectURL(url);};
        i.onerror=rej;
        i.src=url;
      });
      if(img.naturalWidth <= RESIZE_MAX_WIDTH) return file;
      const ratio = RESIZE_MAX_WIDTH / img.naturalWidth;
      const canvas = document.createElement('canvas');
      canvas.width = RESIZE_MAX_WIDTH;
      canvas.height = Math.round(img.naturalHeight * ratio);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg',RESIZE_QUALITY));
      return new File([blob], file.name.replace(/\.(png|jpeg|jpg|webp|gif)$/i,'')+'_resized.jpg',{type:'image/jpeg'});
    }

    async function uploadToCloudinary(file, statusEl){
      statusEl.style.display='block';
      statusEl.textContent='Preparing...';
      statusEl.className='up';
      const processed = await maybeResizeImage(file);
      statusEl.textContent='Uploading...';
      const fd = new FormData();
      fd.append("file", processed);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
      const resp = await fetch(CLOUDINARY_UPLOAD_URL,{ method:"POST", body:fd });
      const data = await resp.json();
      if(!data.secure_url) throw new Error("Upload failed");
      statusEl.textContent='Upload OK';
      statusEl.className='ok';
      setTimeout(()=>{ statusEl.style.display='none'; }, 1200);
      return data.secure_url;
    }

    /* ---------- Firebase ---------- */
    const campaignConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const campaignApp = initializeApp(campaignConfig);
    const campaignDb = getDatabase(campaignApp);

    const polygonsConfig = {
      apiKey:"AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain:"nftfanactive.firebaseapp.com",
      databaseURL:"https://nftfanactive-default-rtdb.firebaseio.com",
      projectId:"nftfanactive",
      storageBucket:"nftfanactive.appspot.com",
      messagingSenderId:"311309982791",
      appId:"1:311309982791:web:3e55bba6b78feb57ea6562",
      measurementId:"G-3TRDL9749N"
    };
    const polygonsApp = initializeApp(polygonsConfig,'polys');
    const polygonsDb = getDatabase(polygonsApp);

    /* ---------- Map ---------- */
    const map = L.map('map',{ zoomControl:false }).setView([50.85,4.35],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    /* ---------- State / Data ---------- */
    let ZONES=0, zoneData=[], zonePolys=[], polygonsLoaded=false, pendingCampaign=null;
    let selected=0, loadedCampaignId='';

    /* ---------- DOM Elements ---------- */
    const campaignIdInput = document.getElementById('campaignIdInput');
    const campaignMsg = document.getElementById('campaignMsg');
    const zoneSelect = document.getElementById('zoneSelect');
    const prevZoneBtn = document.getElementById('prevZoneBtn');
    const nextZoneBtn = document.getElementById('nextZoneBtn');
    const focusBtn = document.getElementById('focusBtn');
    const zoneBox = document.getElementById('zoneBox');
    const zoneTitle = document.getElementById('zoneTitle');
    const zoneStatusBadge = document.getElementById('zoneStatusBadge');
    const flyersInput = document.getElementById('flyersInput');
    const gpsUrlInput = document.getElementById('gpsUrlInput');
    const gpsOpenLink = document.getElementById('gpsOpenLink');
    const toggleWorkBtn = document.getElementById('toggleWorkBtn');
    const toggleCompleteBtn = document.getElementById('toggleCompleteBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const saveMsg = document.getElementById('saveMsg');

    const openProofModalBtn = document.getElementById('openProofModalBtn');
    const quickCameraBtn = document.getElementById('quickCameraBtn');
    const proofModalBackdrop = document.getElementById('proofModalBackdrop');
    const closeProofModalBtn = document.getElementById('closeProofModalBtn');
    const proofFileInput = document.getElementById('proofFileInput');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const pickPhotoBtn = document.getElementById('pickPhotoBtn');
    const proofPreview = document.getElementById('proofPreview');
    const proofUrlInput = document.getElementById('proofUrlInput');
    const proofSubmitBtn = document.getElementById('proofSubmitBtn');
    const clearProofBtn = document.getElementById('clearProofBtn');
    const proofErrorMsg = document.getElementById('proofErrorMsg');
    const proofSuccessMsg = document.getElementById('proofSuccessMsg');
    const proofUploadStatus = document.getElementById('proofUploadStatus');
    const proofsList = document.getElementById('proofsList');

    /* ---------- Utilities ---------- */
    function defaultZone(){ return { status:'pending', flyers:'', gpsUrl:'', working:false }; }
    function ensureLen(){
      if(zoneData.length<ZONES) for(let i=zoneData.length;i<ZONES;i++) zoneData.push(defaultZone());
      if(zoneData.length>ZONES) zoneData = zoneData.slice(0,ZONES);
    }
    function isValidUrl(u){
      try { const x=new URL(u); return ['http:','https:'].includes(x.protocol); }
      catch { return false; }
    }

    function renderSelect(){
      zoneSelect.innerHTML='';
      for(let i=0;i<ZONES;i++){
        const z=zoneData[i];
        const opt=document.createElement('option');
        const icon = z.working ? 'ðŸŸ¡' : (z.status==='completed' ? 'âœ…' : 'ðŸ”´');
        opt.value=i;
        opt.textContent = `${icon} Z${i+1}`;
        zoneSelect.appendChild(opt);
      }
      if(ZONES){ zoneSelect.value=selected; zoneBox.style.display='block'; }
      else zoneBox.style.display='none';
    }
    function updatePanel(){
      if(!ZONES) return;
      const z=zoneData[selected];
      zoneTitle.textContent='Zone '+(selected+1);
      zoneStatusBadge.className='badge '+(z.working?'working':(z.status==='completed'?'completed':'pending'));
      zoneStatusBadge.textContent = z.working ? 'Working' : (z.status==='completed'?'Completed':'Pending');
      toggleWorkBtn.textContent = z.working ? 'Stop' : 'Work';
      toggleCompleteBtn.textContent = z.status==='completed' ? 'Undo' : 'Complete';
      flyersInput.value = z.flyers || '';
      gpsUrlInput.value = z.gpsUrl || '';
      if(isValidUrl(z.gpsUrl)){ gpsOpenLink.href=z.gpsUrl; gpsOpenLink.style.display='inline-block'; }
      else gpsOpenLink.style.display='none';
    }
    function selectZone(i){
      if(!ZONES) return;
      if(i<0) i=0;
      if(i>=ZONES) i=ZONES-1;
      selected=i;
      zoneSelect.value=selected;
      updatePanel();
      colorPolys();
      focusPolygon(selected);
    }
    function colorPolys(){
      zoneData.forEach((z,i)=>{
        if(!zonePolys[i]) return;
        const col = z.working ? '#d97706' : (z.status==='completed' ? '#2563eb' : '#dc2626');
        zonePolys[i].setStyle({
          fillColor: col,
          color: i===selected ? '#000' : col,
          weight: i===selected ? 3 : 2,
          fillOpacity: z.working ? 0.45 : (z.status==='completed' ? 0.4 : 0.35),
          dashArray: z.working && i===selected ? '3 3' : null
        });
      });
    }
    function focusPolygon(i){
      if(zonePolys[i]) map.fitBounds(zonePolys[i].getBounds().pad(0.4));
    }

    async function loadPolygons(){
      const snap=await get(ref(polygonsDb,'polygons'));
      zonePolys.forEach(p=>map.removeLayer(p));
      zonePolys=[];
      if(!snap.exists()){ ZONES=0; renderSelect(); return; }
      let idx=0;
      let allLatLng=[];
      snap.forEach(ch=>{
        const arr=ch.val();
        if(!Array.isArray(arr)||!arr.length) return;
        const coords=arr.map(pt=>[pt.lat,pt.lng]);
        const poly=L.polygon(coords,{color:'#dc2626',fillColor:'#dc2626',fillOpacity:0.35,weight:2}).addTo(map);
        poly.on('click',()=>selectZone(idx));
        zonePolys.push(poly);
        allLatLng.push(...coords);
        const center=poly.getBounds().getCenter();
        L.marker(center,{
          icon:L.divIcon({
            className:'leaflet-label-zone',
            html:`<div style="background:rgba(37,99,235,.9);padding:2px 6px;border-radius:6px;color:#fff;font-size:11px;font-weight:600;">Z${idx+1}</div>`,
            iconSize:[32,18],
            iconAnchor:[16,9]
          }),
          interactive:false
        }).addTo(map);
        idx++;
      });
      if(allLatLng.length) map.fitBounds(L.latLngBounds(allLatLng).pad(0.1));
      ZONES=zonePolys.length;
      polygonsLoaded=true;
      ensureLen();
      renderSelect();
      selectZone(0);
      if(pendingCampaign){ await loadCampaign(pendingCampaign); pendingCampaign=null; }
    }
    loadPolygons();

    async function saveAll(){
      const id=campaignIdInput.value.trim();
      if(!id){
        campaignMsg.textContent='Enter ID';
        campaignMsg.className='err';
        campaignMsg.style.display='block';
        return;
      }
      await set(ref(campaignDb,`campaigns/${id}/zone_statuses`), zoneData);
      loadedCampaignId=id;
      localStorage.setItem('lastCampaignId', id);
      saveMsg.style.display='block';
      setTimeout(()=>saveMsg.style.display='none',1400);
    }

    async function loadCampaign(id){
      if(!id) return;
      if(!polygonsLoaded){ pendingCampaign=id; return; }
      const snap=await get(ref(campaignDb,`campaigns/${id}/zone_statuses`));
      if(snap.exists()){
        const data=snap.val();
        zoneData=[];
        for(let i=0;i<ZONES;i++){
          zoneData.push({ ...defaultZone(), ...(Array.isArray(data)?data[i]: (data[i]||{})) });
        }
        campaignMsg.textContent='Loaded';
        campaignMsg.className='success';
      } else {
        zoneData = Array.from({length:ZONES}, defaultZone);
        campaignMsg.textContent='New';
        campaignMsg.className='err';
      }
      campaignMsg.style.display='block';
      setTimeout(()=>campaignMsg.style.display='none',1600);
      renderSelect();
      selectZone(0);
      loadedCampaignId=id;
      fetchProofs();
    }

    /* ---------- Events: campaign input ---------- */
    let debounceTimer=null;
    campaignIdInput.addEventListener('input', ()=>{
      const v=campaignIdInput.value.trim();
      if(v===loadedCampaignId) return;
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(()=>loadCampaign(v), 420);
    });
    campaignIdInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        loadCampaign(campaignIdInput.value.trim());
      }
    });

    zoneSelect.addEventListener('change', ()=>{ selected=+zoneSelect.value; updatePanel(); colorPolys(); focusPolygon(selected); });
    prevZoneBtn.addEventListener('click', ()=>selectZone((selected-1+ZONES)%ZONES));
    nextZoneBtn.addEventListener('click', ()=>selectZone((selected+1)%ZONES));
    focusBtn.addEventListener('click', ()=>focusPolygon(selected));

    flyersInput.addEventListener('input', ()=>{ zoneData[selected].flyers=flyersInput.value; renderSelect(); });
    gpsUrlInput.addEventListener('input', ()=>{
      zoneData[selected].gpsUrl = gpsUrlInput.value.trim();
      if(isValidUrl(zoneData[selected].gpsUrl)){
        gpsOpenLink.href=zoneData[selected].gpsUrl;
        gpsOpenLink.style.display='inline-block';
      } else gpsOpenLink.style.display='none';
    });
    toggleWorkBtn.addEventListener('click', ()=>{
      const z=zoneData[selected];
      z.working=!z.working;
      if(z.working) z.status='pending';
      updatePanel(); renderSelect(); colorPolys();
    });
    toggleCompleteBtn.addEventListener('click', ()=>{
      const z=zoneData[selected];
      if(z.status==='completed'){ z.status='pending'; }
      else { z.status='completed'; z.working=false; }
      updatePanel(); renderSelect(); colorPolys();
    });
    resetBtn.addEventListener('click', ()=>{
      zoneData[selected]=defaultZone();
      updatePanel(); renderSelect(); colorPolys();
    });
    saveAllBtn.addEventListener('click', saveAll);

    /* ---------- Geolocation ---------- */
    let userLatLng=null;
    let userMarker=null;
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(p=>{
        userLatLng=[p.coords.latitude, p.coords.longitude];
        if(!userMarker){
          userMarker= L.circleMarker(userLatLng,{ radius:7, color:'#2563eb', fillColor:'#2563eb', fillOpacity:.9 }).addTo(map);
        } else userMarker.setLatLng(userLatLng);
      }, e=>console.warn(e), { enableHighAccuracy:true, maximumAge:8000, timeout:15000 });
    }

    /* ---------- Proofs ---------- */
    let proofMarkers=[];
    function clearProofMarkers(){ proofMarkers.forEach(m=>map.removeLayer(m)); proofMarkers=[]; }

    function renderProofs(proofs){
      clearProofMarkers();
      proofsList.innerHTML='';
      proofs.forEach((p,i)=>{
        const icon = L.divIcon({
          className:'custom-proof-icon',
          html: document.getElementById('markerIconTpl').innerHTML,
          iconSize:[20,20],
          iconAnchor:[10,20]
        });
        const mk = L.marker([p.lat,p.lng],{ icon }).addTo(map)
          .bindPopup(`<div style="font-size:12px;text-align:center;max-width:160px;">
            <strong>P${i+1}</strong><br>
            <img src="${p.url}" alt="Proof ${i+1}" loading="lazy"
             style="max-width:140px;max-height:110px;border:1px solid #2563eb;border-radius:6px;margin-top:6px;object-fit:cover;">
            <div style="margin-top:4px;color:#334155;font-size:11px;">${new Date(p.timestamp||0).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>`);
        proofMarkers.push(mk);
        const img=document.createElement('img');
        img.src=p.url;
        img.loading='lazy';
        img.alt='Proof '+(i+1);
        img.className='proof-thumb';
        img.addEventListener('click', ()=>{
          map.setView([p.lat,p.lng], Math.max(map.getZoom(), 16), { animate:true });
          mk.openPopup();
        }, { passive:true });
        proofsList.appendChild(img);
      });
    }

    function fetchProofs(){
      const id = campaignIdInput.value.trim();
      if(!id){
        clearProofMarkers();
        proofsList.innerHTML='';
        return;
      }
      onValue(ref(campaignDb,`campaigns/${id}/proofs`), snap=>{
        const arr=[];
        snap.forEach(ch=>{
          const v=ch.val();
          if(v && typeof v.lat==='number' && typeof v.lng==='number' && v.url) arr.push(v);
        });
        arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
        renderProofs(arr);
      });
    }
    campaignIdInput.addEventListener('input', ()=> setTimeout(fetchProofs, 500));
    saveAllBtn.addEventListener('click', ()=> setTimeout(fetchProofs, 400));

    /* ---------- Proof Modal & Quick Camera ---------- */
    function openProofModal(){
      proofModalBackdrop.style.display='flex';
      proofUrlInput.value='';
      proofFileInput.value='';
      proofPreview.style.display='none';
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      proofUploadStatus.style.display='none';
      setTimeout(()=>proofUrlInput.focus(), 90);
    }
    function closeProofModal(){
      proofModalBackdrop.style.display='none';
    }
    openProofModalBtn.addEventListener('click', openProofModal);
    closeProofModalBtn.addEventListener('click', closeProofModal);
    proofModalBackdrop.addEventListener('click', e=>{
      if(e.target===proofModalBackdrop) closeProofModal();
    });

    // Quick camera (opens capture file input, auto submits modal open)
    quickCameraBtn.addEventListener('click', ()=>{
      openProofModal();
      // Programmatically trigger camera
      takePhotoBtn.click();
    });

    takePhotoBtn.addEventListener('click', ()=>{
      proofFileInput.setAttribute('capture','environment'); // ensure environment camera (if supported)
      proofFileInput.click();
    });
    pickPhotoBtn.addEventListener('click', ()=>{
      proofFileInput.removeAttribute('capture');
      proofFileInput.click();
    });

    proofFileInput.addEventListener('change', ()=>{
      proofSuccessMsg.style.display='none';
      proofErrorMsg.style.display='none';
      proofUploadStatus.style.display='none';
      const file = proofFileInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e=>{
          proofPreview.src = e.target.result;
          proofPreview.style.display='block';
        };
        reader.readAsDataURL(file);
      } else {
        proofPreview.style.display='none';
      }
    });

    function showError(msg){
      proofErrorMsg.textContent=msg;
      proofErrorMsg.style.display='block';
      proofSuccessMsg.style.display='none';
    }
    function showSuccess(msg){
      proofSuccessMsg.textContent=msg;
      proofSuccessMsg.style.display='block';
      proofErrorMsg.style.display='none';
    }

    function validImageUrl(u){ return isValidUrl(u); }

    proofSubmitBtn.addEventListener('click', async ()=>{
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      const id = campaignIdInput.value.trim();
      if(!id){ showError('No ID'); return; }
      if(!userLatLng){ showError('No GPS'); return; }

      let finalUrl='';
      const file = proofFileInput.files[0];
      const pasted = proofUrlInput.value.trim();

      try {
        if(file){
          finalUrl = await uploadToCloudinary(file, proofUploadStatus);
        } else if(pasted) {
          if(!validImageUrl(pasted)){ showError('Bad URL'); return; }
          finalUrl = pasted;
        } else {
          showError('Select or capture an image');
          return;
        }
        await push(ref(campaignDb,`campaigns/${id}/proofs`), {
          url:finalUrl,
          lat:userLatLng[0],
          lng:userLatLng[1],
          timestamp:Date.now()
        });
        showSuccess('Uploaded');
        proofFileInput.value='';
        proofUrlInput.value='';
        proofPreview.style.display='none';
        proofUploadStatus.style.display='none';
        fetchProofs();
        setTimeout(()=>closeProofModal(), 900);
      } catch(err){
        console.error(err);
        showError('Upload error');
      }
    });

    clearProofBtn.addEventListener('click', ()=>{
      proofFileInput.value='';
      proofPreview.style.display='none';
      proofUrlInput.value='';
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      proofUploadStatus.style.display='none';
    });

    /* ---------- Restore last campaign ---------- */
    const stored = localStorage.getItem('lastCampaignId');
    if(stored){
      campaignIdInput.value = stored;
      loadCampaign(stored);
      setTimeout(fetchProofs, 800);
    }

    /* ---------- Bottom Sheet Drag (Mobile) ---------- */
    const sheet = document.getElementById('sheet');
    let startY=0, startHeight=0;
    const minHeight = 200;
    const maxHeight = window.innerHeight - 80;
    const mapEl = document.getElementById('map');

    function setHeights(panelH){
      panelH = Math.min(Math.max(panelH, minHeight), maxHeight);
      const mapH = window.innerHeight - panelH;
      mapEl.style.height = mapH+'px';
      sheet.style.height = panelH+'px';
      map.invalidateSize();
    }
    // Initialize
    if(window.innerWidth < 880){
      setHeights(window.innerHeight * 0.48);
    }

    sheet.addEventListener('touchstart', e=>{
      if(window.innerWidth >= 880) return;
      if(e.target.closest('.panel-scroll')) return; // allow scroll inside
      startY = e.touches[0].clientY;
      startHeight = sheet.getBoundingClientRect().height;
    }, { passive:true });

    sheet.addEventListener('touchmove', e=>{
      if(!startY) return;
      const dy = startY - e.touches[0].clientY;
      setHeights(startHeight + dy);
    }, { passive:true });

    sheet.addEventListener('touchend', ()=>{ startY=0; }, { passive:true });

    window.addEventListener('orientationchange', ()=>{
      setTimeout(()=>{
        if(window.innerWidth < 880){
          setHeights(window.innerHeight * 0.5);
        } else {
          mapEl.style.height='100%';
          sheet.style.height='100%';
          map.invalidateSize();
        }
      }, 400);
    });

    /* ---------- Accessibility: keyboard close modal ---------- */
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape' && proofModalBackdrop.style.display==='flex'){
        closeProofModal();
      }
    });

  </script>
</body>
</html>
