<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zone Tracker + Photo Proof (Mobile)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --clr-primary:#2563eb;
      --clr-primary-accent:#1d4ed8;
      --clr-danger:#dc2626;
      --clr-warn:#d97706;
      --clr-success:#059669;
      --clr-muted:#64748b;
      --clr-bg:#ffffff;
      --clr-bg-alt:#f1f5f9;
      --clr-border:#d9e0e7;
      --radius-sm:6px;
      --radius:10px;
      --shadow:0 2px 4px rgba(15,23,42,.08);
      --tap-min:44px;
      --font-xs: clamp(10px, 2.5vw, 11px);
      --font-sm: clamp(11px, 2.7vw, 13px);
      --font-md: clamp(13px, 3.1vw, 15px);
    }
    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--clr-bg);
      color:#0f172a;
      line-height:1.35;
      min-height:100vh;
      overflow:hidden;
    }

    /* Header */
    .app-header {
      position:fixed;
      top:0; left:0; right:0;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      background:#fffffff2;
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--clr-border);
      z-index:40;
    }
    .brand {
      font-size:16px;
      font-weight:700;
      letter-spacing:.5px;
      color:var(--clr-primary);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .brand-icon {
      width:30px;
      height:30px;
      border-radius:8px;
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:15px;
      font-weight:600;
      box-shadow:0 2px 4px rgba(0,0,0,.12);
    }
    .header-actions {
      display:flex;
      align-items:center;
      gap:8px;
    }
    .header-btn {
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      font-size:12px;
      font-weight:600;
      border-radius:30px;
      background:#2563eb;
      color:#fff;
      border:1px solid #1d56c9;
      line-height:1;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(37,99,235,.35);
      transition:background .18s, transform .15s;
      min-height:var(--tap-min);
    }
    .header-btn.secondary {
      background:#0f172a;
      border-color:#0f172a;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
    }
    .header-btn:active { transform:scale(.94); }
    .header-btn:focus-visible { outline:2px solid #93c5fd; outline-offset:2px; }

    /* Layout below header */
    .app {
      position:relative;
      display:flex;
      flex-direction:column;
      height:100dvh;
      width:100%;
      padding-top:54px; /* header offset */
    }
    #map {
      flex:0 0 auto;
      height:50dvh;
      width:100%;
      background:#e2e8f0;
    }

    .panel {
      flex:1;
      display:flex;
      flex-direction:column;
      background:var(--clr-bg);
      border-top:1px solid var(--clr-border);
      padding:10px 12px 28px;
      position:relative;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:var(--clr-border) transparent;
    }
    .panel::-webkit-scrollbar { width:6px; }
    .panel::-webkit-scrollbar-thumb { background:var(--clr-border); border-radius:3px; }

    h2 {
      font-size:var(--font-sm);
      margin:2px 0 10px;
      text-align:center;
      color:var(--clr-primary);
      font-weight:700;
      letter-spacing:.3px;
    }
    label {
      font-size:var(--font-xs);
      font-weight:600;
      display:block;
      margin:0 0 4px;
    }
    input, select {
      width:100%;
      font-size:var(--font-sm);
      padding:10px 12px;
      border:1px solid var(--clr-border);
      border-radius:var(--radius-sm);
      background:var(--clr-bg-alt);
      outline:none;
      transition:border-color .18s, background .18s;
    }
    input:focus, select:focus {
      border-color:var(--clr-primary);
      background:#fff;
      box-shadow:0 0 0 3px rgba(37,99,235,.18);
    }
    .row { display:flex; gap:10px; margin-bottom:12px; }
    .row > div { flex:1; }

    .zone-box {
      background:var(--clr-bg-alt);
      border:1px solid var(--clr-border);
      border-radius:var(--radius);
      padding:14px 14px 16px;
      margin-bottom:16px;
      box-shadow:var(--shadow);
    }
    .zone-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .zone-head-title {
      font-size:var(--font-sm);
      font-weight:700;
      letter-spacing:.4px;
    }
    .badge {
      font-size:var(--font-xs);
      padding:5px 12px;
      border-radius:24px;
      font-weight:600;
      letter-spacing:.4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      background:var(--clr-border);
      color:#0f172a;
    }
    .badge.pending { background:rgba(220,38,38,.15); color:var(--clr-danger); }
    .badge.completed { background:rgba(37,99,235,.15); color:var(--clr-primary); }
    .badge.working { background:rgba(217,119,6,.2); color:var(--clr-warn); }

    .work-hint {
      font-size:10.5px;
      font-weight:600;
      background:#fff;
      border:1px solid #e2e8f0;
      padding:8px 10px;
      border-radius:8px;
      margin:0 0 12px;
      line-height:1.3;
      color:#0f172a;
    }
    .work-hint strong { color:#dc2626; }

    .btn-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-bottom:12px;
    }
    button.action {
      font-size:var(--font-sm);
      font-weight:600;
      padding:12px 10px;
      border-radius:10px;
      border:1px solid transparent;
      background:var(--clr-primary);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:var(--tap-min);
      line-height:1.1;
      letter-spacing:.3px;
      transition:background .18s, transform .15s;
    }
    button.action:active { transform:scale(.95); }
    button.action:disabled { opacity:.55; transform:none; }
    button.warn { background:var(--clr-warn); }
    button.success { background:var(--clr-success); }
    button.danger { background:var(--clr-danger); }

    .pair { display:flex; align-items:center; gap:14px; margin-bottom:12px; }
    .pair label { flex:0 0 70px; margin:0; }

    .link {
      font-size:var(--font-xs);
      color:var(--clr-primary-accent);
      text-decoration:none;
      font-weight:600;
      display:inline-block;
      margin-top:4px;
    }

    .proofs-wrapper { margin:4px 0 18px; }
    .proofs-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .proofs-header h3 {
      margin:0;
      font-size:var(--font-sm);
      font-weight:700;
      letter-spacing:.4px;
      color:#1e293b;
    }
    #proofsList {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      max-height:160px;
      overflow-y:auto;
    }
    #proofsList::-webkit-scrollbar{width:6px;}
    #proofsList::-webkit-scrollbar-thumb{background:var(--clr-border);border-radius:3px;}
    .proof-item {
      position:relative;
      width:70px;
      height:70px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--clr-border);
      background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
    }
    .proof-thumb {
      width:100%; height:100%; object-fit:cover; display:block; cursor:pointer;
      transition:transform .18s;
    }
    .proof-thumb:active { transform:scale(.94); }
    .del-btn {
      position:absolute;
      top:3px; right:3px;
      width:22px; height:22px;
      border:none;
      background:rgba(0,0,0,.65);
      color:#fff;
      border-radius:7px;
      font-size:15px;
      line-height:20px;
      padding:0;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .del-btn:active { transform:scale(.85); }

    #saveMsg, #campaignMsg {
      font-size:var(--font-xs);
      font-weight:600;
      margin-top:4px;
      display:none;
    }
    #saveMsg { color:var(--clr-success); }
    #campaignMsg.success { color:var(--clr-success); }
    #campaignMsg.err { color:var(--clr-danger); }

    /* Modal */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:60;
    }
    .modal {
      width:100%;
      max-width:520px;
      background:var(--clr-bg);
      border-radius:20px 20px 0 0;
      border:1px solid var(--clr-border);
      padding:18px 18px calc(22px + env(safe-area-inset-bottom));
      box-shadow:0 -4px 18px -2px rgba(0,0,0,.25);
      max-height:88dvh;
      display:flex;
      flex-direction:column;
      animation:slideUp .3s ease;
    }
    @keyframes slideUp {
      from { transform:translateY(30px); opacity:0; }
      to { transform:translateY(0); opacity:1; }
    }
    .modal header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .modal h3 {
      margin:0;
      font-size:var(--font-md);
      font-weight:700;
      color:var(--clr-primary);
    }
    .close-btn {
      background:var(--clr-bg-alt);
      border:1px solid var(--clr-border);
      width:42px;
      height:42px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      cursor:pointer;
      color:var(--clr-muted);
    }
    .close-btn:active { transform:scale(.9); }

    .file-actions { display:flex; gap:10px; margin:0 0 10px; }
    .file-actions button { flex:1; padding:12px 8px; font-size:12px; background:#2563eb; color:#fff; border:1px solid #1d56c9; border-radius:10px; font-weight:600; cursor:pointer; }
    .file-actions button:active { transform:scale(.95); }
    #proofFileInput { display:none; }
    #proofPreview {
      width:100%; max-height:230px; object-fit:cover;
      border:1px solid var(--clr-border); border-radius:12px;
      margin:4px 0 12px; display:none; background:#fff;
    }
    #proofUploadStatus {
      font-size:var(--font-xs);
      font-weight:600;
      display:none;
      margin:4px 0 6px;
      color:var(--clr-primary);
    }
    #proofUploadStatus.ok { color:var(--clr-success); }
    #proofUploadStatus.err { color:var(--clr-danger); }

    .alert {
      font-size:var(--font-xs);
      font-weight:600;
      padding:10px 12px;
      border-radius:10px;
      display:none;
      margin:4px 0 6px;
    }
    .alert.error { background:rgba(220,38,38,.14); color:var(--clr-danger); }
    .alert.success { background:rgba(5,150,105,.14); color:var(--clr-success); }

    .submit-row { display:flex; gap:12px; margin-top:8px; }
    .submit-row button {
      flex:1;
      padding:12px 14px;
      font-size:13px;
      font-weight:600;
      border-radius:12px;
      border:1px solid #1d56c9;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      transition:transform .15s;
    }
    .submit-row button.outline {
      background:#fff;
      color:#2563eb;
      border:1px solid #2563eb;
    }
    .submit-row button:active { transform:scale(.95); }

    /* Desktop */
    @media (min-width: 880px) {
      .app { flex-direction:row; padding-top:54px; }
      #map { height:100%; flex:1; }
      .panel { width:400px; }
      .modal { border-radius:24px; max-width:430px; }
    }

    .leaflet-label-zone{
      background:rgba(37,99,235,.9);
      color:#fff;
      font-size:10px;
      font-weight:600;
      padding:2px 6px;
      border-radius:6px;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">ZT</div>
      <span>Zone Tracker</span>
    </div>
    <div class="header-actions">
      <button id="quickCameraBtn" class="header-btn secondary" type="button" title="Quick Photo">ðŸ“·</button>
      <button id="saveAllBtn" class="header-btn" type="button" title="Save Campaign">ðŸ’¾ Save</button>
    </div>
  </header>

  <div class="app" id="app">
    <div id="map" role="region" aria-label="Map with zones"></div>
    <div class="panel">
      <h2>Zones</h2>
      <div class="row">
        <div>
          <label for="campaignIdInput">Campaign ID</label>
          <input id="campaignIdInput" type="text" placeholder="ID" autocomplete="off">
          <div id="campaignMsg"></div>
        </div>
        <div>
          <label for="zoneSelect">Zone</label>
          <select id="zoneSelect" aria-label="Zone select"></select>
        </div>
      </div>

      <div id="zoneBox" class="zone-box" style="display:none;">
        <div class="zone-head">
          <div class="zone-head-title" id="zoneTitle">Zone</div>
          <div id="zoneStatusBadge" class="badge pending">Pending</div>
        </div>

        <div class="work-hint">
          <strong>Open MapMyWalk</strong> (or your walk tracker) before tapping Work so progress is recorded.
        </div>

        <div class="btn-grid">
          <button id="toggleWorkBtn" class="action warn" type="button">Work</button>
          <button id="toggleCompleteBtn" class="action success" type="button">Complete</button>
          <button id="resetBtn" class="action danger" type="button">Reset</button>
        </div>

        <div class="pair">
          <label for="flyersInput">Flyers</label>
          <input id="flyersInput" type="number" min="0" placeholder="0" inputmode="numeric">
        </div>
        <div class="pair">
          <label for="gpsUrlInput">GPS URL</label>
          <input id="gpsUrlInput" type="url" placeholder="https://">
        </div>
        <a id="gpsOpenLink" class="link" href="#" target="_blank" rel="noopener" style="display:none;">Open GPS</a>
      </div>

      <div class="proofs-wrapper">
        <div class="proofs-header">
          <h3>Proofs</h3>
          <button id="openProofModalBtn" class="header-btn" type="button" style="padding:8px 14px;min-height:auto;font-size:12px;">Add</button>
        </div>
        <div id="proofsList" aria-live="polite"></div>
      </div>

      <div id="saveMsg">Saved!</div>
    </div>
  </div>

  <!-- Proof Modal -->
  <div id="proofModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="proofModalTitle">
    <div class="modal" id="proofModal">
      <header>
        <h3 id="proofModalTitle">Photo Proof</h3>
        <button class="close-btn" id="closeProofModalBtn" aria-label="Close proof modal">Ã—</button>
      </header>

      <div class="file-actions">
        <button id="takePhotoBtn" type="button">Take</button>
        <button id="pickPhotoBtn" type="button">Gallery</button>
      </div>
      <input id="proofFileInput" type="file" accept="image/*" capture="environment">
      <img id="proofPreview" alt="Selected proof preview" loading="lazy">

      <label for="proofUrlInput" style="font-size:12px;font-weight:600;margin:4px 0 6px;">Or Image URL</label>
      <input id="proofUrlInput" type="url" placeholder="https://image">

      <div id="proofUploadStatus"></div>
      <div id="proofErrorMsg" class="alert error"></div>
      <div id="proofSuccessMsg" class="alert success">Uploaded</div>

      <div class="submit-row">
        <button id="proofSubmitBtn" type="button">Submit</button>
        <button id="clearProofBtn" class="outline" type="button">Clear</button>
      </div>
    </div>
  </div>

  <template id="markerIconTpl">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="#2563eb" stroke="white" stroke-width="1.5">
      <path d="M12 2.75a7.25 7.25 0 0 0-7.25 7.25c0 4.7 5.85 10.91 7.08 12.18.1.1.24.16.38.16s.28-.06.38-.16c1.23-1.27 7.08-7.49 7.08-12.18A7.25 7.25 0 0 0 12 2.75Zm0 10.5a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z"/>
    </svg>
  </template>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* Cloudinary */
    const CLOUDINARY_CLOUD_NAME = "dvndw130d";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_nft";
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    async function uploadToCloudinary(file, statusEl){
      if(!file) throw new Error("No file");
      statusEl.style.display='block';
      statusEl.textContent='Uploading...';
      statusEl.classList.remove('ok','err');
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
      const resp = await fetch(CLOUDINARY_UPLOAD_URL,{ method:"POST", body:fd });
      const data = await resp.json();
      if(!data.secure_url) {
        statusEl.classList.add('err');
        statusEl.textContent='Upload failed';
        throw new Error("Upload failed");
      }
      statusEl.classList.add('ok');
      statusEl.textContent='Uploaded';
      setTimeout(()=>statusEl.style.display='none',1400);
      return data.secure_url;
    }

    /* Firebase */
    const campaignConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const campaignApp = initializeApp(campaignConfig);
    const campaignDb = getDatabase(campaignApp);

    const polygonsConfig = {
      apiKey:"AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain:"nftfanactive.firebaseapp.com",
      databaseURL:"https://nftfanactive-default-rtdb.firebaseio.com",
      projectId:"nftfanactive",
      storageBucket:"nftfanactive.appspot.com",
      messagingSenderId:"311309982791",
      appId:"1:311309982791:web:3e55bba6b78feb57ea6562"
    };
    const polygonsApp = initializeApp(polygonsConfig,'polys');
    const polygonsDb = getDatabase(polygonsApp);

    /* Map */
    const map = L.map('map',{ zoomControl:false }).setView([50.85,4.35],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    /* State */
    let ZONES=0, zoneData=[], zonePolys=[], polygonsLoaded=false, pendingCampaign=null;
    let selected=0, loadedCampaignId='';

    /* DOM refs */
    const campaignIdInput=document.getElementById('campaignIdInput');
    const campaignMsg=document.getElementById('campaignMsg');
    const zoneSelect=document.getElementById('zoneSelect');
    const zoneBox=document.getElementById('zoneBox');
    const zoneTitle=document.getElementById('zoneTitle');
    const zoneStatusBadge=document.getElementById('zoneStatusBadge');
    const flyersInput=document.getElementById('flyersInput');
    const gpsUrlInput=document.getElementById('gpsUrlInput');
    const gpsOpenLink=document.getElementById('gpsOpenLink');
    const toggleWorkBtn=document.getElementById('toggleWorkBtn');
    const toggleCompleteBtn=document.getElementById('toggleCompleteBtn');
    const resetBtn=document.getElementById('resetBtn');
    const saveAllBtn=document.getElementById('saveAllBtn');
    const saveMsg=document.getElementById('saveMsg');

    const openProofModalBtn=document.getElementById('openProofModalBtn');
    const quickCameraBtn=document.getElementById('quickCameraBtn');
    const proofModalBackdrop=document.getElementById('proofModalBackdrop');
    const closeProofModalBtn=document.getElementById('closeProofModalBtn');
    const proofFileInput=document.getElementById('proofFileInput');
    const takePhotoBtn=document.getElementById('takePhotoBtn');
    const pickPhotoBtn=document.getElementById('pickPhotoBtn');
    const proofPreview=document.getElementById('proofPreview');
    const proofUrlInput=document.getElementById('proofUrlInput');
    const proofSubmitBtn=document.getElementById('proofSubmitBtn');
    const clearProofBtn=document.getElementById('clearProofBtn');
    const proofErrorMsg=document.getElementById('proofErrorMsg');
    const proofSuccessMsg=document.getElementById('proofSuccessMsg');
    const proofUploadStatus=document.getElementById('proofUploadStatus');
    const proofsList=document.getElementById('proofsList');

    function defaultZone(){ return { status:'pending', flyers:'', gpsUrl:'', working:false }; }
    function ensureLen(){
      if(zoneData.length<ZONES) for(let i=zoneData.length;i<ZONES;i++) zoneData.push(defaultZone());
      if(zoneData.length>ZONES) zoneData=zoneData.slice(0,ZONES);
    }
    function isValidUrl(u){ try{ const x=new URL(u); return ['http:','https:'].includes(x.protocol); }catch{return false;} }

    function renderSelect(){
      zoneSelect.innerHTML='';
      for(let i=0;i<ZONES;i++){
        const z=zoneData[i], opt=document.createElement('option');
        const icon=z.working?'ðŸŸ¡':(z.status==='completed'?'âœ…':'ðŸ”´');
        opt.value=i; opt.textContent=`${icon} Z${i+1}`;
        zoneSelect.appendChild(opt);
      }
      if(ZONES){ zoneSelect.value=selected; zoneBox.style.display='block'; } else zoneBox.style.display='none';
    }
    function updatePanel(){
      if(!ZONES) return;
      const z=zoneData[selected];
      zoneTitle.textContent='Zone '+(selected+1);
      zoneStatusBadge.className='badge '+(z.working?'working':(z.status==='completed'?'completed':'pending'));
      zoneStatusBadge.textContent=z.working?'Working':(z.status==='completed'?'Completed':'Pending');
      toggleWorkBtn.textContent=z.working?'Stop':'Work';
      if(z.status==='completed'){
        toggleCompleteBtn.textContent='Completed';
        toggleCompleteBtn.disabled=true;
      } else {
        toggleCompleteBtn.textContent='Complete';
        toggleCompleteBtn.disabled=false;
      }
      flyersInput.value=z.flyers||'';
      gpsUrlInput.value=z.gpsUrl||'';
      if(isValidUrl(z.gpsUrl)){gpsOpenLink.href=z.gpsUrl;gpsOpenLink.style.display='inline-block';}
      else gpsOpenLink.style.display='none';
    }
    function selectZone(i){
      if(!ZONES) return;
      if(i<0)i=0; if(i>=ZONES)i=ZONES-1;
      selected=i; zoneSelect.value=selected; updatePanel(); colorPolys();
    }
    function colorPolys(){
      zoneData.forEach((z,i)=>{
        if(!zonePolys[i])return;
        const col=z.working?'#d97706':(z.status==='completed'?'#2563eb':'#dc2626');
        zonePolys[i].setStyle({
          fillColor:col,
          color:i===selected?'#000':col,
          weight:i===selected?3:2,
          fillOpacity:z.working?0.45:(z.status==='completed'?0.4:0.35),
          dashArray:z.working&&i===selected?'3 3':null
        });
      });
    }

    async function loadPolygons(){
      const snap=await get(ref(polygonsDb,'polygons'));
      zonePolys.forEach(p=>map.removeLayer(p)); zonePolys=[];
      if(!snap.exists()){ZONES=0;renderSelect();return;}
      let all=[];
      let idx=0;
      snap.forEach(ch=>{
        const arr=ch.val();
        if(!Array.isArray(arr)||!arr.length)return;
        const coords=arr.map(pt=>[pt.lat,pt.lng]);
        const poly=L.polygon(coords,{color:'#dc2626',fillColor:'#dc2626',fillOpacity:0.35,weight:2}).addTo(map);
        poly.on('click',()=>selectZone(idx));
        zonePolys.push(poly);
        all.push(...coords);
        const center=poly.getBounds().getCenter();
        L.marker(center,{icon:L.divIcon({className:'leaflet-label-zone',html:`<div style="background:rgba(37,99,235,.9);padding:2px 6px;border-radius:6px;color:#fff;font-size:11px;font-weight:600;">Z${idx+1}</div>`,iconSize:[32,18],iconAnchor:[16,9]}),interactive:false}).addTo(map);
        idx++;
      });
      if(all.length) map.fitBounds(L.latLngBounds(all).pad(0.1));
      ZONES=zonePolys.length;
      polygonsLoaded=true;
      ensureLen();
      renderSelect();
      selectZone(0);
      if(pendingCampaign){await loadCampaign(pendingCampaign);pendingCampaign=null;}
    }
    loadPolygons();

    async function saveAll(){
      const id=campaignIdInput.value.trim();
      if(!id){campaignMsg.textContent='Enter ID';campaignMsg.className='err';campaignMsg.style.display='block';return;}
      await set(ref(campaignDb,`campaigns/${id}/zone_statuses`),zoneData);
      loadedCampaignId=id; localStorage.setItem('lastCampaignId',id);
      saveMsg.style.display='block'; setTimeout(()=>saveMsg.style.display='none',1400);
    }

    async function loadCampaign(id){
      if(!id) return;
      if(!polygonsLoaded){pendingCampaign=id;return;}
      const snap=await get(ref(campaignDb,`campaigns/${id}/zone_statuses`));
      if(snap.exists()){
        const data=snap.val(); zoneData=[];
        for(let i=0;i<ZONES;i++){
          zoneData.push({ ...defaultZone(), ...(Array.isArray(data)?data[i]:(data[i]||{})) });
        }
        campaignMsg.textContent='Loaded'; campaignMsg.className='success';
      } else {
        zoneData=Array.from({length:ZONES},defaultZone);
        campaignMsg.textContent='New'; campaignMsg.className='err';
      }
      campaignMsg.style.display='block'; setTimeout(()=>campaignMsg.style.display='none',1600);
      renderSelect(); selectZone(0);
      loadedCampaignId=id;
      fetchProofs();
    }

    let debounceTimer=null;
    campaignIdInput.addEventListener('input',()=>{
      const v=campaignIdInput.value.trim();
      if(v===loadedCampaignId) return;
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(()=>loadCampaign(v),420);
    });
    campaignIdInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){e.preventDefault();loadCampaign(campaignIdInput.value.trim());}
    });

    zoneSelect.addEventListener('change',()=>{selected=+zoneSelect.value;updatePanel();colorPolys();});
    flyersInput.addEventListener('input',()=>{zoneData[selected].flyers=flyersInput.value;renderSelect();});
    gpsUrlInput.addEventListener('input',()=>{
      zoneData[selected].gpsUrl=gpsUrlInput.value.trim();
      if(isValidUrl(zoneData[selected].gpsUrl)){gpsOpenLink.href=zoneData[selected].gpsUrl;gpsOpenLink.style.display='inline-block';}
      else gpsOpenLink.style.display='none';
    });
    toggleWorkBtn.addEventListener('click',()=>{
      const z=zoneData[selected];
      if(z.status==='completed') return;
      z.working=!z.working;
      if(z.working) z.status='pending';
      updatePanel();renderSelect();colorPolys();
    });
    toggleCompleteBtn.addEventListener('click',()=>{
      const z=zoneData[selected];
      if(z.status==='completed') return;
      z.status='completed';
      z.working=false;
      updatePanel();renderSelect();colorPolys();
    });
    resetBtn.addEventListener('click',()=>{
      zoneData[selected]=defaultZone();
      updatePanel();renderSelect();colorPolys();
    });
    saveAllBtn.addEventListener('click',saveAll);

    /* Geolocation - black dot */
    let userLatLng=null;
    let userMarker=null;
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(p=>{
        userLatLng=[p.coords.latitude,p.coords.longitude];
        if(!userMarker){
          userMarker=L.circleMarker(userLatLng,{radius:7,color:'#000',fillColor:'#000',fillOpacity:.95}).addTo(map);
        } else userMarker.setLatLng(userLatLng);
      },err=>console.warn(err),{enableHighAccuracy:true});
    }

    /* Proofs */
    let proofMarkers=[];
    function clearProofMarkers(){proofMarkers.forEach(m=>map.removeLayer(m));proofMarkers=[];}
    function deleteProof(key){
      const id=campaignIdInput.value.trim();
      if(!id||!key) return;
      if(!confirm('Delete this photo proof?')) return;
      remove(ref(campaignDb,`campaigns/${id}/proofs/${key}`)).catch(()=>alert('Delete failed'));
    }
    function renderProofs(proofs){
      clearProofMarkers();
      proofsList.innerHTML='';
      proofs.forEach((p,i)=>{
        const icon = L.divIcon({
          className:'custom-proof-icon',
            html: document.getElementById('markerIconTpl').innerHTML,
          iconSize:[20,20],
          iconAnchor:[10,20]
        });
        const mk=L.marker([p.lat,p.lng],{icon}).addTo(map)
          .bindPopup(`<div style="font-size:12px;text-align:center;max-width:160px;">
            <strong>P${i+1}</strong><br>
            <img src="${p.url}" alt="Proof ${i+1}" style="max-width:140px;max-height:100px;border:1px solid #2563eb;border-radius:8px;margin-top:6px;object-fit:cover;">
            <div style="margin-top:6px;">
              <button data-del="${p.key}" style="background:#dc2626;color:#fff;border:none;padding:5px 12px;border-radius:8px;font-size:11px;cursor:pointer;">Delete</button>
            </div>
          </div>`);
        mk.on('popupopen', ()=>{
          const btn=mk.getPopup().getElement().querySelector('button[data-del]');
          if(btn) btn.onclick=()=>{deleteProof(p.key); map.closePopup();};
        });
        proofMarkers.push(mk);

        const wrap=document.createElement('div');
        wrap.className='proof-item';
        const img=document.createElement('img');
        img.src=p.url; img.alt='Proof '+(i+1); img.className='proof-thumb';
        img.onclick=()=>{map.setView([p.lat,p.lng], Math.max(map.getZoom(),16)); mk.openPopup();};
        const del=document.createElement('button');
        del.className='del-btn'; del.type='button'; del.textContent='Ã—';
        del.onclick=(e)=>{e.stopPropagation();deleteProof(p.key);};
        wrap.appendChild(img); wrap.appendChild(del);
        proofsList.appendChild(wrap);
      });
    }
    function fetchProofs(){
      const id=campaignIdInput.value.trim();
      if(!id){clearProofMarkers();proofsList.innerHTML='';return;}
      onValue(ref(campaignDb,`campaigns/${id}/proofs`),snap=>{
        const arr=[]; snap.forEach(ch=>{const v=ch.val(); if(v && typeof v.lat==='number' && typeof v.lng==='number' && v.url) arr.push({...v,key:ch.key});});
        arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
        renderProofs(arr);
      });
    }
    campaignIdInput.addEventListener('input',()=>setTimeout(fetchProofs,500));
    saveAllBtn.addEventListener('click',()=>setTimeout(fetchProofs,400));

    /* Proof Modal */
    function openProofModal(){
      proofModalBackdrop.style.display='flex';
      proofUrlInput.value='';
      proofFileInput.value='';
      proofPreview.style.display='none';
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      proofUploadStatus.style.display='none';
      setTimeout(()=>proofUrlInput.focus(),80);
    }
    function closeProofModal(){
      proofModalBackdrop.style.display='none';
    }
    openProofModalBtn.addEventListener('click',openProofModal);
    closeProofModalBtn.addEventListener('click',closeProofModal);
    proofModalBackdrop.addEventListener('click',e=>{if(e.target===proofModalBackdrop)closeProofModal();});

    quickCameraBtn.addEventListener('click',()=>{
      openProofModal();
      takePhotoBtn.click();
    });
    takePhotoBtn.addEventListener('click',()=>{
      proofFileInput.setAttribute('capture','environment');
      proofFileInput.click();
    });
    pickPhotoBtn.addEventListener('click',()=>{
      proofFileInput.removeAttribute('capture');
      proofFileInput.click();
    });
    proofFileInput.addEventListener('change',()=>{
      proofSuccessMsg.style.display='none';
      proofErrorMsg.style.display='none';
      proofUploadStatus.style.display='none';
      const file=proofFileInput.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=e=>{
          proofPreview.src=e.target.result;
          proofPreview.style.display='block';
        };
        reader.readAsDataURL(file);
      } else proofPreview.style.display='none';
    });

    function showError(msg){
      proofErrorMsg.textContent=msg;
      proofErrorMsg.style.display='block';
      proofSuccessMsg.style.display='none';
    }
    function showSuccess(msg){
      proofSuccessMsg.textContent=msg;
      proofSuccessMsg.style.display='block';
      proofErrorMsg.style.display='none';
    }
    function validImageUrl(u){return isValidUrl(u);}

    proofSubmitBtn.addEventListener('click',async()=>{
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      const id=campaignIdInput.value.trim();
      if(!id){showError('No ID');return;}
      if(!userLatLng){showError('No GPS');return;}
      let finalUrl='';
      const file=proofFileInput.files[0];
      const pasted=proofUrlInput.value.trim();
      try{
        if(file){
          finalUrl=await uploadToCloudinary(file, proofUploadStatus);
        } else if(pasted){
          if(!validImageUrl(pasted)){showError('Bad URL');return;}
          finalUrl=pasted;
        } else {
          showError('Select or paste image');
          return;
        }
        await push(ref(campaignDb,`campaigns/${id}/proofs`),{
          url:finalUrl,
          lat:userLatLng[0],
          lng:userLatLng[1],
          timestamp:Date.now()
        });
        showSuccess('Uploaded');
        proofFileInput.value='';
        proofUrlInput.value='';
        proofPreview.style.display='none';
        proofUploadStatus.style.display='none';
        fetchProofs();
        setTimeout(()=>closeProofModal(),900);
      }catch(e){
        console.error(e);
        showError('Upload error');
      }
    });

    clearProofBtn.addEventListener('click',()=>{
      proofFileInput.value='';
      proofPreview.style.display='none';
      proofUrlInput.value='';
      proofErrorMsg.style.display='none';
      proofSuccessMsg.style.display='none';
      proofUploadStatus.style.display='none';
    });

    /* Restore last campaign */
    const stored=localStorage.getItem('lastCampaignId');
    if(stored){campaignIdInput.value=stored;loadCampaign(stored);setTimeout(fetchProofs,600);}

    document.addEventListener('keydown',e=>{
      if(e.key==='Escape' && proofModalBackdrop.style.display==='flex') closeProofModal();
    });
  </script>
</body>
</html>
