<!DOCTYPE html>
<html lang="en">
<head>
  <title>Compact Zone Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --p:#2563eb;--p2:#1d4ed8;--d:#dc2626;--s:#059669;--w:#d97706;
      --bg:#ffffff;--bg2:#f1f5f9;--bd:#d9e0e7;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;}
    body{background:#fff;font-size:10px;line-height:1.25;color:#0f172a;-webkit-font-smoothing:antialiased;}
    #map{height:400px;width:100%;background:#e2e8f0;}
    /* BELOW AREA TOTAL TARGET ≈400px */
    .panel{
      height:400px;overflow:hidden;display:flex;flex-direction:column;
      border-top:1px solid var(--bd);background:var(--bg);font-size:10px;
    }
    .scroller{overflow-y:auto;flex:1;padding:6px 6px 52px}
    h2{font-size:10px;font-weight:700;color:var(--p);text-align:center;margin:2px 0 4px;}
    label{font-size:9px;font-weight:600;display:block;margin-bottom:2px;}
    input,select{
      width:100%;padding:4px 5px;font-size:9px;border:1px solid var(--bd);border-radius:4px;
      background:var(--bg2);outline:none;
    }
    input:focus,select:focus{border-color:var(--p);background:#fff;box-shadow:0 0 0 2px rgba(37,99,235,.18);}
    .row{display:flex;gap:4px;margin-bottom:4px;}
    .row > div{flex:1;}
    .zone-box{
      border:1px solid var(--bd);border-radius:5px;padding:4px 5px;margin-top:4px;background:#fff;
    }
    .zone-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
    .badge{padding:2px 6px;border-radius:20px;font-size:9px;font-weight:600;line-height:1;}
    .pending{background:rgba(220,38,38,.15);color:var(--d);}
    .completed{background:rgba(37,99,235,.18);color:var(--p);}
    .working{background:rgba(217,119,6,.25);color:var(--w);}
    .btns{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px;}
    button{
      border:none;border-radius:4px;padding:4px 6px;font-size:9px;font-weight:600;
      background:var(--p);color:#fff;cursor:pointer;line-height:1;letter-spacing:.3px;
    }
    button.small{padding:3px 5px;font-size:8px;}
    button.alt{background:#64748b;}
    button.dng{background:var(--d);}
    button.wrk{background:var(--w);}
    button.scs{background:var(--s);}
    button.out{background:#fff;color:#334155;border:1px solid var(--bd);}
    button:active{transform:scale(.95);}
    .pair{display:flex;align-items:center;gap:4px;margin-bottom:4px;}
    .pair input{flex:1;}
    .link{font-size:8px;color:var(--p);text-decoration:none;display:inline-block;margin-top:2px;}
    .save-bar{
      position:absolute;left:0;right:0;bottom:0;padding:4px 6px 4px;
      background:#ffffffef;border-top:1px solid var(--bd);display:flex;gap:4px;
    }
    .save-bar button{flex:1;padding:6px 4px;font-size:9px;}
    #saveMsg{display:none;font-size:9px;font-weight:600;color:var(--s);text-align:center;margin-top:2px;}
    #campaignMsg{display:none;margin-top:2px;font-size:9px;font-weight:600;padding:3px 4px;border-radius:4px;}
    #campaignMsg.success{background:rgba(5,150,105,.15);color:var(--s);}
    #campaignMsg.err{background:rgba(220,38,38,.15);color:var(--d);}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);z-index:40;justify-content:center;align-items:center;}
    .modal{background:#fff;width:260px;padding:8px 10px;border-radius:6px;border:1px solid var(--bd);font-size:9px;}
    .modal h3{margin:0 0 4px;font-size:10px;text-align:center;color:var(--p);}
    .modal input{margin-bottom:4px;}
    .close-btn{position:absolute;right:6px;top:4px;background:#fff;border:1px solid var(--bd);width:18px;height:18px;font-size:11px;line-height:16px;padding:0;border-radius:3px;cursor:pointer;}
    .modal-error,.modal-success{display:none;font-size:8px;font-weight:600;padding:4px;border-radius:4px;margin-top:2px;}
    .modal-error{background:rgba(220,38,38,.18);color:var(--d);}
    .modal-success{background:rgba(5,150,105,.2);color:var(--s);}
    /* Scrollbar tiny */
    .scroller::-webkit-scrollbar{width:5px}
    .scroller::-webkit-scrollbar-track{background:transparent}
    .scroller::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    /* Leaflet label */
    .leaflet-label-zone{
      background:rgba(37,99,235,.9);color:#fff;font-size:8px;font-weight:600;
      padding:2px 4px;border-radius:4px;pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="scroller">
      <h2>Zones</h2>
      <div class="row">
        <div>
          <label for="campaignIdInput">Campaign ID</label>
          <input id="campaignIdInput" type="text" placeholder="ID">
          <div id="campaignMsg"></div>
        </div>
        <div>
          <label for="zoneSelect">Zone</label>
          <select id="zoneSelect"></select>
        </div>
      </div>

      <div class="row" style="gap:2px;margin-bottom:2px;">
        <button id="prevZoneBtn" class="out small" style="flex:1;">◀</button>
        <button id="nextZoneBtn" class="out small" style="flex:1;">▶</button>
        <button id="focusBtn" class="out small" style="flex:2;">Focus</button>
      </div>

      <div id="zoneBox" class="zone-box" style="display:none;">
        <div class="zone-head">
          <div id="zoneTitle" style="font-weight:700;font-size:9px;">Zone</div>
          <div id="zoneStatusBadge" class="badge pending">Pending</div>
        </div>
        <div class="btns">
          <button id="toggleWorkBtn" class="wrk small" style="flex:1;">Work</button>
          <button id="toggleCompleteBtn" class="small" style="flex:1;">Complete</button>
          <button id="resetBtn" class="dng small" style="flex:1;">Reset</button>
        </div>
        <div class="pair">
          <label style="flex:0 0 60px;" for="flyersInput">Flyers</label>
          <input id="flyersInput" type="number" min="0" placeholder="0" style="max-width:90px;">
        </div>
        <div class="pair">
          <label style="flex:0 0 60px;" for="gpsUrlInput">GPS URL</label>
          <input id="gpsUrlInput" type="text" placeholder="https://">
        </div>
        <a id="gpsOpenLink" class="link" href="#" target="_blank" style="display:none;">Open GPS</a>
      </div>
      <div id="saveMsg">Saved!</div>
    </div>
    <div class="save-bar">
      <button id="openProofModalBtn" class="scs">Proof</button>
      <button id="saveAllBtn">Save</button>
    </div>
  </div>

  <!-- Proof Modal -->
  <div id="proofModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" id="closeProofModalBtn">×</button>
      <h3>Photo Proof</h3>
      <label for="proofUrlInput" style="margin-top:2px;">Image URL</label>
      <input id="proofUrlInput" type="text" placeholder="https://img">
      <div class="modal-error" id="proofErrorMsg"></div>
      <div class="modal-success" id="proofSuccessMsg">Uploaded</div>
      <button id="proofSubmitBtn" style="margin-top:2px;padding:6px 4px;font-size:9px;">Submit</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const campaignConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const campaignApp = initializeApp(campaignConfig);
    const campaignDb = getDatabase(campaignApp);

    const polygonsConfig = {
      apiKey:"AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain:"nftfanactive.firebaseapp.com",
      databaseURL:"https://nftfanactive-default-rtdb.firebaseio.com",
      projectId:"nftfanactive",
      storageBucket:"nftfanactive.appspot.com",
      messagingSenderId:"311309982791",
      appId:"1:311309982791:web:3e55bba6b78feb57ea6562",
      measurementId:"G-3TRDL9749N"
    };
    const polygonsApp = initializeApp(polygonsConfig,'polys');
    const polygonsDb = getDatabase(polygonsApp);

    let ZONES=0, zoneData=[], zonePolys=[], polygonsLoaded=false, pendingCampaign=null;
    let selected=0, loadedCampaignId='';
    const map=L.map('map').setView([50.85,4.35],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    // DOM
    const campaignIdInput=document.getElementById('campaignIdInput');
    const campaignMsg=document.getElementById('campaignMsg');
    const zoneSelect=document.getElementById('zoneSelect');
    const prevZoneBtn=document.getElementById('prevZoneBtn');
    const nextZoneBtn=document.getElementById('nextZoneBtn');
    const focusBtn=document.getElementById('focusBtn');
    const zoneBox=document.getElementById('zoneBox');
    const zoneTitle=document.getElementById('zoneTitle');
    const zoneStatusBadge=document.getElementById('zoneStatusBadge');
    const flyersInput=document.getElementById('flyersInput');
    const gpsUrlInput=document.getElementById('gpsUrlInput');
    const gpsOpenLink=document.getElementById('gpsOpenLink');
    const toggleWorkBtn=document.getElementById('toggleWorkBtn');
    const toggleCompleteBtn=document.getElementById('toggleCompleteBtn');
    const resetBtn=document.getElementById('resetBtn');
    const saveAllBtn=document.getElementById('saveAllBtn');
    const saveMsg=document.getElementById('saveMsg');
    const openProofModalBtn=document.getElementById('openProofModalBtn');
    const proofModalBackdrop=document.getElementById('proofModalBackdrop');
    const closeProofModalBtn=document.getElementById('closeProofModalBtn');
    const proofUrlInput=document.getElementById('proofUrlInput');
    const proofSubmitBtn=document.getElementById('proofSubmitBtn');
    const proofErrorMsg=document.getElementById('proofErrorMsg');
    const proofSuccessMsg=document.getElementById('proofSuccessMsg');

    function defaultZone(){return {status:'pending',flyers:'',gpsUrl:'',working:false};}
    function ensureLen(){
      if(zoneData.length<ZONES) for(let i=zoneData.length;i<ZONES;i++) zoneData.push(defaultZone());
      if(zoneData.length>ZONES) zoneData=zoneData.slice(0,ZONES);
    }
    function isValidUrl(u){try{const x=new URL(u);return ['http:','https:'].includes(x.protocol);}catch{return false;}}
    function renderSelect(){
      zoneSelect.innerHTML='';
      for(let i=0;i<ZONES;i++){
        const z=zoneData[i],opt=document.createElement('option');
        const icon=z.working?'🟡':(z.status==='completed'?'✅':'🔴');
        opt.value=i;opt.textContent=`${icon} Z${i+1}`;
        zoneSelect.appendChild(opt);
      }
      if(ZONES){zoneSelect.value=selected;zoneBox.style.display='block';} else zoneBox.style.display='none';
    }
    function updatePanel(){
      if(!ZONES) return;
      const z=zoneData[selected];
      zoneTitle.textContent='Zone '+(selected+1);
      zoneStatusBadge.className='badge '+(z.working?'working':(z.status==='completed'?'completed':'pending'));
      zoneStatusBadge.textContent=z.working?'Working':(z.status==='completed'?'Completed':'Pending');
      toggleWorkBtn.textContent=z.working?'Stop':'Work';
      toggleCompleteBtn.textContent=z.status==='completed'?'Undo':'Complete';
      flyersInput.value=z.flyers||'';
      gpsUrlInput.value=z.gpsUrl||'';
      if(isValidUrl(z.gpsUrl)){gpsOpenLink.href=z.gpsUrl;gpsOpenLink.style.display='inline-block';}else gpsOpenLink.style.display='none';
    }
    function selectZone(i){
      if(!ZONES) return;
      if(i<0)i=0; if(i>=ZONES)i=ZONES-1;
      selected=i;zoneSelect.value=selected;updatePanel();colorPolys();focusPolygon(selected);
    }
    function colorPolys(){
      zoneData.forEach((z,i)=>{
        if(!zonePolys[i])return;
        let col=z.working?'#d97706':(z.status==='completed'?'#2563eb':'#dc2626');
        zonePolys[i].setStyle({
          fillColor:col,
          color:i===selected?'#000':col,
          weight:i===selected?3:2,
          fillOpacity:z.working?0.4:(z.status==='completed'?0.35:0.3),
          dashArray:z.working&&i===selected?'3 3':null
        });
      });
    }
    function focusPolygon(i){
      if(zonePolys[i]) map.fitBounds(zonePolys[i].getBounds().pad(0.4));
    }

    async function loadPolygons(){
      const snap=await get(ref(polygonsDb,'polygons'));
      zonePolys.forEach(p=>map.removeLayer(p)); zonePolys=[];
      if(!snap.exists()){ZONES=0;renderSelect();return;}
      let all=[];
      let idx=0;
      snap.forEach(ch=>{
        const arr=ch.val();
        if(!Array.isArray(arr)||!arr.length)return;
        const coords=arr.map(pt=>[pt.lat,pt.lng]);
        const poly=L.polygon(coords,{color:'#dc2626',fillColor:'#dc2626',fillOpacity:0.3,weight:2}).addTo(map);
        poly.on('click',()=>selectZone(idx));
        zonePolys.push(poly);
        all.push(...coords);
        const center=poly.getBounds().getCenter();
        L.marker(center,{icon:L.divIcon({className:'leaflet-label-zone',html:`Z${idx+1}`,iconSize:[24,12],iconAnchor:[12,6]}),interactive:false}).addTo(map);
        idx++;
      });
      if(all.length) map.fitBounds(L.latLngBounds(all).pad(0.1));
      ZONES=zonePolys.length;
      polygonsLoaded=true;
      ensureLen();
      renderSelect();
      selectZone(0);
      if(pendingCampaign){await loadCampaign(pendingCampaign);pendingCampaign=null;}
    }
    loadPolygons();

    async function saveAll(){
      const id=campaignIdInput.value.trim();
      if(!id){
        campaignMsg.textContent='Enter ID'; campaignMsg.className='err'; campaignMsg.style.display='block'; return;
      }
      await set(ref(campaignDb,`campaigns/${id}/zone_statuses`),zoneData);
      loadedCampaignId=id; localStorage.setItem('lastCampaignId',id);
      saveMsg.style.display='block'; setTimeout(()=>saveMsg.style.display='none',1500);
    }

    async function loadCampaign(id){
      if(!id) return;
      if(!polygonsLoaded){pendingCampaign=id;return;}
      const snap=await get(ref(campaignDb,`campaigns/${id}/zone_statuses`));
      if(snap.exists()){
        const data=snap.val(); zoneData=[];
        for(let i=0;i<ZONES;i++){
          zoneData.push({ ...defaultZone(), ...(Array.isArray(data)?data[i]:(data[i]||{})) });
        }
        campaignMsg.textContent='Loaded'; campaignMsg.className='success';
      } else {
        zoneData=Array.from({length:ZONES},defaultZone);
        campaignMsg.textContent='New'; campaignMsg.className='err';
      }
      campaignMsg.style.display='block'; setTimeout(()=>campaignMsg.style.display='none',1200);
      renderSelect(); selectZone(0);
      loadedCampaignId=id;
      fetchProofs();
    }

    // Debounce campaign input
    let t=null;
    campaignIdInput.addEventListener('input',()=>{
      const v=campaignIdInput.value.trim();
      if(v===loadedCampaignId) return;
      clearTimeout(t);
      t=setTimeout(()=>loadCampaign(v),500);
    });
    campaignIdInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){e.preventDefault();loadCampaign(campaignIdInput.value.trim());}
    });

    zoneSelect.addEventListener('change',()=>{selected=+zoneSelect.value;updatePanel();colorPolys();focusPolygon(selected);});
    prevZoneBtn.addEventListener('click',()=>selectZone((selected-1+ZONES)%ZONES));
    nextZoneBtn.addEventListener('click',()=>selectZone((selected+1)%ZONES));
    focusBtn.addEventListener('click',()=>focusPolygon(selected));

    flyersInput.addEventListener('input',()=>{zoneData[selected].flyers=flyersInput.value;renderSelect();});
    gpsUrlInput.addEventListener('input',()=>{
      zoneData[selected].gpsUrl=gpsUrlInput.value.trim();
      if(isValidUrl(zoneData[selected].gpsUrl)){gpsOpenLink.href=zoneData[selected].gpsUrl;gpsOpenLink.style.display='inline-block';}
      else gpsOpenLink.style.display='none';
    });
    toggleWorkBtn.addEventListener('click',()=>{
      const z=zoneData[selected];
      z.working=!z.working;
      if(z.working) z.status='pending';
      updatePanel();renderSelect();colorPolys();
    });
    toggleCompleteBtn.addEventListener('click',()=>{
      const z=zoneData[selected];
      if(z.status==='completed'){z.status='pending';} else {z.status='completed';z.working=false;}
      updatePanel();renderSelect();colorPolys();
    });
    resetBtn.addEventListener('click',()=>{
      zoneData[selected]=defaultZone();
      updatePanel();renderSelect();colorPolys();
    });

    saveAllBtn.addEventListener('click',saveAll);

    // Location
    let userLatLng=null;
    let userMarker=null;
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(p=>{
        userLatLng=[p.coords.latitude,p.coords.longitude];
        if(!userMarker){
          userMarker=L.circleMarker(userLatLng,{radius:6,color:'#2563eb',fillColor:'#2563eb',fillOpacity:.9}).addTo(map);
        } else userMarker.setLatLng(userLatLng);
      },err=>console.warn(err),{enableHighAccuracy:true});
    }

    // Proofs
    let proofMarkers=[];
    function clearProofMarkers(){proofMarkers.forEach(m=>map.removeLayer(m));proofMarkers=[];}
    function renderProofs(proofs){
      clearProofMarkers();
      proofs.forEach((p,i)=>{
        const mk=L.marker([p.lat,p.lng],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/61/61168.png',iconSize:[18,18],iconAnchor:[9,18]})})
        .addTo(map)
        .bindPopup(`<div style="font-size:8px;text-align:center;"><b>P${i+1}</b><br><img src="${p.url}" style="max-width:120px;max-height:80px;border:1px solid #2563eb;border-radius:3px;margin-top:2px"></div>`);
        proofMarkers.push(mk);
      });
    }
    function fetchProofs(){
      const id=campaignIdInput.value.trim(); if(!id){clearProofMarkers();return;}
      onValue(ref(campaignDb,`campaigns/${id}/proofs`),snap=>{
        const arr=[]; snap.forEach(ch=>{const v=ch.val(); if(v && typeof v.lat==='number' && typeof v.lng==='number' && v.url) arr.push(v);});
        arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
        renderProofs(arr);
      });
    }
    campaignIdInput.addEventListener('input',()=>setTimeout(fetchProofs,700));
    saveAllBtn.addEventListener('click',()=>setTimeout(fetchProofs,400));

    // Proof modal
    openProofModalBtn.addEventListener('click',()=>{
      proofModalBackdrop.style.display='flex';
      proofUrlInput.value='';proofErrorMsg.style.display='none';proofSuccessMsg.style.display='none';
      setTimeout(()=>proofUrlInput.focus(),80);
    });
    closeProofModalBtn.addEventListener('click',()=>proofModalBackdrop.style.display='none');
    proofModalBackdrop.addEventListener('click',e=>{if(e.target===proofModalBackdrop)proofModalBackdrop.style.display='none';});
    function validImage(u){return isValidUrl(u);}
    proofSubmitBtn.addEventListener('click',async ()=>{
      proofErrorMsg.style.display='none';proofSuccessMsg.style.display='none';
      const url=proofUrlInput.value.trim(); const id=campaignIdInput.value.trim();
      if(!validImage(url)){proofErrorMsg.textContent='Bad URL';proofErrorMsg.style.display='block';return;}
      if(!userLatLng){proofErrorMsg.textContent='No GPS';proofErrorMsg.style.display='block';return;}
      if(!id){proofErrorMsg.textContent='No ID';proofErrorMsg.style.display='block';return;}
      try{
        await push(ref(campaignDb,`campaigns/${id}/proofs`),{url,lat:userLatLng[0],lng:userLatLng[1],timestamp:Date.now()});
        proofSuccessMsg.style.display='block';proofUrlInput.value='';
        fetchProofs();
        setTimeout(()=>proofModalBackdrop.style.display='none',800);
      }catch(e){
        proofErrorMsg.textContent='Err';proofErrorMsg.style.display='block';
      }
    });

    // Restore last campaign
    const stored=localStorage.getItem('lastCampaignId');
    if(stored){campaignIdInput.value=stored;loadCampaign(stored);setTimeout(fetchProofs,900);}
  </script>
</body>
</html>
