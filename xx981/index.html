<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>LEUVENFLYERS â€“ Campaign XX981 (Map)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Icons+Outlined&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/and.json">
  <link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
  <link rel="apple-touch-startup-image" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
  /**
 * Corporate Blue - Refined Edition
 *
 * v7 FINAL FIX:
 * - Prevent verified/booked zones from resetting after any new completion.
 * - Verified and Booked state is preserved by merging snapshot data with previously known state.
 */
 :root {
  /* Corporate Blue (Facebook-like) Color Palette */
  --brand: #1877F2;
  --brand-alt: #166FE5;
  --accent: #1877F2;
  --accent-alt: #166FE5;
  --accent-soft: #E7F3FF;
  --success: #31A24C;
  --success-soft: rgba(49, 162, 76, 0.1);
  --warning: #F5C33B;
  --warning-soft: rgba(245, 195, 59, 0.15);
  --booked: #F5C33B;
  --danger: #E41E3F;
  --danger-soft: #FFE5E9;
  --fully-viewed-color: #31A24C;

  /* Clean Greyscale for Light Theme */
  --ink-900: #1C1E21;
  --ink-800: #4B4F56;
  --ink-700: #606770;
  --ink-600: #8A8D91;
  --ink-500: #BEC3C9;
  --ink-400: #CCD0D5;
  --ink-300: #E4E6EB;
  --ink-200: #F0F2F5;
  --ink-100: #F5F6F7;
  --ink-050: #FAFBFC;
  
  --surface: #eaeaea;
  --surface-elev: #FFFFFF;
  
  /* Refined Sizing & Effects for a lighter feel */
  --panel-border: var(--ink-300);
  --radius-sm: 8px;
  --radius-md: 12px; /* Softer radius for panels */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
  --focus-ring: 0 0 0 3px rgba(24, 119, 242, 0.3);
  --transition: 150ms cubic-bezier(.4, 0, .2, 1);
  --footer-h: 34px;
  --chip-h: 30px;
  --header-row-gap: 4px;
}

/* Base & Typography */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  width: 100%; height: 100%; overflow: hidden;
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 12px; line-height: 1.4;
  background: var(--ink-200); color: var(--ink-900);
  -webkit-font-smoothing: antialiased;
}
body { display: flex; flex-direction: column; }
a { color: var(--brand); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Top Bar */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--ink-400);
  color: var(--ink-900); z-index: 600;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  position: fixed; top: 0; left: 0; right: 0; display: flex; flex-direction: column;
  padding: 6px 10px 8px; gap: var(--header-row-gap);
}
.brand-title { color: var(--brand); }
.campaign-badge { background: var(--accent-soft); color: var(--brand); font-weight: 600; }
button.icon-btn {
  background: var(--ink-200); border: none;
  color: var(--ink-800); border-radius: 50%; width: 36px; height: 36px;
  position: relative;
}
button.icon-btn:hover { background: var(--ink-300); }

/* Hide the "Zoom to most recent zone" button */
button.icon-btn[title="Zoom to most recent zone"] {
  display: none !important;
}

/* ENHANCED: Notification Badges */
.notif-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  min-width: 18px;
  height: 18px;
  border-radius: 999px;
  color: #fff;
  background-color: var(--danger); /* Default color */
  font-size: 10px;
  font-weight: 700;
  line-height: 18px;
  text-align: center;
  padding: 0 5px;
  box-shadow: 0 0 0 2px var(--surface);
}
#chat-btn .notif-badge { background-color: var(--brand); } /* Specific color for chat */


/* Panels (Notifications, Chat) */
.notifications, .chat-panel {
  background: var(--surface); border: 1px solid var(--panel-border);
  border-radius: var(--radius-md); box-shadow: var(--shadow-md);
  backdrop-filter: none;
  position: fixed; top: calc(var(--topbar-total-height) + 4px); right: 10px;
  display: none; /* Panels are hidden by default */
  flex-direction: column; overflow: hidden;
  animation: dropIn .18s ease; z-index: 650;
}
.chat-panel.visible, .notifications.visible {
  display: flex; /* Use a class to show panels */
}
@keyframes dropIn{from{transform:translateY(-6px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* Refined Notifications */
.notifications { width: 320px; }
.notif-header { color: var(--ink-900); font-weight: 600; font-size: 13px; padding: 12px 16px 8px; }
.notif-item { padding: 12px 16px; }
.notif-item:hover { background: var(--ink-100); }
.notif-icon {
  width: 32px; height: 32px;
  border-radius: 50%; /* Circular icons */
  background: var(--accent-soft); color: var(--brand);
  font-size: 16px;
}
.notif-msg, .notif-empty { color: var(--ink-800); }
.notif-footer { color: var(--ink-700); }

/* REFINED CHAT UI */
.chat-panel {
  width: 360px; max-width: 92vw; height: 60vh; max-height: 70vh; min-height: 360px;
  flex-direction: column;
}
.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--panel-border);
  flex-shrink: 0;
}
.chat-title { font-size: 14px; font-weight: 600; color: var(--ink-900); }
.chat-list {
  flex-grow: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--surface);
}
.chat-msg {
  border: none;
  color: var(--ink-900);
  border-radius: 18px; /* More rounded bubbles */
  padding: 10px 14px;
  background: var(--ink-200);
  max-width: 80%;
}
.chat-row.mine .chat-msg { background: var(--brand); color: #fff; }
.chat-row .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--ink-300);
  color: var(--ink-800);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}
.chat-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-top: 1px solid var(--panel-border);
  background: var(--surface);
  flex-shrink: 0;
}
.chat-input {
  flex-grow: 1;
  background: var(--ink-200);
  border: 1px solid var(--ink-200);
  border-radius: 18px;
  color: var(--ink-900);
  padding: 10px 14px;
  font-size: 12px;
  resize: none;
  line-height: 1.4;
}
.chat-input:focus {
  border-color: var(--brand);
  box-shadow: var(--focus-ring);
  background: #fff;
  outline: none;
}
.send-btn {
  background: var(--brand);
  color: #fff;
  box-shadow: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  flex-shrink: 0;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.send-btn:hover { filter: brightness(1.1); }
.send-btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }

/* FIXED: Original Map Style */
#map { background: var(--ink-100); } /* Light background for before tiles load */
.leaflet-tile-pane { filter: hue-rotate(260deg) saturate(790%) brightness(90%); } /* Removed all filters */
.leaflet-control-zoom a { background: var(--surface) !important; color: var(--ink-900) !important; border: 1px solid var(--ink-400); }

/* Themed Leaflet Pop-up */
.leaflet-popup-content-wrapper { background: var(--surface); color: var(--ink-900); border: none; border-radius: var(--radius-md); box-shadow: var(--shadow-md); }
.leaflet-popup-tip { background: var(--surface); box-shadow: none; border: none; }
.leaflet-popup-close-button { color: var(--ink-600) !important; }
.leaflet-popup-close-button:hover { color: var(--ink-900) !important; background: var(--ink-200) !important; border-radius: 50%; }

/* FIXED: Zone Labels Text Color */
.zone-label {
  background: var(--surface);
  border: 1px solid var(--ink-400);
  color: var(--ink-800);

  border-radius: 30px; /* Pill shape */
  font-weight: 900; /* Extra bold */
  font-size: 12px; /* Font size */
  padding: 2px 8px;

  display: flex;             /* make it flexbox */
  align-items: center;       /* vertical center */
  justify-content: center;   /* horizontal center */
  text-align: center;        /* center-align text */
}

.zone-label.tiny {
  background: var(--brand);
  color: #fff; /* White text on brand color for contrast */
  border-color: transparent;
  padding: 2px 6px;
  font-size: 9px;
  font-weight: 600;
}
.zone-label.status-booked {
  background: var(--warning);
  color: var(--ink-900); /* Black text */
  border-color: transparent;
}
.zone-label.status-completed {
  background: var(--success);
  color: #fff !important; /* White text for green labels */
  border-color: transparent;
}


/* REFINED: Footer & Proof Strip */
.footer {
  background: var(--surface);
  border-top: 1px solid var(--ink-400);
  color: var(--ink-800);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--footer-h);
  z-index: 550;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  font-size: 11px;
}
.footer-info {
  font-weight: 600;
  color: var(--ink-700);
}
.proof-strip {
  border: 1px solid var(--ink-400);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-md);
  position: fixed;
  left: 10px;
  right: 10px;
  bottom: calc(var(--footer-h) + 8px);
  height: 50px; /* Adjusted height for smaller images */
  
  align-items: center;
  gap: 6px;
  z-index: 570;
}
.proof-item {
  position: relative;
  flex: 0 0 auto;
  width: 40px; /* Made images smaller */
  height: 40px; /* Made images smaller */
  border-radius: var(--radius-sm);
  overflow: hidden;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  border: 1px solid var(--ink-300);
}
.ps-btn { background: var(--ink-200); border: 1px solid var(--ink-300); color: var(--ink-800); }

/* REFINED: Modal & Image Popup */
.modal { background: rgba(240, 242, 245, 0.85); backdrop-filter: blur(3px); }
.modal-content { background: var(--surface); border-radius: var(--radius-md); box-shadow: var(--shadow-md); border: 1px solid var(--ink-400); }
.modal-close { background: var(--ink-300); color: var(--ink-800); border-radius: 50%; }
.modal-close:hover { background: var(--ink-400); }
/* Sleek image-only popup */
.modal-content.img-modal {
  padding: 0;
  background: transparent;
  border: none;
  box-shadow: none;
}
.modal-content.img-modal img {
  max-width: 85vw;
  max-height: 75vh;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
}


/* Buttons */
.zp-btn { background: var(--ink-300); color: var(--ink-900); border: none; }
.zp-btn:hover { background: var(--ink-400); }
.zp-btn.verify-btn { background: var(--success); color: #fff; }
.zp-btn.warn { background: var(--warning); color: #fff; }
.zp-btn.danger { background: var(--danger); color: #fff; }

/* Scrollbars */
::-webkit-scrollbar { width: 14px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--ink-400); border-radius: 8px; border: 4px solid transparent; background-clip: padding-box; }
::-webkit-scrollbar-thumb:hover { background: var(--ink-500); }

/* Loading Overlay */
#loadingOverlay { background: var(--surface); color: var(--ink-900); }
.loader { border: 4px solid var(--ink-300); border-top-color: var(--brand); }

/* --- Full structural CSS (unchanged, with chat refinements) --- */
.topbar-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;width:100%;}
.brand-block{display:flex;align-items:center;gap:8px;min-width:0;flex:1;}
.brand-icon{font-size:18px;flex-shrink:0;}
.metrics-scroll{display:flex;align-items:center;gap:6px;overflow-x:auto;padding:2px 0 2px 2px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.metrics-scroll::-webkit-scrollbar{display:none;}
.metric-chip{flex:0 0 auto;display:inline-flex;align-items:center;gap:4px;height:var(--chip-h);padding:4px 10px 4px 8px;font-size:11px;font-weight:500;line-height:1;position:relative;border-radius:var(--radius-sm); border: 2px solid #ccc;   /* light grey */; background: var(--surface);}
.metric-chip .material-icons-outlined{font-size:15px;opacity:.9; color: var(--brand);}
.metric-chip .value{font-weight:800;min-width:34px;text-align:right;}

/* FINAL FIX: Metric-specific styles with high specificity */
@keyframes soft-red-blink {
  50% { box-shadow: 0 0 0 2px rgba(228, 30, 63, 0.5); }
}

/* Use highly specific selectors to guarantee override */
.metrics-scroll .metric-chip.metric-chip-total-impressions {
  animation: soft-red-blink 2s infinite;
  background-color: var(--danger-soft) !important;
  border-color: var(--danger) !important;
}
.metrics-scroll .metric-chip.metric-chip-completed {
  background-color: var(--success-soft) !important;
  border-color: var(--success) !important;
}
.metrics-scroll .metric-chip.metric-chip-required {
  background-color: var(--warning-soft) !important;
  border-color: var(--warning) !important;
}


@media (max-width:420px){
  .metric-chip{padding:4px 6px;flex-direction:column;gap:2px;min-width:54px;height:48px;font-size:9px;}
  .metric-chip .material-icons-outlined{font-size:16px;}
  .metric-chip .value{font-size:11px;}
}
.right-controls{display:flex;align-items:center;gap:6px;flex:0 0 auto;}
button.icon-btn .material-icons-outlined{font-size:18px;}
button.icon-btn:focus-visible{outline:none;box-shadow:var(--focus-ring);}
.notifications.scroll-after-4 .notif-list{max-height:240px;overflow-y:auto;}
.notif-list{overflow-y:hidden;flex:1;}
.notif-item{display:flex;gap:10px;font-size:11px;border-top:1px solid var(--panel-border);cursor:pointer;align-items:center;transition:var(--transition);background:transparent;}
.notif-item:first-child{border-top:none;}
.notif-item:active{background:var(--accent-soft);}
.notif-msg{flex:1;line-height:1.3;}
.notif-item[data-zone]::after{content:"View";font-size:9px;font-weight:600;color:var(--brand);align-self:center;margin-left:6px;opacity:.55;}
.notif-item[data-zone]:hover::after{opacity:1;}
.notif-empty{padding:18px 14px;font-size:11px;}
.notif-footer{padding:6px 12px 8px;font-size:10px;text-align:right;border-top:1px solid var(--panel-border);}
.chat-actions{display:flex;gap:6px;align-items:center;}
.chat-mark-btn{appearance:none;border:1px solid var(--panel-border);background:var(--surface);color:var(--ink-700);font-size:10px;font-weight:700;padding:4px 8px;border-radius:var(--radius-md);cursor:pointer;transition:var(--transition);}
.chat-mark-btn:hover{background:var(--ink-200);}
.chat-msg .chat-text{font-size:12px;white-space:pre-wrap;word-break:break-word;line-height:1.5;}
.chat-msg .chat-meta{margin-top:4px;font-size:9px;color:var(--ink-500);display:flex;gap:6px;align-items:center;}
.chat-row{display:flex;gap:8px;align-items:flex-end;}
.chat-row + .chat-row { margin-top: 12px; }
.chat-row.mine{justify-content:flex-end;}
.send-btn .material-icons-outlined{font-size:18px;}
#map{position:absolute;top:var(--topbar-total-height);left:0;right:0;bottom:var(--footer-h);transition:top .25s ease;}
.leaflet-div-icon.zone-label-wrapper{background:transparent !important;border:none !important;}
@keyframes zoneFlash{ 0%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(24,119,242,0));} 40%{stroke-width:4;filter:drop-shadow(0 0 6px rgba(24,119,242,.85));} 100%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(24,119,242,0));} }
.leaflet-interactive.flash-highlight{animation:zoneFlash 1.3s ease-in-out 1;}
.proof-strip.visible{display:flex;}
.proof-strip-inner{display:flex;align-items:center;gap:8px;overflow-x:auto;flex:1;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.proof-strip-inner::-webkit-scrollbar{display:none;}
.proof-item:hover{transform:translateY(-2px);box-shadow:0 6px 14px -6px rgba(0,0,0,.15);border-color:var(--ink-400);}
.proof-item.selected{outline:2px solid var(--brand);outline-offset:2px;}
.proof-thumb{width:100%;height:100%;object-fit:cover;display:block;}
.proof-badge{display: none !important;} /* Hide the time/date badge on images in all views */
.ps-btn .material-icons-outlined{font-size:18px;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.zp-btn{appearance:none;border-radius:18px;padding:6px 12px;font-size:11px;font-weight:700;letter-spacing:.3px;cursor:pointer;transition:all .12s ease;display:inline-flex;align-items:center;gap:6px;}
.zp-btn:disabled{background:var(--ink-300);color:var(--ink-500);cursor:not-allowed;transform:none;filter:none;}
@media(max-width:420px){.brand-title{font-size:12px;}.campaign-badge{display:none;}.metric-chip{min-width:50px;}}
#loadingOverlay.fade-out{opacity:0;pointer-events:none;}
@keyframes spin{to{transform:rotate(360deg);}}
.mini-hint{margin-top:12px;font-size:11px;opacity:.85;line-height:1.4;}
  </style>
</head>
<body>
  <div id="loadingOverlay" aria-live="polite">
    <div class="loader" aria-hidden="true"></div>
    <div><strong>Please wait</strong>, full data & map are loading...</div>
    <div class="mini-hint">
      Once loaded we will automatically zoom into the most recently <strong>completed zone</strong>.<br/>
      You can still pan / pinch after that.
    </div>
  </div>

  <header class="topbar" id="topbar">
    <div class="topbar-row primary-row">
      <div class="brand-block">
        <span class="material-icons-outlined brand-icon">map</span>
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
          <span class="brand-title">LEUVENFLYERS</span>
          <span class="campaign-badge">Campaign XX981</span>
        </div>
      </div>
      <div class="right-controls">
        <button id="recentBtn" class="icon-btn" title="Zoom to most recent completed zone" aria-label="Zoom to most recent completed zone">
          <span class="material-icons-outlined">my_location</span>
        </button>
        <button id="chatBtn" class="icon-btn" aria-label="Chat" title="Chat">
          <span class="material-icons-outlined">chat</span>
          <span id="chatBadge" class="notif-badge chat-badge"></span>
        </button>
        <button id="notifBtn" class="icon-btn" aria-label="Notifications">
          <span class="material-icons-outlined">notifications</span>
          <span id="notifBadge" class="notif-badge"></span>
        </button>
      </div>
    </div>
  <div class="metrics-scroll" id="metricsScroll" aria-label="Campaign metrics">
  <div class="metric-chip" title="Total Flyers">
    <span class="material-icons-outlined">inventory_2</span>
    <span class="value" id="flyersTotal">0</span>
  </div>

  <div class="metric-chip metric-chip-completed" title="Completed / Verified Flyers">
    <span class="material-icons-outlined">task_alt</span>
    <span class="value" id="flyersDistributed">0</span>
  </div>

  <div id="impressionsCounter" class="metric-chip metric-chip-total-impressions" title="Total Impressions">
    <span class="material-icons-outlined">visibility</span>
    <span class="value" id="impressionsTotal">0 / 0</span>
  </div>

  <div class="metric-chip" title="Booked / Completed Zones">
      <span class="material-icons-outlined">checklist</span>
      <span class="value" id="zoneProgress">0 / 0</span>
  </div>

  <div class="metric-chip metric-chip-required" title="Flyers Required (Booked)">
    <span class="material-icons-outlined">group</span>
    <span class="value" id="flyersRequired">0</span>
  </div>

  <div id="qrCounter" class="metric-chip" style="cursor:pointer;" title="QR Scan Count">
    <span class="material-icons-outlined">qr_code_scanner</span>
    <span class="value" id="qrScanCount">0</span>
  </div>
</div>
  </header>

  <div id="notificationsPanel" class="notifications" role="dialog" aria-label="Notifications">
    <div class="notif-header">Notifications</div>
    <div id="notifList" class="notif-list"></div>
    <div id="notifFooter" class="notif-footer"></div>
  </div>

  <div id="chatPanel" class="chat-panel" role="dialog" aria-label="Chat">
    <div class="chat-header">
      <div class="chat-title" style="display:flex;align-items:center;gap:6px;">
        <span class="material-icons-outlined" style="font-size:14px;">chat</span>Chat
      </div>
      <div class="chat-actions">
        <button id="chatMarkReadBtn" class="chat-mark-btn" title="Mark all as read">Mark all read</button>
      </div>
    </div>
    <div id="chatList" class="chat-list" aria-live="polite"></div>
    <div class="chat-input-row">
      <input id="chatInput" class="chat-input" type="text" placeholder="Type a message..." aria-label="Type a message">
      <button id="chatSendBtn" class="send-btn" title="Send" aria-label="Send">
        <span class="material-icons-outlined">send</span>
      </button>
    </div>
  </div>

  <div id="map" class="map-visual-dimmer" aria-label="Distribution Map"></div>

  <div id="proofStrip" class="proof-strip" aria-label="Proofs slider">
    <button id="psLeft" class="ps-btn" title="Scroll left" aria-label="Scroll left">
      <span class="material-icons-outlined">chevron_left</span>
    </button>
    <div id="proofStripInner" class="proof-strip-inner"></div>
    <button id="psRight" class="ps-btn" title="Scroll right" aria-label="Scroll right">
      <span class="material-icons-outlined">chevron_right</span>
    </button>
  </div>

  <footer class="footer" id="footer">
    <div>click on any zone to view details</div>
  </footer>

  <div id="imgModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content img-modal">
      <button id="modalCloseBtn" class="modal-close" aria-label="Close preview">&times;</button>
      <img id="modalImg" alt="Proof preview">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* Firebase Configs */
    const campaignFirebaseConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const polygonsFirebaseConfig = {
      apiKey: "AIzaSyBHRyOy3hNcWarK8Zk34MWrv_tIYKM7mXM",
      authDomain: "leuvenflyers-23584.firebaseapp.com",
      databaseURL: "https://leuvenflyers-23584-default-rtdb.firebaseio.com",
      projectId: "leuvenflyers-23584",
      storageBucket: "leuvenflyers-23584.firebasestorage.app",
      messagingSenderId: "1077790950414",
      appId: "1:1077790950414:web:036fafe06df86f41ed285f"
    };

    const campaignApp = initializeApp(campaignFirebaseConfig, 'campaignApp');
    const db = getDatabase(campaignApp);
    const polygonsApp = initializeApp(polygonsFirebaseConfig,'polygonsApp');
    const polygonsDb = getDatabase(polygonsApp);

    /* DOM Elements */
    const flyersTotalEl = document.getElementById('flyersTotal');
    const flyersDistributedEl = document.getElementById('flyersDistributed');
    const qrScanCountEl = document.getElementById('qrScanCount');
    const qrCounter = document.getElementById('qrCounter');
    const notifBtn = document.getElementById('notifBtn');
    const notifPanel = document.getElementById('notificationsPanel');
    const notifList = document.getElementById('notifList');
    const notifBadge = document.getElementById('notifBadge');
    const notifFooter = document.getElementById('notifFooter');
    const topbar = document.getElementById('topbar');
    const mapEl = document.getElementById('map');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const recentBtn = document.getElementById('recentBtn');
    const proofStrip = document.getElementById('proofStrip');
    const proofStripInner = document.getElementById('proofStripInner');
    const psLeft = document.getElementById('psLeft');
    const psRight = document.getElementById('psRight');
    const flyersRequiredEl = document.getElementById('flyersRequired');
    const zoneProgressEl = document.getElementById('zoneProgress');
    const impressionsTotalEl = document.getElementById('impressionsTotal');
    const footerEl = document.getElementById('footer');

    // Chat DOM
    const chatBtn = document.getElementById('chatBtn');
    const chatPanel = document.getElementById('chatPanel');
    const chatListEl = document.getElementById('chatList');
    const chatInputEl = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatBadge = document.getElementById('chatBadge');
    const chatMarkReadBtn = document.getElementById('chatMarkReadBtn');

    /* State */
    const TOTAL_FLYERS = 0;
    flyersTotalEl.textContent = TOTAL_FLYERS.toLocaleString();

    let map;
    let polygonLayers = [];
    let labelMarkers = [];
    let labelMarkersByZone = new Map();
    let polygonMeta = [];
    let polygonsByZone = new Map();

    let proofMarkers = [];
    let proofMarkersById = new Map();
    let proofsList = [];
    let notificationsArr = [];

    const ZONE_STATUS_PATH = 'campaigns/XX981/zone_statuses';
    const zoneStatusByZone = new Map();
    const zoneStatusKeyByZone = new Map();

    let firstFullLoad = true;
    let viewCalculationInterval = null;

    // Building data cache
    const buildingDataByZone = new Map();
    const buildingFetchPromises = new Map();
    let currentBuildingLayerGroup = null;

    // Chat state
    const CHAT_PATH = 'campaigns/XX981/chat/messages';
    let chatMessages = [];
    let chatInitialized = false;
    const deviceIdKey = 'XX981_chat_device_id';
    const myDeviceId = getOrCreateDeviceId();
    const myName = 'Viewer';
    const lastReadKey = 'XX981_chat_last_read_ts';

    function setHeaderHeightVar(){
      const h = topbar.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--topbar-total-height', h + 'px');
      mapEl.style.top = h + 'px';
      notifPanel.style.top = (h + 4) + 'px';
      chatPanel.style.top = (h + 4) + 'px';
    }
    new ResizeObserver(setHeaderHeightVar).observe(topbar);
    window.addEventListener('orientationchange',()=>setTimeout(setHeaderHeightVar,350));
    window.addEventListener('resize',setHeaderHeightVar);

    function addNotification(icon, message, key, timestamp = Date.now()){
      if(key && notificationsArr.some(n=>n.key===key)) return;
      const zMatch = /Zone\s+(\d+)/i.exec(message);
      const zone = zMatch? parseInt(zMatch[1],10) : null;
      notificationsArr.push({
        key: key || ('k_'+timestamp+'_'+Math.random().toString(36).slice(2)),
        icon, message, zone, ts: timestamp
      });
      notificationsArr.sort((a, b) => b.ts - a.ts);
      renderNotifications();
    }
    function renderNotifications(){
      notifList.innerHTML='';
      if(!notificationsArr.length){
        notifList.innerHTML='<div class="notif-empty">No notifications yet.</div>';
        notifFooter.textContent='';
        notifBadge.style.display='none';
        notifPanel.classList.remove('scroll-after-4');
        return;
      }
      notificationsArr.slice(0,60).forEach(n=>{
        const item=document.createElement('div');
        item.className='notif-item';
        if(n.zone) item.dataset.zone = n.zone;
        item.innerHTML=`
          <div class="notif-icon"><span class="material-icons-outlined">${n.icon}</span></div>
          <div class="notif-msg">${n.message}</div>`;
        item.addEventListener('click',()=>{
          if(n.zone) focusZone(n.zone);
          notifPanel.style.display='none';
        });
        notifList.appendChild(item);
      });
      notifBadge.textContent=notificationsArr.length;
      notifBadge.style.display='inline-block';
      notifFooter.textContent=`${notificationsArr.length} notifications`;
      if(notificationsArr.length > 4){
        notifPanel.classList.add('scroll-after-4');
      } else {
        notifPanel.classList.remove('scroll-after-4');
      }
    }
    notifBtn.addEventListener('click',e=>{
      e.stopPropagation();
      notifPanel.style.display = notifPanel.style.display === 'flex' ? 'none' : 'flex';
      if (notifPanel.style.display === 'flex') {
        setHeaderHeightVar();
        renderNotifications();
      }
    });
    document.addEventListener('click',e=>{
      if(!notifPanel.contains(e.target) && !notifBtn.contains(e.target)){
        notifPanel.style.display='none';
      }
      if(!chatPanel.contains(e.target) && !chatBtn.contains(e.target)){
        chatPanel.style.display='none';
      }
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      setHeaderHeightVar();
      map = L.map('map',{zoomControl:true, attributionControl:false})
        .setView([50.85,4.35],13);
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        {maxZoom:20, attribution:'&copy; OpenStreetMap & CARTO'}
      ).addTo(map);
      map.on('zoomend',()=>{
        const z=map.getZoom();
        if(z>=15) mapEl.classList.add('zoomed-in');
        else mapEl.classList.remove('zoomed-in');
      });
      
      try {
        await loadPolygons();
        listenZoneStatuses();
        listenProofs();
        listenQrScans();
        listenChat();
        
        if (viewCalculationInterval) clearInterval(viewCalculationInterval);
        viewCalculationInterval = setInterval(updateViewingZones, 2000);
      } catch (error) {
        console.error("Failed to initialize application:", error);
        footerEl.innerHTML = `<div style="color: var(--danger);">Could not load map data. Please refresh.</div>`;
      } finally {
        hideLoader();
      }
    });

    async function loadPolygons(){
      const snap = await get(ref(polygonsDb,'polygons'));
      if(!snap.exists()) { 
        throw new Error("No polygons found in the database.");
      }
      
      polygonLayers.forEach(p=>map.removeLayer(p));
      labelMarkers.forEach(m=>map.removeLayer(m));
      polygonLayers=[];labelMarkers=[];labelMarkersByZone.clear();polygonMeta=[];polygonsByZone.clear();
      let allCoords=[];
      
      snap.forEach(child=>{
        const raw = child.val();
        if(!raw || typeof raw!=='object') return;
        const coordsArr = Object.keys(raw)
          .filter(k => !isNaN(Number(k)))
          .sort((a,b)=>Number(a)-Number(b))
          .map(k => {
            const pt=raw[k];
            return Array.isArray(pt) && pt.length===2
              ? [pt[0], pt[1]]
              : [pt.lat, pt.lng];
          })
          .filter(pt => Array.isArray(pt) && typeof pt[0]==='number' && typeof pt[1]==='number');
        if(!coordsArr.length) return;

        let zoneNum = raw.zoneNumber;
        if(zoneNum===undefined || zoneNum===null || zoneNum===''){
          zoneNum = polygonLayers.length + 1;
        } else {
          zoneNum = parseInt(zoneNum,10);
          if(isNaN(zoneNum)) zoneNum = polygonLayers.length + 1;
        }

        const poly=L.polygon(coordsArr,{
          color:'#1976d2',
          weight:1,
          fillColor:'#2196f3',
          fillOpacity:.26
        }).addTo(map);

        poly.bindPopup(`<div style="font-size:11px;">Zone ${zoneNum}<br/>Loading...</div>`);

        const index = polygonLayers.length;
        polygonLayers.push(poly);
        polygonsByZone.set(zoneNum, index);

        const areaSqM = computeAreaSqM(coordsArr);
        const isTiny = areaSqM < 250;

        polygonMeta.push({layer:poly, zoneNumber:zoneNum, isTiny});

        allCoords = allCoords.concat(coordsArr);

        const center=poly.getBounds().getCenter();
        const label=L.marker(center,{
          icon:L.divIcon({
            className:'zone-label-wrapper',
            html:zoneNumberLabelHtml(zoneNum, isTiny, '', false),
            iconSize:[34,24],
            iconAnchor:[17,12]
          }),
          interactive:true
        }).addTo(map);

        label.on('click', () => { try { poly.openPopup(); } catch(e){} });

        labelMarkers.push(label);
        labelMarkersByZone.set(zoneNum, label);
      });
      if(allCoords.length){
        map.fitBounds(L.latLngBounds(allCoords).pad(0.12));
      }
    }

    function computeAreaSqM(latlngPairs){
      try{
        if(!Array.isArray(latlngPairs) || latlngPairs.length < 3) return 0;
        const ring = latlngPairs.map(([lat, lng]) => [lng, lat]);
        const first = ring[0], last = ring[ring.length-1];
        if(first[0] !== last[0] || first[1] !== last[1]){
          ring.push([first[0], first[1]]);
        }
        const poly = turf.polygon([ring]);
        const area = turf.area(poly);
        return Number.isFinite(area) ? area : 0;
      }catch(err){
        console.error('Area compute failed', err);
        return 0;
      }
    }

    function getStatusClass(status, fullyViewed){
      if(fullyViewed) return 'status-fully-viewed';
      if(status==='booked') return 'status-booked';
      if(status==='completed') return 'status-completed';
      return '';
    }

    function zoneNumberLabelHtml(z, tiny=false, status='', fullyViewed = false){
      const statusClass = getStatusClass(status, fullyViewed);
      const classes = ['zone-label'];
      if(tiny) classes.push('tiny');
      if(statusClass) classes.push(statusClass);
      return `<div class="${classes.join(' ')}">${z}</div>`;
    }

    function safeInt(v){const n=parseInt(v);return isNaN(n)?0:n;}
    function statusMeta(status, fullyViewed){
      if(fullyViewed) return {text:'Fully Viewed', color: 'var(--fully-viewed-color)', icon:'visibility'};
      switch(status){
        case 'completed': return {text:'Done',color:'#2e7d32',icon:'task_alt'};
        case 'inprogress': return {text:'Active',color:'var(--warning)',icon:'play_arrow'};
        case 'booked': return {text:'Booked',color:'var(--booked)',icon:'bookmark_added'};
        default: return {text:'Pending',color:'#d32f2f',icon:'hourglass_empty'};
      }
    }

    // Resolve verifiedAt to ms
    function getVerifiedAtMs(z) {
      const v = z?.verifiedAt;
      if (typeof v === 'number' && Number.isFinite(v)) return v;
      if (typeof v === 'string') {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }
      if (v && typeof v === 'object' && v['.sv'] === 'timestamp') {
        return Date.now();
      }
      return 0;
    }

    function listenZoneStatuses(){
      onValue(ref(db, ZONE_STATUS_PATH), snap=>{
        let newlyCompletedZones = [];
        
        if(!snap.exists()) {
            zoneStatusByZone.clear();
            zoneStatusKeyByZone.clear();
            updateZonesVisual();
            return;
        }

        const nextZoneStatusByZone = new Map();

        snap.forEach(child => {
            const key = child.key;
            const data = child.val() || {};
            
            const fieldZone = safeInt(data.zoneNumber);
            const keyNum = safeInt(key);
            let zNum = null;
            if(fieldZone && polygonsByZone.has(fieldZone)) zNum = fieldZone;
            else if(keyNum && polygonsByZone.has(keyNum)) zNum = keyNum;
            else if((keyNum || key==='0') && polygonsByZone.has(keyNum+1)) zNum = keyNum+1;
            else if(safeInt(data.zone) && polygonsByZone.has(safeInt(data.zone))) zNum = safeInt(data.zone);

            if(zNum != null){
              const existingStatus = zoneStatusByZone.get(zNum) || {};

              // Merge to preserve previously known fields if they're missing in the snapshot.
              const merged = { ...existingStatus, ...data };

              // Preserve status if snapshot doesn't include it (prevents "booked" -> "pending" regress)
              if (existingStatus.status && !merged.status) {
                merged.status = existingStatus.status;
              }
              // Preserve flyersRequired if missing
              if (typeof existingStatus.flyersRequired === 'number' && typeof merged.flyersRequired !== 'number') {
                merged.flyersRequired = existingStatus.flyersRequired;
              }
              // Preserve flyers if missing
              if (typeof existingStatus.flyers === 'number' && typeof merged.flyers !== 'number') {
                merged.flyers = existingStatus.flyers;
              }
              // Preserve verifiedAt if missing or invalid
              if (typeof existingStatus.verifiedAt === 'number' && typeof merged.verifiedAt !== 'number') {
                merged.verifiedAt = existingStatus.verifiedAt;
              }
              // Preserve completedAt if previously set and now missing
              if (typeof existingStatus.completedAt === 'number' && typeof merged.completedAt !== 'number') {
                merged.completedAt = existingStatus.completedAt;
              }

              // Detect newly completed
              if (merged.status === 'completed' && existingStatus.status !== 'completed' && typeof merged.completedAt === 'number') {
                  newlyCompletedZones.push({zoneNum: zNum, timestamp: merged.completedAt});
              }
              
              nextZoneStatusByZone.set(zNum, merged);
              zoneStatusKeyByZone.set(zNum, key);
            }
        });

        zoneStatusByZone.clear();
        nextZoneStatusByZone.forEach((v, k) => zoneStatusByZone.set(k, v));
        
        newlyCompletedZones.forEach(({zoneNum, timestamp}) => {
            addNotification('task_alt', `Zone ${zoneNum} completed!`, `zone-${zoneNum}-done`, timestamp);
        });

        updateZonesVisual();
        
        if (newlyCompletedZones.length > 0) {
            const lastCompleted = newlyCompletedZones.sort((a,b) => b.timestamp - a.timestamp)[0];
            if (firstFullLoad) {
                setTimeout(() => focusZone(lastCompleted.zoneNum), 500);
            } else {
                focusZone(lastCompleted.zoneNum);
            }
        }
        firstFullLoad = false;
      });
    }

    function updateZonesVisual(){
      let distributed=0;
      let bookedCount = 0;
      let completedCount = 0;
      let totalCurrentImpressions = 0;
      let totalPossibleImpressions = 0;

      polygonMeta.forEach(({layer:poly, zoneNumber:zoneNum, isTiny})=>{
        const z = zoneStatusByZone.get(zoneNum) || {};
        const flyers = safeInt(z.flyers);
        const impressionInfo = calculateImpressionProgress(z);
        totalCurrentImpressions += impressionInfo.current;
        totalPossibleImpressions += impressionInfo.total;

        if(z.status === 'booked') bookedCount++;
        if(z.status === 'completed') completedCount++;
        
        if(z.status==='completed') distributed+=flyers;

        const meta=statusMeta(z.status, impressionInfo.fullyViewed);
        poly.setStyle({
          fillColor: meta.color, fillOpacity: impressionInfo.isViewing ? poly.options.fillOpacity : .38, color:'#1976d2', weight:1, dashArray:null
        });
        
        const path = poly._path;
        if (path) {
            path.classList.toggle('viewing-animation', impressionInfo.isViewing);
        }
        
        const canBook = z.status !=='booked' && z.status !=='completed';
        const canUnbook = z.status === 'booked';
        let actionButtonsHtml = '';

        if(canBook) {
            actionButtonsHtml += `<button class="zp-btn warn" data-act="book" data-zone="${zoneNum}"><span class="material-icons-outlined" style="font-size:14px;">bookmark_add</span>Book</button>`;
        }
        if(canUnbook) {
            actionButtonsHtml += `<button class="zp-btn danger" data-act="unbook" data-zone="${zoneNum}"><span class="material-icons-outlined" style="font-size:14px;">bookmark_remove</span>Unbook</button>`;
        }
        if (z.status === 'completed') {
            if (getVerifiedAtMs(z)) {
                actionButtonsHtml += `<button class="zp-btn" disabled><span class="material-icons-outlined" style="font-size:14px;">verified</span>Verified</button>`;
            } else {
                actionButtonsHtml += `<button class="zp-btn verify-btn" data-act="verify" data-zone="${zoneNum}"><span class="material-icons-outlined" style="font-size:14px;">check_circle</span>Verify</button>`;
            }
        }
        
        let impressionHTML = '';
        if (getVerifiedAtMs(z)) {
            impressionHTML = `
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:var(--accent);">visibility</span>
                Impressions: <strong>${impressionInfo.current.toLocaleString()} / ${impressionInfo.total.toLocaleString()}</strong>
              </span>
            </div>
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:var(--ink-500);">today</span>
                Days Passed: <strong>${impressionInfo.daysPassed} / 7</strong>
              </span>
            </div>`;
        }
        
        let flyersRequiredHTML = '';
        if (typeof z.flyersRequired === 'number') {
            flyersRequiredHTML = `
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:var(--booked);">group</span>
                Flyers Required: <strong>${z.flyersRequired.toLocaleString()}</strong>
              </span>
            </div>`;
        }

        let popupHTML=`
          <div style="text-align:left;">
            <strong style="display:flex;justify-content:flex-start;align-items:center;gap:4px;color:#0e3450;font-size:12px;">
              <span class="material-icons-outlined" style="font-size:14px;color:#1976d2;">layers</span>
              Zone ${zoneNum}
            </strong>
            <div style="margin-top:6px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">mail</span>
                Flyers (reported): <strong>${flyers || '-'}</strong>
              </span>
            </div>
            ${flyersRequiredHTML}
            ${impressionHTML}
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:${meta.color};">info</span>
                Status: <strong>${meta.text}</strong>
              </span>
            </div>
        `;
        if(z.gpsProof || z.gpsUrl){
          popupHTML+=`<div style="margin-top:8px;"><a href="${z.gpsProof||z.gpsUrl}" target="_blank" rel="noopener"
                 style="background:#1976d2;color:#fff;font-size:10px;padding:5px 12px;border-radius:18px;
                 display:inline-flex;align-items:center;gap:6px;text-decoration:none;
                 box-shadow:0 2px 6px -2px rgba(0,0,0,.25);">
                <span class="material-icons-outlined" style="font-size:14px;">assistant_navigation</span>GPS Route
              </a></div>`;
        }
        if(z.proofImage){
          popupHTML+=`<div style="margin-top:10px;"><img src="${z.proofImage}" alt="Proof" class="popup-img-thumb" data-proof="${z.proofImage}"
                style="max-width:90px;border-radius:8px;cursor:pointer;border:1px solid #d9e2e8;"></div>`;
        }
        popupHTML += `<div style="margin-top: 8px; display: flex; gap: 6px;">${actionButtonsHtml}</div></div>`;
        poly.bindPopup(popupHTML);

        const label = labelMarkersByZone.get(zoneNum);
        if(label){
          label.setIcon(L.divIcon({
            className:'zone-label-wrapper',
            html: zoneNumberLabelHtml(zoneNum, isTiny, z.status || '', impressionInfo.fullyViewed),
            iconSize:[34,24],
            iconAnchor:[17,12]
          }));
        }

        poly.off('popupopen');
        poly.on('popupopen', evt=>{
            const popupEl = evt.popup?.getElement?.();
            if(!popupEl) return;
            
            const img = popupEl.querySelector('.popup-img-thumb[data-proof]');
            if(img) img.addEventListener('click',()=>showModal('imgModal', img.getAttribute('data-proof')));
            
            popupEl.querySelectorAll('.zp-btn[data-act]').forEach(btn => {
                btn.addEventListener('click', async e => {
                    e.preventDefault(); e.stopPropagation();
                    const act = btn.dataset.act;
                    const znum = parseInt(btn.dataset.zone, 10);
                    btn.disabled = true;
                    btn.innerHTML = `<span class="material-icons-outlined" style="font-size:14px;">hourglass_top</span>Working...`;
                    
                    if (act === 'verify') {
                        await verifyZone(znum);
                    } else if (act === 'book' || act === 'unbook') {
                        await applyStatusToZones([znum], act === 'book' ? 'booked' : 'pending');
                    }
                    poly.closePopup();
                });
            });
          
            showBuildingDots(zoneNum, poly);
        });
      });
      flyersDistributedEl.textContent = distributed.toLocaleString();
      zoneProgressEl.textContent = `${bookedCount}B / ${completedCount}C`;
      impressionsTotalEl.textContent = `${totalCurrentImpressions.toLocaleString()} / ${totalPossibleImpressions.toLocaleString()}`;
      recalcFlyersRequiredTotal();
    }
    
    async function verifyZone(zoneNum) {
        const key = zoneStatusKeyByZone.get(zoneNum);
        if (!key) {
            console.error("Could not find key for zone", zoneNum);
            return;
        }
        const zoneRef = ref(db, `${ZONE_STATUS_PATH}/${key}`);
        try {
            await update(zoneRef, { verifiedAt: serverTimestamp() });
            addNotification('verified', `Zone ${zoneNum} has been verified for impressions.`, `zone-verified-${zoneNum}`);
        } catch (err) {
            console.error("Failed to verify zone:", err);
            alert("Could not verify zone. Please try again.");
        }
    }

    function focusRecentCompletedZones(onlyLast=true){
        const completed = [];
        zoneStatusByZone.forEach((z, zoneNum) => {
            if (z.status === 'completed' && z.completedAt) {
                completed.push({zoneNum, ts: z.completedAt});
            }
        });
        if (!completed.length) return;
        completed.sort((a,b) => b.ts - a.ts);
        if (onlyLast) {
          if (completed.length > 0) {
            focusZone(completed[0].zoneNum);
          }
        }
    }

    window.focusZone = function(zoneNum){
      const idx = polygonsByZone.get(zoneNum);
      if(idx===undefined) return;
      const poly = polygonLayers[idx];
      if(!poly) return;
      const bounds=poly.getBounds();
      map.fitBounds(bounds.pad(0.4));
      setTimeout(()=>{
        map.flyTo(bounds.getCenter(), Math.max(map.getZoom(),15), {duration:.55});
        poly.openPopup();
        const path=poly._path;
        if(path){
          path.classList.add('flash-highlight');
          setTimeout(()=>path.classList.remove('flash-highlight'),1300);
        }
      },350);
    };
    recentBtn.addEventListener('click',()=>focusRecentCompletedZones(true));

    async function applyStatusToZones(zones, newStatus){
      if(!zones.length) return;
      const updates = {};
      zones.forEach(zoneNum=>{
        let nodeKey = zoneStatusKeyByZone.get(zoneNum) || String(zoneNum);
        updates[`${nodeKey}/status`] = newStatus;
        updates[`${nodeKey}/zoneNumber`] = zoneNum;
        if (newStatus === 'completed') {
            updates[`${nodeKey}/completedAt`] = serverTimestamp();
        }
      });
      await update(ref(db, ZONE_STATUS_PATH), updates);

      if(newStatus==='booked'){
        for(const z of zones){
          const statusObj = zoneStatusByZone.get(z) || {};
          if(typeof statusObj.flyersRequired === 'number'){ continue; }
          const poly = polygonLayers[polygonsByZone.get(z)];
          if(poly){
            try{
              const count = await computeBuildingCount(z, poly);
              const required = count * 2;
              const nodeKey = zoneStatusKeyByZone.get(z) || String(z);
              await update(ref(db, `${ZONE_STATUS_PATH}/${nodeKey}`), { flyersRequired: required });
            }catch(err){
              console.error('Failed to compute flyersRequired for zone', z, err);
            }
          }
        }
      }
    }

    function recalcFlyersRequiredTotal(){
      let total=0;
      zoneStatusByZone.forEach(z=>{
        if(z.status==='booked' && typeof z.flyersRequired === 'number'){
          total += z.flyersRequired;
        }
      });
      flyersRequiredEl.textContent = total.toLocaleString();
    }

    function getPrimaryRingLatLngs(poly){
      let latlngs = poly.getLatLngs();
      if(Array.isArray(latlngs[0])) latlngs = latlngs[0];
      return latlngs;
    }

    /* ---------------- Impressions Calculation ---------------- */
    const IMPRESSION_MULTIPLIER = 1.5;
    const TOTAL_DAYS = 7;
    const TOTAL_MS = TOTAL_DAYS * 24 * 60 * 60 * 1000;

    function calculateImpressionProgress(zoneStatus) {
        const result = { total: 0, current: 0, daysPassed: 0, fullyViewed: false, isViewing: false };
        if (zoneStatus.status !== 'completed') return result;

        const verifiedAtMs = getVerifiedAtMs(zoneStatus);
        if (!verifiedAtMs) return result;
        
        const totalPossible = Math.floor((zoneStatus.flyers || 0) * IMPRESSION_MULTIPLIER);
        result.total = totalPossible;
        
        const now = Date.now();
        const timeSinceVerification = now - verifiedAtMs;
        
        if (timeSinceVerification < 0) {
            result.isViewing = true;
            return result;
        }

        let currentImpressions = 0;
        if (timeSinceVerification < TOTAL_MS) {
            const progress = timeSinceVerification / TOTAL_MS;
            currentImpressions = totalPossible * progress;
            result.isViewing = true;
        } else {
            currentImpressions = totalPossible;
            result.fullyViewed = true;
        }
        result.current = Math.floor(currentImpressions);
        result.daysPassed = Math.min(TOTAL_DAYS, Math.floor(timeSinceVerification / (1000 * 60 * 60 * 24)));

        return result;
    }

    function updateViewingZones() {
        let needsVisualUpdate = false;
        let totalCurrentImpressions = 0;
        let totalPossibleImpressions = 0;

        zoneStatusByZone.forEach((status) => {
            const impressionInfo = calculateImpressionProgress(status);
            totalCurrentImpressions += impressionInfo.current;
            totalPossibleImpressions += impressionInfo.total;

            if (status.status === 'completed' && getVerifiedAtMs(status)) {
                const oldFullyViewed = status.fullyViewed || false;
                status.fullyViewed = impressionInfo.fullyViewed;
                status.isViewing = impressionInfo.isViewing;
                if (oldFullyViewed !== impressionInfo.fullyViewed) {
                    needsVisualUpdate = true;
                }
            }
        });
        
        impressionsTotalEl.textContent = `${totalCurrentImpressions.toLocaleString()} / ${totalPossibleImpressions.toLocaleString()}`;

        if (needsVisualUpdate) {
            updateZonesVisual();
        }
    }
    
    function formatDateTime(ts){
      if (!ts) return '';
      const d=new Date(ts);
      const p=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.style.display = 'none';
        if (modalId === 'imgModal') {
            document.getElementById('modalImg').src = '';
        }
        const anyModalOpen = Array.from(document.querySelectorAll('.modal')).some(m => m.style.display === 'flex');
        if (!anyModalOpen) {
            document.body.style.overflow='';
        }
    }

    document.getElementById('modalCloseBtn').addEventListener('click', () => hideModal('imgModal'));
    document.getElementById('imgModal').addEventListener('click', e => { if(e.target.id === 'imgModal') hideModal('imgModal'); });
    document.addEventListener('keydown', e => { if(e.key==='Escape') { hideModal('imgModal'); }});

    function hideLoader(){
      if(!loadingOverlay) return;
      if (loadingOverlay.classList.contains('fade-out')) return;
      loadingOverlay.classList.add('fade-out');
    }

    function listenProofs(){
      onValue(ref(db,'campaigns/XX981/proofs'), snap=>{
        proofMarkers.forEach(m=>map.removeLayer(m));
        proofMarkers=[]; proofMarkersById.clear(); proofsList=[];
        const val=snap.val();
        if(val){
          for(const id in val){
            const p=val[id];
            if(typeof p.lat==='number' && typeof p.lng==='number' && p.url){
              proofsList.push({id,url:p.url,lat:p.lat,lng:p.lng,timestamp:p.timestamp||0});
            }
          }
        }
        proofsList.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
        proofsList.forEach(p=>{
          const icon=L.divIcon({
            html:`<span class="material-icons-outlined" style="display:block;font-size:26px;color:#1976d2;text-shadow:0 0 4px #fff;">photo_camera</span>`,
            className:'custom-camera-pin',
            iconSize:[28,28],
            iconAnchor:[14,28]
          });
          const marker=L.marker([p.lat,p.lng],{icon}).addTo(map);
          marker.bindPopup(`
            <div style="text-align:left;">
              <img src="${p.url}" class="popup-img-thumb" data-proof="${p.url}" style="max-width:100px;border-radius:10px;
                border:1px solid #d9e2e8;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.15);" alt="Proof">
              ${p.timestamp?`<div style="margin-top:6px;font-size:10px;color:#4a5d69;display:flex;gap:4px;align-items:center;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">schedule</span>${""}
              </div>`:''}
            </div>`);
          marker.on('popupopen',()=>{
            setTimeout(()=>{
              const img=document.querySelector('.leaflet-popup .popup-img-thumb[data-proof]');
              if(img) img.addEventListener('click',()=>showModal('imgModal', img.getAttribute('data-proof')));
            },60);
          });
          proofMarkers.push(marker);
          proofMarkersById.set(p.id,marker);
        });
        renderProofSlider();
      });
    }

    function renderProofSlider(){
      proofStripInner.innerHTML='';
      if(!proofsList.length){ proofStrip.classList.remove('visible'); return; }
      proofStrip.classList.add('visible');
      proofsList.forEach((p,idx)=>{
        const div=document.createElement('div');
        div.className='proof-item';
        div.dataset.id=p.id;
        div.title=p.timestamp?formatDateTime(p.timestamp):'Proof';
        div.innerHTML=`
          <img class="proof-thumb" src="${p.url}" alt="Proof ${idx+1}">
          ${p.timestamp?`<span class="proof-badge">${new Date(p.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`:''}`;
        div.addEventListener('click',()=>{
          focusProof(p.id);
          setSelectedProof(p.id);
        });
        proofStripInner.appendChild(div);
      });
      psLeft.onclick=()=>scrollProofs(-1);
      psRight.onclick=()=>scrollProofs(1);
    }

    function setSelectedProof(id){
      document.querySelectorAll('.proof-item').forEach(el=>{
        el.classList.toggle('selected', el.dataset.id===id);
      });
    }
    function scrollProofs(dir){
      const amt=Math.max(120, Math.floor(proofStripInner.clientWidth*0.8));
      proofStripInner.scrollBy({left:dir*amt,behavior:'smooth'});
    }
    function focusProof(id){
      const marker=proofMarkersById.get(id);
      if(!marker) return;
      const latlng = marker.getLatLng();
      map.flyTo(latlng, Math.max(map.getZoom(),16), {duration:.6});
      setTimeout(()=>{
        marker.openPopup();
        const pulse = L.circle(latlng,{radius:15,color:'#2563eb',weight:2,opacity:.9,fill:false}).addTo(map);
        setTimeout(()=>map.removeLayer(pulse),1000);
      },500);
    }

    function listenQrScans(){
      onValue(ref(db,'qr_scans'), snap=>{
        const scans=[];
        const val=snap.val();
        if(val){
          for(const k in val){
            const s=val[k];
            if(s.promoCode==='XX981') scans.push({...s,id:k});
          }
          scans.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
        }
        qrScanCountEl.textContent=scans.length.toString();
      });
      qrCounter.addEventListener('click',()=>{
        alert('QR Scans list is only available if active for this campaign.');
      });
    }

    async function computeBuildingCount(zoneNum, poly) {
      if (buildingDataByZone.has(zoneNum)) {
        return buildingDataByZone.get(zoneNum).count;
      }
      if (buildingFetchPromises.has(zoneNum)) {
        await buildingFetchPromises.get(zoneNum);
        return buildingDataByZone.get(zoneNum)?.count || 0;
      }
      
      const ring = getPrimaryRingLatLngs(poly);
      if (!ring || !ring.length) {
        buildingDataByZone.set(zoneNum, { centers: [], count: 0 });
        return 0;
      }
      
      const polyStr = ring.map(ll => `${ll.lat} ${ll.lng}`).join(' ');
      const query = `[out:json][timeout:25];(node["building"](poly:"${polyStr}");way["building"](poly:"${polyStr}");relation["building"](poly:"${polyStr}"););out center;`;
      
      const prom = fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(query)
      })
      .then(r => {
        if (!r.ok) throw new Error('Overpass API error');
        return r.json();
      })
      .then(data => {
        const elements = data?.elements || [];
        const centers = [];
        const seen = new Set();
        elements.forEach(el => {
          let lat, lon;
          if (el.type === 'node' && typeof el.lat === 'number') {
            lat = el.lat; lon = el.lon;
          } else if (el.center) {
            lat = el.center.lat; lon = el.center.lon;
          }
          if (typeof lat === 'number' && typeof lon === 'number') {
            const key = el.type + ':' + el.id;
            if (!seen.has(key)) {
              seen.add(key);
              centers.push([lat, lon]);
            }
          }
        });
        buildingDataByZone.set(zoneNum, { centers, count: centers.length });
        return centers.length;
      })
      .catch(err => {
        console.error('Building fetch failed for zone', zoneNum, err);
        buildingDataByZone.set(zoneNum, { centers: [], count: 0 }); // Cache failure
        return 0;
      })
      .finally(() => {
        buildingFetchPromises.delete(zoneNum);
      });

      buildingFetchPromises.set(zoneNum, prom);
      return prom;
    }

    function showBuildingDots(zoneNum, poly){
      computeBuildingCount(zoneNum, poly).then(() => {
        const data = buildingDataByZone.get(zoneNum);
        if(!data) return;
        if(currentBuildingLayerGroup){
          map.removeLayer(currentBuildingLayerGroup);
          currentBuildingLayerGroup = null;
        }
        currentBuildingLayerGroup = L.layerGroup();
        data.centers.forEach(c=>{
          L.circleMarker(c,{
            radius:2.5,
            color:'#000',
            fillColor:'#000',
            fillOpacity:0.85,
            stroke:false
          }).addTo(currentBuildingLayerGroup);
        });
        currentBuildingLayerGroup.addTo(map);
      }).catch(err=>console.error('Dots error',err));
    }

    function getOrCreateDeviceId(){
      let id = localStorage.getItem(deviceIdKey);
      if(!id){
        id = 'dev_'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);
        localStorage.setItem(deviceIdKey, id);
      }
      return id;
    }
    function getLastReadTs(){
      const v = parseInt(localStorage.getItem(lastReadKey)||'0',10);
      return isNaN(v)?0:v;
    }
    function setLastReadTs(ts){
      localStorage.setItem(lastReadKey, String(ts||0));
      updateChatBadge();
    }
    function listenChat(){
      onValue(ref(db, CHAT_PATH), snap=>{
        chatMessages = [];
        const val = snap.val();
        if(val){
          Object.keys(val).forEach(k=>{
            const m = val[k];
            if(m && m.text){
              chatMessages.push({
                id: k,
                text: String(m.text),
                ts: typeof m.timestamp === 'number' ? m.timestamp : (m._serverTs || 0),
                authorId: m.authorId || 'unknown',
                authorName: m.authorName || 'User'
              });
            }
          });
          chatMessages.sort((a,b)=>(a.ts||0)-(b.ts||0));
        }
        renderChat();
        updateChatBadge();

        if(chatInitialized){
          const unreadFromOthers = chatMessages.filter(m=>m.authorId!==myDeviceId && m.ts > getLastReadTs());
          if(unreadFromOthers.length){
            const last = unreadFromOthers[unreadFromOthers.length-1];
            addNotification('chat', `New chat message: "${truncate(last.text, 48)}"`, `chat-last-${last.id}`);
          }
        }
        chatInitialized = true;
      });

      chatBtn.addEventListener('click', e=>{
        e.stopPropagation();
        chatPanel.style.display = chatPanel.style.display === 'flex' ? 'none' : 'flex';
        if(chatPanel.style.display === 'flex'){
          setHeaderHeightVar();
          setTimeout(()=>{ scrollChatToBottom(); chatInputEl.focus(); }, 60);
        }
      });
      chatSendBtn.addEventListener('click', sendChatMessage);
      chatInputEl.addEventListener('keydown', e=>{
        if(e.key==='Enter' && !e.shiftKey){
          e.preventDefault();
          sendChatMessage();
        }
      });
      chatMarkReadBtn.addEventListener('click', ()=>{
        const lastTs = chatMessages.length ? chatMessages[chatMessages.length-1].ts||Date.now() : Date.now();
        setLastReadTs(lastTs);
      });
    }
    function truncate(s, n){
      return (s||'').length>n ? s.slice(0,n-1)+'â€¦' : s;
    }
    function avatarInitial(name){
      const s = (name||'U').trim();
      return (s[0]||'U').toUpperCase();
    }
    function renderChat(){
      chatListEl.innerHTML = '';
      if(!chatMessages.length){
        const empty = document.createElement('div');
        empty.style.cssText='padding:6px 8px;color:#667883;font-size:11px;text-align:center;';
        empty.textContent = 'No messages yet. Start the conversation!';
        chatListEl.appendChild(empty);
        return;
      }
      chatMessages.forEach(m=>{
        const isMine = m.authorId===myDeviceId;
        const row = document.createElement('div');
        row.className = 'chat-row'+(isMine?' mine':'');
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = avatarInitial(isMine?myName:m.authorName);
        const bubble = document.createElement('div');
        bubble.className = 'chat-msg';
        const text = document.createElement('div');
        text.className = 'chat-text';
        text.textContent = m.text;
        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        meta.innerHTML = `
          <span class="material-icons-outlined" style="font-size:12px;color:#94a3b8;">schedule</span>
          <span>${formatDateTime(m.ts||Date.now())}</span>
        `;
        bubble.appendChild(text);
        bubble.appendChild(meta);
        if(isMine){
          row.appendChild(bubble);
          row.appendChild(avatar);
        }else{
          row.appendChild(avatar);
          row.appendChild(bubble);
        }
        chatListEl.appendChild(row);
      });
      scrollChatToBottom();
    }
    function scrollChatToBottom(){
      chatListEl.scrollTop = chatListEl.scrollHeight + 1000;
    }
    async function sendChatMessage(){
      const text = (chatInputEl.value||'').trim();
      if(!text) return;
      chatSendBtn.disabled = true;
      try{
        const now = Date.now();
        const newRef = push(ref(db, CHAT_PATH));
        await set(newRef, {
          text,
          authorId: myDeviceId,
          authorName: myName,
          timestamp: now,
          _serverTs: serverTimestamp()
        });
        chatInputEl.value='';
        setLastReadTs(now);
        setTimeout(scrollChatToBottom, 60);
      }catch(err){
        console.error('Failed to send message', err);
        alert('Failed to send message. Please try again.');
      }finally{
        chatSendBtn.disabled = false;
      }
    }
    function updateChatBadge(){
      const lastRead = getLastReadTs();
      const unread = chatMessages.filter(m=>m.authorId!==myDeviceId && (m.ts||0)>lastRead).length;
      if(unread>0){
        chatBadge.textContent = String(unread);
        chatBadge.style.display = 'inline-block';
      }else{
        chatBadge.style.display = 'none';
      }
    }
  </script>

</body>
</html>
