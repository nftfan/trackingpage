
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dot Poster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f0f12" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Icons+Outlined&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/and.json">
  <link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
  <link rel="apple-touch-startup-image" href="https://www.iconpacks.net/icons/2/free-location-map-icon-2956-thumb.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg: #0b0b0e;
      --panel: #141419;
      --muted: #8b8b95;
      --text: #f2f2f7;
      --accent: #4f8cff;
      --accent-2: #7a5cff;
      --success: #00d37f;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background: radial-gradient(1200px 800px at 70% -10%, rgba(79,140,255,.12), transparent 60%),
                  radial-gradient(900px 600px at -10% -10%, rgba(122,92,255,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font: 15px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
    }
    .app{
      max-width: 620px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
      display: grid;
      grid-template-rows: auto auto auto auto auto 1fr_auto;
      gap: 14px;
      min-height: 100vh;
    }
    header{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.02) 100%);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      justify-content: space-between;
    }
    .logo{
      width:34px;height:34px; display:grid; place-items:center;
      background: radial-gradient(120% 120% at 20% 20%, #4f8cff, #7a5cff);
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(79,140,255,.35), inset 0 0 20px rgba(255,255,255,.15);
    }
    .title-wrap{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      margin:0; font-size:16px; letter-spacing:.2px;
      font-weight:700;
    }
    .subtitle{color:var(--muted); font-size:12px;}

    .user-pill{
      font-size:12px;
      color:#cbd5ff;
      background: rgba(122,92,255,.12);
      border:1px solid rgba(122,92,255,.3);
      padding:6px 10px;
      border-radius:999px;
      display:flex; align-items:center; gap:8px;
    }
    .user-pill button{
      appearance:none;border:0;background:transparent;color:#aab7ff;cursor:pointer;font-weight:600
    }

    /* Speed bar under title */
    .speed-wrap{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .speed-label-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:10px;
      color:var(--muted);
    }
    .speed-label-main{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .speed-label-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:conic-gradient(from 180deg, #f97316,#eab308,#22c55e,#22d3ee,#3b82f6,#a855f7,#ec4899,#f97316);
      box-shadow:0 0 10px rgba(236,72,153,.65);
    }
    .speed-current{
      font-weight:600;
      color:#e5e7ff;
    }
    .speed-unit{
      opacity:.75;
    }

    .speed-bar-container{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background: radial-gradient(circle at 0% 50%, rgba(239,68,68,.4), transparent 55%),
                  radial-gradient(circle at 50% 50%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(circle at 100% 50%, rgba(34,197,94,.3), transparent 55%),
                  rgba(15,15,18,0.95);
      overflow:hidden;
      box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 8px 15px rgba(0,0,0,.5);
    }
    .speed-bar-gradient{
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,
        #f97316 0%,
        #facc15 16%,
        #22c55e 32%,
        #2dd4bf 48%,
        #3b82f6 64%,
        #a855f7 80%,
        #ec4899 100%
      );
      opacity:0.95;
      filter:saturate(1.2);
    }
    .speed-bar-fill{
      position:absolute;
      inset:0;
      background:linear-gradient(90deg, rgba(15,15,18,0.02), rgba(15,15,18,0.18));
      transform-origin:left center;
      transform:scaleX(0);
      transition:transform .45s cubic-bezier(.16,.84,.44,1);
      mix-blend-mode:multiply;
    }
    .speed-bar-glow{
      position:absolute;
      inset:-20px 0 0 0;
      background:radial-gradient(circle at var(--glow-pos,0%) 40%,
        rgba(255,255,255,.35),
        transparent 55%
      );
      mix-blend-mode:screen;
      pointer-events:none;
      opacity:.4;
      transition:opacity .3s ease;
    }
    .speed-bar-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(255,255,255,.35), transparent 55%);
      mix-blend-mode:soft-light;
      pointer-events:none;
    }
    .speed-scale-row{
      margin-top:3px;
      display:flex;
      justify-content:space-between;
      font-size:9px;
      color:var(--muted);
      opacity:.9;
    }

    .map-card{
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: #0f0f12;
      box-shadow: var(--shadow);
    }
    #map{ height: 200px; width: 100%; }
    .leaflet-container{ background: #0f0f12; outline: none; }
    .leaflet-control-container .leaflet-top .leaflet-control,
    .leaflet-control-container .leaflet-bottom .leaflet-control{
      border-radius: 12px; overflow: hidden;
    }

    .controls{
      display: grid; grid-template-columns: 56px 1fr; gap: 12px; align-items: stretch;
    }
    .btn-icon{
      appearance:none; border:0; cursor:pointer;
      height:56px; width:56px; border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.02) 100%);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      transition: transform .12s ease, filter .12s ease, background .2s ease;
    }
    .btn-icon:active{ transform: scale(.98); filter: brightness(1.05); }
    .btn-primary{
      appearance:none; border:0; cursor:pointer;
      border-radius: 16px; height:56px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color:white; font-weight: 700; letter-spacing:.2px;
      box-shadow: 0 10px 24px rgba(79,140,255,.35);
      transition: transform .12s ease, box-shadow .2s ease, filter .12s ease;
    }
    .btn-primary:active{ transform: translateY(1px); filter: brightness(.98); }
    .btn-primary[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none; }

    .stats{ display:flex; gap:10px; align-items:stretch; flex-wrap: wrap; }
    .stat{
      flex:1;
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.02) 100%);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
      min-width: 48%;
    }
    .stat .label{ color: var(--muted); font-size:12px; }
    .stat .value{ font-size:18px; font-weight:800; letter-spacing:.3px; }
    .footnote{ color: var(--muted); font-size:12px; text-align:center; padding: 8px 6px 16px; }
    .toast{
      position: fixed; z-index: 9999; left: 50%; bottom: 20px; transform: translateX(-50%);
      background: #0f0f12; border: 1px solid rgba(255,255,255,.08);
      padding: 10px 14px; border-radius: 12px; color: var(--text); box-shadow: var(--shadow);
      font-weight:600; opacity: 0; pointer-events:none; transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); pointer-events:auto; }
    .hint{ font size:12px; color: var(--muted); padding: 0 4px; }
    a.inline{ color:#aab7ff; text-decoration: none; }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9998;
    }
    .modal{
      width: min(92vw, 420px); background: var(--panel);
      border:1px solid rgba(255,255,255,.1); border-radius: 16px; box-shadow: var(--shadow); padding: 18px;
    }
    .modal h2{ margin: 0 0 8px; font-size: 18px; }
    .modal p{ margin: 0 0 14px; color: var(--muted); font-size: 13px; }
    .input-row{ display:flex; gap:10px; align-items:stretch; margin-top: 8px; }
    .input{
      flex:1; height:48px; border-radius: 12px; padding: 0 12px;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04);
      color: var(--text); font-weight:700; letter-spacing:.4px;
    }
    .btn{ height:48px; border-radius:12px; border:0; cursor:pointer; padding: 0 16px;
      font-weight:700; color:#fff; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 18px rgba(79,140,255,.35);
    }
    .error{ color:#ff8a8a; font-size:12px; min-height: 16px; padding-top:6px;}
    .show{ display:flex !important; }

    /* Tabs for stats area */
    .stats-tabs{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:4px;
      margin-bottom:2px;
      padding:0 2px;
    }
    .stats-tab-btn{
      flex:0 0 auto;
      padding:4px 10px;
      font-size:10px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .stats-tab-btn.active{
      background:rgba(79,140,255,.18);
      color:#e5e7ff;
      border-color:rgba(79,140,255,.5);
    }

    /* Daily stats table */
    .daily-stats-card{
      background: linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.015) 100%);
      border-radius: var(--radius-md);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding: 10px 10px 8px;
    }
    .daily-stats-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .daily-stats-title{
      font-size:11px;
      font-weight:600;
      letter-spacing:.2px;
      color:#e5e7ff;
    }
    .daily-stats-subtitle{
      font-size:10px;
      color:var(--muted);
    }
    .daily-stats-table-wrap{
      max-height:160px;
      overflow:auto;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(10,10,14,.85);
    }
    .daily-stats-table{
      width:100%;
      border-collapse:collapse;
      font-size:10px;
      color:#d5d7ff;
    }
    .daily-stats-table thead{
      background:linear-gradient(90deg, rgba(79,140,255,.16), rgba(122,92,255,.18));
      position:sticky;
      top:0;
      z-index:1;
    }
    .daily-stats-table th,
    .daily-stats-table td{
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    .daily-stats-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.4px;
      font-size:9px;
      color:#f3f4ff;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .daily-stats-table tbody tr:nth-child(odd){
      background:rgba(255,255,255,.01);
    }
    .daily-stats-table tbody tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .daily-stats-table tbody tr:hover{
      background:rgba(79,140,255,.16);
    }
    .daily-stats-date{
      font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      color:#e5e7ff;
    }
    .daily-stats-dots{
      font-weight:600;
      color:#a5f3fc;
    }
    .daily-stats-earn{
      font-weight:600;
      color:#bbf7d0;
    }
    .daily-stats-worktime{
      font-weight:500;
      color:#fde68a;
    }
    .daily-stats-empty{
      padding:6px;
      font-size:10px;
      color:var(--muted);
      text-align:center;
    }

    /* Performance card */
    .performance-card{
      background: linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.015) 100%);
      border-radius: var(--radius-md);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding: 10px 10px 10px;
      display:none;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .performance-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .performance-title{
      font-size:11px;
      font-weight:600;
      letter-spacing:.2px;
      color:#e5e7ff;
    }
    .performance-subtitle{
      font-size:10px;
      color:var(--muted);
    }
    .performance-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:4px;
    }
    .perf-metric{
      flex:1;
    }
    .perf-label{
      font-size:10px;
      color:var(--muted);
      margin-bottom:3px;
    }
    .perf-value{
      font-size:20px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .perf-unit{
      font-size:11px;
      color:var(--muted);
      margin-left:4px;
    }
    .perf-badge{
      flex:0 0 auto;
      padding:6px 10px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(37, 99, 235, .18);
      border:1px solid rgba(37,99,235,.5);
      color:#bfdbfe;
    }
    .perf-badge-rank{
      font-size:11px;
    }
    .perf-badge-label{
      opacity:.85;
    }
    .perf-note{
      font-size:9px;
      color:var(--muted);
      margin-top:4px;
    }
    .perf-empty{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      padding:6px 4px 2px;
    }

    .perf-daily-wrap{
      margin-top:4px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(10,10,14,.9);
      max-height:150px;
      overflow:auto;
    }
    .perf-daily-table{
      width:100%;
      border-collapse:collapse;
      font-size:9px;
      color:#d5d7ff;
    }
    .perf-daily-table thead{
      position:sticky;
      top:0;
      background:linear-gradient(90deg, rgba(79,140,255,.18), rgba(122,92,255,.18));
      z-index:1;
    }
    .perf-daily-table th,
    .perf-daily-table td{
      padding:3px 5px;
      white-space:nowrap;
      text-align:left;
    }
    .perf-daily-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.35px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .perf-daily-table tbody tr:nth-child(odd){
      background:rgba(255,255,255,.01);
    }
    .perf-daily-table tbody tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .perf-daily-table tbody tr:hover{
      background:rgba(79,140,255,.18);
    }
    .perf-daily-date{
      font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      color:#e5e7ff;
    }
    .perf-daily-dots{
      color:#a5f3fc;
      font-weight:600;
    }
    .perf-daily-work{
      color:#fde68a;
    }
    .perf-daily-avg{
      color:#bbf7d0;
      font-weight:600;
    }
    .perf-daily-time{
      color:#cbd5ff;
      font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:9px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex; align-items:flex-start; gap:12px; flex:1">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="white" stroke-opacity=".9" stroke-width="1.4"/>
            <circle cx="12" cy="12" r="3.2" fill="white" />
          </svg>
        </div>
        <div class="title-wrap" style="flex:1">
          <h1>Dot Poster</h1>
          <div class="subtitle">Tap locate, then post tiny dots and earn</div>

          <!-- Live speed bar (today only) -->
          <div class="speed-wrap" aria-label="Live posting speed for today">
            <div class="speed-label-row">
              <div class="speed-label-main">
                <span class="speed-label-dot"></span>
                <span>Today's speed</span>
              </div>
              <div>
                <span id="speedCurrent" class="speed-current">0.0</span>
                <span class="speed-unit">flyers/hr</span>
              </div>
            </div>
            <div class="speed-bar-container">
              <div class="speed-bar-gradient"></div>
              <div class="speed-bar-fill" id="speedBarFill"></div>
              <div class="speed-bar-glow" id="speedBarGlow"></div>
              <div class="speed-bar-overlay"></div>
            </div>
            <div class="speed-scale-row" aria-hidden="true">
              <span>0</span>
              <span>125</span>
              <span>250+</span>
            </div>
          </div>
        </div>
      </div>
      <div id="userPill" class="user-pill" style="display:none">
        <span id="userPillText"></span>
        <button id="changeUserBtn" title="Change user">Change</button>
      </div>
    </header>

    <div class="map-card">
      <div id="map" role="application" aria-label="Map showing your current location and posted dots"></div>
    </div>

    <div class="controls">
      <button id="btnLocate" class="btn-icon" title="Go to current location" aria-label="Go to current location">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="7.5" stroke="currentColor" stroke-width="1.6"></circle>
          <path d="M12 2v3M12 19v3M2 12h3M19 12h3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="2.2" fill="currentColor"/>
        </svg>
      </button>
      <button id="btnPost" class="btn-primary" disabled>
        Post dot at my location
      </button>
    </div>

    <div class="hint">Tip: Allow location permission for precise posting. Works best over HTTPS or localhost.</div>

    <!-- Per-user stats only -->
    <div class="stats">
      <div class="stat" aria-live="polite">
        <span class="label">My dots</span>
        <span id="myDots" class="value">0</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="label">My earnings (€0.10/dot)</span>
        <span id="myEarnings" class="value">€0.00</span>
      </div>
    </div>

    <!-- Tabs for Daily / Performance -->
    <div class="stats-tabs" aria-label="Stats view switches">
      <button id="tabDaily" class="stats-tab-btn active" type="button">Daily breakdown</button>
      <button id="tabPerformance" class="stats-tab-btn" type="button">Performance</button>
    </div>

    <!-- Daily stats table (TAB 1) -->
    <div id="dailyStatsCard" class="daily-stats-card" aria-live="polite">
      <div class="daily-stats-header">
        <div class="daily-stats-title">Daily breakdown</div>
        <div class="daily-stats-subtitle">Dots, earnings &amp; time of work per day</div>
      </div>
      <div class="daily-stats-table-wrap">
        <table class="daily-stats-table" aria-label="Daily dot posting stats">
          <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Dots</th>
              <th scope="col">Earnings</th>
              <th scope="col">Work time</th>
            </tr>
          </thead>
          <tbody id="dailyStatsBody">
            <tr><td colspan="4" class="daily-stats-empty">No dots yet. Post your first dot to see stats.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Performance card (TAB 2) -->
    <div id="performanceCard" class="performance-card" aria-live="polite">
      <div>
        <div class="performance-header">
          <div>
            <div class="performance-title">Performance</div>
            <div class="performance-subtitle">Lifetime avg flyers/hour &amp; badge</div>
          </div>
        </div>
        <div id="performanceContent">
          <div class="performance-main">
            <div class="perf-metric">
              <div class="perf-label">Avg flyers/hour (lifetime)</div>
              <div>
                <span id="perfAvgValue" class="perf-value">0.0</span>
                <span class="perf-unit">flyers/hr</span>
              </div>
            </div>
            <div class="perf-badge" id="perfBadge">
              <span class="perf-badge-rank" id="perfBadgeRank">–</span>
              <span class="perf-badge-label" id="perfBadgeLabel">No badge yet</span>
            </div>
          </div>
          <div class="perf-note">
            Badges: 50+ Beginner, 100+ Intermediate, 150+ Pro, 200+ Elite, 250+ Top.
          </div>
        </div>
        <div id="performanceEmpty" class="perf-empty" style="display:none;">
          No dots yet. Start posting to unlock your performance stats and badge.
        </div>
      </div>

      <!-- Per-day performance table -->
      <div>
        <div class="performance-header" style="margin-top:6px;">
          <div class="performance-title">Daily performance</div>
          <div class="performance-subtitle">Speed &amp; time window per day</div>
        </div>
        <div class="perf-daily-wrap">
          <table class="perf-daily-table" aria-label="Per-day performance stats">
            <thead>
              <tr>
                <th>Date</th>
                <th>Dots</th>
                <th>Work time</th>
                <th>Avg flyers/hr</th>
                <th>First</th>
                <th>Last</th>
              </tr>
            </thead>
            <tbody id="perfDailyBody">
              <tr><td colspan="6" class="perf-empty">No dots yet. Post to see daily performance.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footnote">Your location is used only to place dots and is stored with each post.</div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Posted!</div>

  <!-- Simple login modal -->
  <div id="loginBackdrop" class="modal-backdrop" aria-modal="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal">
      <h2 id="loginTitle">Enter User ID</h2>
      <p>Example: FF001, FF993, etc. Use 3–10 letters/numbers. This will register the user instantly.</p>
      <div class="input-row">
        <input id="userIdInput" class="input" type="text" placeholder="e.g. FF993" autocomplete="off" autocapitalize="characters" maxlength="12">
        <button id="userJoinBtn" class="btn">Join</button>
      </div>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, push, query, orderByChild, onValue,
    set, update, get, runTransaction, off
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Replaced old config with the single new Firebase project
  const firebaseConfig = {
    apiKey: "AIzaSyBWPCkYNw7gT_T7kcwbp5laZgIHac18bvE",
    authDomain: "expandlf.firebaseapp.com",
    databaseURL: "https://expandlf-default-rtdb.firebaseio.com",
    projectId: "expandlf",
    storageBucket: "expandlf.firebasestorage.app",
    messagingSenderId: "890066961009",
    appId: "1:890066961009:web:3a2ed1e7c2cf797f3751d0",
    measurementId: "G-QPRSX7ZVZ5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI elements
  const btnLocate = document.getElementById('btnLocate');
  const btnPost = document.getElementById('btnPost');
  const myDotsEl = document.getElementById('myDots');
  const myEarningsEl = document.getElementById('myEarnings');
  const toastEl = document.getElementById('toast');

  const loginBackdrop = document.getElementById('loginBackdrop');
  const userIdInput = document.getElementById('userIdInput');
  const userJoinBtn = document.getElementById('userJoinBtn');
  const loginError = document.getElementById('loginError');
  const userPill = document.getElementById('userPill');
  const userPillText = document.getElementById('userPillText');
  const changeUserBtn = document.getElementById('changeUserBtn');

  const dailyStatsBody = document.getElementById('dailyStatsBody');

  // Tabs and performance elements
  const tabDaily = document.getElementById('tabDaily');
  const tabPerformance = document.getElementById('tabPerformance');
  const dailyStatsCard = document.getElementById('dailyStatsCard');
  const performanceCard = document.getElementById('performanceCard');
  const perfAvgValue = document.getElementById('perfAvgValue');
  const perfBadgeRank = document.getElementById('perfBadgeRank');
  const perfBadgeLabel = document.getElementById('perfBadgeLabel');
  const performanceContent = document.getElementById('performanceContent');
  const performanceEmpty = document.getElementById('performanceEmpty');
  const perfDailyBody = document.getElementById('perfDailyBody');

  // Speed bar elements
  const speedCurrent = document.getElementById('speedCurrent');
  const speedBarFill = document.getElementById('speedBarFill');
  const speedBarGlow = document.getElementById('speedBarGlow');

  // Map init
  const map = L.map('map', { zoomControl: false, tap: true }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
  L.control.zoom({ position: 'topright' }).addTo(map);
  const postsLayer = L.layerGroup().addTo(map);

  // State
  let currentLatLng = null;
  let currentMarker = null;
  const postMarkers = new Map();
  let currentUserId = null;
  let myStatsUnsub = null;
  let myPostsUnsub = null;

  // Styles
  const redStyle = { radius: 6, color: '#ff3344', weight: 2, fillColor: '#ff3344', fillOpacity: 0.9 };
  const blackStyle = { radius: 1.6, color: '#000', weight: 1, fillColor: '#000', fillOpacity: 1 };

  function showToast(text = 'Posted!') {
    toastEl.textContent = text;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 1500);
  }

  function setPostEnabled(enabled) {
    btnPost.disabled = !enabled || !currentUserId;
  }

  function ensureCurrentMarker(latlng) {
    if (!currentMarker) {
      currentMarker = L.circleMarker(latlng, redStyle).addTo(map);
    } else {
      currentMarker.setLatLng(latlng);
    }
  }

  function fitIfNeeded() {
    if (!currentLatLng && postsLayer.getLayers().length > 0) {
      try { map.fitBounds(postsLayer.getBounds().pad(0.2), { animate: true }); } catch { }
    }
  }

  async function goToCurrentLocation({ focus = true } = {}) {
    if (!('geolocation' in navigator)) { showToast('Geolocation not supported'); return; }
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          currentLatLng = [latitude, longitude];
          ensureCurrentMarker(currentLatLng);
          if (focus) map.setView(currentLatLng, Math.max(map.getZoom(), 16), { animate: true });
          setPostEnabled(true);
          resolve(currentLatLng);
        },
        (err) => {
          console.warn('Geolocation error:', err);
          showToast('Location permission needed');
          setPostEnabled(false);
          resolve(null);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 10000 }
      );
    });
  }

  if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        currentLatLng = [latitude, longitude];
        ensureCurrentMarker(currentLatLng);
        setPostEnabled(true);
      },
      () => { },
      { enableHighAccuracy: true, maximumAge: 15000, timeout: 15000 }
    );
  }

  // ========= User handling =========
  const LS_KEY = 'dotPoster:userId';

  function showLogin() {
    loginBackdrop.classList.add('show');
    userIdInput.value = '';
    userIdInput.focus();
    setPostEnabled(false);
    // Detach per-user listeners when changing user
    if (typeof myStatsUnsub === 'function') { myStatsUnsub(); myStatsUnsub = null; }
    if (typeof myPostsUnsub === 'function') { myPostsUnsub(); myPostsUnsub = null; }
    currentUserId = null;
    // Clear user markers & daily stats & performance & speed
    postsLayer.clearLayers();
    postMarkers.clear();
    renderDailyStats(null);
    updatePerformance(null);
    updateSpeedBar(0, false);
    renderDailyPerformance(null);
  }
  function hideLogin() { loginBackdrop.classList.remove('show'); }
  function normalizeUserId(id) { return (id || '').toUpperCase().replace(/[^A-Z0-9]/g, ''); }
  function validateUserId(id) { return /^[A-Z0-9]{3,10}$/.test(id); }

  function attachMyStatsListener(id) {
    if (typeof myStatsUnsub === 'function') { myStatsUnsub(); myStatsUnsub = null; }
    myStatsUnsub = onValue(ref(db, `users/${id}/stats`), (snap) => {
      const stats = snap.val() || {};
      const totalDots = stats.totalDots || 0;
      const cents = stats.totalEarningsCents ?? (totalDots * 10);
      myDotsEl.textContent = String(totalDots);
      myEarningsEl.textContent = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(cents / 100);
    });
  }

  // Helper: format timestamp to YYYY-MM-DD for grouping (UTC)
  function formatDate(ts) {
    const d = new Date(ts);
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const day = String(d.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Today's date key (UTC) for speed bar activation
  function getTodayKeyUtc() {
    const d = new Date();
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const day = String(d.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Helper: local time HH:MM
  function formatLocalTime(ts) {
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  // Helper: format duration in ms to "Hh MMm"
  function formatWorkDuration(ms) {
    if (!ms || ms <= 0) return '0h 00m';
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const hStr = `${hours}h`;
    const mStr = `${String(minutes).padStart(2, '0')}m`;
    return `${hStr} ${mStr}`;
  }

  // Render daily stats from posts snapshot (dots, earnings, work time)
  function renderDailyStats(snapshot) {
    dailyStatsBody.innerHTML = '';
    if (!snapshot || !snapshot.exists()) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'daily-stats-empty';
      td.textContent = 'No dots yet. Post your first dot to see stats.';
      tr.appendChild(td);
      dailyStatsBody.appendChild(tr);
      return;
    }

    const dataByDate = {};
    snapshot.forEach((child) => {
      const val = child.val();
      if (!val || typeof val.timestamp !== 'number') return;
      const dateKey = formatDate(val.timestamp);
      if (!dataByDate[dateKey]) {
        dataByDate[dateKey] = {
          count: 0,
          earliest: val.timestamp,
          latest: val.timestamp
        };
      }
      const d = dataByDate[dateKey];
      d.count += 1;
      if (val.timestamp < d.earliest) d.earliest = val.timestamp;
      if (val.timestamp > d.latest) d.latest = val.timestamp;
    });

    const dates = Object.keys(dataByDate).sort((a, b) => b.localeCompare(a)); // latest first

    if (dates.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'daily-stats-empty';
      td.textContent = 'No dots yet. Post your first dot to see stats.';
      tr.appendChild(td);
      dailyStatsBody.appendChild(tr);
      return;
    }

    dates.forEach((dateStr) => {
      const { count, earliest, latest } = dataByDate[dateStr];
      const earnings = count * 0.10;
      const workMs = Math.max(latest - earliest, 0);
      const workStr = formatWorkDuration(workMs);

      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.className = 'daily-stats-date';
      tdDate.textContent = dateStr;

      const tdDots = document.createElement('td');
      tdDots.className = 'daily-stats-dots';
      tdDots.textContent = count.toString();

      const tdEarn = document.createElement('td');
      tdEarn.className = 'daily-stats-earn';
      tdEarn.textContent = `€${earnings.toFixed(2)}`;

      const tdWork = document.createElement('td');
      tdWork.className = 'daily-stats-worktime';
      tdWork.textContent = workStr;

      tr.appendChild(tdDate);
      tr.appendChild(tdDots);
      tr.appendChild(tdEarn);
      tr.appendChild(tdWork);
      dailyStatsBody.appendChild(tr);
    });
  }

  // Render per-day performance table: adds avg flyers/hr and first/last times
  function renderDailyPerformance(snapshot) {
    perfDailyBody.innerHTML = '';
    if (!snapshot || !snapshot.exists()) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.className = 'perf-empty';
      td.textContent = 'No dots yet. Post to see daily performance.';
      tr.appendChild(td);
      perfDailyBody.appendChild(tr);
      return;
    }

    const dataByDate = {};
    snapshot.forEach((child) => {
      const val = child.val();
      if (!val || typeof val.timestamp !== 'number') return;
      const dateKey = formatDate(val.timestamp);
      if (!dataByDate[dateKey]) {
        dataByDate[dateKey] = {
          count: 0,
          earliest: val.timestamp,
          latest: val.timestamp
        };
      }
      const d = dataByDate[dateKey];
      d.count += 1;
      if (val.timestamp < d.earliest) d.earliest = val.timestamp;
      if (val.timestamp > d.latest) d.latest = val.timestamp;
    });

    const dates = Object.keys(dataByDate).sort((a, b) => b.localeCompare(a)); // latest first

    if (dates.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.className = 'perf-empty';
      td.textContent = 'No dots yet. Post to see daily performance.';
      tr.appendChild(td);
      perfDailyBody.appendChild(tr);
      return;
    }

    dates.forEach((dateStr) => {
      const { count, earliest, latest } = dataByDate[dateStr];
      const workMs = Math.max(latest - earliest, 0);
      const workStr = formatWorkDuration(workMs);

      let hours = workMs / (1000 * 60 * 60);
      if (hours <= 0) hours = 1; // if single dot, consider 1h window
      const avg = count / hours;

      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.className = 'perf-daily-date';
      tdDate.textContent = dateStr;

      const tdDots = document.createElement('td');
      tdDots.className = 'perf-daily-dots';
      tdDots.textContent = count.toString();

      const tdWork = document.createElement('td');
      tdWork.className = 'perf-daily-work';
      tdWork.textContent = workStr;

      const tdAvg = document.createElement('td');
      tdAvg.className = 'perf-daily-avg';
      tdAvg.textContent = avg.toFixed(1);

      const tdFirst = document.createElement('td');
      tdFirst.className = 'perf-daily-time';
      tdFirst.textContent = formatLocalTime(earliest);

      const tdLast = document.createElement('td');
      tdLast.className = 'perf-daily-time';
      tdLast.textContent = formatLocalTime(latest);

      tr.appendChild(tdDate);
      tr.appendChild(tdDots);
      tr.appendChild(tdWork);
      tr.appendChild(tdAvg);
      tr.appendChild(tdFirst);
      tr.appendChild(tdLast);
      perfDailyBody.appendChild(tr);
    });
  }

  // Compute badges based on flyers per hour (lifetime)
  function getPerformanceBadge(flyersPerHour) {
    if (flyersPerHour >= 250) return { rank: 'TOP', label: 'Top badge (250+ flyers/hr)' };
    if (flyersPerHour >= 200) return { rank: 'ELITE', label: 'Elite (200–249 flyers/hr)' };
    if (flyersPerHour >= 150) return { rank: 'PRO', label: 'Pro (150–199 flyers/hr)' };
    if (flyersPerHour >= 100) return { rank: 'INTER', label: 'Intermediate (100–149 flyers/hr)' };
    if (flyersPerHour >= 50) return { rank: 'BEGIN', label: 'Beginner (50–99 flyers/hr)' };
    return { rank: '–', label: 'No badge yet' };
  }

  // Map flyers/hour to 0–1 (0 -> 0, 250+ -> 1)
  function speedToRatio(flyersPerHour) {
    const capped = Math.max(0, Math.min(flyersPerHour, 250));
    return capped / 250;
  }

  // Update header live speed bar
  // active=false keeps it visually low-glow when no flyers today yet
  function updateSpeedBar(flyersPerHour, active) {
    const value = active ? flyersPerHour : 0;
    const ratio = speedToRatio(value);
    speedCurrent.textContent = value.toFixed(1);

    speedBarFill.style.transform = `scaleX(${ratio})`;
    const glowPos = 5 + ratio * 90;
    speedBarGlow.style.setProperty('--glow-pos', `${glowPos}%`);
    speedBarGlow.style.opacity = active && ratio > 0 ? 0.45 : 0.15;
  }

  // Update lifetime performance + header speed bar (today only)
  function updatePerformance(snapshot) {
    // Lifetime stats
    if (!snapshot || !snapshot.exists()) {
      perfAvgValue.textContent = '0.0';
      const badge0 = getPerformanceBadge(0);
      perfBadgeRank.textContent = badge0.rank;
      perfBadgeLabel.textContent = badge0.label;
      performanceContent.style.display = 'none';
      performanceEmpty.style.display = 'block';
      // No flyers at all -> no daily performance, no speed today
      updateSpeedBar(0, false);
      return;
    }

    let totalDots = 0;
    let earliestTs = Infinity;
    let latestTs = 0;

    const todayKey = getTodayKeyUtc();
    let todayCount = 0;
    let todayEarliest = Infinity;
    let todayLatest = 0;

    snapshot.forEach((child) => {
      const val = child.val();
      if (!val || typeof val.timestamp !== 'number') return;
      const ts = val.timestamp;
      totalDots += 1;
      if (ts < earliestTs) earliestTs = ts;
      if (ts > latestTs) latestTs = ts;

      const dateKey = formatDate(ts);
      if (dateKey === todayKey) {
        todayCount += 1;
        if (ts < todayEarliest) todayEarliest = ts;
        if (ts > todayLatest) todayLatest = ts;
      }
    });

    if (totalDots === 0 || earliestTs === Infinity) {
      perfAvgValue.textContent = '0.0';
      const badge0 = getPerformanceBadge(0);
      perfBadgeRank.textContent = badge0.rank;
      perfBadgeLabel.textContent = badge0.label;
      performanceContent.style.display = 'none';
      performanceEmpty.style.display = 'block';
      updateSpeedBar(0, false);
      return;
    }

    // Lifetime avg
    const diffMsLifetime = Math.max(latestTs - earliestTs, 0);
    let hoursLifetime = diffMsLifetime / (1000 * 60 * 60);
    if (hoursLifetime < 1) hoursLifetime = 1;
    const flyersPerHourLifetime = totalDots / hoursLifetime;

    perfAvgValue.textContent = flyersPerHourLifetime.toFixed(1);
    const badge = getPerformanceBadge(flyersPerHourLifetime);
    perfBadgeRank.textContent = badge.rank;
    perfBadgeLabel.textContent = badge.label;
    performanceContent.style.display = 'block';
    performanceEmpty.style.display = 'none';

    // Today's speed bar: only if at least one flyer today
    if (todayCount > 0 && todayEarliest !== Infinity) {
      const diffMsToday = Math.max(todayLatest - todayEarliest, 0);
      let hoursToday = diffMsToday / (1000 * 60 * 60);
      if (hoursToday < 1) hoursToday = 1;
      const flyersPerHourToday = todayCount / hoursToday;
      updateSpeedBar(flyersPerHourToday, true);
    } else {
      updateSpeedBar(0, false);
    }
  }

  function attachMyPostsListener(id) {
    if (typeof myPostsUnsub === 'function') { myPostsUnsub(); myPostsUnsub = null; }
    const myPostsRef = query(ref(db, `userPosts/${id}`), orderByChild('timestamp'));
    const handler = (snapshot) => {
      // Map markers
      postsLayer.clearLayers();
      postMarkers.clear();

      snapshot.forEach((child) => {
        const key = child.key;
        const val = child.val();
        if (!val || typeof val.lat !== 'number' || typeof val.lng !== 'number') return;

        const label = val.userId ? `My dot (${val.userId})` : 'My dot';
        const marker = L.circleMarker([val.lat, val.lng], blackStyle).bindTooltip(label, { direction: 'top', offset: [0, -8] });
        marker.addTo(postsLayer);
        postMarkers.set(key, marker);
      });

      fitIfNeeded();

      // Daily totals
      renderDailyStats(snapshot);
      // Per-day performance
      renderDailyPerformance(snapshot);
      // Lifetime performance + today's live speed
      updatePerformance(snapshot);
    };
    onValue(myPostsRef, handler);
    // Create an unsubscribe wrapper
    myPostsUnsub = () => off(myPostsRef, 'value', handler);
  }

  function onUserReady(id) {
    currentUserId = id;
    localStorage.setItem(LS_KEY, id);
    userPillText.textContent = `Logged in as ${id}`;
    userPill.style.display = 'flex';
    attachMyStatsListener(id);
    attachMyPostsListener(id);
    setPostEnabled(true);
  }

  async function registerUser(id) {
    const now = Date.now();
    const userRef = ref(db, `users/${id}`);
    try {
      const snap = await get(userRef);
      if (snap.exists()) {
        await update(userRef, { lastActiveAt: now });
      } else {
        await set(userRef, {
          createdAt: now,
          lastActiveAt: now,
          ua: navigator.userAgent || '',
          stats: { totalDots: 0, totalEarningsCents: 0 }
        });
      }
    } catch (e) {
      console.error('User register error', e);
      showToast('Failed to register user');
    }
  }

  const stored = normalizeUserId(localStorage.getItem(LS_KEY));
  if (validateUserId(stored)) {
    registerUser(stored).then(() => onUserReady(stored));
  } else {
    showLogin();
  }

  userJoinBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    const raw = userIdInput.value;
    const id = normalizeUserId(raw);
    if (!validateUserId(id)) {
      loginError.textContent = 'Use 3–10 letters/numbers, e.g. FF001';
      return;
    }
    await registerUser(id);
    onUserReady(id);
    hideLogin();
    showToast(`User ${id} ready`);
  });
  userIdInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') userJoinBtn.click(); });
  changeUserBtn.addEventListener('click', () => { showLogin(); });

  // ========= Posting (ONLY to userPosts, not to /posts) =========
  btnLocate.addEventListener('click', () => { goToCurrentLocation({ focus: true }); });

  btnPost.addEventListener('click', async () => {
    if (!currentUserId) { showToast('Enter User ID to post'); showLogin(); return; }
    if (!currentLatLng) {
      await goToCurrentLocation({ focus: true });
      if (!currentLatLng) return;
    }
    const [lat, lng] = currentLatLng;
    const now = Date.now();
    const data = {
      lat, lng,
      userId: currentUserId,
      timestamp: now,
      ua: navigator.userAgent || ''
    };

    try {
      // Create a new key under userPosts/<userId> only
      const newPostRef = push(ref(db, `userPosts/${currentUserId}`));
      const newKey = newPostRef.key;

      // Multi-location update WITHOUT /posts
      const rootRef = ref(db);
      const updates = {};
      updates[`userPosts/${currentUserId}/${newKey}`] = data;
      updates[`users/${currentUserId}/lastPostAt`] = now;

      await update(rootRef, updates);

      // Atomically bump per-user stats only
      await Promise.all([
        runTransaction(ref(db, `users/${currentUserId}/stats/totalDots`), (v) => (v || 0) + 1),
        runTransaction(ref(db, `users/${currentUserId}/stats/totalEarningsCents`), (v) => (v || 0) + 10)
      ]);

      showToast('Dot posted');
      if (currentMarker) {
        const ping = L.circle(currentMarker.getLatLng(), { radius: 10, color: '#7a5cff', weight: 1, opacity: 0.7, fillOpacity: 0 });
        ping.addTo(map);
        setTimeout(() => map.removeLayer(ping), 500);
      }
    } catch (e) {
      console.error(e);
      showToast('Failed to post');
    }
  });

  // Tabs behaviour
  function setActiveTab(tab) {
    if (tab === 'daily') {
      tabDaily.classList.add('active');
      tabPerformance.classList.remove('active');
      dailyStatsCard.style.display = 'block';
      performanceCard.style.display = 'none';
    } else {
      tabDaily.classList.remove('active');
      tabPerformance.classList.add('active');
      dailyStatsCard.style.display = 'none';
      performanceCard.style.display = 'flex';
    }
  }

  // Small fix: ensure only one is visible based on tab
  tabDaily.addEventListener('click', () => setActiveTab('daily'));
  tabPerformance.addEventListener('click', () => setActiveTab('performance'));

  // Default tab
  setActiveTab('daily');

  // Initialize speed bar
  updateSpeedBar(0, false);

  // Auto prompt for location on load
  goToCurrentLocation({ focus: false });

  // Accessibility
  [btnLocate, btnPost].forEach(btn => {
    btn.addEventListener('keyup', (e) => { if (e.key === 'Enter' || e.key === ' ') btn.click(); });
  });
</script>
</body>
</html>
