<!DOCTYPE html>
<html>
<head>
  <title>Polygon Saver</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      height: 100%;
      width: 100%;
      border: none;
      margin: 0;
      padding: 0;
      z-index: 0;
    }
    #save-polygon, #delete-selected, #copy-selected, #select-all {
      position: fixed;
      z-index: 999;
      padding: 12px 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: background 0.2s;
    }
    #save-polygon { top: 20px; right: 20px; }
    #select-all { top: 170px; right: 20px; display: none; background: #6c757d; }
    #delete-selected { top: 120px; right: 20px; display: none; background: #e53935;}
    #copy-selected { top: 70px; right: 20px; display: none; background: #43a047; }
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .selected-polygon { stroke: #43a047 !important; stroke-width: 5 !important; fill-opacity: 0.2 !important; }
    .polygon-action-bar {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    @media (max-width: 600px) {
      #save-polygon, #delete-selected, #copy-selected, #select-all {
        top: auto;
        bottom: 20px;
        right: 20px;
        font-size: 14px;
        padding: 10px 12px;
      }
      #select-all { bottom: 170px; }
      #delete-selected { bottom: 70px; }
      #copy-selected { bottom: 120px; }
    }
  </style>
</head>
<body>
  <button id="save-polygon" style="display:none;">Save Polygon</button>
  <button id="copy-selected">Copy Selected Coordinates</button>
  <button id="delete-selected">Delete Selected</button>
  <button id="select-all">Select All</button>
  <div id="map"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Leaflet and Draw -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain: "nftfanactive.firebaseapp.com",
      databaseURL: "https://nftfanactive-default-rtdb.firebaseio.com",
      projectId: "nftfanactive",
      storageBucket: "nftfanactive.appspot.com",
      messagingSenderId: "311309982791",
      appId: "1:311309982791:web:3e55bba6b78feb57ea6562",
      measurementId: "G-3TRDL9749N"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Map setup: Center on Belgium and set appropriate zoom
    var map = L.map('map').setView([50.8503, 4.3517], 8); // Brussels, Belgium

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
      draw: { polygon: true, polyline: false, marker: false, circle: false, circlemarker: false, rectangle: false },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    var lastLayer = null;
    var polygonRefs = {}; // key: polygon._leaflet_id, value: { key, layer, coords }
    var selectedPolygons = new Set();

    function updateActionButtons() {
      const hasPolygons = Object.keys(polygonRefs).length > 0;
      const hasSelection = selectedPolygons.size > 0;
      document.getElementById('copy-selected').style.display = hasSelection ? 'inline-block' : 'none';
      document.getElementById('delete-selected').style.display = hasSelection ? 'inline-block' : 'none';
      document.getElementById('select-all').style.display = hasPolygons ? 'inline-block' : 'none';
      // Update select-all text
      document.getElementById('select-all').textContent = (selectedPolygons.size === Object.keys(polygonRefs).length && hasPolygons) ? "Unselect All" : "Select All";
    }

    // Draw event
    map.on('draw:created', function (e) {
      drawnItems.clearLayers();
      lastLayer = e.layer;
      drawnItems.addLayer(lastLayer);
      document.getElementById('save-polygon').style.display = 'inline-block';
    });

    // Save polygon to Firebase manually
    document.getElementById('save-polygon').onclick = function() {
      if (!lastLayer) return;
      var coords = lastLayer.getLatLngs()[0].map(p => ({lat: p.lat, lng: p.lng}));
      db.ref('polygons').push(coords, function(error) {
        if (!error) {
          alert('Polygon saved!');
          document.getElementById('save-polygon').style.display = 'none';
          lastLayer = null;
          drawnItems.clearLayers();
          loadPolygons();
        }
      });
    };

    function formatCoordsArray(coordsArray) {
      return '[\n' + coordsArray.map(
        poly => '  [\n' + poly.map(
          pt => `    [${pt[0]}, ${pt[1]}]`
        ).join(',\n') + '\n  ]'
      ).join(',\n') + '\n]';
    }

    function copyToClipboard(str) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(str).then(() => {
          alert("Coordinates copied to clipboard!");
        }, () => {
          alert("Failed to copy.");
        });
      } else {
        var textarea = document.createElement("textarea");
        textarea.value = str;
        document.body.appendChild(textarea);
        textarea.select();
        try { document.execCommand('copy'); alert("Coordinates copied to clipboard!"); }
        catch (err) { alert("Failed to copy."); }
        document.body.removeChild(textarea);
      }
    }

    function loadPolygons() {
      drawnItems.clearLayers();
      polygonRefs = {};
      selectedPolygons.clear();

      db.ref('polygons').once('value', function(snapshot) {
        snapshot.forEach(function(child) {
          var coordsArr = child.val().map(pt => [pt.lat, pt.lng]);
          var polygon = L.polygon(coordsArr, {color: 'red', weight: 3, fillOpacity: 0.15});
          drawnItems.addLayer(polygon);

          polygonRefs[polygon._leaflet_id] = { key: child.key, layer: polygon, coords: coordsArr };

          polygon.on('click', function(e) {
            // Toggle selection
            if (selectedPolygons.has(polygon._leaflet_id)) {
              selectedPolygons.delete(polygon._leaflet_id);
              polygon.setStyle({ color: 'red', weight: 3, fillOpacity: 0.15 });
            } else {
              selectedPolygons.add(polygon._leaflet_id);
              polygon.setStyle({ color: '#43a047', weight: 5, fillOpacity: 0.22 });
            }
            updateActionButtons();
            L.DomEvent.stopPropagation(e);
          });

          polygon.on('dblclick', function(e) {
            // Show popup for copy (single polygon, double click)
            var coordStr = formatCoordsArray([coordsArr]);
            var popupContent = `<b>Polygon Coordinates:</b>
              <pre style="max-width:350px;overflow-x:auto;font-size:12px;">${coordStr}</pre>
              <button onclick="window.copyPolygonCoords('${btoa(coordStr)}')" style="padding:6px 12px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;">Copy Coordinates</button>
              <br><small>Tip: Click polygon to select for batch copy/delete.</small>`;
            polygon.bindPopup(popupContent).openPopup();
            L.DomEvent.stopPropagation(e);
          });
        });
        updateActionButtons();
      });
    }

    window.copyPolygonCoords = function(encoded) {
      var str = atob(encoded);
      copyToClipboard(str);
    };

    document.getElementById('delete-selected').onclick = function() {
      if (selectedPolygons.size === 0) return;
      if (!confirm("Delete selected polygons? This cannot be undone.")) return;
      let promises = [];
      selectedPolygons.forEach(id => {
        let ref = polygonRefs[id];
        if (ref) {
          promises.push(db.ref('polygons/' + ref.key).remove());
          drawnItems.removeLayer(ref.layer);
        }
      });
      Promise.all(promises).then(() => {
        selectedPolygons.clear();
        updateActionButtons();
        loadPolygons();
      });
    };

    document.getElementById('copy-selected').onclick = function() {
      if (selectedPolygons.size === 0) return;
      var coordsArray = [];
      selectedPolygons.forEach(id => {
        let ref = polygonRefs[id];
        if (ref) {
          coordsArray.push(ref.coords);
        }
      });
      var jsArray = formatCoordsArray(coordsArray);
      copyToClipboard(jsArray);
    };

    document.getElementById('select-all').onclick = function() {
      const allIds = Object.keys(polygonRefs);
      // If all are selected, unselect all
      if (selectedPolygons.size === allIds.length) {
        selectedPolygons.forEach(id => {
          const ref = polygonRefs[id];
          if (ref) ref.layer.setStyle({ color: 'red', weight: 3, fillOpacity: 0.15 });
        });
        selectedPolygons.clear();
      } else {
        // Otherwise, select all polygons
        allIds.forEach(id => {
          if (!selectedPolygons.has(id)) {
            selectedPolygons.add(id);
            polygonRefs[id].layer.setStyle({ color: '#43a047', weight: 5, fillOpacity: 0.22 });
          }
        });
      }
      updateActionButtons();
    };

    window.onload = loadPolygons;
  </script>
</body>
</html>

