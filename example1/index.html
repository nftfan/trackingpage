<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFans Lottery ‚Äì Win 100 $POL Mega Prize!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Google Fonts for professional look -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #12d6b3;
      --secondary: #ffd700;
      --background: #10151c;
      --card-bg: #181f2a;
      --accent: #1a2463;
      --success: #4ade80;
      --danger: #ff3860;
      --font: 'Inter', Arial, sans-serif;
      --shadow: 0 4px 18px #0005;
      --border-radius: 12px;
      --transition: 0.35s cubic-bezier(.22,1,.36,1);
      --mobile-font-size: 10px;
    }
    html, body {
      margin: 0; padding: 0;
      background: var(--background);
      font-family: var(--font);
      color: #f0f3f9;
      min-height: 100vh;
      box-sizing: border-box;
      font-size: var(--mobile-font-size);
    }
    .container {
      max-width: 98vw;
      margin: 10px auto 10px auto;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 10px 3vw 8px 3vw;
      border: 1px solid #26314a;
    }
    h1 {
      text-align: center;
      font-size: 1.2rem;
      margin: 0 0 4px 0;
      color: var(--secondary);
      letter-spacing: 0.5px;
      font-weight: 600;
      text-shadow: 0 2px 8px #fffa;
      line-height: 1.1;
    }
    .prize {
      font-weight: 600;
      color: var(--primary);
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
    }
    .instructions {
      background: linear-gradient(90deg, #171d23 80%, #142933 100%);
      border-left: 2px solid var(--primary);
      padding: 6px 10px 6px 10px;
      margin-bottom: 10px;
      border-radius: 7px;
      font-size: 0.9em;
      line-height: 1.5;
      box-shadow: 0 1px 6px #0ff2;
    }
    .bonus-nftfan {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #202c30;
      border-radius: 6px;
      padding: 5px 8px;
      margin: 8px 0 10px 0;
      font-size: 0.95em;
      box-shadow: 0 1px 6px #00ffe733;
      color: #00ffc3;
      justify-content: center;
      font-weight: 600;
    }
    .nftfan-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      border-radius: 50%;
      box-shadow: 0 0 8px #fff5;
      background: #fff;
      object-fit: cover;
    }
    .lottery-img {
      display: block;
      width: 95vw;
      max-width: 340px;
      margin: 7px auto 7px auto;
      border-radius: 8px;
      border: 1.5px solid var(--secondary);
      box-shadow: 0 0 8px #ffd70044;
      transition: transform .22s cubic-bezier(.22,1,.36,1);
    }
    .lottery-img:hover { transform: scale(1.01) rotate(-1deg); }

    .address-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-bottom: 7px;
    }
    .address-box {
      background: var(--accent);
      border: 1.5px dashed var(--primary);
      color: var(--primary);
      border-radius: 4px;
      padding: 6px 8px;
      font-family: 'Fira Mono', monospace;
      font-size: 0.85em;
      text-align: center;
      margin-bottom: 2px;
      word-break: break-all;
      font-weight: bold;
      letter-spacing: .3px;
      user-select: all;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 0 6px #12d6b322;
    }
    .address-box.copied {
      background: var(--success);
      color: #002a24;
      border-color: #fff;
      animation: pop 0.7s;
    }
    @keyframes pop {
      0% { transform: scale(1);}
      40% { transform: scale(1.05);}
      100% { transform: scale(1);}
    }
    .copy-btn {
      font-size: 0.8em;
      padding: 2px 8px;
      border-radius: 5px;
      background: #232b4b;
      color: var(--primary);
      border: none;
      cursor: pointer;
      transition: background .2s;
      margin-top: 1px;
    }
    .copy-btn:hover {
      background: #34418a;
      color: #fff;
    }

    .entry-count {
      text-align: center;
      font-size: 0.97em;
      color: var(--primary);
      margin-bottom: 3px;
      font-weight: 600;
    }
    .progress-bar-bg {
      width: 100%;
      background: #26314a;
      border-radius: 4px;
      height: 8px;
      margin: 0 auto 6px auto;
      box-shadow: 0 1px 3px #1118;
      position: relative;
    }
    .progress-bar-fill {
      height: 8px;
      background: linear-gradient(90deg, var(--primary), #fff 70%);
      border-radius: 4px;
      transition: width 0.8s var(--transition);
      min-width: 4px;
      max-width: 100%;
      box-shadow: 0 0 4px #12d6b366;
    }

    .send-pol-section {
      margin: 7px auto 10px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .send-btn {
      background: linear-gradient(90deg, var(--primary) 10%, #8affec 90%);
      border: none;
      color: #003e2e;
      font-weight: bold;
      font-size: 0.99em;
      border-radius: 11px;
      padding: 7px 16px;
      cursor: pointer;
      margin-top: 2px;
      transition: background .18s, transform .18s;
      position: relative;
      overflow: hidden;
      min-width: 110px;
      min-height: 26px;
      box-shadow: 0 1px 4px #12d6b355;
    }
    .send-btn:active { transform: scale(.98);}
    .send-btn.success {
      background: linear-gradient(90deg, #4ade80 10%, #fff 70%);
      color: #0e2;
      animation: send-success 0.7s;
    }
    .send-btn.error {
      background: linear-gradient(90deg, #ff3860 10%, #fff 70%);
      color: #fff;
      animation: send-fail 0.5s;
    }
    @keyframes send-success {
      0% { box-shadow: 0 0 0 #4ade8040;}
      60% { box-shadow: 0 0 16px #4ade8040;}
      100% { box-shadow: 0 0 0 #4ade8040;}
    }
    @keyframes send-fail {
      0% { box-shadow: 0 0 0 #ff386044;}
      50% { box-shadow: 0 0 16px #ff386044;}
      100% { box-shadow: 0 0 0 #ff386044;}
    }
    .send-anim {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      pointer-events: none;
      z-index: 1;
      display: none;
    }
    .send-btn.sending .send-anim {
      display: block;
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%,-50%) rotate(0);}
      100% { transform: translate(-50%,-50%) rotate(360deg);}
    }

    .tx-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 7px;
      background: #171d23;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 4px #000a;
      font-size: 10px;
    }
    .tx-table th, .tx-table td {
      padding: 3.5px 2px;
      text-align: center;
    }
    .tx-table th {
      background: #23272b;
      color: var(--secondary);
      font-weight: 600;
      font-size: 10px;
      border-bottom: 1px solid #26314a;
    }
    .tx-table tr {
      transition: background 0.13s;
    }
    .tx-table tr.valid-row {
      background: linear-gradient(90deg, #08ffb0 0, #1c1 100%);
      color: #050;
      font-weight: bold;
      box-shadow: 0 0 3px #0f82;
    }
    .tx-table tr.new-entry-anim {
      animation: entry-pop 0.7s;
    }
    @keyframes entry-pop {
      0% { background: #fff9; transform: scale(0.94);}
      60% { background: #08ffb055; transform: scale(1.01);}
      100% { }
    }
    .tx-table tr:not(.valid-row):hover {
      background: #21282f;
    }
    .tx-table td a {
      color: var(--secondary);
      text-decoration: underline;
      font-size: 10px;
    }
    .tx-table td a:hover { color: #fff;}
    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 9px;
      color: #474d61;
      letter-spacing: .08em;
    }
    .blink {
      animation: blink-anim 0.5s 2;
    }
    @keyframes blink-anim {
      0% { background: #fff9; color: #222;}
      50% { background: #12d6b3; color: #fff;}
      100% { }
    }
    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #26314a;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 5px;
    }
    .error-message {
      color: var(--danger);
      font-size: 9px;
      text-align: center;
      margin-top: 5px;
    }
    @media (max-width: 380px) {
      .container { padding: 2vw 1vw; }
      .entry-count { font-size: 0.9em; }
      .tx-table th, .tx-table td, .tx-table td a { font-size: 9px;}
    }
  </style>
  <!-- Ethers.js for wallet interaction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
<div class="container">
  <h1>üéüÔ∏è NFTFans Lottery</h1>
  <div class="prize">
    WIN <span style="color:#ffd700;">100 $POL</span> (~$20) ‚Äì 1 Lucky Winner!
  </div>
  <div class="bonus-nftfan">
    <img class="nftfan-icon" src="https://res.cloudinary.com/dvbwmtdwh/image/upload/v1751403742/Untitled_design_69_kxpjn9.png" alt="NFTFAN Token">
    <span>With every entry, you also get <b>1,000T $NFTFAN</b> tokens!</span>
  </div>
  <img src="https://pbs.twimg.com/media/GuzMxVMWkAA08_t?format=jpg&name=large" alt="Lottery Ticket" class="lottery-img" loading="lazy">
  <div class="instructions">
    <b style="color:#ffd700;">How to Enter:</b> <br>
    1. Send <b>1 $POL</b> to the address below.<br>
    2. Each 1 $POL = 1 lottery entry.<br>
    3. At 150 entries, <b>1 random participant wins 100 $POL!</b><br>
    <b>No limits:</b> Enter as many times as you wish.<br>
    <b>Prize:</b> 100 $POL (~$20) automatically sent to the winner.
  </div>
  <div class="address-section">
    <div class="address-box" id="address-box" title="Click to copy">0xaf2d132C8773bca3821C24EcF64e844E202A12e8</div>
    <button class="copy-btn" id="copy-btn">Copy Address</button>
  </div>
  <div class="entry-count" id="entry-count">
    <span class="loading-spinner"></span>Loading entries...
  </div>
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
  </div>
  <div class="send-pol-section">
    <button id="send-btn" class="send-btn">
      <span>Send 1 $POL & Enter</span>
      <svg class="send-anim" width="15" height="15" viewBox="0 0 50 50">
        <circle cx="25" cy="25" r="20" fill="none" stroke="#00ffe7" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4" stroke-dashoffset="0"/>
      </svg>
    </button>
    <div id="send-status" style="font-size:9px; min-height:1.1em; color:#ffd700; margin-top:2px;"></div>
  </div>
  <h2 style="margin-top:10px; color:#ffd700; text-align:center; font-size:11px;">Valid Entries</h2>
  <table class="tx-table" id="tx-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>From</th>
        <th>Amount</th>
        <th>Txn</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4"><span class="loading-spinner"></span>Loading‚Ä¶</td></tr>
    </tbody>
  </table>
  <div id="error-message" class="error-message" style="display:none;"></div>
</div>
<div class="footer">
  Powered by <b>NFTFans</b> | Luck favours the brave!
</div>
<script>
const LOTTERY_ADDRESS = "0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
const API_KEYS = [
  "3AFN3ZU4ANK3XEUJQ6BRJCBCITAFHKFVTV",
  "YourBackupAPIKey1", // Add backup API keys here
  "YourBackupAPIKey2"
];
const POL_DECIMALS = 18;
const ENTRY_AMOUNT = 1;
const MAX_ENTRIES = 150;
const START_TIMESTAMP = Math.floor(new Date('2025-01-01T00:00:00Z').getTime() / 1000);

let currentApiKeyIndex = 0;
let retryCount = 0;
const MAX_RETRIES = 3;

function formatAddress(addr) {
  return addr.slice(0, 4) + "‚Ä¶" + addr.slice(-3);
}

function formatDate(ts) {
  const date = new Date(parseInt(ts, 10) * 1000);
  return date.toLocaleString(undefined, {
    month: "2-digit", day: "2-digit",
    hour: '2-digit', minute: '2-digit'
  });
}

function formatPol(val) {
  return (parseFloat(val) / Math.pow(10, POL_DECIMALS)).toFixed(2);
}

function showError(message) {
  const errorDiv = document.getElementById('error-message');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function hideError() {
  const errorDiv = document.getElementById('error-message');
  errorDiv.style.display = 'none';
}

let prevTxHashes = [];
let allValidTransactions = [];
let isLoading = false;

async function fetchTransactionsPage(startblock = 0, endblock = 99999999, page = 1) {
  const apiKey = API_KEYS[currentApiKeyIndex];
  const url = `https://api.polygonscan.com/api?module=account&action=txlist&address=${LOTTERY_ADDRESS}&startblock=${startblock}&endblock=${endblock}&page=${page}&offset=100&sort=desc&apikey=${apiKey}`;
  
  const response = await fetch(url);
  const data = await response.json();
  
  if (data.status === "0") {
    if (data.message.includes("rate limit") || data.message.includes("API")) {
      // Try next API key
      currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
      throw new Error(`API rate limit or error: ${data.message}`);
    }
    throw new Error(data.message || "API error");
  }
  
  return data.result || [];
}

async function fetchAllValidTransactions() {
  if (isLoading) return;
  isLoading = true;
  
  try {
    hideError();
    let allTransactions = [];
    let page = 1;
    let hasMore = true;
    
    // Fetch all transactions in batches
    while (hasMore && page <= 10) { // Limit to 10 pages to prevent infinite loops
      const transactions = await fetchTransactionsPage(0, 99999999, page);
      
      if (transactions.length === 0) {
        hasMore = false;
        break;
      }
      
      // Filter transactions from January 1, 2025 onwards
      const recentTransactions = transactions.filter(tx => 
        parseInt(tx.timeStamp) >= START_TIMESTAMP
      );
      
      allTransactions = allTransactions.concat(recentTransactions);
      
      // If we got less than 100 transactions or the last transaction is before our start date, stop
      if (transactions.length < 100 || parseInt(transactions[transactions.length - 1].timeStamp) < START_TIMESTAMP) {
        hasMore = false;
      }
      
      page++;
    }
    
    // Filter for valid entries (to our address, exactly 1 POL, not failed)
    allValidTransactions = allTransactions.filter(tx => 
      tx.to && tx.to.toLowerCase() === LOTTERY_ADDRESS.toLowerCase() &&
      Math.abs(parseFloat(tx.value) / Math.pow(10, POL_DECIMALS) - ENTRY_AMOUNT) < 0.00001 &&
      tx.isError === "0" &&
      parseInt(tx.timeStamp) >= START_TIMESTAMP
    );
    
    // Sort by timestamp descending (newest first)
    allValidTransactions.sort((a, b) => parseInt(b.timeStamp) - parseInt(a.timeStamp));
    
    retryCount = 0; // Reset retry count on success
    
  } catch (error) {
    console.error('Error fetching transactions:', error);
    
    if (retryCount < MAX_RETRIES) {
      retryCount++;
      showError(`Loading entries... (Retry ${retryCount}/${MAX_RETRIES})`);
      setTimeout(() => fetchAllValidTransactions(), 2000 * retryCount);
      return;
    } else {
      showError(`Failed to load entries after ${MAX_RETRIES} attempts. Please refresh the page.`);
    }
  } finally {
    isLoading = false;
  }
}

function renderTransactions() {
  const tbody = document.querySelector("#tx-table tbody");
  const entryCountDiv = document.getElementById("entry-count");
  const progressBar = document.getElementById("progress-fill");
  
  const entries = allValidTransactions.length;
  const displayTransactions = allValidTransactions.slice(0, 50); // Show latest 50
  
  // Check for new transactions
  const currentHashes = displayTransactions.map(tx => tx.hash);
  const newHashes = prevTxHashes.length === 0 ? [] : currentHashes.filter(h => !prevTxHashes.includes(h));
  
  let rows = "";
  displayTransactions.forEach((tx) => {
    const isNew = newHashes.includes(tx.hash);
    rows += `<tr class="valid-row${isNew ? ' new-entry-anim' : ''}">
      <td>${formatDate(tx.timeStamp)}</td>
      <td title="${tx.from}">${formatAddress(tx.from)}</td>
      <td>${formatPol(tx.value)} POL</td>
      <td><a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" rel="noopener">View</a></td>
    </tr>`;
  });
  
  if (!rows) {
    rows = `<tr><td colspan="4">No valid entries found since January 1, 2025.</td></tr>`;
  }
  
  tbody.innerHTML = rows;
  entryCountDiv.innerHTML = `Valid entries: <b style="color:#ffd700;">${entries}</b> / <b>${MAX_ENTRIES}</b>`;
  
  const percent = Math.min(Math.round((entries / MAX_ENTRIES) * 100), 100);
  progressBar.style.width = percent + "%";
  
  // Animate new entries
  if (newHashes.length > 0) {
    entryCountDiv.classList.add('blink');
    setTimeout(() => entryCountDiv.classList.remove('blink'), 950);
    setTimeout(() => {
      document.querySelectorAll('.new-entry-anim').forEach(row => row.classList.remove('new-entry-anim'));
    }, 800);
  }
  
  prevTxHashes = currentHashes;
}

async function fetchAndRenderTxs() {
  await fetchAllValidTransactions();
  renderTransactions();
}

// Initial load
fetchAndRenderTxs();

// Refresh every 10 seconds
setInterval(fetchAndRenderTxs, 10000);

// Copy Address Logic
const addressBox = document.getElementById('address-box');
const copyBtn = document.getElementById('copy-btn');

async function copyAddress() {
  try {
    await navigator.clipboard.writeText(LOTTERY_ADDRESS);
    addressBox.classList.add('copied');
    copyBtn.innerText = "Copied!";
    setTimeout(() => {
      addressBox.classList.remove('copied');
      copyBtn.innerText = "Copy Address";
    }, 900);
  } catch (err) {
    // Fallback for browsers that don't support clipboard API
    const textArea = document.createElement('textarea');
    textArea.value = LOTTERY_ADDRESS;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    
    addressBox.classList.add('copied');
    copyBtn.innerText = "Copied!";
    setTimeout(() => {
      addressBox.classList.remove('copied');
      copyBtn.innerText = "Copy Address";
    }, 900);
  }
}

copyBtn.addEventListener('click', copyAddress);
addressBox.addEventListener('click', copyAddress);

// Send $POL Button with wallet integration
const sendBtn = document.getElementById('send-btn');
const sendStatus = document.getElementById('send-status');
let sending = false;

sendBtn.addEventListener('click', async () => {
  if (sending) return;
  sending = true;
  sendBtn.classList.remove('success', 'error');
  sendBtn.classList.add('sending');
  sendStatus.innerText = "";
  
  try {
    if (typeof window.ethereum === 'undefined') {
      throw new Error("No wallet detected. Please install MetaMask or another Web3 wallet.");
    }
    
    const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    
    // Check if user is on Polygon network
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x89' }],
        });
      } catch (switchError) {
        // This error code indicates that the chain has not been added to MetaMask
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x89',
              chainName: 'Polygon Mainnet',
              nativeCurrency: {
                name: 'POL',
                symbol: 'POL',
                decimals: 18,
              },
              rpcUrls: ['https://polygon-rpc.com/'],
              blockExplorerUrls: ['https://polygonscan.com/'],
            }],
          });
        } else {
          throw switchError;
        }
      }
    }
    
    const tx = {
      to: LOTTERY_ADDRESS,
      value: ethers.utils.parseUnits(ENTRY_AMOUNT.toString(), POL_DECIMALS),
      gasLimit: 21000 // Standard gas limit for simple transfer
    };
    
    sendBtn.querySelector('span').innerText = "Confirm in Wallet‚Ä¶";
    sendStatus.style.color = "#ffd700";
    sendStatus.innerText = "Please confirm the transaction in your wallet";
    
    const txResponse = await signer.sendTransaction(tx);
    
    sendBtn.querySelector('span').innerText = "Processing‚Ä¶";
    sendStatus.innerText = "Transaction sent! Waiting for confirmation‚Ä¶";
    
    await txResponse.wait(1);
    
    sendBtn.classList.remove('sending');
    sendBtn.classList.add('success');
    sendBtn.querySelector('span').innerText = "Success! You're In üéâ";
    sendStatus.style.color = "var(--success)";
    sendStatus.innerText = "Entry confirmed! Good luck!";
    
    // Refresh the transactions to show the new entry
    setTimeout(() => {
      fetchAndRenderTxs();
    }, 2000);
    
    setTimeout(() => {
      sendBtn.classList.remove('success');
      sendBtn.querySelector('span').innerText = "Send 1 $POL & Enter";
      sendStatus.innerText = "";
    }, 3000);
    
  } catch (error) {
    console.error('Transaction error:', error);
    
    sendBtn.classList.remove('sending');
    sendBtn.classList.add('error');
    sendBtn.querySelector('span').innerText = "Failed! Try Again";
    sendStatus.style.color = "var(--danger)";
    
    let errorMessage = "Transaction failed. Please try again.";
    if (error.message.includes("user rejected")) {
      errorMessage = "Transaction cancelled by user.";
    } else if (error.message.includes("insufficient funds")) {
      errorMessage = "Insufficient funds for transaction.";
    } else if (error.message.includes("No wallet detected")) {
      errorMessage = error.message;
    }
    
    sendStatus.innerText = errorMessage;
    
    setTimeout(() => {
      sendBtn.classList.remove('error');
      sendBtn.querySelector('span').innerText = "Send 1 $POL & Enter";
      sendStatus.innerText = "";
    }, 4000);
  }
  
  sending = false;
});
</script>
</body>
</html>
