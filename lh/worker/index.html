<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Become a LocalHelper - Register to Find Temporary Work Near You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', 'Roboto', 'Arial', sans-serif;
      background: #f6f8fa;
      color: #222;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-size: 10px;
      -webkit-tap-highlight-color: transparent;
      width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      margin: 12px 0 4px 0;
      font-size: 1.22rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: #1976d2;
      text-shadow: 0 2px 8px #0002;
      line-height: 1.18;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .help-icon {
      margin-left: 5px;
      cursor: pointer;
      vertical-align: middle;
      color: #1976d2;
      transition: color 0.15s;
      border-radius: 50%;
      background: #f1f8ff;
      padding: 3px;
      box-shadow: 0 1px 7px #1976d233;
      font-size: 18px !important;
    }
    .help-icon:hover {
      color: #d32f2f;
      background: #e3ecfa;
    }
    .mainbox {
      width: 97vw;
      max-width: 410px;
      margin: 10px auto 0 auto;
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 2px 18px #0001;
      padding: 11px 7px 15px 7px;
      border: 1px solid #e0e5eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .description-helper {
      background: #e3f2fd;
      color: #1976d2;
      font-size: 13px;
      border-radius: 8px;
      padding: 16px 14px 16px 14px;
      margin: 0 0 18px 0;
      text-align: left;
      font-weight: 500;
      line-height: 1.44;
      box-shadow: 0 1px 7px #0001;
      border: 1px solid #1976d2;
    }
    .mapbox {
      width: 100%;
      max-width: 370px;
      height: 41vw;
      max-height: 470px;
      min-height: 120px;
      border: 1px solid #1976d2;
      border-radius: 8px;
      margin-bottom: 9px;
      background: #f8fafc;
      overflow: hidden;
      box-shadow: 0 3px 18px #0001;
      position: relative;
      box-sizing: border-box;
    }
    .legend {
      background: rgba(255,255,255,0.94);
      color: #1976d2;
      padding: 4px 10px 4px 7px;
      border-radius: 7px;
      font-size: 8.5px;
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 1000;
      box-shadow: 0 1px 6px #0001;
      display: flex;
      align-items: center;
      gap: 7px;
      border: 1px solid #e0e5eb;
    }
    .legend-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 3px;
      background: #1976d2;
      box-shadow: 0 0 9px #1976d277,0 1px 2px #0001;
    }
    .location-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 210px;
      margin: 0 auto 10px auto;
      background: linear-gradient(90deg, #1976d2 50%, #43a047 100%);
      color: #fff;
      font-size: 1.07rem;
      font-weight: 700;
      letter-spacing: 1px;
      border: none;
      border-radius: 8px;
      padding: 13px 7px 12px 7px;
      box-shadow: 0 2px 12px #1976d233, 0 1.5px 7px #0001;
      cursor: pointer;
      transition: background 0.13s, transform 0.09s;
      outline: none;
      gap: 7px;
      position: relative;
      z-index: 2;
    }
    .location-btn:active {
      background: linear-gradient(90deg, #43a047 60%, #1976d2 100%);
      transform: scale(0.98);
    }
    .location-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #e0e5eb !important;
      color: #888 !important;
    }
    .form-step-box {
      width: 100%;
      max-width: 330px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 11px;
      padding-left: 5px;
      padding-right: 5px;
      box-sizing: border-box;
    }
    .inputbox {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 12px;
      width: 100%;
      align-items: flex-start;
    }
    label {
      color: #1976d2;
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 11px;
      text-align: left;
    }
    input[type="text"], input[type="email"], textarea, input[type="tel"], input[type="number"] {
      background: #f3f6fa;
      border: 1.2px solid #e0e5eb;
      color: #222;
      border-radius: 7px;
      padding: 10px 9px;
      font-size: 15px;
      margin-bottom: 2px;
      outline: none;
      transition: border 0.1s;
      width: 100%;
      box-sizing: border-box;
      appearance: none;
      caret-color: #1976d2;
    }
    input[type="text"]:focus, input[type="email"]:focus, textarea:focus, input[type="tel"]:focus, input[type="number"]:focus {
      border: 1.6px solid #1976d2;
      background: #fff;
    }
    textarea {
      min-height: 70px;
      max-height: 180px;
      resize: vertical;
      font-size: 15px;
    }
    .btn, button[type="submit"].btn, .submit-btn, .step-btn, .back-btn {
      background: linear-gradient(90deg, #43a047 0%, #1976d2 100%);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 11px 0 10px 0;
      font-size: 1.13rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 9px 0 7px 0;
      box-shadow: 0 2px 9px #43a04744, 0 1.5px 7px #0001;
      width: 100%;
      transition: background 0.13s, transform 0.09s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-height: 34px;
      cursor: pointer;
      outline: none;
      position: relative;
      z-index: 2;
    }
    .btn:active, button[type="submit"].btn:active, .submit-btn:active, .step-btn:active, .back-btn:active {
      background: linear-gradient(90deg, #1976d2 60%, #43a047 100%);
      transform: scale(0.98);
    }
    .btn[disabled], button[type="submit"].btn[disabled], .submit-btn[disabled], .step-btn[disabled], .back-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #e0e5eb !important;
      color: #888 !important;
    }
    .back-btn {
      width: 100%;
      background: linear-gradient(90deg, #e0e5eb 0%, #bdbdbd 100%);
      color: #1976d2;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      margin-top: 2px;
      margin-bottom: 6px;
      box-shadow: 0 1px 4px #0001;
      gap: 5px;
    }
    .info-message {
      color: #1976d2;
      background: #e3f2fd;
      border-radius: 7px;
      padding: 7px 9px;
      margin: 7px 0 0 0;
      font-size: 10.5px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid #1976d2;
    }
    .success-message {
      color: #fff;
      background: #388e3c;
      border: 1px solid #388e3c;
    }
    .popup-help-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.13);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .popup-help {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 2px 18px #0002;
      border: 1.5px solid #1976d2;
      max-width: 340px;
      width: 92vw;
      padding: 23px 15px 19px 15px;
      color: #222;
      font-size: 13px;
      line-height: 1.52;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 7px;
      animation: pop-in 0.22s;
    }
    @keyframes pop-in {
      from {transform: scale(0.88); opacity: 0;}
      to {transform: scale(1); opacity: 1;}
    }
    .popup-help-close {
      position: absolute;
      top: 8px;
      right: 9px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 50%;
      border: none;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.12s;
      padding: 2px 5px 2px 5px;
    }
    .popup-help-close:hover {
      background: #1976d2;
      color: #fff;
    }
    .popup-help-title {
      font-weight: 700;
      font-size: 15px;
      color: #1976d2;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    @media (max-width: 600px) {
      html, body { font-size: 10px; width: 100vw; max-width: 100vw; overflow-x: hidden !important; box-sizing: border-box; }
      h1 { font-size: 1rem; }
      .mainbox { max-width: 99vw; width: 99vw; padding: 6px 1.3vw 13px 1.3vw;}
      .mapbox { max-width: 99vw; width: 99vw; height: 270px; min-height: 90px;}
      .legend { font-size: 8px; top: 4px; left: 4px;}
      .location-btn, .btn, .submit-btn, .step-btn, .back-btn { font-size: 1rem; padding: 11px 7px 10px 7px; }
      input[type="text"], input[type="email"], textarea, input[type="tel"], input[type="number"] { font-size: 13px; }
      #map { width: 100% !important; }
      .form-step-box { max-width: 99vw; }
      .popup-help { max-width: 98vw; font-size: 12px;}
    }
    @media (max-width: 400px) {
      .mainbox, .mapbox { max-width: 100vw; width: 100vw; }
      html, body { padding: 0; margin: 0; }
    }
    .leaflet-container {
      background: #f8fafc !important;
      background-repeat: no-repeat !important;
      background-size: cover !important;
    }
    @media (min-width: 1025px) {
      .mainbox {
        max-width: 800px;
      }
      .mapbox {
        max-width: 560px;
        height: 560px;
      }
      .form-step-box {
        max-width: 500px;
      }
    }
  </style>
</head>
<body>
  <h1>
    <span style="display:inline-flex;align-items:center;">
      <span class="material-icons" style="font-size:15px;color:#1976d2;margin-right:3px;">person_add</span>
      Become a LocalHelper
    </span>
    <span class="material-icons help-icon" id="helpIcon" title="Help">help_outline</span>
  </h1>
  <div class="mainbox">
    <div class="description-helper">
      <span class="material-icons" style="font-size:13px;vertical-align:-2px;color:#1976d2;">info</span>
      Register as a LocalHelper to receive job opportunities near your location.<br>
      <br><span class="material-icons" style="font-size:13px;vertical-align:-2px;color:#1976d2;">attach_money</span>
      <b>Earn $14/hour</b>. Payment is made via <b>PayPal</b>.<br>
      <span class="material-icons" style="font-size:13px;vertical-align:-2px;color:#1976d2;">schedule</span>
      Flexible, temporary jobs in your area.<br>
      <span class="material-icons" style="font-size:13px;vertical-align:-2px;color:#1976d2;">email</span>
      We will contact you as soon as a job opportunity is available and tell you the date and time of job. We will explain the temporary job description before you go to the job. Be on time, payments are done on weekly basis. You will find all details about job in your job <a href="https://sxcd.com" target="_blank">dashboard</a> <br>
    </div>
    <div class="mapbox">
      <div class="legend">
        <span class="legend-dot"></span> Your Location (required for registration)
      </div>
      <div id="map" style="width:100%;height:100%;"></div>
    </div>
    <div id="step1">
      <button class="location-btn" id="shareLocationBtn" type="button">
        <span class="material-icons" style="font-size:15px;">my_location</span>
        SHARE YOUR LOCATION
      </button>
      <div id="locError" class="info-message" style="display:none"></div>
    </div>
    <div id="stepForm" style="display:none;">
      <form id="multiStepForm" autocomplete="off">
        <div class="form-step-box" id="formStepBox"></div>
        <button type="button" class="back-btn" id="backStepBtn" style="display:none;">
          <span class="material-icons" style="font-size:14px;color:#1976d2;">arrow_back</span>
          Back
        </button>
        <button type="button" class="step-btn" id="nextStepBtn">
          <span class="material-icons" style="font-size:13px;">arrow_forward</span>
          Next
        </button>
        <button class="btn submit-btn" type="submit" id="submitStepBtn" style="display:none;">
          <span class="material-icons" style="font-size:13px;">send</span>
          Register
        </button>
      </form>
      <div id="stepFormError" class="info-message" style="display:none"></div>
    </div>
    <div id="step3" style="display:none;">
      <div class="info-message success-message">
        <span class="material-icons" style="font-size:14px;color:#fff;">check_circle</span>
        Thank you for registering as a LocalHelper!<br>
        <span style="font-size:9px;color:#d1fae5;">We will contact you as soon as a job opportunity is available.</span>
      </div>
    </div>
  </div>
  <!-- Help Popup -->
  <div class="popup-help-bg" id="popupHelpBg" style="display:none;">
    <div class="popup-help" id="popupHelp">
      <button class="popup-help-close" id="popupHelpClose" title="Close">
        <span class="material-icons">close</span>
      </button>
      <div class="popup-help-title">
        <span class="material-icons" style="color:#1976d2;font-size:17px;">help_outline</span>
        LocalHelper Registration Instructions
      </div>
      <div>
        <span class="material-icons" style="font-size:13px;color:#1976d2;vertical-align:middle;">my_location</span>
        <b>Step 1:</b> Click "Share Your Location" to provide your current position.<br>
        <span class="material-icons" style="font-size:13px;color:#1976d2;vertical-align:middle;">assignment</span>
        <b>Step 2:</b> Fill in your name, email, and WhatsApp number.<br>
        <span class="material-icons" style="font-size:13px;color:#1976d2;vertical-align:middle;">verified_user</span>
        <b>Step 3:</b> Submit your application. You must have a PayPal account to receive payment.<br>
        <span class="material-icons" style="font-size:13px;color:#1976d2;vertical-align:middle;">attach_money</span>
        Payment rate is <b>$14/hour</b> via PayPal.<br>
        <span class="material-icons" style="font-size:13px;color:#1976d2;vertical-align:middle;">info</span>
        We will contact you via WhatsApp or email when a suitable job is found.<br>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const helpersRef = ref(db, 'localHelpersApplicants');

    let mapHasFitInitial = false;
    const europeSouthWest = L.latLng(34.5, -10.5);
    const europeNorthEast = L.latLng(71.5, 40.0);
    const europeBounds = L.latLngBounds(europeSouthWest, europeNorthEast);
    const europeCenter = [52, 7];

    const map = L.map('map', {
      maxBounds: europeBounds,
      zoomControl: false,
      attributionControl: false
    }).setView(europeCenter, 5);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      minZoom: 5,
      maxZoom: 18,
      bounds: europeBounds,
    }).addTo(map);

    function fitEuropeOnce() {
      if (!mapHasFitInitial) {
        map.fitBounds(europeBounds, { animate: false });
        mapHasFitInitial = true;
      }
    }
    fitEuropeOnce();

    // Blue dot icon for all applicants
    const blueDotIcon = L.divIcon({
      html: '<div style="width:16px;height:16px;background:#1976d2;border-radius:50%;box-shadow:0 0 12px #1976d2cc,0 1.5px 4px #0001;border:2px solid #fff;"></div>',
      iconSize: [16, 16], className: ''
    });

    let userMarker = null;
    let userLocation = null;
    let userEntryLatLng = null;
    let userHelperId = null;

    // Help Popup logic
    const helpIcon = document.getElementById('helpIcon');
    const popupHelpBg = document.getElementById('popupHelpBg');
    const popupHelpClose = document.getElementById('popupHelpClose');
    helpIcon.addEventListener('click', () => {
      popupHelpBg.style.display = "flex";
    });
    popupHelpClose.addEventListener('click', () => {
      popupHelpBg.style.display = "none";
    });
    popupHelpBg.addEventListener('click', e => {
      if (e.target === popupHelpBg) popupHelpBg.style.display = "none";
    });

    function generateHelperId() {
      const prefix = "LH";
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return prefix + code;
    }

    const shareLocationBtn = document.getElementById('shareLocationBtn');
    const step1 = document.getElementById('step1');
    const stepForm = document.getElementById('stepForm');
    const step3 = document.getElementById('step3');
    const multiStepForm = document.getElementById('multiStepForm');
    const formStepBox = document.getElementById('formStepBox');
    const nextStepBtn = document.getElementById('nextStepBtn');
    const backStepBtn = document.getElementById('backStepBtn');
    const submitStepBtn = document.getElementById('submitStepBtn');
    const stepFormError = document.getElementById('stepFormError');
    const locError = document.getElementById('locError');

    let formData = {
      name: "",
      email: "",
      whatsapp: ""
    };
    let currentStep = 0;
    let postedHelperId = null;

    const steps = [
      {
        label: "Full Name",
        type: "text",
        id: "helperName",
        name: "name",
        placeholder: "Your full name",
        maxlength: 50,
        required: true,
        validate: v => v && v.trim().length >= 2,
        error: "Enter your full name (min 2 chars)."
      },
      {
        label: "Email Address",
        type: "email",
        id: "helperEmail",
        name: "email",
        placeholder: "your@email.com",
        maxlength: 70,
        required: true,
        validate: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),
        error: "Enter a valid email address."
      },
      {
        label: "WhatsApp Number",
        type: "text",
        id: "helperWhatsapp",
        name: "whatsapp",
        placeholder: "e.g. +32412345678",
        maxlength: 18,
        required: true,
        validate: v => /^\+?\d{7,18}$/.test(v.replace(/\s/g,"")),
        error: "Enter a valid WhatsApp number (min 7 digits, include country code)."
      }
    ];

    function showStep(stepIdx) {
      formStepBox.innerHTML = "";
      const step = steps[stepIdx];
      let inputEl;
      inputEl = document.createElement("input");
      inputEl.type = step.type;
      inputEl.id = step.id;
      inputEl.name = step.name;
      inputEl.placeholder = step.placeholder || "";
      inputEl.required = step.required;
      inputEl.style.marginBottom = "2px";
      inputEl.value = formData[step.name] || "";
      if (step.maxlength) inputEl.maxLength = step.maxlength;

      formStepBox.appendChild(createLabel(step.label, step.id));
      formStepBox.appendChild(inputEl);

      stepFormError.style.display = "none";
      nextStepBtn.style.display = stepIdx < steps.length - 1 ? "" : "none";
      submitStepBtn.style.display = stepIdx === steps.length - 1 ? "" : "none";
      backStepBtn.style.display = stepIdx > 0 ? "" : "none";
      setTimeout(() => { inputEl.focus(); }, 180);
    }

    function createLabel(text, forId) {
      const lbl = document.createElement("label");
      lbl.setAttribute("for", forId);
      lbl.textContent = text + ":";
      return lbl;
    }

    shareLocationBtn.addEventListener('click', () => {
      locError.style.display = "none";
      shareLocationBtn.disabled = true;
      if (!navigator.geolocation) {
        locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Geolocation not supported.';
        locError.style.display = "";
        shareLocationBtn.disabled = false;
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            timestamp: Date.now(),
            userAgent: navigator.userAgent
          };
          userEntryLatLng = [userLocation.lat, userLocation.lng];
          if (userMarker) map.removeLayer(userMarker);
          // Don't show popup yet, wait for registration to finish.
          userMarker = L.marker(userEntryLatLng, { icon: blueDotIcon }).addTo(map);
          map.setView(userEntryLatLng, 14, { animate: true });
          step1.style.display = "none";
          stepForm.style.display = "";
          currentStep = 0;
          showStep(currentStep);
        },
        (err) => {
          locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Unable to get location: ' + (err.message || "Permission denied.");
          locError.style.display = "";
          shareLocationBtn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    });

    nextStepBtn.addEventListener("click", () => {
      const step = steps[currentStep];
      const inputValue = multiStepForm[step.name].value.trim();
      if (!step.validate(inputValue)) {
        stepFormError.innerHTML = `<span class="material-icons" style="font-size:12px;">warning</span> ${step.error}`;
        stepFormError.style.display = "";
        return;
      }
      formData[step.name] = inputValue;
      currentStep += 1;
      showStep(currentStep);
    });

    backStepBtn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep -= 1;
        showStep(currentStep);
      }
    });

    multiStepForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const step = steps[currentStep];
      const inputValue = multiStepForm[step.name].value.trim();
      if (!step.validate(inputValue)) {
        stepFormError.innerHTML = `<span class="material-icons" style="font-size:12px;">warning</span> ${step.error}`;
        stepFormError.style.display = "";
        return;
      }
      formData[step.name] = inputValue;
      if (!userLocation) {
        stepFormError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Location missing. Please start again.';
        stepFormError.style.display = "";
        return;
      }
      try {
        postedHelperId = generateHelperId();
        userHelperId = postedHelperId; // Save for popup
        const entry = {
          ...userLocation,
          helperId: postedHelperId,
          name: formData.name,
          email: formData.email,
          whatsapp: formData.whatsapp
        };
        await push(helpersRef, entry);
        stepForm.style.display = "none";
        step3.style.display = "";
        setTimeout(() => { step3.querySelector('.info-message').scrollIntoView({behavior: 'smooth', block: 'center'}); }, 200);

        // Show popup on user's marker
        if (userMarker) {
          userMarker.bindPopup(`
            <div style="font-size:13px;color:#222;">
              <div style="font-weight:700;color:#1976d2;display:flex;align-items:center;gap:6px;">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;color:#1976d2;">badge</span>
                Worker ID: ${userHelperId}
              </div>
            </div>
          `).openPopup();
        }
      } catch (err) {
        stepFormError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Failed to register. Please try again.';
        stepFormError.style.display = "";
      }
    });

    // Show all applicants on the map (as blue dots, only show Worker ID in popup)
    onValue(helpersRef, (snapshot) => {
      // Remove all applicant markers except the user marker
      map.eachLayer(layer => {
        if (layer instanceof L.Marker && layer !== userMarker) {
          map.removeLayer(layer);
        }
      });
      const data = snapshot.val();
      if (!data) return;
      Object.values(data).forEach(point => {
        if (!point.lat || !point.lng || !point.helperId) return;
        // Don't double place user's own marker (based on ID)
        if (userHelperId && point.helperId === userHelperId) {
          return;
        }
        const popupHtml = `
          <div style="font-size:13px;color:#222;">
            <div style="font-weight:700;color:#1976d2;display:flex;align-items:center;gap:6px;">
              <span class="material-icons" style="font-size:16px;vertical-align:middle;color:#1976d2;">badge</span>
              Worker ID: ${point.helperId}
            </div>
          </div>
        `;
        L.marker([point.lat, point.lng], { icon: blueDotIcon })
          .addTo(map)
          .bindPopup(popupHtml, {
            closeButton: true, minWidth: 120, maxWidth: 220, autoClose: true, closeOnClick: true, className: ''
          });
      });
      // If user marker exists and registered, show popup with Worker ID
      if (userMarker && userHelperId) {
        userMarker.bindPopup(`
          <div style="font-size:13px;color:#222;">
            <div style="font-weight:700;color:#1976d2;display:flex;align-items:center;gap:6px;">
              <span class="material-icons" style="font-size:16px;vertical-align:middle;color:#1976d2;">badge</span>
              Worker ID: ${userHelperId}
            </div>
          </div>
        `);
      }
    });

    window.addEventListener('resize', () => {
      setTimeout(() => { map.invalidateSize(); }, 400);
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => { map.invalidateSize(); }, 300);
    });
  </script>
</body>
</html>
