<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>LEUVENFLYERS â€“ Campaign XX101 (Map)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Icons+Outlined&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    /* ---------------- Root Theme Tokens (Neutral Professional) ---------------- */
    :root{
      --brand:#0e3450;
      --brand-alt:#133d5d;
      --accent:#2563eb;
      --accent-alt:#1d4ed8;
      --accent-soft:#eff6ff;
      --success:#1e8e46;
      --warning:#e4a400;
      --danger:#c62828;
      --danger-soft:#fde7e7;
      --ink-900:#0f1a22;
      --ink-800:#1d2c35;
      --ink-700:#2f4451;
      --ink-600:#4a5d69;
      --ink-500:#667883;
      --ink-400:#8b99a2;
      --ink-300:#b5c0c7;
      --ink-200:#d6dde1;
      --ink-100:#e9eef1;
      --ink-050:#f5f7f9;
      --surface:#ffffff;
      --surface-elev:#ffffffcc;
      --panel-border:rgba(15,26,34,0.08);
      --radius-xs:4px;
      --radius-sm:6px;
      --radius-md:10px;
      --radius-lg:14px;
      --shadow-sm:0 1px 2px rgba(15,26,34,0.06),0 1px 3px rgba(15,26,34,0.1);
      --shadow-md:0 4px 10px -2px rgba(15,26,34,.12),0 2px 4px rgba(15,26,34,.08);
      --shadow-focus:0 0 0 3px rgba(37,99,235,0.35);
      --focus-ring:0 0 0 3px rgba(37,99,235,0.45);
      --transition:140ms cubic-bezier(.4,0,.2,1);
      --footer-h:32px;
    }

    .theme-dark{
      --surface:#161e23;
      --surface-elev:#1d272dcc;
      --panel-border:rgba(255,255,255,0.08);
      --ink-900:#eef4f7;
      --ink-800:#d7e1e7;
      --ink-700:#b9c5cc;
      --ink-600:#9aa8b0;
      --ink-500:#7a8992;
      --ink-400:#66747c;
      --ink-300:#4d5a61;
      --ink-200:#3a454b;
      --ink-100:#2b3439;
      --ink-050:#20282d;
      --accent-soft:#1e3966;
      --danger-soft:#462427;
      --shadow-sm:0 1px 2px rgba(0,0,0,0.4),0 1px 3px rgba(0,0,0,0.55);
      --shadow-md:0 6px 18px -4px rgba(0,0,0,.55),0 2px 6px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{
      width:100%;height:100%;overflow:hidden;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      font-size:12px;line-height:1.35;
      background:var(--ink-050);color:var(--ink-700);
      -webkit-font-smoothing:antialiased;
    }
    body{display:flex;flex-direction:column;}

    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* ---------------- Top Bar ---------------- */
    .topbar{
      position:fixed;inset:0 0 auto 0;height:52px;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;
      background:linear-gradient(90deg,var(--brand) 0%,var(--brand-alt) 80%);
      color:#fff;
      z-index:600;
      box-shadow:0 2px 6px -2px rgba(0,0,0,.35);
    }
    .topbar-left{display:flex;align-items:center;gap:12px;}
    .app-title{font-size:13px;font-weight:600;letter-spacing:.35px;display:flex;align-items:center;gap:8px;}
    .app-title .badge{
      background:rgba(255,255,255,0.14);padding:2px 8px;
      border-radius:999px;font-size:10px;font-weight:500;
      letter-spacing:.4px;
    }

    .topbar-right{display:flex;align-items:center;gap:12px;}

    .metric-chip{
      display:flex;align-items:center;gap:6px;
      background:rgba(255,255,255,0.14);
      padding:6px 10px;border-radius:var(--radius-md);
      font-size:11px;font-weight:500;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.18);
    }
    .metric-chip .material-icons-outlined{font-size:15px;opacity:.9;}
    .metric-chip .value{font-weight:600;}

    button.icon-btn{
      background:rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      width:34px;height:34px;
      display:flex;align-items:center;justify-content:center;
      border-radius:var(--radius-md);
      cursor:pointer;
      transition:var(--transition);
      backdrop-filter:blur(8px);
      position:relative;
    }
    button.icon-btn:hover{background:rgba(255,255,255,0.22);}
    button.icon-btn:active{background:rgba(255,255,255,0.28);}
    button.icon-btn:focus-visible{outline:none;box-shadow:var(--focus-ring);}

    .notif-badge{
      position:absolute;top:4px;right:4px;
      background:var(--danger);color:#fff;
      font-size:9px;padding:1px 5px;border-radius:999px;
      font-weight:600;display:none;
      line-height:1;
      box-shadow:0 0 0 1px rgba(0,0,0,.25);
    }

    /* Theme Toggle */
    .theme-select{
      background:rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      height:34px;
      border-radius:var(--radius-md);
      padding:0 10px;
      font-size:11px;
      font-weight:500;
      cursor:pointer;
      backdrop-filter:blur(8px);
      appearance:none;
      transition:var(--transition);
    }
    .theme-select:focus-visible{outline:none;box-shadow:var(--focus-ring);}
    .theme-select:hover{background:rgba(255,255,255,0.22);}

    /* ---------------- Notifications Dropdown ---------------- */
    .notifications{
      position:absolute;top:52px;right:12px;
      width:280px;max-height:62vh;
      background:var(--surface-elev);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-md);
      backdrop-filter:blur(12px) saturate(140%);
      display:none;flex-direction:column;
      overflow:hidden;
      animation:dropIn .18s ease;
      z-index:650;
    }
    @keyframes dropIn{from{transform:translateY(-6px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .notif-header{
      padding:10px 14px 6px;
      font-size:11px;font-weight:600;letter-spacing:.4px;
      color:var(--accent);
      background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);
    }
    .notif-list{overflow-y:auto;flex:1;}
    .notif-item{
      display:flex;gap:10px;
      padding:10px 14px;
      font-size:11px;
      border-top:1px solid rgba(0,0,0,0.04);
      cursor:pointer;
      align-items:flex-start;
      transition:var(--transition);
      background:transparent;
    }
    .notif-item:first-child{border-top:none;}
    .notif-item:hover{background:var(--ink-050);}
    .theme-dark .notif-item:hover{background:#26323866;}
    .notif-item:active{background:var(--accent-soft);}
    .notif-icon{
      width:24px;height:24px;border-radius:6px;
      background:var(--accent-soft);
      display:flex;align-items:center;justify-content:center;
      color:var(--accent);
      flex-shrink:0;
      font-size:15px;
    }
    .theme-dark .notif-icon{background:#1e3966;color:#9cc6ff;}
    .notif-msg{flex:1;color:var(--ink-600);line-height:1.3;}
    .theme-dark .notif-msg{color:var(--ink-500);}
    .notif-item[data-zone]::after{
      content:"View";
      font-size:9px;font-weight:600;color:var(--accent);
      align-self:center;margin-left:6px;opacity:.55;
    }
    .notif-item[data-zone]:hover::after{opacity:1;}
    .notif-empty{padding:18px 14px;font-size:11px;color:var(--ink-500);}
    .notif-footer{
      padding:6px 12px 8px;
      font-size:10px;color:var(--ink-400);
      text-align:right;border-top:1px solid rgba(0,0,0,0.05);
    }

    /* ---------------- Map Area ---------------- */
    #map{
      position:absolute;
      top:52px;left:0;right:0;bottom:var(--footer-h);
      background:#ffffff;
    }
    /* Dim / neutralize bright map tiles */
    .map-visual-dimmer .leaflet-tile{
      filter:brightness(.92) saturate(.9) contrast(1.02) hue-rotate(-4deg);
      transition:filter .4s ease;
    }
    /* When zoomed in more detail -> slightly raise brightness */
    .map-visual-dimmer.zoomed-in .leaflet-tile{
      filter:brightness(.97) saturate(.98) contrast(1.03);
    }

    .leaflet-control-zoom{
      margin-top:64px!important;
      border:1px solid var(--panel-border)!important;
      box-shadow:var(--shadow-sm)!important;
    }
    .leaflet-control-zoom a{
      background:var(--surface)!important;
      color:var(--ink-700)!important;
      transition:var(--transition);
      border:none!important;
    }
    .leaflet-control-zoom a:hover{
      background:var(--ink-050)!important;
    }
    .theme-dark .leaflet-control-zoom a{
      background:#243038!important;
      color:#f0f4f6!important;
    }
    .theme-dark .leaflet-control-zoom a:hover{
      background:#2e3b44!important;
    }

    /* ---------------- Zone Labels ---------------- */
    .leaflet-div-icon.zone-label-wrapper{
      background:transparent!important;border:none!important;
    }

    .zone-label{
      background:rgba(255,255,255,0.62);
      backdrop-filter:blur(9px) saturate(160%);
      -webkit-backdrop-filter:blur(9px) saturate(160%);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:10px;
      width:92px;
      padding:6px 7px 7px;
      font-size:9px;
      font-weight:500;
      line-height:1.28;
      color:var(--ink-700);
      display:flex;flex-direction:column;gap:4px;
      box-shadow:0 2px 8px -2px rgba(0,0,0,.2);
      position:relative;
    }
    .theme-dark .zone-label{
      background:rgba(29,38,45,0.58);
      border:1px solid rgba(255,255,255,0.08);
      color:#e3edf2;
    }

    .zl-row{display:flex;justify-content:space-between;align-items:center;gap:4px;}
    .zl-id{display:flex;align-items:center;gap:3px;font-weight:600;text-transform:uppercase;}
    .zl-id .material-icons-outlined{font-size:12px;color:var(--accent);opacity:.9;}
    .theme-dark .zl-id .material-icons-outlined{color:#91befb;}
    .zl-flyers{display:flex;align-items:center;gap:2px;color:var(--ink-500);font-weight:500;}
    .zl-flyers .material-icons-outlined{font-size:12px;color:var(--accent);opacity:.55;}
    .theme-dark .zl-flyers{color:#b0c0c8;}

    .zl-status{
      display:inline-flex;align-items:center;gap:3px;
      font-size:8px;font-weight:700;letter-spacing:.5px;
      padding:3px 6px;border-radius:8px;
      text-transform:uppercase;
      max-width:fit-content;
      box-shadow:0 1px 2px rgba(0,0,0,0.18);
      color:#fff;
    }
    .zl-status .material-icons-outlined{font-size:10px;}

    .status-completed{background:linear-gradient(135deg,#22803a,#35a551);}
    .status-inprogress{background:linear-gradient(135deg,#f2ad09,#ffd54f);color:#222;}
    .status-pending{background:linear-gradient(135deg,#d1393d,#ef6a6d);}

    .zl-gps{
      display:inline-flex;align-items:center;gap:3px;
      background:linear-gradient(135deg,#1976d2,#4094f0);
      color:#fff;border-radius:999px;
      padding:3px 8px;font-size:8px;font-weight:600;
      letter-spacing:.5px;text-decoration:none;
      box-shadow:0 2px 6px -2px rgba(0,0,0,.3);
      transition:var(--transition);
    }
    .zl-gps:hover{background:linear-gradient(135deg,#1f7fe0,#61a9fa);transform:translateY(-1px);}
    .zl-gps .material-icons-outlined{font-size:11px;}

    /* Focus flash */
    @keyframes zoneFlash{
      0%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(37,99,235,0));}
      40%{stroke-width:4;filter:drop-shadow(0 0 6px rgba(37,99,235,.85));}
      100%{stroke-width:1;filter:drop-shadow(0 0 0 rgba(37,99,235,0));}
    }
    .leaflet-interactive.flash-highlight{animation:zoneFlash 1.4s ease-in-out 1;}

    /* ---------------- Footer ---------------- */
    .footer{
      position:fixed;left:0;right:0;bottom:0;height:var(--footer-h);
      background:var(--surface-elev);
      backdrop-filter:blur(10px);
      border-top:1px solid var(--panel-border);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;font-size:10.5px;
      color:var(--ink-500);
      z-index:560;
      letter-spacing:.35px;
    }
    .footer .left{display:flex;align-items:center;gap:6px;font-weight:600;color:var(--ink-700);}
    .footer .left .material-icons-outlined{font-size:14px;color:var(--accent);}
    .footer .right{display:flex;align-items:center;gap:6px;}
    .footer .right .material-icons-outlined{font-size:14px;color:var(--accent);}
    .theme-dark .footer{color:#98a8b1;}
    .theme-dark .footer .left{color:#e2ecf1;}

    /* ---------------- Modal ---------------- */
    .modal{
      display:none;position:fixed;inset:0;z-index:900;
      background:rgba(0,0,0,.55);
      align-items:center;justify-content:center;
      backdrop-filter:blur(4px);
    }
    .modal-content{
      background:var(--surface);
      border-radius:16px;
      padding:12px 12px 8px;
      box-shadow:0 18px 42px -10px rgba(0,0,0,.35),0 0 0 1px var(--panel-border);
      max-width:92vw;max-height:92vh;
      position:relative;
      display:flex;flex-direction:column;gap:8px;
    }
    .modal-content img{max-width:85vw;max-height:75vh;border-radius:12px;box-shadow:var(--shadow-md);}
    .modal-close{
      position:absolute;top:6px;right:8px;
      background:var(--danger-soft);border:none;
      color:var(--danger);width:30px;height:30px;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;border-radius:10px;
      cursor:pointer;transition:var(--transition);
    }
    .modal-close:hover{filter:brightness(1.05);}
    .modal-close:focus-visible{outline:none;box-shadow:var(--focus-ring);}

    /* ---------------- Misc ---------------- */
    .material-icons-outlined{font-family:'Material Icons Outlined',sans-serif;line-height:1;}

    ::-webkit-scrollbar{width:10px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{
      background:var(--ink-200);border-radius:10px;
      border:2px solid transparent;background-clip:padding-box;
    }
    .theme-dark ::-webkit-scrollbar-thumb{background:#3d4a52;border:2px solid #1d272d;}
    ::-webkit-scrollbar-thumb:hover{background:var(--ink-300);}

    @media (max-width:640px){
      .metric-chip{display:none;}
      .notifications{width:90vw;}
      .zone-label{transform:scale(.94);transform-origin:center;}
      #map{top:52px;}
    }
  </style>
</head>
<body class="theme-neutral">

  <!-- Top Bar -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="app-title">
        <span class="material-icons-outlined" style="font-size:18px;">map</span>
        LEUVENFLYERS <span class="badge">Campaign XX101</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="metric-chip" title="Total Flyers">
        <span class="material-icons-outlined">inventory_2</span>
        <span class="value" id="flyersTotal">0</span>
      </div>
      <div class="metric-chip" title="Completed / Verified Flyers">
        <span class="material-icons-outlined">task_alt</span>
        <span class="value" id="flyersDistributed">0</span>
      </div>
      <div class="metric-chip qr-counter" id="qrCounter" style="cursor:pointer;" title="QR Scan Count">
        <span class="material-icons-outlined">qr_code_scanner</span>
        <span class="value" id="qrScanCount">0</span>
      </div>

      <select id="themeSelect" class="theme-select" aria-label="Theme">
        <option value="neutral" selected>Neutral</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>

      <button id="notifBtn" class="icon-btn" aria-label="Notifications">
        <span class="material-icons-outlined">notifications</span>
        <span id="notifBadge" class="notif-badge"></span>
      </button>
    </div>
  </header>

  <!-- Notifications -->
  <div id="notificationsPanel" class="notifications" role="dialog" aria-label="Notifications">
    <div class="notif-header">Notifications</div>
    <div id="notifList" class="notif-list"></div>
    <div id="notifFooter" class="notif-footer"></div>
  </div>

  <!-- Map -->
  <div id="map" class="map-visual-dimmer" aria-label="Distribution Map"></div>

  <!-- Footer -->
  <footer class="footer">
    <div class="left">
      <span class="material-icons-outlined">flag</span>
      <span>Campaign ID: <strong>XX101</strong></span>
    </div>
    <div class="right">
      <span class="material-icons-outlined">zoom_in</span>
      <span>Zoom in to inspect progress & proofs</span>
    </div>
  </footer>

  <!-- Modal -->
  <div id="imgModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <button id="modalCloseBtn" class="modal-close" aria-label="Close preview">&times;</button>
      <img id="modalImg" alt="Proof preview">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* ---- Firebase Configs ---- */
    const campaignFirebaseConfig = {
      apiKey:"AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain:"trackingclients.firebaseapp.com",
      projectId:"trackingclients",
      storageBucket:"trackingclients.appspot.com",
      messagingSenderId:"27490943622",
      appId:"1:27490943622:web:d6c87547aa5df440508707",
      databaseURL:"https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const polygonsFirebaseConfig = {
      apiKey:"AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain:"nftfanactive.firebaseapp.com",
      databaseURL:"https://nftfanactive-default-rtdb.firebaseio.com",
      projectId:"nftfanactive",
      storageBucket:"nftfanactive.appspot.com",
      messagingSenderId:"311309982791",
      appId:"1:311309982791:web:3e55bba6b78feb57ea6562",
      measurementId:"G-3TRDL9749N"
    };

    const app = initializeApp(campaignFirebaseConfig);
    const db = getDatabase(app);
    const polygonsApp = initializeApp(polygonsFirebaseConfig,'polygonsApp');
    const polygonsDb = getDatabase(polygonsApp);

    /* ---- DOM Refs ---- */
    const flyersTotalEl = document.getElementById('flyersTotal');
    const flyersDistributedEl = document.getElementById('flyersDistributed');
    const qrScanCountEl = document.getElementById('qrScanCount');
    const qrCounter = document.getElementById('qrCounter');
    const notifBtn = document.getElementById('notifBtn');
    const notifPanel = document.getElementById('notificationsPanel');
    const notifList = document.getElementById('notifList');
    const notifBadge = document.getElementById('notifBadge');
    const notifFooter = document.getElementById('notifFooter');
    const themeSelect = document.getElementById('themeSelect');

    /* ---- State ---- */
    const TOTAL_FLYERS = 20000;
    flyersTotalEl.textContent = TOTAL_FLYERS.toLocaleString();
    let map;
    let polygonLayers = [];
    let labelMarkers = [];
    let proofMarkers = [];
    let zoneData = [];
    let qrScans = [];
    let notificationsArr = [];
    const completedNotified = new Set();

    /* ---- Theme Handling ---- */
    function applyTheme(value){
      document.body.classList.remove('theme-light','theme-dark','theme-neutral');
      if(value==='dark') document.body.classList.add('theme-dark');
      else if(value==='light') document.body.classList.add('theme-neutral'); // neutral & light similar
      else document.body.classList.add('theme-neutral');
    }
    themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value));

    /* ---- Notifications ---- */
    function addNotification(icon, message, key){
      if(key && notificationsArr.some(n=>n.key===key)) return;
      const zoneMatch = /Zone\s+(\d+)/i.exec(message);
      const zoneNum = zoneMatch? parseInt(zoneMatch[1],10) : null;
      notificationsArr.unshift({
        key: key || ('k_'+Date.now()+'_'+Math.random().toString(36).slice(2)),
        icon, message, zone: zoneNum, ts: Date.now()
      });
      renderNotifications();
    }

    function renderNotifications(){
      notifList.innerHTML='';
      if(!notificationsArr.length){
        notifList.innerHTML = '<div class="notif-empty">No notifications yet.</div>';
        notifFooter.textContent = '';
        notifBadge.style.display='none';
        return;
      }
      notificationsArr.slice(0,60).forEach(n=>{
        const item = document.createElement('div');
        item.className='notif-item';
        if(n.zone) item.dataset.zone = n.zone;
        item.innerHTML = `
          <div class="notif-icon"><span class="material-icons-outlined">${n.icon}</span></div>
          <div class="notif-msg">${n.message}</div>
        `;
        item.addEventListener('click',()=>{
          if(n.zone) focusZone(n.zone);
          notifPanel.style.display='none';
        });
        notifList.appendChild(item);
      });
      notifBadge.textContent = notificationsArr.length;
      notifBadge.style.display='inline-block';
      notifFooter.textContent = notificationsArr.length + ' notifications';
    }

    notifBtn.addEventListener('click', e=>{
      e.stopPropagation();
      const open = notifPanel.style.display==='flex';
      notifPanel.style.display = open ? 'none':'flex';
      if(!open) renderNotifications();
    });
    document.addEventListener('click', e=>{
      if(!notifPanel.contains(e.target) && !notifBtn.contains(e.target)){
        notifPanel.style.display='none';
      }
    });

    /* ---- Map Init ---- */
    document.addEventListener('DOMContentLoaded', () =>{
      applyTheme('neutral');

      map = L.map('map',{ zoomControl:true, attributionControl:false })
        .setView([50.85,4.35],13);

      // Professional subtle base (Carto Positron - neutral; filtered by CSS)
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        { maxZoom:20, attribution:'&copy; OpenStreetMap & CARTO' }
      ).addTo(map);

      map.on('zoomend',()=>{
        const z = map.getZoom();
        const dimmer = document.getElementById('map');
        if(z >= 15) dimmer.classList.add('zoomed-in');
        else dimmer.classList.remove('zoomed-in');
      });

      loadPolygons().then(()=>{
        listenZoneStatuses();
        listenProofs();
      });
      listenQrScans();
    });

    /* ---- Polygons ---- */
    async function loadPolygons(){
      try{
        const snap = await get(ref(polygonsDb,'polygons'));
        if(!snap.exists()) return;
        polygonLayers.forEach(p=>map.removeLayer(p));
        polygonLayers=[];
        labelMarkers.forEach(m=>map.removeLayer(m));
        labelMarkers=[];

        let allCoords=[];
        let i=0;
        snap.forEach(child=>{
          const arr = child.val();
            if(!Array.isArray(arr)) return;
          const coords = arr.map(p=>[p.lat,p.lng]);
          const poly = L.polygon(coords,{
            color:'#1976d2', weight:1,
            fillColor:'#2196f3', fillOpacity:.28
          }).addTo(map);
          poly.bindPopup(`<div>Zone ${i+1}<br/>Loading...</div>`);
          polygonLayers.push(poly);
          allCoords = allCoords.concat(coords);

          const center = poly.getBounds().getCenter();
          const labelMarker = L.marker(center,{
            icon:L.divIcon({
              className:'zone-label-wrapper',
              html: initialLabelHtml(i+1),
              iconSize:[92,64],
              iconAnchor:[46,32]
            }),
            interactive:false
          }).addTo(map);
          labelMarkers.push(labelMarker);
          i++;
        });
        if(allCoords.length){
          map.fitBounds(L.latLngBounds(allCoords).pad(0.12));
        }
      }catch(err){
        console.error('Polygon load error', err);
      }
    }

    function initialLabelHtml(zone){
      return `
        <div class="zone-label">
          <div class="zl-row">
            <div class="zl-id"><span class="material-icons-outlined">layers</span>${zone}</div>
            <div class="zl-flyers"><span class="material-icons-outlined">mail</span>-</div>
          </div>
          <div class="zl-status status-pending">
            <span class="material-icons-outlined">hourglass_empty</span><span>Pend</span>
          </div>
        </div>
      `;
    }

    function safeInt(v){
      const n = parseInt(v);
      return isNaN(n) ? 0 : n;
    }

    function statusMeta(status){
      switch(status){
        case 'completed': return {text:'Done', short:'Done', cls:'status-completed', color:'#2e7d32', icon:'task_alt'};
        case 'inprogress': return {text:'Active', short:'Actv', cls:'status-inprogress', color:'#f9a825', icon:'play_arrow'};
        default: return {text:'Pending', short:'Pend', cls:'status-pending', color:'#d32f2f', icon:'hourglass_empty'};
      }
    }

    function buildLabelHtml(zoneNum, flyers, meta, gpsLink){
      return `
        <div class="zone-label">
          <div class="zl-row">
            <div class="zl-id" title="Zone ${zoneNum}">
              <span class="material-icons-outlined">layers</span>${zoneNum}
            </div>
            <div class="zl-flyers" title="Flyers">${flyers || '-'}
              <span class="material-icons-outlined">mail</span>
            </div>
          </div>
          <div class="zl-status ${meta.cls}" title="${meta.text}">
            <span class="material-icons-outlined">${meta.icon}</span><span>${meta.short}</span>
          </div>
          ${gpsLink ? `<a class="zl-gps" href="${gpsLink}" target="_blank" rel="noopener">
              <span class="material-icons-outlined">assistant_navigation</span><span>GPS</span>
            </a>` : ''}
        </div>
      `;
    }

    function listenZoneStatuses(){
      onValue(ref(db,'campaigns/XX101/zone_statuses'), snap=>{
        const val = snap.val();
        let zones=[];
        if(Array.isArray(val)) zones=val;
        else if(val && typeof val === 'object') zones=Object.values(val);
        zoneData = zones;
        updateZonesVisual();
      });
    }

    function updateZonesVisual(){
      let distributed=0;
      zoneData.forEach((z,i)=>{
        if(!polygonLayers[i]) return;
        const flyers = safeInt(z.flyers);
        if(z.status==='completed') distributed += flyers;

        const meta = statusMeta(z.status);
        polygonLayers[i].setStyle({
          fillColor: meta.color,
          fillOpacity:.40,
          color:'#1976d2',
          weight:1
        });

        const zoneNum = i+1;
        const gpsLink = z.gpsProof || z.gpsUrl;
        const proofImage = z.proofImage;

        if(z.status==='completed' && !completedNotified.has(i)){
          completedNotified.add(i);
          addNotification('task_alt',`Zone ${zoneNum} completed!`,`zone-${zoneNum}-done`);
        }

        let popupHTML = `
          <div style="text-align:center;">
            <strong style="display:flex;justify-content:center;align-items:center;gap:4px;color:#0e3450;font-size:12px;">
              <span class="material-icons-outlined" style="font-size:14px;color:#1976d2;">layers</span>
              Zone ${zoneNum}
            </strong>
            <div style="margin-top:6px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">mail</span>
                Flyers: <strong>${flyers || '-'}</strong>
              </span>
            </div>
            <div style="margin-top:4px;color:#2f4451;font-size:11px;">
              <span style="display:inline-flex;align-items:center;gap:4px;">
                <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">info</span>
                Status: <strong>${meta.text}</strong>
              </span>
            </div>
        `;
        if(gpsLink){
          popupHTML += `
            <div style="margin-top:8px;">
              <a href="${gpsLink}" target="_blank" rel="noopener"
                 style="background:#1976d2;color:#fff;font-size:10px;padding:5px 12px;border-radius:18px;
                        display:inline-flex;align-items:center;gap:6px;text-decoration:none;
                        box-shadow:0 2px 6px -2px rgba(0,0,0,.25);">
                <span class="material-icons-outlined" style="font-size:14px;">assistant_navigation</span>GPS Route
              </a>
            </div>
          `;
        }
        if(proofImage){
          popupHTML += `
            <div style="margin-top:10px;">
              <img src="${proofImage}" alt="Proof" class="popup-img-thumb" data-proof="${proofImage}"
                   style="max-width:90px;border-radius:8px;cursor:pointer;border:1px solid #d9e2e8;">
            </div>
          `;
        }
        popupHTML += `</div>`;
        polygonLayers[i].bindPopup(popupHTML);

        if(labelMarkers[i]){
          labelMarkers[i].setIcon(L.divIcon({
            className:'zone-label-wrapper',
            html: buildLabelHtml(zoneNum, flyers, meta, gpsLink),
            iconSize:[92, gpsLink ? 82 : 64],
            iconAnchor:[46, gpsLink ? 41 : 32]
          }));
        }
      });
      flyersDistributedEl.textContent = distributed.toLocaleString();
    }

    /* ---- Focus Zone (notification click) ---- */
    window.focusZone = function(zone){
      const idx = zone - 1;
      const poly = polygonLayers[idx];
      if(!poly) return;
      const bounds = poly.getBounds();
      map.fitBounds(bounds.pad(0.4));
      setTimeout(()=>{
        map.flyTo(bounds.getCenter(), Math.max(map.getZoom(), 15), {duration:.55});
        poly.fire('click');
        const path = poly._path;
        if(path){
          path.classList.add('flash-highlight');
          setTimeout(()=>path.classList.remove('flash-highlight'),1400);
        }
      },350);
    };

    /* ---- Proof Pins ---- */
    function listenProofs(){
      onValue(ref(db,'campaigns/XX101/proofs'), snap=>{
        proofMarkers.forEach(m=>map.removeLayer(m));
        proofMarkers=[];
        const val = snap.val();
        if(!val) return;
        for(const k in val){
          const p = val[k];
          if(typeof p.lat==='number' && typeof p.lng==='number' && p.url){
            const iconHtml = `
              <span class="material-icons-outlined" style="display:block;font-size:16px;color:#1976d2;
                text-shadow:0 0 4px #fff;margin-bottom:2px;">photo_camera</span>
              <img src="${p.url}" alt="Proof" style="width:30px;height:30px;object-fit:cover;border-radius:8px;
                border:2px solid #1976d2;box-shadow:0 2px 6px -2px rgba(0,0,0,.35);" />
            `;
            const icon = L.divIcon({
              html:iconHtml,
              className:'custom-img-pin',
              iconSize:[36,48],
              iconAnchor:[18,44]
            });
            const marker = L.marker([p.lat,p.lng],{icon}).addTo(map);
            marker.bindPopup(`
              <div style="text-align:center;">
                <img src="${p.url}" class="popup-img-thumb" data-proof="${p.url}" style="max-width:100px;border-radius:10px;
                  border:1px solid #d9e2e8;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.15);" alt="Proof">
                ${p.timestamp ? `<div style="margin-top:6px;font-size:10px;color:#4a5d69;display:flex;gap:4px;justify-content:center;align-items:center;">
                  <span class="material-icons-outlined" style="font-size:12px;color:#1976d2;">schedule</span>
                  ${formatDateTime(p.timestamp)}
                </div>`:''}
              </div>
            `);
            marker.on('popupopen',()=>{
              setTimeout(()=>{
                const img = document.querySelector('.leaflet-popup .popup-img-thumb[data-proof]');
                if(img) img.addEventListener('click',()=>showModal(p.url));
              },60);
            });
            proofMarkers.push(marker);
          }
        }
      });
    }

    /* ---- QR Scans ---- */
    function listenQrScans(){
      onValue(ref(db,'qr_scans'), snap=>{
        qrScans=[];
        const val = snap.val();
        if(val){
          for(const k in val){
            const s = val[k];
            if(s.promoCode === 'XX101') qrScans.push({...s,id:k});
          }
          qrScans.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
        }
        qrScanCountEl.textContent = qrScans.length.toString();
      });

      qrCounter.addEventListener('click',()=>{
        if(!qrScans.length){alert('No scans yet.');return;}
        alert('QR Scans:\\n' + qrScans.map((s,i)=>{
          const t = s.timestamp ? formatDateTime(s.timestamp) : 'n/a';
          return `#${i+1} - ${t}`;
        }).join('\\n'));
      });
    }

    function formatDateTime(ts){
      const d = new Date(ts);
      const pad = n=> n<10 ? '0'+n : n;
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    /* ---- Modal ---- */
    window.showModal = function(src){
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('modalImg');
      img.src = src;
      modal.style.display='flex';
      document.body.style.overflow='hidden';
    };
  </script>

  <script>
    // Modal close
    const modal = document.getElementById('imgModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    modalCloseBtn.addEventListener('click',()=>hideModal());
    modal.addEventListener('click',e=>{
      if(e.target===modal) hideModal();
    });
    document.addEventListener('keydown',e=>{
      if(e.key==='Escape') hideModal();
    });
    function hideModal(){
      modal.style.display='none';
      const img = document.getElementById('modalImg');
      img.src='';
      document.body.style.overflow='';
    }
  </script>
</body>
</html>
