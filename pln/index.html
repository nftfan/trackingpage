
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<title>LeuvenFlyers</title>
<link rel="icon" href="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749533761/4HirECt_srdsx7.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
	<!-- Google Fonts: Roboto + Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --belgio-bg-primary: #0a0a0a;
      --belgio-bg-secondary: #171717;
      --belgio-bg-tertiary: #23272e;
      --belgio-text-primary: #ffffff;
      --belgio-text-secondary: #a3a3a3;
      --belgio-accent: #3b82f6;
      --belgio-success: #10b981;
      --belgio-warning: #f59e0b;
      --belgio-error: #ef4444;
      --belgio-border: #23272e;
      --belgio-shadow: 0 2px 10px 0 rgba(0,0,0,.13);
      --belgio-shadow-lg: 0 4px 16px 0 rgba(0,0,0,.18);
      --belgio-tab-bg: #191d23;
      --belgio-tab-active-bg: #3b82f6;
      --belgio-tab-active-text: #fff;
    }
	 body {
      background: #000000;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Material Icons', sans-serif;
      margin: 0;
      padding: 0;
    }
    .belgio-estimator {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Material Icons', sans-serif;
      max-width: 100%;
      margin: 0 auto;
      padding: 1.1rem 0.5rem 2.2rem 0.5rem;
      background: #1e2642;
      min-height: 100vh;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .belgio-main-container {
      background: var(--belgio-bg-secondary);
      border-radius: 18px;
      box-shadow: var(--belgio-shadow-lg);
      overflow: hidden;
      border: 1px solid var(--belgio-border);
      margin-top: 1.7rem;
    }
    .belgio-map-container {
      position: relative;
    }
    #belgio-map {
      height: 640px;
      width: 100%;
      z-index: 1;
      border-bottom: 1px solid var(--belgio-border);
      border-radius: 18px 18px 0 0;
    }
    .belgio-results-panel {
      background: var(--belgio-bg-tertiary);
      padding: 1.1rem 1.1rem 1.7rem 1.1rem;
      border-top: 1px solid var(--belgio-border);
      min-height: 170px;
    }
    .belgio-info-box {
      background: var(--belgio-bg-tertiary);
      border-radius: 10px;
      padding: 1.05rem 1.12rem;
      box-shadow: var(--belgio-shadow);
      border: 1px solid var(--belgio-border);
      font-size: 1rem;
      color: var(--belgio-text-primary);
      display: flex;
      align-items: flex-start;
      gap: 1.0rem;
      min-height: 48px;
      justify-content: flex-start;
      margin-bottom: 0.7em;
    }
    .belgio-info-icon {
      font-family: 'Material Icons';
      font-size: 2rem;
      color: var(--belgio-accent);
      flex-shrink: 0;
      margin-right: 0.45rem;
      margin-top: 0.08em;
      opacity: 0.92;
      text-shadow: 0 2px 10px #17477d44;
      display: inline-block;
    }
    .belgio-info-box-content strong {
      color: var(--belgio-accent);
      font-weight: 600;
      font-size: 1.08em;
      letter-spacing: 0.01em;
    }
    .belgio-btn-group {
      display: flex;
      gap: 0.65em;
      flex-wrap: wrap;
      margin-bottom: 0.5em;
    }
    .belgio-analyze-btn,
    .belgio-savepdf-btn {
      background: var(--belgio-accent);
      color: #fff;
      font-weight: 600;
      font-size: 1.07rem;
      padding: 0.66em 2.1em;
      border: none;
      border-radius: 7px;
      box-shadow: 0 2px 9px #3b82f62d;
      cursor: pointer;
      letter-spacing: 0.03em;
      display: inline-flex;
      align-items: center;
      gap: 0.42em;
      outline: none;
      transition: background 0.18s, box-shadow 0.18s;
      margin: 0.4rem 0 0.2rem 0;
    }
    .belgio-analyze-btn[disabled] {
      background: #23272e !important;
      color: #aaa !important;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }
    .belgio-savepdf-btn {
      background: #fff;
      color: var(--belgio-accent);
      border: 1.5px solid var(--belgio-accent);
      box-shadow: 0 2px 9px #3b82f62d;
      font-size: 1.07rem;
      padding: 0.66em 1.6em;
      margin-left: 0 !important;
    }
    .belgio-savepdf-btn:disabled {
      background: #23272e !important;
      color: #aaa !important;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
      border-color: #23272e;
    }
    .belgio-analyze-btn .material-icons,
    .belgio-savepdf-btn .material-icons {
      font-size: 1.3em;
      vertical-align: middle;
    }
    .belgio-tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1.0rem;
      margin-top: 0.4rem;
      user-select: none;
      border-bottom: 1.2px solid #23272e;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .belgio-tabs::-webkit-scrollbar { display: none; }
    .belgio-tab {
      background: var(--belgio-tab-bg);
      color: #e7e7e7;
      padding: 0.41em 1.18em;
      border-radius: 7px 7px 0 0;
      font-size: 1.01rem;
      font-weight: 600;
      border: 1px solid var(--belgio-border);
      border-bottom: none;
      cursor: pointer;
      transition: background 0.17s, color 0.17s;
      display: flex;
      align-items: center;
      gap: 0.32em;
      min-width: 90px;
      justify-content: center;
      outline: none;
      letter-spacing: 0.01em;
    }
    .belgio-tab.active {
      background: var(--belgio-tab-active-bg);
      color: var(--belgio-tab-active-text);
      border-bottom: 2px solid var(--belgio-tab-active-bg);
      box-shadow: 0 6px 18px #3b82f622;
      z-index: 1;
    }
    .belgio-tab .material-icons {
      font-size: 1.03em;
    }
    .belgio-tab-content {
      border-radius: 0 0 12px 12px;
      background: var(--belgio-bg-secondary);
      padding: 1.3rem 0.5rem 1.2rem 0.5rem;
      box-shadow: 0 2px 24px #1e293b14;
      text-align: center;
      min-height: 100px;
      color: var(--belgio-text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
      font-size: 1.25rem;
    }
    /* Summary tab rows */
    .belgio-summary-table {
      width: 100%;
      max-width: 440px;
      margin: 0 auto;
      border-radius: 9px;
      overflow: hidden;
      box-shadow: 0 2px 16px #1e293b19;
      background: var(--belgio-bg-tertiary);
      border: 1px solid #222a;
      font-size: 1.03rem;
      margin-top: 0.3em;
    }
    .belgio-summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.78em 1.1em;
      border-bottom: 1px solid #2226;
      gap: 1.2em;
      font-weight: 500;
      color: var(--belgio-text-primary);
    }
    .belgio-summary-row:last-child {
      border-bottom: none;
    }
    .belgio-summary-label {
      display: flex;
      align-items: center;
      gap: 0.42em;
      color: var(--belgio-text-secondary);
      font-size: 1em;
      font-weight: 500;
    }
    .belgio-summary-label .material-icons {
      font-size: 1.08em;
      color: var(--belgio-accent);
    }
    .belgio-summary-value {
      font-family: monospace;
      font-weight: 800;
      color: #fff;
      font-size: 1.05em;
      letter-spacing: 0.01em;
    }
    .belgio-summary-cost {
      color: var(--belgio-accent);
      font-weight: 800;
      font-size: 1.15em;
    }
    .belgio-summary-total-row {
      background: #1d2843;
      font-size: 1.13em;
      color: var(--belgio-success);
      font-weight: 800;
      border-top: 2.2px solid #3b82f6;
      border-bottom: none !important;
    }
    .belgio-dropdown-row {
      display: flex;
      align-items: center;
      gap: 1.2em;
      margin: 0.2em 0 0.7em 0;
      justify-content: flex-start;
      width: 100%;
      max-width: 440px;
    }
    .belgio-dropdown-label {
      color: #a3a3a3;
      font-size: 0.99em;
      font-weight: 500;
      margin-right: 1em;
    }
    .belgio-select-paper {
      background: #171a1f;
      color: #fff;
      border: 1px solid #3b82f6;
      border-radius: 6px;
      padding: 0.27em 1em 0.27em 0.7em;
      font-size: 1.01em;
      font-family: inherit;
      font-weight: 600;
      min-width: 115px;
      outline: none;
      transition: border 0.14s;
    }
    .belgio-select-paper:focus {
      border: 1.5px solid #60a5fa;
    }
    .belgio-tab-big {
      font-size: 2rem;
      font-weight: 800;
      color: var(--belgio-accent);
      text-shadow: 0 2px 16px #3b82f646;
      line-height: 1.12;
      letter-spacing: 0.01em;
      font-family: Inter, Arial, sans-serif;
      margin-bottom: 0.04em;
      margin-top: 0;
      display: block;
    }
    .belgio-tab-label {
      font-size: 1.04rem;
      opacity: 0.95;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: #fff;
      margin-bottom: .19em;
    }
    .belgio-tab-desc {
      color: var(--belgio-text-secondary);
      font-size: 1.00rem;
      margin-top: 0.05em;
      font-weight: 500;
    }
    .belgio-details-row {
      display: flex;
      justify-content: center;
      gap: 1.3em;
      margin-top: 0.2em;
      font-size: 1em;
      flex-wrap: wrap;
      width: 100%;
      max-width: 600px;
    }
    .belgio-detail-block {
      background: var(--belgio-bg-tertiary);
      border-radius: 8px;
      color: #fff;
      font-size: 0.98rem;
      display: flex;
      align-items: center;
      gap: 0.56em;
      flex-direction: column;
      font-weight: 600;
      border: 1px solid #1e293b;
      box-shadow: 0 2px 10px #3b82f61a;
      /* Equal sizing */
      min-width: 180px;
      min-height: 150px;
      flex: 1 1 180px;
      justify-content: center;
      padding: 1.1em 1.1em;
      box-sizing: border-box;
      margin: 0;
    }
    .belgio-detail-block .material-icons {
      font-size: 1.35rem;
      color: var(--belgio-accent);
      margin-bottom: 0.17em;
      opacity: 0.93;
    }
    /* Provider cards for printing tab */
    .providers-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.1em;
      margin-top: 2.2em;
      width: 100%;
      max-width: 600px;
    }
    .provider-card {
      background: #181c23;
      border-radius: 10px;
      box-shadow: 0 2px 12px #1e293b14;
      border: 1px solid #222a;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow 0.15s, border 0.13s;
      min-width: 180px;
      min-height: 150px;
      max-width: 220px;
      flex: 1 1 180px;
      justify-content: center;
      margin: 0;
      padding: 1.2em 1em;
      box-sizing: border-box;
    }
    .provider-card:hover {
      box-shadow: 0 4px 20px #3b82f633;
      border: 1.5px solid #3b82f6;
    }
    .provider-logo {
      background: #222e3b;
      border-radius: 100%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.7em;
      font-size: 1.59em;
      color: var(--belgio-accent);
    }
    .provider-name {
      font-size: 1.09em;
      font-weight: 700;
      margin: 0.1em 0 0.3em 0;
      text-align: center;
    }
    .provider-name a {
      color: #3b82f6;
      text-decoration: none;
    }
    .provider-name a:hover {
      text-decoration: underline;
    }
    .provider-rating {
      color: #f59e0b;
      font-size: 1.1em;
      margin-bottom: 0.25em;
    }
    .provider-info {
      color: #a3a3a3;
      font-size: 0.99em;
      text-align: center;
      margin-top: 0.15em;
    }
    .loading-state {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--belgio-warning);
      font-size: 1.01rem;
      margin-top: 0.1em;
      justify-content: center;
      min-height: 52px;
    }
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2.5px solid var(--belgio-border);
      border-top: 2.5px solid var(--belgio-warning);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .error-state {
      color: var(--belgio-error);
      background: #1f1113;
      border: 1px solid #4c1d1d;
      border-radius: 8px;
      padding: 0.9rem 0.8rem;
      margin-top: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      font-size: 1.02rem;
      justify-content: center;
    }
    .error-icon {
      font-family: 'Material Icons';
      font-size: 1.3rem;
      color: var(--belgio-error);
      margin-right: 0.18em;
      margin-top: 0.01em;
      flex-shrink: 0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 480px) {
      .belgio-tab-big { font-size: 1.3rem; }
      .belgio-estimator { padding: 0.08rem 0.08rem 1rem 0.08rem;}
      .belgio-main-container { margin-top: 0.15rem;}
      #belgio-map { border-radius: 0; }
      .belgio-details-row,
      .providers-grid { flex-direction: column; gap:0.8em; max-width: 100%;}
      .belgio-detail-block,
      .provider-card { min-width: unset; max-width: unset; }
    }
  </style>
  
  </head>
<body>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Font Awesome for print/star icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <!-- Leaflet + Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <div class="belgio-estimator">
    <header style="display:flex;align-items:center;gap:0.8rem; margin-bottom: 0.9rem;">
      <span class="material-icons" style="font-size:2.2rem;color:var(--belgio-accent);background:linear-gradient(135deg,var(--belgio-accent),#fff3);border-radius:16%;padding:0.08em 0.11em 0.09em 0.09em;box-shadow:0 2px 10px #17477d28;">
        location_city
      </span>
      <span style="font-size:1.15rem;color:var(--belgio-text-primary);font-weight:600;letter-spacing:0.01em;">
        Offline Ads Estimator <span style="color:var(--belgio-accent);font-size:1.01em;">Belgium</span>
      </span>
    </header>

    <div class="belgio-main-container">
      <div class="belgio-map-container">
        <div id="belgio-map"></div>
      </div>
      <div class="belgio-results-panel">
        <div class="belgio-info-box" id="belgio-infoBox">
          <span class="belgio-info-icon material-icons">explore</span>
          <div class="belgio-info-box-content">
            <strong>Ready to analyze</strong> • Draw a circle on the map to estimate flyers required for that area
          </div>
        </div>
        <div class="belgio-btn-group">
          <button class="belgio-analyze-btn" id="belgio-analyzeBtn" disabled>
            <span class="material-icons">analytics</span>
            Analyze
          </button>
          <button class="belgio-savepdf-btn" id="belgio-savePdfBtn" disabled>
            <span class="material-icons">picture_as_pdf</span>
            Save as PDF
          </button>
        </div>
        <div id="belgio-resultsTabs" style="display:none;">
          <div class="belgio-tabs" id="belgio-tabsBar">
            <div class="belgio-tab" data-tab="flyers"><span class="material-icons">local_post_office</span> Flyers</div>
            <div class="belgio-tab" data-tab="customers"><span class="material-icons">group_add</span> Customers</div>
            <div class="belgio-tab" data-tab="cost"><span class="material-icons">euro</span> Distribution</div>
            <div class="belgio-tab" data-tab="printing"><span class="material-icons">print</span> Printing</div>
            <div class="belgio-tab" data-tab="summary"><span class="material-icons">summarize</span> Summary</div>
          </div>
          <div class="belgio-tab-content" id="belgio-tabContent"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Map setup with original (light) tiles - Belgium view
    const map = L.map('belgio-map').setView([50.5039, 4.4699], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --- Draw control (circle only, no edit button needed)
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      draw: {
        marker: false,
        polygon: false,
        polyline: false,
        rectangle: false,
        circle: {
          shapeOptions: {
            color: '#3b82f6',
            fillColor: '#3b82f6',
            fillOpacity: 0.10,
            weight: 2,
            opacity: 0.85
          }
        },
        circlemarker: false
      },
      edit: {
        featureGroup: drawnItems,
        edit: true,
        remove: true
      }
    });
    map.addControl(drawControl);

    let currentCircle = null;
    let infoBox = document.getElementById('belgio-infoBox');
    let analyzeBtn = document.getElementById('belgio-analyzeBtn');
    let savePdfBtn = document.getElementById('belgio-savePdfBtn');
    let resultsTabs = document.getElementById('belgio-resultsTabs');
    let tabsBar = document.getElementById('belgio-tabsBar');
    let tabContent = document.getElementById('belgio-tabContent');
    let lastStats = null;
    let selectedPaper = "none"; // "a6", "a5", "none"

    function calcFlyerStats(buildingCount) {
      const flyers = Math.ceil(buildingCount * 1.5);
      const minCustomers = Math.floor(flyers * 7 / 1000);
      const distCost = (flyers * 0.05).toFixed(2);
      const a6Cost = (flyers * 0.03).toFixed(2);
      const a5Cost = (flyers * 0.04).toFixed(2);
      return { flyers, minCustomers, distCost, a6Cost, a5Cost };
    }

    async function countBuildingsInCircle(lat, lon, radius) {
      const query = `
        [out:json][timeout:25];
        (
          way["building"](around:${Math.round(radius)},${lat},${lon});
          node["building"](around:${Math.round(radius)},${lat},${lon});
        );
        out count;
      `;
      const url = "https://overpass-api.de/api/interpreter";
      try {
        const response = await fetch(url, {
          method: "POST",
          body: query,
          headers: { "Content-Type": "text/plain" }
        });
        if (!response.ok) throw new Error("Overpass API error");
        const data = await response.json();

        let wayCount = 0, nodeCount = 0;
        if (data.elements) {
          data.elements.forEach(el => {
            if (el.type === "count") {
              if (typeof el.tags.ways !== "undefined") wayCount = parseInt(el.tags.ways);
              if (typeof el.tags.nodes !== "undefined") nodeCount = parseInt(el.tags.nodes);
              if (typeof el.tags.total !== "undefined") wayCount += parseInt(el.tags.total);
            }
          });
        }
        return wayCount + nodeCount;
      } catch (e) {
        showError(e.message);
        return null;
      }
    }

    function showError(msg) {
      infoBox.innerHTML = `
        <div class="error-state">
          <span class="error-icon material-icons">error_outline</span>
          <div>
            <strong>⚠️ Error fetching building data</strong><br>
            Please check your internet connection and try again.<br>
            <small style='opacity: 0.7; margin-top: 0.5rem; display: block;'>Error: ${msg}</small>
          </div>
        </div>
      `;
      resultsTabs.style.display = "none";
      savePdfBtn.disabled = true;
    }

    function showReadyState() {
      infoBox.innerHTML = `
        <span class="belgio-info-icon material-icons">explore</span>
        <div class="belgio-info-box-content">
          <strong>Ready to analyze</strong> • Draw a circle on the map to estimate flyers required for that area
        </div>
      `;
      analyzeBtn.disabled = true;
      savePdfBtn.disabled = true;
      resultsTabs.style.display = "none";
    }

    function showAnalyzePrompt(circle) {
      const center = circle.getLatLng();
      const radius = circle.getRadius();
      infoBox.innerHTML = `
        <span class="belgio-info-icon material-icons">analytics</span>
        <div class="belgio-info-box-content">
          <strong>Area Selected</strong><br>
          <span style="font-size:1.01em;">Move or resize the circle if needed, then click <b>Analyze</b> below to estimate flyers.</span>
          <div style="margin-top:0.7em;font-size:0.97em;opacity:0.78;">
            <span class="material-icons" style="font-size:1.1em;vertical-align:-0.1em;">place</span>
            ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)} &nbsp;&nbsp; 
            <span class="material-icons" style="font-size:1.1em;vertical-align:-0.1em;">radio_button_checked</span> 
            Radius: ${radius.toFixed(0)}m
          </div>
        </div>
      `;
      analyzeBtn.disabled = false;
      savePdfBtn.disabled = true;
      resultsTabs.style.display = "none";
    }

    function showLoading() {
      infoBox.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <span class="material-icons" style="margin-right:0.13em;">autorenew</span>
          <strong>Analyzing...</strong> Counting buildings in selected area
        </div>
      `;
      resultsTabs.style.display = "none";
      savePdfBtn.disabled = true;
    }

    function showTabs(stats, center, radius, area, density, buildingCount) {
      resultsTabs.style.display = "block";
      setActiveTab("flyers");
      updateTabContent("flyers", stats, center, radius, area, density, buildingCount);
      infoBox.innerHTML = `
        <span class="belgio-info-icon material-icons" style="color:var(--belgio-success);">check_circle</span>
        <div class="belgio-info-box-content">
          <strong>Analysis Done</strong> • See results in the tabs below
        </div>
      `;
      savePdfBtn.disabled = false;
    }

    function setActiveTab(tabKey) {
      for (const tab of tabsBar.children) {
        tab.classList.toggle("active", tab.dataset.tab === tabKey);
      }
    }

    function getPrintingCost(stats) {
      if (selectedPaper === "a6") return { label: "A6", value: stats.a6Cost, per: "€0.03/flyer" };
      if (selectedPaper === "a5") return { label: "A5", value: stats.a5Cost, per: "€0.04/flyer" };
      return { label: "None", value: "0.00", per: "" };
    }

    function updateTabContent(tabKey, stats, center, radius, area, density, buildingCount) {
      let html = "";

      if (tabKey === "flyers") {
        html = `
          <span class="belgio-tab-big">${stats.flyers.toLocaleString()}</span>
          <div class="belgio-tab-label">Flyers Required</div>
          <div class="belgio-tab-desc">Calculated as <b>1.5×</b> the number of buildings in area.</div>
        `;
      } else if (tabKey === "customers") {
        html = `
          <span class="belgio-tab-big">${stats.minCustomers.toLocaleString()}</span>
          <div class="belgio-tab-label">Minimum Customers Acquired</div>
          <div class="belgio-tab-desc">Estimated at <b>7 per 1000 flyers</b> distributed.</div>
		  
        `;
      } else if (tabKey === "cost") {
        html = `
          <span class="belgio-tab-big">&euro;${stats.distCost}</span>
          <div class="belgio-tab-label">Distribution Cost</div>
          <div class="belgio-tab-desc">At <b>€0.05 per flyer</b> distributed.</div>
        `;
      } else if (tabKey === "printing") {
        // 4 boxes in a single row, all flex=1, min size enforced by CSS
        html = `
          <div class="belgio-details-row" style="width:100%;max-width:900px;display:flex;flex-wrap:nowrap;gap:1.2em;">
            <div class="belgio-detail-block">
              <span class="material-icons">print</span>
              <div class="belgio-tab-label" style="margin:0.2em 0 0.15em 0;font-size:1em;">A6 Flyer</div>
              <div class="belgio-tab-big" style="font-size:1.15rem;">&euro;${stats.a6Cost}</div>
              <div class="belgio-tab-desc" style="font-size:0.97em;">
                @ €0.03/flyer
              </div>
            </div>
            <div class="belgio-detail-block">
              <span class="material-icons">print</span>
              <div class="belgio-tab-label" style="margin:0.2em 0 0.15em 0;font-size:1em;">A5 Flyer</div>
              <div class="belgio-tab-big" style="font-size:1.15rem;">&euro;${stats.a5Cost}</div>
              <div class="belgio-tab-desc" style="font-size:0.97em;">
                @ €0.04/flyer
              </div>
            </div>
            <div class="provider-card">
              <div class="provider-logo">
                <i class="fas fa-print"></i>
              </div>
              <h3 class="provider-name">
                <a href="https://www.vistaprint.be/" target="_blank" rel="noopener noreferrer">Vista Print</a>
              </h3>
              <div class="provider-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </div>
              <p class="provider-info">Best overall quality and service with home delivery, very Affordable prices.</p>
            </div>
            <div class="provider-card">
              <div class="provider-logo">
                <i class="fas fa-print"></i>
              </div>
              <h3 class="provider-name">
                <a href="https://www.flyer.be/" target="_blank" rel="noopener noreferrer">Flyer BE</a>
              </h3>
              <div class="provider-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="far fa-star"></i>
              </div>
              <p class="provider-info">Great value for large quantity orders</p>
            </div>
          </div>
        `;
      } else if (tabKey === "summary") {
        const printing = getPrintingCost(stats);
        const totalCost = (parseFloat(stats.distCost) + parseFloat(printing.value)).toFixed(2);
        html = `
          <div class="belgio-dropdown-row">
            <span class="belgio-dropdown-label">Paper:</span>
            <select id="belgio-paperSelect" class="belgio-select-paper">
              <option value="none" ${selectedPaper === "none" ? "selected" : ""}>None</option>
              <option value="a6" ${selectedPaper === "a6" ? "selected" : ""}>A6 (€0.03/flyer)</option>
              <option value="a5" ${selectedPaper === "a5" ? "selected" : ""}>A5 (€0.04/flyer)</option>
            </select>
          </div>
          <div class="belgio-summary-table">
            <div class="belgio-summary-row">
              <span class="belgio-summary-label"><span class="material-icons">local_post_office</span>Flyers Required</span>
              <span class="belgio-summary-value">${stats.flyers.toLocaleString()}</span>
            </div>
            <div class="belgio-summary-row">
              <span class="belgio-summary-label"><span class="material-icons">group_add</span>Customers (min)</span>
              <span class="belgio-summary-value">${stats.minCustomers.toLocaleString()}</span>
            </div>
            <div class="belgio-summary-row">
              <span class="belgio-summary-label"><span class="material-icons">print</span>Printing (${printing.label})</span>
              <span class="belgio-summary-value">&euro;${printing.value}${printing.per ? `<span class="belgio-tab-desc" style="display:block;font-size:.89em;color:#6bc4ff;">${printing.per}</span>` : ""}</span>
            </div>
            <div class="belgio-summary-row">
              <span class="belgio-summary-label"><span class="material-icons">euro</span>Distribution</span>
              <span class="belgio-summary-value">&euro;${stats.distCost}</span>
            </div>
            <div class="belgio-summary-row belgio-summary-total-row">
              <span class="belgio-summary-label"><span class="material-icons">summarize</span>Total Cost</span>
              <span class="belgio-summary-cost">&euro;${totalCost}</span>
            </div>
          </div>
        `;
      }
      tabContent.innerHTML = html;
      // Only show dropdown selection in summary tab
      if (tabKey === "summary") {
        const select = document.getElementById("belgio-paperSelect");
        if (select) {
          select.addEventListener("change", function (e) {
            selectedPaper = this.value;
            updateTabContent("summary", lastStats.stats, lastStats.center, lastStats.radius, lastStats.area, lastStats.density, lastStats.buildingCount);
          });
        }
      }
    }

    // --- Handle draw events
    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.clearLayers();
      if (e.layerType === 'circle') {
        currentCircle = e.layer;
        drawnItems.addLayer(currentCircle);
        currentCircle.editing.enable();
        showAnalyzePrompt(currentCircle);
        currentCircle.on('edit', function() {
          showAnalyzePrompt(currentCircle);
        });
        analyzeBtn.disabled = false;
        savePdfBtn.disabled = true;
        resultsTabs.style.display = "none";
      }
    });
    drawnItems.on('layeredit', function(e) {
      if (e.layer === currentCircle) {
        showAnalyzePrompt(currentCircle);
      }
    });
    map.on('draw:edited', function (e) {
      if (currentCircle) showAnalyzePrompt(currentCircle);
    });
    map.on('draw:deleted', function () {
      currentCircle = null;
      showReadyState();
    });
    // --- Analyze Button
    analyzeBtn.addEventListener('click', async function() {
      if (!currentCircle) return;
      showLoading();
      const center = currentCircle.getLatLng();
      const radius = currentCircle.getRadius();
      const area = Math.PI * Math.pow(radius, 2) / 1000000;
      const buildingCount = await countBuildingsInCircle(center.lat, center.lng, radius);
      if (buildingCount === null) return; // error already shown
      const density = buildingCount > 0 ? (buildingCount / area).toFixed(1) : 0;
      const stats = calcFlyerStats(buildingCount);
      lastStats = { stats, center, radius, area, density, buildingCount };
      showTabs(stats, center, radius, area, density, buildingCount);
    });
    // --- Tabs interaction
    tabsBar.addEventListener('click', function(e) {
      const tab = e.target.closest('.belgio-tab');
      if (!tab || !lastStats) return;
      setActiveTab(tab.dataset.tab);
      updateTabContent(tab.dataset.tab, lastStats.stats, lastStats.center, lastStats.radius, lastStats.area, lastStats.density, lastStats.buildingCount);
    });
    // --- PDF Export with beautiful table (no provider info), both printing & total costs, and campaign link
    savePdfBtn.addEventListener('click', function() {
      if (!lastStats) return;
      const { stats, center, radius, area, density, buildingCount } = lastStats;
      // Both printing costs and totals:
      const a6Cost = parseFloat(stats.a6Cost).toFixed(2);
      const a5Cost = parseFloat(stats.a5Cost).toFixed(2);
      const distCost = parseFloat(stats.distCost).toFixed(2);
      const totalCostA6 = (parseFloat(a6Cost) + parseFloat(distCost)).toFixed(2);
      const totalCostA5 = (parseFloat(a5Cost) + parseFloat(distCost)).toFixed(2);

      // PDF generation
      const doc = new window.jspdf.jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
      let y = 14;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(17);
      doc.text('Offline Ads Campaign Estimate', 14, y); y += 8;
      doc.setFontSize(13);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(59, 130, 246);
      doc.text('Belgium', 14, y); y += 8;
      doc.setTextColor(60, 60, 60);
      doc.setFontSize(11);
      doc.text(`Area Center: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`, 14, y); y += 6;
      doc.text(`Radius: ${radius.toFixed(0)} meters`, 14, y); y += 6;
      doc.text(`Estimated Area: ${area.toFixed(2)} km²`, 14, y); y += 6;
      doc.text(`Building Count: ${buildingCount}`, 14, y); y += 6;
      doc.text(`Building Density: ${density} per km²`, 14, y); y += 10;

      // Table header
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(59, 130, 246);
      doc.text('Estimate Summary', 14, y); y += 8;

      // Table
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255,255,255);
      // Draw table background
      const tableX = 14, tableY = y, tableW = 182, cellH = 9;
      doc.setFillColor(59, 130, 246);
      doc.roundedRect(tableX, tableY, tableW, cellH, 2, 2, 'F');
      doc.text('Item', tableX + 3, tableY + 6);
      doc.text('Value', tableX + 52, tableY + 6);
      doc.text('A6 Printing', tableX + 93, tableY + 6);
      doc.text('A5 Printing', tableX + 134, tableY + 6);

      // Table rows
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(44,44,44);

      let row = 1;
      function tablerow(label, value, a6, a5) {
        const yrow = tableY + cellH*row;
        doc.setFillColor(row%2==0?246:255, row%2==0?249:255, row%2==0?255:255);
        doc.roundedRect(tableX, yrow, tableW, cellH, 1.5, 1.5, 'F');
        doc.text(label, tableX + 3, yrow + 6);
        doc.text(value, tableX + 52, yrow + 6);
        doc.text(a6, tableX + 93, yrow + 6);
        doc.text(a5, tableX + 134, yrow + 6);
        row++;
      }
      tablerow("Flyers Required", stats.flyers.toLocaleString(), "-", "-");
      tablerow("Min Customers", stats.minCustomers.toLocaleString(), "-", "-");
      tablerow("Distribution", `€${distCost}`, "-", "-");
      tablerow("Printing Cost", "-", `€${a6Cost}`, `€${a5Cost}`);
      tablerow("Total Cost", "-", `€${totalCostA6}`, `€${totalCostA5}`);

      y = tableY + cellH * (row) + 8;

      // Campaign link
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(59, 130, 246);
      doc.textWithLink('Powered by LeuvenFlyers', 14, y, { url: 'https://www.leuvenflyers.com/' });
      y += 8;

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.setTextColor(160,160,160);
      doc.text('Generated by Offline Ads Estimator - Belgium', 14, 285);
      doc.save('offline-ads-campaign-estimate.pdf');
    });

    // --- Initial state
    showReadyState();
  </script>
</body>
</html>
