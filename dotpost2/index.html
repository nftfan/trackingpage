<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dot Poster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f12" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Icons+Outlined&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>

  <style>
    :root{
      --bg:#0b0b0e; --panel:#141419; --muted:#8b8b95; --text:#f2f2f7;
      --accent:#4f8cff; --accent-2:#7a5cff; --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius-lg:18px; --radius-md:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;}
    .app{max-width:620px;margin:0 auto;padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom);display:grid;gap:14px;min-height:100vh}
    header{display:flex;justify-content:space-between;gap:12px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:var(--radius-lg);box-shadow:var(--shadow)}
    h1{margin:0;font-size:16px;font-weight:800}
    .subtitle{color:var(--muted);font-size:12px;margin-top:2px}
    .user-pill{font-size:12px;color:#cbd5ff;background:rgba(122,92,255,.12);border:1px solid rgba(122,92,255,.3);padding:6px 10px;border-radius:999px;display:none;gap:8px;align-items:center}
    .user-pill button{border:0;background:transparent;color:#aab7ff;cursor:pointer;font-weight:700}

    .map-card{border-radius:var(--radius-lg);overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#0f0f12;box-shadow:var(--shadow)}
    #map{height:220px;width:100%}

    .controls{display:grid;grid-template-columns:56px 1fr;gap:12px}
    .btn-icon{height:56px;width:56px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      color:var(--text);display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
    .btn-primary{height:56px;border-radius:16px;border:0;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff;font-weight:800;box-shadow:0 10px 24px rgba(79,140,255,.35)}
    .btn-primary[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}

    .activity-select-wrap{display:flex;gap:10px;align-items:center}
    .activity-select{flex:1;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);padding:0 12px;font-weight:700}
    .activity-chip{display:inline-flex;align-items:center;gap:8px;min-width:160px;justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px}
    .color-dot{width:12px;height:12px;border-radius:4px;border:1px solid rgba(0,0,0,.25);display:inline-block}

    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat{flex:1;min-width:48%;padding:14px;border-radius:var(--radius-md);border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));box-shadow:var(--shadow);display:flex;justify-content:space-between}
    .stat .label{color:var(--muted);font-size:12px}
    .stat .value{font-size:18px;font-weight:900}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0f0f12;border:1px solid rgba(255,255,255,.08);
      padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);font-weight:800;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* Login modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal{width:min(92vw,420px);background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .modal h2{margin:0 0 8px}
    .modal p{margin:0 0 14px;color:var(--muted);font-size:13px}
    .input-row{display:flex;gap:10px}
    .input{flex:1;height:48px;border-radius:12px;padding:0 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-weight:900;letter-spacing:.4px}
    .btn{height:48px;border-radius:12px;border:0;cursor:pointer;padding:0 16px;font-weight:900;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent-2))}
    .error{color:#ff8a8a;font-size:12px;min-height:16px;padding-top:6px}
    .show{display:flex !important}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Dot Poster</h1>
        <div class="subtitle">Login with any FF code, select activity, then post dots</div>
      </div>
      <div id="userPill" class="user-pill">
        <span id="userPillText"></span>
        <button id="changeUserBtn" type="button">Change</button>
      </div>
    </header>

    <div class="map-card">
      <div id="map" role="application" aria-label="Map showing your current location and posted dots"></div>
    </div>

    <div class="controls">
      <button id="btnLocate" class="btn-icon" type="button" title="Go to current location" aria-label="Go to current location">
        <span class="material-icons-outlined">my_location</span>
      </button>
      <button id="btnPost" class="btn-primary" type="button" disabled>Post dot at my location</button>
    </div>

    <div class="activity-select-wrap">
      <select id="activitySelect" class="activity-select" aria-label="Select activity to post under">
        <option value="">Select an activity…</option>
      </select>
      <div class="activity-chip" aria-live="polite">
        <span class="color-dot" id="activityColorDot" style="background:#555;"></span>
        <span id="activityChipLabel">No activity</span>
      </div>
    </div>

    <div class="stats">
      <div class="stat" aria-live="polite">
        <span class="label">My dots (selected activity)</span>
        <span id="myDots" class="value">0</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="label">My earnings (€0.00/dot)</span>
        <span id="myEarnings" class="value">€0.00</span>
      </div>
    </div>

    <div style="color:var(--muted);font-size:12px;text-align:center;padding:4px 0 16px;">
      Stored paths:
      <div style="font-family:ui-monospace, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:11px;opacity:.9;">
        campaigns/&lt;FFID&gt;/services<br/>
        userPosts/&lt;FFID&gt;/&lt;postId&gt;
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Posted!</div>

  <div id="loginBackdrop" class="modal-backdrop" aria-modal="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal">
      <h2 id="loginTitle">Enter User / Campaign ID</h2>
      <p>Examples: <b>FF9500</b>, <b>FF001</b>, <b>FF993</b>. This ID is used for BOTH:
        <code>campaigns/&lt;ID&gt;/services</code> and <code>userPosts/&lt;ID&gt;</code>.
      </p>
      <div class="input-row">
        <input id="userIdInput" class="input" type="text" placeholder="e.g. FF9500" autocomplete="off" autocapitalize="characters" maxlength="12">
        <button id="userJoinBtn" class="btn" type="button">Join</button>
      </div>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref, push, query, orderByChild, onValue,
      set, update, get, runTransaction, off
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
      authDomain: "tokentransfer-4a9b3.firebaseapp.com",
      databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
      projectId: "tokentransfer-4a9b3",
      storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
      messagingSenderId: "205455490321",
      appId: "1:205455490321:web:9919f5dde059316c9320b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI
    const btnLocate = document.getElementById('btnLocate');
    const btnPost = document.getElementById('btnPost');
    const myDotsEl = document.getElementById('myDots');
    const myEarningsEl = document.getElementById('myEarnings');
    const toastEl = document.getElementById('toast');

    const loginBackdrop = document.getElementById('loginBackdrop');
    const userIdInput = document.getElementById('userIdInput');
    const userJoinBtn = document.getElementById('userJoinBtn');
    const loginError = document.getElementById('loginError');

    const userPill = document.getElementById('userPill');
    const userPillText = document.getElementById('userPillText');
    const changeUserBtn = document.getElementById('changeUserBtn');

    const activitySelect = document.getElementById('activitySelect');
    const activityChipLabel = document.getElementById('activityChipLabel');
    const activityColorDot = document.getElementById('activityColorDot');

    // Map
    const map = L.map('map', { zoomControl: false, tap: true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);
    const postsLayer = L.layerGroup().addTo(map);

    // State
    const LS_KEY = 'dotPoster:userId'; // can be ANY FFxxxx used as both user and campaign id
    let currentLatLng = null;
    let currentMarker = null;

    let currentUserId = null;       // FFxxxx
    let selectedActivityId = '';    // service id

    let activities = [];            // [{id,name,color}]
    let activitiesUnsub = null;
    let myPostsUnsub = null;

    // ---------- helpers ----------
    function showToast(text = 'Posted!') {
      toastEl.textContent = text;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1400);
    }

    function normalizeUserId(id) {
      return (id || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    // IMPORTANT: allow ANY FF number (FF + 1..10 digits)
    function validateUserId(id) {
      return /^FF[0-9]{1,10}$/.test(id);
    }

    function safeColor(c, fallback = '#2563eb') {
      if (typeof c !== 'string') return fallback;
      const s = c.trim();
      return /^#[0-9a-fA-F]{6}$/.test(s) ? s : fallback;
    }

    function setPostEnabled() {
      btnPost.disabled = !(currentUserId && selectedActivityId);
    }

    function ensureCurrentMarker(latlng, color) {
      const style = { radius: 6, color, weight: 2, fillColor: color, fillOpacity: 0.9 };
      if (!currentMarker) currentMarker = L.circleMarker(latlng, style).addTo(map);
      else { currentMarker.setLatLng(latlng); currentMarker.setStyle(style); }
    }

    async function goToCurrentLocation({ focus = true } = {}) {
      if (!('geolocation' in navigator)) { showToast('Geolocation not supported'); return null; }
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            currentLatLng = [latitude, longitude];

            const act = activities.find(a => a.id === selectedActivityId);
            const color = safeColor(act?.color, '#ff3344');
            ensureCurrentMarker(currentLatLng, color);

            // Do NOT zoom too much by default
            if (focus) map.setView(currentLatLng, Math.max(map.getZoom(), 15), { animate: true });
            resolve(currentLatLng);
          },
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 15000 }
        );
      });
    }

    function updateActivityChip() {
      const act = activities.find(a => a.id === selectedActivityId);
      if (act) {
        activityChipLabel.textContent = act.name;
        activityColorDot.style.background = safeColor(act.color);
      } else {
        activityChipLabel.textContent = 'No activity';
        activityColorDot.style.background = '#555';
      }
      const color = safeColor(act?.color, '#ff3344');
      if (currentMarker) currentMarker.setStyle({ color, fillColor: color });
    }

    function renderActivitiesDropdown() {
      activitySelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = activities.length ? 'Select an activity' : 'No activities found';
      activitySelect.appendChild(placeholder);

      for (const a of activities) {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        activitySelect.appendChild(opt);
      }

      if (selectedActivityId && activities.some(a => a.id === selectedActivityId)) {
        activitySelect.value = selectedActivityId;
      } else {
        selectedActivityId = activities[0]?.id || '';
        activitySelect.value = selectedActivityId || '';
      }

      updateActivityChip();
      setPostEnabled();
      // Re-render markers to keep colors consistent
      loadAndRenderPosts();
    }

    // ---------- listeners ----------
    function detachListeners() {
      if (typeof activitiesUnsub === 'function') { activitiesUnsub(); activitiesUnsub = null; }
      if (typeof myPostsUnsub === 'function') { myPostsUnsub(); myPostsUnsub = null; }
    }

    function attachActivitiesListener(ffId) {
      // Read activities from SAME FF id campaign bucket:
      // campaigns/<FFID>/services
      const servicesRef = ref(db, `campaigns/${ffId}/services`);
      const handler = (snapshot) => {
        const next = [];
        if (snapshot.exists()) {
          snapshot.forEach((ch) => {
            const v = ch.val();
            if (!v) return;

            // support either stored shape:
            // 1) {id,name,color} (your old)
            // 2) {name,color} where key is id
            const id = v.id || ch.key;
            const name = v.name || v.title || id;
            const color = safeColor(v.color, '#2563eb');

            if (id && name) next.push({ id, name, color });
          });
        }
        activities = next;
        renderActivitiesDropdown();
      };
      onValue(servicesRef, handler);
      activitiesUnsub = () => off(servicesRef, 'value', handler);
    }

    function attachMyPostsListener(ffId) {
      const myPostsRef = query(ref(db, `userPosts/${ffId}`), orderByChild('timestamp'));
      const handler = (snapshot) => {
        postsLayer.clearLayers();

        // keep counts per selected activity
        let countSelected = 0;

        snapshot.forEach((child) => {
          const v = child.val();
          if (!v || typeof v.lat !== 'number' || typeof v.lng !== 'number') return;

          // IMPORTANT: ensure we have good category fields
          const activityId = v.activityId || '';
          const activityColor = safeColor(v.activityColor, '#000000');
          const activityName = v.activityName || 'Dot';

          // count for selected activity
          if (selectedActivityId && activityId === selectedActivityId) countSelected += 1;

          // Always render ALL dots on map (activity map will filter later by tabs).
          // But your request here is just Dot Poster: show all dots.
          const marker = L.circleMarker([v.lat, v.lng], { radius: 2.2, color: activityColor, weight: 1, fillColor: activityColor, fillOpacity: 1 })
            .bindTooltip(activityName, { direction: 'top', offset: [0, -8] });
          marker.addTo(postsLayer);
        });

        myDotsEl.textContent = String(countSelected || 0);
        myEarningsEl.textContent = '€0.00';
      };
      onValue(myPostsRef, handler);
      myPostsUnsub = () => off(myPostsRef, 'value', handler);
    }

    function loadAndRenderPosts() {
      if (!currentUserId) return;
      // reattach is easiest (keeps logic consistent)
      attachMyPostsListener(currentUserId);
    }

    // ---------- auth ----------
    function showLogin() {
      detachListeners();
      currentUserId = null;
      selectedActivityId = '';
      activities = [];

      userPill.style.display = 'none';
      activitySelect.innerHTML = '<option value="">Select an activity…</option>';
      updateActivityChip();
      setPostEnabled();

      postsLayer.clearLayers();
      if (currentMarker) { map.removeLayer(currentMarker); currentMarker = null; }
      currentLatLng = null;

      loginError.textContent = '';
      loginBackdrop.classList.add('show');
      userIdInput.value = '';
      userIdInput.focus();
    }

    function hideLogin() {
      loginBackdrop.classList.remove('show');
    }

    async function registerUser(ffId) {
      // keep your old user record (optional)
      const now = Date.now();
      const userRef = ref(db, `users/${ffId}`);
      try {
        const snap = await get(userRef);
        if (snap.exists()) await update(userRef, { lastActiveAt: now });
        else await set(userRef, { createdAt: now, lastActiveAt: now, stats: { totalDots: 0, totalEarningsCents: 0 } });
      } catch (e) {
        console.warn('registerUser failed', e);
      }
    }

    async function onUserReady(ffId) {
      currentUserId = ffId;
      localStorage.setItem(LS_KEY, ffId);

      userPillText.textContent = `Logged in as ${ffId}`;
      userPill.style.display = 'flex';

      // Important: activities and posts are BOTH keyed on FFID
      attachActivitiesListener(ffId);
      attachMyPostsListener(ffId);

      // gentle location update (no big zoom)
      goToCurrentLocation({ focus: false });

      setPostEnabled();
    }

    // ---------- events ----------
    userJoinBtn.addEventListener('click', async () => {
      loginError.textContent = '';
      const ffId = normalizeUserId(userIdInput.value);
      if (!validateUserId(ffId)) {
        loginError.textContent = 'Use format FF + digits. Examples: FF9500, FF1, FF001';
        return;
      }
      await registerUser(ffId);
      hideLogin();
      await onUserReady(ffId);
      showToast(`User ${ffId} ready`);
    });

    userIdInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') userJoinBtn.click(); });
    changeUserBtn.addEventListener('click', () => showLogin());

    activitySelect.addEventListener('change', () => {
      selectedActivityId = activitySelect.value;
      updateActivityChip();
      setPostEnabled();
      // refresh counts immediately (listener will also fire)
      loadAndRenderPosts();
    });

    btnLocate.addEventListener('click', () => { goToCurrentLocation({ focus: true }); });

    btnPost.addEventListener('click', async () => {
      if (!currentUserId) { showToast('Login first'); showLogin(); return; }
      if (!selectedActivityId) { showToast('Select an activity'); return; }

      if (!currentLatLng) {
        await goToCurrentLocation({ focus: true });
        if (!currentLatLng) { showToast('Location needed'); return; }
      }

      const act = activities.find(a => a.id === selectedActivityId);
      if (!act) { showToast('Select an activity'); return; }

      const [lat, lng] = currentLatLng;
      const now = Date.now();

      // IMPORTANT for Activity Map categorization:
      // we must store activityId + activityName + activityColor (hex)
      const data = {
        lat, lng,
        userId: currentUserId,
        timestamp: now,
        ua: navigator.userAgent || '',
        activityId: act.id,
        activityName: act.name,
        activityColor: safeColor(act.color, '#000000'),
        earningsCents: 0
      };

      try {
        const newPostRef = push(ref(db, `userPosts/${currentUserId}`));
        const newKey = newPostRef.key;

        const updates = {};
        updates[`userPosts/${currentUserId}/${newKey}`] = data;
        updates[`users/${currentUserId}/lastPostAt`] = now;

        await update(ref(db), updates);

        // Optional (keeps your old totals)
        await runTransaction(ref(db, `users/${currentUserId}/stats/totalDots`), (v) => (v || 0) + 1);

        showToast('Dot posted');

        // Small ping effect
        if (currentMarker) {
          const ping = L.circle(currentMarker.getLatLng(), { radius: 10, color: safeColor(act.color, '#7a5cff'), weight: 1, opacity: 0.7, fillOpacity: 0 });
          ping.addTo(map);
          setTimeout(() => map.removeLayer(ping), 450);
        }
      } catch (e) {
        console.error(e);
        showToast('Failed to post');
      }
    });

    // background geo updates (smooth, no aggressive pan)
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          currentLatLng = [latitude, longitude];
          const act = activities.find(a => a.id === selectedActivityId);
          const color = safeColor(act?.color, '#ff3344');
          ensureCurrentMarker(currentLatLng, color);
        },
        () => {},
        { enableHighAccuracy: true, maximumAge: 15000, timeout: 15000 }
      );
    }

    // Startup
    const stored = normalizeUserId(localStorage.getItem(LS_KEY));
    if (validateUserId(stored)) {
      registerUser(stored).then(() => onUserReady(stored));
    } else {
      showLogin();
    }
  </script>
</body>
</html>
