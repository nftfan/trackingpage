<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pak Portal &mdash; 1 PPC = 1000 PKR</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body {
      font-size: 13px;
      font-family: 'Roboto', 'Arial', sans-serif;
      background: #ffffff;
      color: #333;
      margin: 0;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    body.blurred *:not(.key-modal, .key-modal *, .modal-overlay, .modal-overlay *) {
      filter: blur(3px) brightness(0.93);
      pointer-events: none !important;
      user-select: none !important;
    }
  .top-bar {
      width: 100%;
      background: #fff;
      
      display: flex;
      align-items: center;
      justify-content: space-between;
      
      height: 48px;
      margin-bottom: 10px;
      top: 0;
      z-index: 10;
      font-size: 14px;
      font-weight: 400;
      padding: 0 12px 0 32px;
    }
    .title {
      font-size: 18px;
      font-weight: 600;
      color: #7a3cff;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }
    .exchange-rate {
      font-size: 11px;
      color: #ffd600;
      background: #333;
      border-radius: 5px;
      padding: 2px 10px;
      margin-left: 10px;
      font-weight: 400;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      margin-right: auto;
      margin-left: 36px;
    }
    .key-short {
      color: #7a3cff;
      font-weight: 400;
      font-size: 13px;
      background: #f5f3ff;
      border-radius: 8px;
      padding: 4px 12px 4px 10px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 100px;
      position: relative;
    }
    .delete-btn {
      background: #eee;
      color: #7a3cff;
      border: none;
      border-radius: 4px;
      height: 22px;
      min-width: 22px;
      padding: 0 3px;
      font-size: 16px;
      margin-left: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .delete-btn:hover {
      background: #fdd;
      color: #e53935;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 48px;
      left: 0;
      width: 335px;
      background: #ffffff;
      
      min-height: calc(100vh - 48px);
      
      
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 20px 12px 24px 12px;
      gap: 18px;
    }
    .sidebar .balance-card {
      max-width: unset;
      width: 100%;
      margin: 0 0 0 0;
    }
    .main-content {
      margin-left: 235px;
      padding-left: 0;
    }
    @media (max-width: 900px) {
      .sidebar {
        width: 100vw;
        min-height: unset;
        height: unset;
        position: static;
        flex-direction: row;
        padding: 8px 2vw;
        gap: 10px;
        box-shadow: none;
        border-right: none;
        border-bottom: 1px solid #ececec;
      }
      .sidebar .balance-card {
        min-width: 140px;
        max-width: 180px;
        margin: 0;
      }
      .main-content {
        margin-left: 0;
        padding-left: 0;
      }
    }
    @media (max-width: 600px) {
      .sidebar {
        flex-direction: column;
        gap: 7px;
        padding: 4px 1vw;
      }
      .sidebar .balance-card {
        min-width: unset;
        max-width: unset;
      }
      .main-content {
        margin-left: 0;
      }
    }

    .balance-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px 0 #ece6fa;
      padding: 24px 18px 18px 22px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      border-left: 6px solid #7a3cff;
      transition: box-shadow 0.18s;
      position: relative;
      margin-bottom: 2px;
    }
    .balance-card.spent { border-left: 6px solid #d32f2f;}
    .balance-card.inspending { border-left: 6px solid #ffd600;}
    .balance-card.returned { border-left: 6px solid #42b883; background: #edfff2;}
    .balance-card.available { border-left: 6px solid #7a3cff;}
    .balance-label {
      color: #888;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 1px;
      letter-spacing: 0.3px;
    }
    .balance-label.spent { color: #d32f2f;}
    .balance-label.inspending { color: #ffd600;}
    .balance-label.returned { color: #42b883;}
    .balance-label.available { color: #7a3cff;}
    .balance-card .material-icons {
      font-size: 19px;
      vertical-align: middle;
      margin-right: 2px;
    }
    .balance-value {
      font-size: 18px;
      color: #222;
      font-weight: 600;
      letter-spacing: 0.6px;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      min-height: 20px;
      margin-bottom: 0;
      margin-top: 2px;
    }
    .balance-value-pkr {
      color: #888;
      font-size: 12px;
      font-weight: 500;
      margin-top: 3px;
      margin-left: 1px;
      letter-spacing: 0.2px;
      line-height: 1.2em;
      display: block;
    }
    /* Rest of the styles (sections, tables, etc.) ... */
    .sections-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 36px;
      max-width: 1100px;
      margin: 0 auto 52px auto;
      padding: 0 2vw;
    }
    .card-section {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 1px 16px 0 #ececec;
      padding: 32px 30px 20px 30px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      font-size: 13px;
      font-weight: 400;
      align-items: flex-start;
      min-width: 260px;
      min-height: 230px;
      justify-content: flex-start;
      transition: box-shadow 0.2s;
      overflow-x: auto;
      max-width: 100%;
    }
    .card-section.financial { background: #ffffff; border-left: 7px solid #ffd600; }
    .card-section.processing { background: #fff; border-left: 7px solid #7a3cff; }
    .card-section.support { background: #f3f9ff; border-left: 7px solid #2196f3; }
    .card-section.product { border-left: 7px solid #7a3cff;}
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #7a3cff;
      margin-bottom: 6px;
      letter-spacing: 0.6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title.financial { color: #ffd600;}
    .section-title.support { color: #2196f3;}
    .section-title.processing {color: #7a3cff;}
    .section-title.returned { color: #42b883;}
    .row {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      font-size: 13px;
      font-weight: 400;
      color: #444;
      margin: 0 0 6px 0;
      padding: 0;
      flex-wrap: wrap;
    }
    .row .label {
      min-width: 100px;
      font-weight: 500;
      color: #7a3cff;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
    }
    .row .label.financial { color: #ffd600;}
    .row .label.support { color: #2196f3;}
    .row .label.returned { color: #42b883;}
    .row .value {
      color: #333;
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .row .date {
      color: #888;
      font-size: 12px;
      margin-left: 14px;
      font-weight: 400;
      letter-spacing: .2px;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .row .material-icons { font-size: 15px; margin-right: 2px; vertical-align: middle;}
    .row .material-icons.financial { color: #ffd600;}
    .row .material-icons.support { color: #2196f3;}
    .row .material-icons.returned { color: #42b883;}
    .row .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 10px 3px 6px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
      background: #90caf9;
    }
    /* Clean statuses for processing */
    .processing-table .status-chip {
      background: none !important;
      border-radius: 0;
      color: #7a3cff;
      font-weight: 600;
      font-size: 13px;
      margin: 0;
      box-shadow: none;
      gap: 4px;
      padding: 0;
      display: flex;
      align-items: center;
    }
    .processing-table .yes-status { color: #249a60; }
    .processing-table .pending-status { color: #fbc02d; }
    .processing-table .status-chip .material-icons {
      font-size: 16px;
      vertical-align: middle;
      margin-right: 2px;
      color: inherit;
    }
    .processing-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    .processing-table th,
    .processing-table td {
      font-weight: 400;
      text-align: left;
      padding: 7px 8px 7px 0;
      border: none;
      background: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .processing-table th {
      color: #7a3cff;
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.03em;
      border-bottom: 1px solid #e4d6fe;
      background: transparent;
      padding-bottom: 6px;
    }
    .processing-table td.status-col {
      min-width: 90px;
      max-width: 120px;
    }
    .processing-table td.date-col {
      min-width: 102px;
      max-width: 165px;
      color: #888;
      font-size: 12px;
      text-align: left;
    }
    .processing-table td.step-label {
      min-width: 130px;
      max-width: 240px;
      color: #444;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .images-row {
      display: flex;
      gap: 8px;
      margin-top: 2px;
      margin-bottom: 2px;
      flex-wrap: wrap;
    }
    .product-image {
      width: 78px;
      height: 62px;
      border-radius: 9px;
      object-fit: cover;
      box-shadow: 0 2px 8px #ececec;
      border: 2px solid #eaeaea;
      background: #fff;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .product-image:hover {
      box-shadow: 0 4px 18px #bdbdbd;
      border-color: #7a3cff;
    }
    .support-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .support-list .support-item {
      display: flex;
      align-items: center;
      gap: 7px;
      color: #1976d2;
      background: #e3f2fd;
      padding: 7px 16px;
      border-radius: 10px;
      font-weight: 500;
      font-size: 13px;
    }
    .support-list .material-icons { color: #2196f3; font-size: 15px;}
    .step-desc {
      font-size: 13px;
      color: #8d7fc7;
      background: #f7f4ff;
      border-radius: 9px;
      margin: 1px 0 6px 14px;
      padding: 7px 14px 7px 18px;
      border-left: 3px solid #7a3cff;
      font-weight: 400;
    }
    .step-desc.returned {
      color: #249a60;
      background: #edfff2;
      border-left: 3px solid #42b883;
    }
    .fullscreen-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(30,24,50,0.93);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      animation: fadeIn .2s;
    }
    .fullscreen-modal.active { display: flex; }
    .fullscreen-img {
      max-width: 70vw;
      max-height: 65vh;
      border-radius: 8px;
      box-shadow: 0 2px 12px #333;
      background: #fff;
      object-fit: contain;
    }
    .close-modal-btn {
      position: absolute;
      top: 16px;
      right: 36px;
      background: rgba(30,24,50,0.4);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 34px; height: 34px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 10001;
      transition: background 0.2s;
    }
    .close-modal-btn:hover { background: #7a3cff; }
    .modal-overlay {
      position: fixed;
      left:0; top:0; right:0; bottom:0;
      width:100vw; height:100vh;
      background: rgba(40,30,60,0.25);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .key-modal {
      background: #fff;
      color: #222;
      border-radius: 14px;
      box-shadow: 0 8px 32px #7a3cff40;
      padding: 22px 18px 18px 18px;
      min-width: 290px;
      max-width: 96vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 10001;
      font-size: 14px;
      font-weight: 400;
    }
    .key-modal .material-icons { color: #7a3cff; font-size: 24px;}
    .key-modal label { font-weight: 500; font-size: 13px;}
    .key-modal input[type="text"] {
      width: 220px;
      font-size: 14px;
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 7px 11px;
      margin-top: 3px;
      outline: none;
      transition: border 0.2s;
    }
    .key-modal input[type="text"]:focus { border: 1px solid #7a3cff;}
    .key-modal button {
      background: #7a3cff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 22px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 0;
      transition: background 0.2s;
    }
    .key-modal button:hover { background: #6338c7;}
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="title">
      <span class="material-icons" style="font-size:20px;">dashboard</span>
      Pak Portal
      <span class="exchange-rate"><span class="material-icons" style="font-size:13px;vertical-align:middle;">sync_alt</span>1 PPC = 1000 PKR</span>
    </div>
    <div class="status-bar">
      <span title="Your Key" class="key-short" id="keyShort">
        <span class="material-icons" style="font-size:17px;">vpn_key</span>
        <span id="keyShortValue" style="font-size:13px;">---</span>
        <button class="delete-btn" title="Remove Key" id="deleteKeyBtn">
          <span class="material-icons" style="font-size:16px;">delete</span>
        </button>
      </span>
    </div>
  </div>
  <!-- Sidebar with 4 PPC cards -->
  <div class="sidebar">
    <div class="balance-card spent">
      <div class="balance-label spent"><span class="material-icons spent">money_off</span>Spent PPC</div>
      <div class="balance-value" id="spentPPC">--</div>
      <div class="balance-value-pkr" id="spentPKR"></div>
    </div>
    <div class="balance-card inspending">
      <div class="balance-label inspending"><span class="material-icons inspending">pending_actions</span>In Spending</div>
      <div class="balance-value" id="spendingPPC">--</div>
      <div class="balance-value-pkr" id="spendingPKR"></div>
    </div>
    <div class="balance-card returned">
      <div class="balance-label returned"><span class="material-icons returned">undo</span>Returned PPC</div>
      <div class="balance-value" id="returnedPPC">--</div>
      <div class="balance-value-pkr" id="returnedPKR"></div>
    </div>
    <div class="balance-card available">
      <div class="balance-label available"><span class="material-icons available">credit_score</span>Available PPC</div>
      <div class="balance-value" id="availablePPC">--</div>
      <div class="balance-value-pkr" id="availablePKR"></div>
    </div>
  </div>
  <!-- Main content shifted right -->
  <div class="main-content">
    <div class="sections-grid">
      <div class="card-section product">
        <div class="section-title"><span class="material-icons">info</span>Product Details</div>
        <div class="row">
          <span class="label"><span class="material-icons">shopping_cart</span>Product</span>
          <span class="value">Mobile Recharge</span>
        </div>
        <div class="row">
          <span class="label"><span class="material-icons">branding_watermark</span>Brand</span>
          <span class="value">Jazz Pakistan</span>
        </div>
        <div class="row">
          <span class="label"><span class="material-icons">description</span>Description</span>
          <span class="value">Prepaid mobile recharge for Jazz Pakistan numbers with instant topup delivery and support. Prepaid mobile recharge for Jazz Pakistan numbers with instant topup delivery and support. Prepaid mobile recharge for Jazz Pakistan numbers with instant topup delivery and support. Prepaid mobile recharge for Jazz Pakistan numbers with instant topup delivery and support. </span>
        </div>
        <div class="row" style="align-items: flex-start;">
          <span class="label"><span class="material-icons">image</span>Images</span>
          <span class="value images-row">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534470/2pXm5tQ_bynr4g.jpg" alt="Product Image 1">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534437/7iXvJCv_dggatx.jpg" alt="Product Image 2">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534470/2pXm5tQ_bynr4g.jpg" alt="Product Image 1">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534437/7iXvJCv_dggatx.jpg" alt="Product Image 2">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534470/2pXm5tQ_bynr4g.jpg" alt="Product Image 1">
            <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534437/7iXvJCv_dggatx.jpg" alt="Product Image 2">
          </span>
        </div>
      </div>
      <div class="card-section financial">
        <div class="section-title financial"><span class="material-icons financial">account_balance</span>Financial Management</div>
        <div class="row">
          <span class="label financial"><span class="material-icons financial">add_circle</span>5000 PPC Credit Bought</span>
          <span class="date"><span class="material-icons financial">calendar_today</span>2025-06-10</span>
        </div>
        <div class="step-desc">
          5,000,000 PKR transferred to bank account of PakPortal agent in Pakistan.<br>
          <strong>Sender:</strong> Goaina Steel Plant, <strong>Account Number:</strong> XXXXX<br>
          <strong>Receiver:</strong> Usman Nasir, <strong>Account Number:</strong> XXXXX
        </div>
        <div class="row">
          <span class="label financial"><span class="material-icons financial">check_circle</span>5000 PPC Credit Made Available</span>
          <span class="date"><span class="material-icons financial">calendar_today</span>2025-06-11</span>
        </div>
        <div class="step-desc">
          5000 PPC added to the PakPortal account of Majeed Ali (Manager, Goaina) by PakPortal agent.
        </div>
        <div class="row">
          <span class="label financial"><span class="material-icons financial">shopping_cart_checkout</span>4000 PPC Credit Added to Spending</span>
          <span class="date"><span class="material-icons financial">calendar_today</span>2025-06-12</span>
        </div>
        <div class="step-desc">
          4000 PPC moved to spending for Mobile Recharge purchases.
        </div>
        <div class="row">
          <span class="label financial"><span class="material-icons financial">shopping_cart_checkout</span>4000 PPC Credit Added to Spending</span>
          <span class="date"><span class="material-icons financial">calendar_today</span>2025-06-12</span>
        </div>
        <div class="step-desc">
          4000 PPC moved to spending for Mobile Recharge purchases.
        </div>
        <!-- Combined Returned section inside financial -->
        <div class="section-title returned" style="margin-top:3px;">
          <span class="material-icons returned">undo</span>1000 PPC Returned
        </div>
        <div class="row">
          <span class="label returned"><span class="material-icons returned">calendar_today</span>Date</span>
          <span class="date"><span class="material-icons returned">calendar_today</span>2025-06-20</span>
        </div>
        <div class="step-desc returned">
          100,000 PKR returned by PakPortal agent in Pakistan to Goaina.<br>
          <strong>Receiver:</strong> Goaina Steel Plant, Account Number: XXXXX<br>
          <strong>Sender:</strong> Usman Nasir, Account Number: XXXXX
        </div>
      </div>
      <div class="card-section processing">
        <div class="section-title processing"><span class="material-icons" style="font-size:19px;">autorenew</span>Updates</div>
        <table class="processing-table" id="processingTable">
          <thead>
            <tr>
              <th class="step-label">Step</th>
              <th class="status-col">Status</th>
              <th class="date-col">Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      <div class="card-section support">
        <div class="section-title support"><span class="material-icons support">support_agent</span>Support</div>
        <div class="support-list">
          <div class="support-item"><span class="material-icons">build_circle</span>Spareparts</div>
          <div class="support-item"><span class="material-icons">home_repair_service</span>Repairing</div>
          <div class="support-item"><span class="material-icons">menu_book</span>Instructions</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Fullscreen Image Modal -->
  <div class="fullscreen-modal" id="fullscreenModal">
    <button class="close-modal-btn" id="closeModalBtn" title="Close">
      <span class="material-icons">close</span>
    </button>
    <img class="fullscreen-img" id="fullscreenImg" src="" alt="Full Image">
  </div>
  <!-- Key Modal Popup -->
  <div class="modal-overlay" id="keyModalOverlay" style="display:none;">
    <div class="key-modal">
      <span class="material-icons" style="font-size:24px;">vpn_key</span>
      <label for="keyInput">Enter Your Polygon (Ethereum) Address:</label>
      <input type="text" id="keyInput" placeholder="0x...">
      <button id="saveKeyBtn">Save Key</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script>
    // These are demo addresses, change them in production
    const WALLETS = {
      spent:     "0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
      inspending:"0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
      returned:  "0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
      available: null // will use user's input key
    };
    const PPC_TO_PKR = 1000;
    // NFTFAN contract (PPC) on Polygon
    const NFTFAN_CA = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const ERC20_ABI = [
      {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
      {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
    ];
    const KEY_STORAGE = "PPC-key";
    const web3 = new Web3("https://polygon-rpc.com/");
    const nftfan = new web3.eth.Contract(ERC20_ABI, NFTFAN_CA);

    function formatNumber(numStr, decimals) {
      if (!numStr) return "--";
      try {
        let n = BigInt(numStr);
        let div = BigInt(10) ** BigInt(decimals);
        let w = n / div;
        return w.toLocaleString('en-US');
      } catch {
        return "--";
      }
    }
    function formatPKR(ppc) {
      if (!ppc || isNaN(ppc.replace(/,/g,''))) return "--";
      let num = parseInt(ppc.replace(/,/g,''), 10);
      return (num * PPC_TO_PKR).toLocaleString('en-US') + " PKR";
    }
    function shortKey(addr) {
      if (!addr) return "---";
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }
    function updatePPCBox(box, value) {
      document.getElementById(box).textContent = value;
      document.getElementById(box.replace('PPC','PKR')).textContent = (value !== "--") ? "≈ " + formatPKR(value) : "";
    }
    async function fetchPPC(addr, box) {
      try {
        const [bal, dec] = await Promise.all([
          nftfan.methods.balanceOf(addr).call(),
          nftfan.methods.decimals().call()
        ]);
        let balStr = formatNumber(bal, dec);
        updatePPCBox(box, balStr);
      } catch {
        updatePPCBox(box, "--");
      }
    }
    // Modal for key input
function showKeyModal() {
  document.getElementById('keyModalOverlay').style.display = 'flex';
  document.body.classList.add("blurred");
  setTimeout(() => { document.getElementById('keyInput').focus(); }, 100);
}

function hideKeyModal() {
  document.getElementById('keyModalOverlay').style.display = 'none';
  document.body.classList.remove("blurred");
}

function getStoredKey() {
  return localStorage.getItem(KEY_STORAGE);
}

function saveKey(addr) {
  localStorage.setItem(KEY_STORAGE, addr);
}

function afterKeySet(addr) {
  WALLETS.available = addr;
  document.getElementById('keyShortValue').textContent = addr; // show full address
  fetchAllBalances();
  document.body.classList.remove("blurred");
}

document.getElementById('deleteKeyBtn').onclick = function() {
  localStorage.removeItem(KEY_STORAGE);
  document.getElementById('keyShortValue').textContent = "---";
  showKeyModal();
};

document.getElementById('saveKeyBtn').onclick = function() {
  let addr = document.getElementById('keyInput').value.trim();
  if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) {
    alert("Please enter a valid Polygon (Ethereum) address.");
    document.getElementById('keyInput').focus();
    return;
  }
  saveKey(addr);
  hideKeyModal();
  afterKeySet(addr);
};

document.getElementById('keyInput').addEventListener('keydown', function(e){
  if (e.key === "Enter") document.getElementById('saveKeyBtn').click();
});

    // Fullscreen image modal logic
    function showFullscreenImage(src) {
      var modal = document.getElementById('fullscreenModal');
      var img = document.getElementById('fullscreenImg');
      img.src = src;
      modal.classList.add('active');
    }
    function closeFullscreenImage() {
      var modal = document.getElementById('fullscreenModal');
      modal.classList.remove('active');
      document.getElementById('fullscreenImg').src = "";
    }
    document.addEventListener("DOMContentLoaded", function() {
      var images = document.querySelectorAll('.product-image');
      images.forEach(function(img) {
        img.addEventListener('click', function() {
          showFullscreenImage(img.src);
        });
      });
      document.getElementById('closeModalBtn').onclick = closeFullscreenImage;
      document.getElementById('fullscreenModal').onclick = function(e) {
        if (e.target === this) closeFullscreenImage();
      };
      document.getElementById('keyModalOverlay').onclick = function(e) {
        if (e.target === this) return false;
      };
      renderProcessingTable();
    });
    // Fetch all balances for each box
    function fetchAllBalances() {
      fetchPPC(WALLETS.spent, "spentPPC");
      fetchPPC(WALLETS.inspending, "spendingPPC");
      fetchPPC(WALLETS.returned, "returnedPPC");
      fetchPPC(WALLETS.available, "availablePPC");
    }
    // On load, check for key and blur content if not set
    (function() {
      let addr = getStoredKey();
      if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) {
        showKeyModal();
      } else {
        afterKeySet(addr);
        setInterval(fetchAllBalances, 60000); // every 60 seconds
      }
    })();

    // --- Processing Section Table ---
    // Only Yes or Pending as text in status
    const processingSteps = [
      {
        label: "Seller Accepted",
        icon: "how_to_reg",
        date: "2025-06-13",
        status: "yes"
      },
      {
        label: "Seller Shipped",
        icon: "local_shipping",
        date: "2025-06-14",
        status: "yes"
      },
      {
        label: "Left EU",
        icon: "flight_takeoff",
        date: "2025-06-15",
        status: "yes"
      },
      {
        label: "Reached Pakistan",
        icon: "flag",
        date: "2025-06-16",
        status: "pending"
      },
      {
        label: "Product Delivered",
        icon: "home",
        date: "2025-06-17",
        status: "pending"
      },
      {
        label: "Completed",
        icon: "verified",
        date: "2025-06-18",
        status: "pending"
      }
    ];

    function renderProcessingTable() {
      const tableBody = document.querySelector("#processingTable tbody");
      tableBody.innerHTML = "";
      processingSteps.forEach(step => {
        const tr = document.createElement("tr");

        // Step label and icon
        const tdLabel = document.createElement("td");
        tdLabel.className = "step-label";
        const icon = document.createElement("span");
        icon.className = "material-icons";
        icon.style.fontSize = "15px";
        icon.textContent = step.icon;
        tdLabel.appendChild(icon);
        const labelText = document.createElement("span");
        labelText.textContent = step.label;
        tdLabel.appendChild(labelText);
        tr.appendChild(tdLabel);

        // Status
        const tdStatus = document.createElement("td");
        tdStatus.className = "status-col";
        if(step.status === "yes") {
          tdStatus.innerHTML = '<span class="status-chip yes-status">Yes</span>';
        } else {
          tdStatus.innerHTML = '<span class="status-chip pending-status">Pending</span>';
        }
        tr.appendChild(tdStatus);

        // Date (with calendar icon)
        const tdDate = document.createElement("td");
        tdDate.className = "date-col";
        tdDate.innerHTML = '<span class="material-icons" style="font-size:13px;vertical-align:middle;margin-right:2px;color:#bdbdbd;">calendar_today</span>' + step.date;
        tr.appendChild(tdDate);

        tableBody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
