<!DOCTYPE html>
<html lang="en">
<head>
  <title>PakPortal</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --primary: #7a3cff;
      --accent: #ffd600;
      --success: #36c177;
      --pending: #ffb300;
      --danger: #e53935;
      --surface: #23273a;
      --surface2: #22263a;
      --surface3: #181a24;
      --border: #312b47;
      --border-light: #3f3b5b;
      --text: #eee;
      --text-light: #bcb9d2;
      --text-faded: #8d8bae;
      --topbar-h: 48px;
      --footer-h: 38px;
      --card-radius: 20px;
      --shadow: rgba(0,0,0,0.08);
      --balance-w: 210px;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-size: 13px;
      font-family: 'Roboto', 'Arial', sans-serif;
      background: var(--surface3);
      color: var(--text);
      box-sizing: border-box;
      overflow: hidden;
    }
    #root-app-layout {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow: hidden;
    }
    .top-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--topbar-h);
      z-index: 100;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 400;
      padding: 0 12px 0 32px;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 2px 10px var(--shadow);
    }
    .footer-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--footer-h);
      background: var(--surface2);
      color: var(--text-faded);
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid var(--border-light);
      z-index: 100;
      letter-spacing: 0.2em;
    }
    .main-app-body {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      width: 100vw;
      height: 100vh;
      margin-top: var(--topbar-h);
      margin-bottom: var(--footer-h);
      overflow: auto;
      align-items: center;
      background: none;
    }
    /* Balances row */
    .balances-row {
      display: flex;
      flex-direction: row;
      gap: 24px;
      justify-content: center;
      align-items: stretch;
      margin: 40px auto 0 auto;
      z-index: 2;
      flex-wrap: wrap;
    }
    .balance-card {
      background: var(--surface3);
      border-radius: 12px;
      padding: 11px 16px 9px 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-left: 4px solid var(--primary);
      position: relative;
      box-shadow: none !important;
      border: 1px solid var(--border);
      min-height: 38px;
      min-width: 180px;
      width: var(--balance-w);
      max-width: 95vw;
      margin-bottom: 0;
      align-items: flex-start;
    }
    .balance-card.spent { border-left: 3px solid var(--danger);}
    .balance-card.inspending { border-left: 3px solid var(--accent);}
    .balance-card.returned { border-left: 3px solid #36c177; background: #1a2c1c;}
    .balance-card.available { border-left: 3px solid var(--primary);}
    .balance-label {
      color: var(--text-faded);
      font-size: 11.5px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 2px;
      letter-spacing: 0.18px;
      text-shadow: 0 2px 10px #0002;
    }
    .balance-label.spent { color: var(--danger);}
    .balance-label.inspending { color: var(--accent);}
    .balance-label.returned { color: #36c177;}
    .balance-label.available { color: var(--primary);}
    .balance-card .material-icons {
      font-size: 15px;
      vertical-align: middle;
      margin-right: 2px;
    }
    .balance-value {
      font-size: 14.5px;
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: flex-end;
      gap: 3px;
      min-height: 14px;
      margin-bottom: 0;
      margin-top: 0;
      text-shadow: 0 2px 10px #0002;
    }
    .balance-value-pkr {
      color: var(--text-faded);
      font-size: 11px;
      font-weight: 500;
      margin-top: 0px;
      margin-left: 1px;
      letter-spacing: 0.1px;
      line-height: 1.2em;
      display: block;
    }
    /* Tabs */
    .tabs-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin: 40px auto 0 auto;
      background: var(--surface2);
      border-radius: 14px 14px 0 0;
      box-shadow: 0 4px 32px #1a183040;
      width: 100%;
      max-width: 720px;
      position: relative;
      z-index: 2;
    }
    .tab-btn {
      flex: 1 1 0;
      padding: 16px 0 12px 0;
      border: none;
      background: none;
      color: var(--text-faded);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.18s;
      outline: none;
      letter-spacing: 0.1em;
      border-radius: 14px 14px 0 0;
    }
    .tab-btn.active {
      color: var(--primary);
      background: var(--surface3);
      border-bottom: 3px solid var(--primary);
    }
    /* Tab content */
    .tab-content {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      display: none;
      background: none;
    }
    .tab-content.active { display: block; }
    .vertical-cards-stack.professional-stack {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      margin: 0 auto;
      padding: 32px 0 40px 0;
      box-sizing: border-box;
    }
    /* Card styles (reused from before) */
    .pro-card {
      background: var(--surface2);
      border-radius: var(--card-radius);
      padding: 0;
      box-shadow: 0 4px 32px #1a183040;
      border: 1.5px solid var(--border);
      margin: 0 auto;
      width: 100%;
      max-width: 680px;
      display: flex;
      flex-direction: column;
      overflow: visible;
    }
    .pro-header {
      background: var(--order-header-bg);
      border-radius: var(--card-radius) var(--card-radius) 0 0;
      padding: 18px 32px 14px 32px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1.5px solid var(--border-light);
    }
    .order-details-list, .product-details-list, .client-details-list {
      padding: 24px 36px 20px 36px;
    }
    .order-details-list dl, .product-details-list dl, .client-details-list dl {
      margin: 0;
      padding: 0;
    }
    .order-row, .product-row, .client-row {
      display: flex;
      align-items: flex-start;
      gap: 32px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
    }
    .order-row:last-child, .product-row:last-child, .client-row:last-child { border-bottom: none; }
    .order-row dt, .product-row dt, .client-row dt {
      min-width: 140px;
      font-weight: 600;
      color: var(--primary);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .order-row dd, .product-row dd, .client-row dd {
      flex: 1;
      font-size: 15px;
      color: var(--text-light);
      font-weight: 400;
      margin: 0;
      background: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .total-row dt, .total-row dd {
      font-size: 17px;
      font-weight: 800;
      color: var(--accent);
    }
    .total-row dd.total-amount {
      font-size: 20px;
      font-weight: 900;
    }
    .images-row {
      display: flex;
      gap: 7px;
      margin-top: 2px;
      margin-bottom: 2px;
      flex-wrap: wrap;
    }
    .product-image {
      width: 80px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 2px 8px #0003;
      border: 2px solid var(--border-light);
      background: #181a24;
      cursor: pointer;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .product-image:hover {
      box-shadow: 0 4px 14px var(--primary);
      border-color: var(--primary);
    }
    .section-title.product-details { color: #36c177;}
    .section-title.support { color: #2196f3;}
    .section-title.client-details { color: #fff;}
    .support-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      margin-top: 4px;
      margin-bottom: 2px;
      padding: 0 32px 20px 32px;
    }
    .support-list .support-item {
      display: flex;
      align-items: center;
      gap: 7px;
      color: #2196f3;
      background: #1d2940;
      padding: 7px 16px;
      border-radius: 10px;
      font-weight: 500;
      font-size: 13px;
      border: 1px solid #253455;
      letter-spacing: 0.1em;
      box-shadow: 0 2px 10px #0002;
    }
    .support-list .material-icons { color: #2196f3; font-size: 15px;}
    /* Updates tab beautiful cards */
    .updates-tab-list {
      padding: 28px 0 30px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }
    .update-beautiful-card {
      background: #1e1935;
      border-radius: 14px;
      margin-bottom: 0;
      padding: 16px 18px 14px 16px;
      border: 1.5px solid var(--border-light);
      box-shadow: 0 2px 10px #0002;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: background 0.2s;
      width: 100%;
      max-width: 590px;
    }
    .update-beautiful-card.success { background: #13291b; border-left: 4px solid var(--success);}
    .update-beautiful-card.pending { background: #2c223c; border-left: 4px solid var(--pending);}
    .update-head-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 0;
      flex-wrap: wrap;
      font-size: 12.5px;
    }
    .update-date {
      color: var(--primary);
      font-size: 12px;
      background: #2d2351;
      border-radius: 3px;
      padding: 2px 10px 2px 7px;
      font-weight: 500;
      border: 1px solid var(--border-light);
      min-width: 92px;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .update-status-chip {
      border-radius: 8px;
      font-size: 11.5px;
      font-weight: 600;
      padding: 4px 16px;
      min-width: 50px;
      text-align: center;
      display: inline-block;
      border: 1.5px solid;
      margin-left: 0;
      margin-right: 0;
      letter-spacing: 0.08em;
      box-shadow: 0 2px 8px #0001;
    }
    .update-status-chip.success { background: #382e0f; color: var(--pending); border-color: #ffd6004d;}
    .update-status-chip.pending { background: #382e0f; color: var(--pending); border-color: #ffd6004d;}
    .update-title-row {
      display: flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap;
      font-size: 14.5px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.03em;
      word-break: break-word;
      max-width: 100%;
      text-shadow: 0 2px 10px #0002;
      padding-right: 8px;
      margin-bottom: 4px;
      margin-top: 2px;
    }
    .update-title {
      font-size: 14.5px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.03em;
      flex: 1 1 140px;
      word-break: break-word;
      max-width: 100%;
      text-shadow: 0 2px 10px #0002;
      padding-right: 8px;
    }
    .update-divider {
      border: none;
      border-top: 1px solid var(--border-light);
      margin: 10px 0 7px 0;
      width: 100%;
      opacity: 0.5;
    }
    .update-description {
      font-size: 13px;
      color: var(--text-light);
      padding: 6px 0 0 2px;
      margin-bottom: 0;
      letter-spacing: 0.01em;
      line-height: 1.6em;
      word-break: break-word;
    }
    .update-icon {
      color: var(--accent);
      margin-right: 3px;
      font-size: 20px;
      vertical-align: middle;
    }
    /* Modal styles reused as in your previous code */
    .fullscreen-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(30,24,50,0.97);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      animation: fadeIn .22s;
    }
    .fullscreen-modal.active { display: flex; }
    .fullscreen-img {
      max-width: 70vw;
      max-height: 65vh;
      border-radius: 8px;
      box-shadow: 0 2px 16px #000;
      background: #fff;
      object-fit: contain;
    }
    .close-modal-btn {
      position: absolute;
      top: 16px;
      right: 36px;
      background: rgba(30,24,50,0.46);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 34px; height: 34px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 10001;
      transition: background 0.2s;
      border: 1.2px solid var(--border-light);
    }
    .close-modal-btn:hover { background: var(--primary); }
    .modal-overlay {
      position: fixed;
      left:0; top:0; right:0; bottom:0;
      width:100vw; height:100vh;
      background: rgba(40,30,60,0.45);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .key-modal {
      background: var(--surface);
      color: var(--text);
      border-radius: 14px;
      box-shadow: 0 8px 32px var(--primary-dark)80;
      padding: 22px 18px 18px 18px;
      min-width: 290px;
      max-width: 96vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 10001;
      font-size: 14px;
      font-weight: 400;
      border: 1px solid var(--border-light);
    }
    .key-modal .material-icons { color: var(--primary); font-size: 24px;}
    .key-modal label { font-weight: 500; font-size: 13px;}
    .key-modal input[type="text"] {
      width: 220px;
      font-size: 14px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 7px 11px;
      margin-top: 3px;
      background: var(--surface2);
      color: var(--text);
      outline: none;
      transition: border 0.2s, background 0.2s;
    }
    .key-modal input[type="text"]:focus { border: 1.5px solid var(--primary);}
    .key-modal button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 22px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 0;
      transition: background 0.2s;
      box-shadow: 0 2px 10px #0001;
    }
    .key-modal button:hover { background: var(--primary-dark);}
    ::-webkit-scrollbar {
      width: 8px;
      background: #21213a;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: #30256b;
      border-radius: 7px;
      border: 2px solid #21213a;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #5a35c5;
    }
    @media (max-width: 900px) {
      .balances-row { flex-direction: column; gap: 16px; margin-top: 22px;}
      .tabs-row { margin-top: 18px; }
      .vertical-cards-stack.professional-stack { padding: 16px 0 24px 0; gap: 18px;}
      .pro-card { max-width: 96vw; }
      .order-details-list, .product-details-list, .client-details-list { padding: 16px 12px 12px 12px;}
      .pro-header { padding: 12px 14px 10px 14px;}
      .order-row, .product-row, .client-row { gap: 12px; flex-direction: column; align-items: flex-start;}
      .order-row dt, .product-row dt, .client-row dt { min-width: 100px;}
      .tab-content, .tabs-row { max-width: 99vw;}
      .update-beautiful-card { max-width: 99vw;}
    }
  </style>
</head>
<body>
<div id="root-app-layout">
  <div class="top-bar">
    <div class="title">
      <span class="material-icons" style="font-size:20px;">precision_manufacturing</span>
      PakPortal
      <span class="exchange-rate"><span class="material-icons" style="font-size:13px;vertical-align:middle;"></span>1 PPC = 1000 PKR</span>
    </div>
    <div class="status-bar">
      <span title="Your Key" class="key-short" id="keyShort">
        <span class="material-icons" style="font-size:17px;">vpn_key</span>
        <span id="keyShortValue" style="font-size:13px;">---</span>
        <button class="delete-btn" title="Remove Key" id="deleteKeyBtn">
          <span class="material-icons" style="font-size:16px;">delete</span>
        </button>
      </span>
    </div>
  </div>
  <div class="main-app-body">
    <!-- Balances row in center -->
    <div class="balances-row">
      <div class="balance-card spent">
        <div class="balance-label spent"><span class="material-icons spent">money_off</span>Spent PPC</div>
        <div class="balance-value" id="spentPPC">--</div>
        <div class="balance-value-pkr" id="spentPKR"></div>
      </div>
      <div class="balance-card inspending">
        <div class="balance-label inspending"><span class="material-icons inspending">pending_actions</span>In Spending</div>
        <div class="balance-value" id="spendingPPC">--</div>
        <div class="balance-value-pkr" id="spendingPKR"></div>
      </div>
      <div class="balance-card returned">
        <div class="balance-label returned"><span class="material-icons returned">undo</span>Returned PPC</div>
        <div class="balance-value" id="returnedPPC">--</div>
        <div class="balance-value-pkr" id="returnedPKR"></div>
      </div>
      <div class="balance-card available">
        <div class="balance-label available"><span class="material-icons available">credit_score</span>Available PPC</div>
        <div class="balance-value" id="availablePPC">--</div>
        <div class="balance-value-pkr" id="availablePKR"></div>
      </div>
    </div>
    <!-- Tabbed Interface -->
    <div class="tabs-row" id="tabsRow">
      <button class="tab-btn active" data-tab="information" id="tabInformationBtn"><span class="material-icons" style="font-size:18px;vertical-align:middle;">info</span> Information</button>
      <button class="tab-btn" data-tab="updates" id="tabUpdatesBtn"><span class="material-icons" style="font-size:18px;vertical-align:middle;">autorenew</span> Updates</button>
    </div>
    <div class="tab-content active" id="informationTab">
      <div class="vertical-cards-stack professional-stack" id="mainScrollableContent">
        <!-- Client Info Section as Card -->
        <section class="card-section client-info pro-card">
          <header class="section-title client-details pro-header">
            <span class="material-icons">person</span> Client Info
          </header>
          <div class="client-details-list">
            <dl>
              <div class="client-row">
                <dt><span class="material-icons">person</span> Client</dt>
                <dd>xx</dd>
              </div>
              <div class="client-row">
                <dt><span class="material-icons">person_outline</span> Contact</dt>
                <dd>John Doe</dd>
              </div>
              <div class="client-row">
                <dt><span class="material-icons">email</span> Email</dt>
                <dd>john@example.com</dd>
              </div>
              <div class="client-row">
                <dt><span class="material-icons">call</span> Phone</dt>
                <dd>+123 456 7890</dd>
              </div>
              <div class="client-row">
                <dt><span class="material-icons">account_balance</span> Bank</dt>
                <dd>PK00XXXX000000000000</dd>
              </div>
              <div class="client-row">
                <dt><span class="material-icons">location_on</span> Address</dt>
                <dd>123 Main Street, Lahore, Pakistan</dd>
              </div>
            </dl>
          </div>
        </section>
        <!-- Order Details Section -->
        <section class="card-section order-details pro-card">
          <header class="order-section-header pro-header">
            <span class="material-icons">shopping_cart</span>
            <h3 class="order-section-title">Order Details</h3>
          </header>
          <div class="order-details-list">
            <dl>
              <div class="order-row">
                <dt><span class="material-icons">shopping_cart</span> Product</dt>
                <dd>Mobile Recharge</dd>
              </div>
              <div class="order-row">
                <dt><span class="material-icons">branding_watermark</span> Brand</dt>
                <dd>Jazz Pakistan</dd>
              </div>
              <div class="order-row">
                <dt><span class="material-icons">payments</span> Unit Price</dt>
                <dd>1000 PPC</dd>
              </div>
              <div class="order-row">
                <dt><span class="material-icons">stacked_line_chart</span> Quantity</dt>
                <dd>1 Piece</dd>
              </div>
              <div class="order-row total-row">
                <dt>Total</dt>
                <dd class="total-amount">1000 PPC</dd>
              </div>
            </dl>
          </div>
        </section>
        <!-- Product Details Section -->
        <section class="card-section product-details pro-card">
          <header class="section-title product-details pro-header">
            <span class="material-icons">info</span> Product Details
          </header>
          <div class="product-details-list">
            <dl>
              <div class="product-row">
                <dt><span class="material-icons">shopping_cart</span> Name</dt>
                <dd>Mobile Recharge</dd>
              </div>
              <div class="product-row">
                <dt><span class="material-icons">branding_watermark</span> Brand</dt>
                <dd>Jazz Pakistan</dd>
              </div>
              <div class="product-row">
                <dt><span class="material-icons">payments</span> Price</dt>
                <dd>1000 PPC</dd>
              </div>
              <div class="product-row">
                <dt><span class="material-icons">description</span> Description</dt>
                <dd>Prepaid mobile recharge for Jazz Pakistan numbers with instant topup delivery and support.</dd>
              </div>
              <div class="product-row">
                <dt><span class="material-icons">image</span> Images</dt>
                <dd>
                  <div class="images-row">
                    <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534470/2pXm5tQ_bynr4g.jpg" alt="Product Image 1">
                    <img class="product-image" src="https://res.cloudinary.com/de3kzkvhd/image/upload/v1749534437/7iXvJCv_dggatx.jpg" alt="Product Image 2">
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </section>
        <!-- Support Section -->
        <section class="card-section support pro-card">
          <header class="section-title support pro-header">
            <span class="material-icons support">support_agent</span> Support
          </header>
          <ul class="support-list">
            <li class="support-item"><span class="material-icons">build_circle</span> Spareparts</li>
            <li class="support-item"><span class="material-icons">home_repair_service</span> Repairing</li>
            <li class="support-item"><span class="material-icons">menu_book</span> Instructions</li>
          </ul>
        </section>
      </div>
    </div>
    <div class="tab-content" id="updatesTab">
      <div class="updates-tab-list" id="updatesTabList">
        <!-- JS will populate beautiful update cards here -->
      </div>
    </div>
  </div>
  <div class="footer-bar">
    Copyright PakPortal 2025
  </div>
</div>
<!-- Fullscreen Image Modal -->
<div class="fullscreen-modal" id="fullscreenModal">
  <button class="close-modal-btn" id="closeModalBtn" title="Close">
    <span class="material-icons">close</span>
  </button>
  <img class="fullscreen-img" id="fullscreenImg" src="" alt="Full Image">
</div>
<!-- Key Modal Popup -->
<div class="modal-overlay" id="keyModalOverlay" style="display:none;">
  <div class="key-modal">
    <span class="material-icons" style="font-size:24px;">vpn_key</span>
    <label for="keyInput">Enter Your Polygon (Ethereum) Address:</label>
    <input type="text" id="keyInput" placeholder="0x...">
    <button id="saveKeyBtn">Save Key</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script>
  // Demo addresses, change in production
  const WALLETS = {
    spent:     "0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
    inspending:"0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
    returned:  "0x53d284357ec70ce289d6d64134dfac8e511c8a3d",
    available: null // will use user's input key
  };
  const PPC_TO_PKR = 1000;
  // NFTFAN contract (PPC) on Polygon
  const NFTFAN_CA = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
  const ERC20_ABI = [
    {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
    {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
  ];
  const KEY_STORAGE = "PPC-key";
  const web3 = new Web3("https://polygon-rpc.com/");
  const nftfan = new web3.eth.Contract(ERC20_ABI, NFTFAN_CA);

  function formatNumber(numStr, decimals) {
    if (!numStr) return "--";
    try {
      let n = BigInt(numStr);
      let div = BigInt(10) ** BigInt(decimals);
      let w = n / div;
      return w.toLocaleString('en-US');
    } catch {
      return "--";
    }
  }
  function formatPKR(ppc) {
    if (!ppc || isNaN(ppc.replace(/,/g,''))) return "--";
    let num = parseInt(ppc.replace(/,/g,''), 10);
    return (num * PPC_TO_PKR).toLocaleString('en-US') + " PKR";
  }
  function updatePPCBox(box, value) {
    document.getElementById(box).textContent = value;
    document.getElementById(box.replace('PPC','PKR')).textContent = (value !== "--") ? "≈ " + formatPKR(value) : "";
  }
  async function fetchPPC(addr, box) {
    try {
      const [bal, dec] = await Promise.all([
        nftfan.methods.balanceOf(addr).call(),
        nftfan.methods.decimals().call()
      ]);
      let balStr = formatNumber(bal, dec);
      updatePPCBox(box, balStr);
    } catch {
      updatePPCBox(box, "--");
    }
  }
  // Modal for key input
  function showKeyModal() {
    document.getElementById('keyModalOverlay').style.display = 'flex';
    document.body.classList.add("blurred");
    setTimeout(() => { document.getElementById('keyInput').focus(); }, 100);
  }
  function hideKeyModal() {
    document.getElementById('keyModalOverlay').style.display = 'none';
    document.body.classList.remove("blurred");
  }
  function getStoredKey() {
    return localStorage.getItem(KEY_STORAGE);
  }
  function saveKey(addr) {
    localStorage.setItem(KEY_STORAGE, addr);
  }
  function afterKeySet(addr) {
    WALLETS.available = addr;
    document.getElementById('keyShortValue').textContent = addr; // show full key now
    fetchAllBalances();
    document.body.classList.remove("blurred");
  }
  document.getElementById('deleteKeyBtn').onclick = function() {
    localStorage.removeItem(KEY_STORAGE);
    document.getElementById('keyShortValue').textContent = "---";
    showKeyModal();
  };
  document.getElementById('saveKeyBtn').onclick = function() {
    let addr = document.getElementById('keyInput').value.trim();
    if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) {
      alert("Please enter a valid Polygon (Ethereum) address.");
      document.getElementById('keyInput').focus();
      return;
    }
    saveKey(addr);
    hideKeyModal();
    afterKeySet(addr);
  };
  document.getElementById('keyInput').addEventListener('keydown', function(e){
    if (e.key === "Enter") document.getElementById('saveKeyBtn').click();
  });

  // Tabs logic
  document.getElementById('tabInformationBtn').onclick = function() {
    document.getElementById('tabInformationBtn').classList.add('active');
    document.getElementById('tabUpdatesBtn').classList.remove('active');
    document.getElementById('informationTab').classList.add('active');
    document.getElementById('updatesTab').classList.remove('active');
  };
  document.getElementById('tabUpdatesBtn').onclick = function() {
    document.getElementById('tabUpdatesBtn').classList.add('active');
    document.getElementById('tabInformationBtn').classList.remove('active');
    document.getElementById('updatesTab').classList.add('active');
    document.getElementById('informationTab').classList.remove('active');
  };

  // Fullscreen image modal logic
  function showFullscreenImage(src) {
    var modal = document.getElementById('fullscreenModal');
    var img = document.getElementById('fullscreenImg');
    img.src = src;
    modal.classList.add('active');
  }
  function closeFullscreenImage() {
    var modal = document.getElementById('fullscreenModal');
    modal.classList.remove('active');
    document.getElementById('fullscreenImg').src = "";
  }
  document.addEventListener("DOMContentLoaded", function() {
    var images = document.querySelectorAll('.product-image');
    images.forEach(function(img) {
      img.addEventListener('click', function() {
        showFullscreenImage(img.src);
      });
    });
    document.getElementById('closeModalBtn').onclick = closeFullscreenImage;
    document.getElementById('fullscreenModal').onclick = function(e) {
      if (e.target === this) closeFullscreenImage();
    };
    document.getElementById('keyModalOverlay').onclick = function(e) {
      if (e.target === this) return false;
    };
    renderBeautifulUpdatesTab();
  });
  // Fetch all balances for each box
  function fetchAllBalances() {
    fetchPPC(WALLETS.spent, "spentPPC");
    fetchPPC(WALLETS.inspending, "spendingPPC");
    fetchPPC(WALLETS.returned, "returnedPPC");
    fetchPPC(WALLETS.available, "availablePPC");
  }
  // On load, check for key and blur content if not set
  (function() {
    let addr = getStoredKey();
    if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) {
      showKeyModal();
    } else {
      afterKeySet(addr);
      setInterval(fetchAllBalances, 60000); // every 60 seconds
    }
  })();

  // --- Updates Tab Section ---
  const updates = [
    {
      title: "5000 PPC Credit Bought",
      icon: "check_circle",
      status: "success",
      date: "2025-06-10",
      description: "5,000,000 PKR transferred to bank account of PakPortal agent in Pakistan. Sender: Goaina Steel Plant (XXXXX). Receiver: Usman Nasir (XXXXX)."
    },
    {
      title: "5000 PPC Credit Made Available",
      icon: "check_circle",
      status: "success",
      date: "2025-06-11",
      description: "5000 PPC added to the PakPortal account of Majeed Ali (Manager, Goaina) by PakPortal agent."
    }
  ];

  function renderBeautifulUpdatesTab() {
    const updatesList = document.getElementById('updatesTabList');
    updatesList.innerHTML = "";
    updates.forEach(update => {
      const card = document.createElement('div');
      card.className = "update-beautiful-card " + (update.status === "success" ? "success" : "pending");

      // Date + Status row
      const headRow = document.createElement('div');
      headRow.className = "update-head-row";
      // Date
      const date = document.createElement('span');
      date.className = "update-date";
      date.innerHTML = `<span class="material-icons" style="font-size:13px;vertical-align:middle;margin-right:2px;">calendar_today</span>${update.date}`;
      headRow.appendChild(date);
      // Status chip
      const status = document.createElement('span');
      status.className = "update-status-chip " + (update.status === "success" ? "success" : "pending");
      status.textContent = update.status === "success" ? "Success" : "Pending";
      headRow.appendChild(status);
      card.appendChild(headRow);

      // Divider line
      const divider1 = document.createElement('hr');
      divider1.className = "update-divider";
      card.appendChild(divider1);

      // Title row (with icon)
      const titleRow = document.createElement('div');
      titleRow.className = "update-title-row";
      // Icon
      const icon = document.createElement('span');
      icon.className = "material-icons update-icon";
      icon.textContent = update.icon;
      titleRow.appendChild(icon);
      // Title
      const title = document.createElement('span');
      title.className = "update-title";
      title.textContent = update.title;
      titleRow.appendChild(title);
      card.appendChild(titleRow);

      // Divider line
      const divider2 = document.createElement('hr');
      divider2.className = "update-divider";
      card.appendChild(divider2);

      // Description
      const desc = document.createElement('div');
      desc.className = "update-description";
      desc.textContent = update.description;
      card.appendChild(desc);

      updatesList.appendChild(card);
    });
  }
</script>
</body>
</html>
