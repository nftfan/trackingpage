<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FOODPHOTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <!-- Material Icons CDN -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #388e3c;
      --accent: #fffde7;
      --border: #e0e0e0;
      --shadow: 0 2px 10px #0002;
      --tab-active: #fffde7;
      --tab-inactive: #e0e0e0;
      font-size: 17px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #222;
      min-height: 100vh;
      font-size: 1rem;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      overscroll-behavior: contain;
    }
    input, select, textarea {
      font-size: 1rem !important;
    }
    .landing-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 75vh;
      gap: 30px;
      padding-top: 20vh;
      background: #f3faf5;
      animation: fadeIn 0.4s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .landing-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 18px 34px;
      background: #fff;
      border-radius: 10px;
      font-size: 1.13em;
      font-weight: bold;
      color: #388e3c;
      border: 1.5px solid #388e3c;
      box-shadow: 0 2px 10px #0001;
      cursor: pointer;
      outline: none;
      transition: background 0.18s, color 0.18s, border 0.15s;
      letter-spacing: .2px;
      text-shadow: 0 1px 2px #fff5;
    }
    .landing-btn:active, .landing-btn:focus {
      background: #e8f5e9;
      color: #2c6c2d;
      border-color: #2c6c2d;
    }
    .landing-btn .material-icons {
      font-size: 2.1em;
      vertical-align: middle;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 14px 15px;
      font-size: 1.2em;
      position: sticky;
      top: 0;
      z-index: 2;
      min-height: 52px;
      letter-spacing: .5px;
    }
    .header-title {
      font-weight: bold;
      letter-spacing: 1px;
      font-size: 1.13em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .icon-btn {
      background: none;
      border: none;
      color: white;
      font-size: 2em;
      cursor: pointer;
      outline: none;
      padding: 0 5px;
      display: flex;
      align-items: center;
    }
    .search-bar-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 5px 0 5px 0;
      transition: max-height 0.2s;
    }
    .search-bar {
      display: flex;
      align-items: center;
      width: 96%;
      max-width: 420px;
      margin: 0 auto;
      background: #f3f3f3;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 1em;
      gap: 7px;
    }
    .search-bar input {
      border: none;
      background: transparent;
      font-size: 1em;
      outline: none;
      width: 100%;
      padding: 7px 0;
      color: #222;
    }
    .search-bar .material-icons {
      color: #388e3c;
      font-size: 1.3em;
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      background: #fff;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    .tab {
      flex: 1 0 auto;
      padding: 10px 20px;
      border: none;
      outline: none;
      background: var(--tab-inactive);
      color: #333;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
      border-right: 1px solid var(--border);
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tab:last-child { border-right: none; }
    .tab.active {
      background: var(--tab-active);
      color: var(--primary);
      border-bottom: 2.5px solid var(--primary);
      font-weight: bold;
    }
    .main {
      padding: 16px 6px 16px 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 22px;
    }
    @media (min-width: 400px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 700px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }
    .item-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 240px;
      transition: box-shadow 0.18s, transform 0.15s;
      position: relative;
      cursor: pointer;
    }
    .item-card:hover {
      box-shadow: 0 4px 15px #0003;
      transform: translateY(-2px) scale(1.012);
    }
    .item-imgs {
      position: relative;
      width: 100%;
      aspect-ratio: 5/3;
      background: linear-gradient(120deg, #f8fafc, #e7fce3);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      min-height: 140px;
      max-height: 210px;
    }
    .item-imgs img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
      transition: filter 0.18s;
      background: #fff;
      cursor: pointer;
    }
    .item-imgs .img-thumbs {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      z-index: 2;
    }
    .item-imgs .img-thumbs img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 2px solid #fff;
      box-shadow: 0 1px 3px #0002;
      opacity: 0.7;
      background: #fff;
      cursor: pointer;
      object-fit: cover;
      transition: opacity 0.18s, border 0.18s;
    }
    .item-imgs .img-thumbs img.selected {
      opacity: 1;
      border: 2px solid var(--primary);
    }
    .item-content {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 16px 14px 12px 14px;
      flex: 1 1 auto;
    }
    .item-title-row {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 2px;
    }
    .item-title {
      font-weight: bold;
      color: #222;
      font-size: 1.23em;
      line-height: 1.35;
      letter-spacing: 0.5px;
      word-break: break-word;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .item-whatsapp-row {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #077f3f;
      font-size: 1em;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .item-whatsapp-row .material-icons {
      font-size: 1.16em;
    }
    .item-whatsapp-row a {
      color: inherit;
      text-decoration: underline;
      font-size: 1em;
      font-weight: 500;
    }
    .item-brand-row {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #388e3c;
      font-size: 1.05em;
      font-weight: 500;
      margin-bottom: 6px;
      letter-spacing: .18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .item-desc-row {
      display: flex;
      align-items: flex-start;
      gap: 7px;
      color: #555;
      font-size: 1em;
      margin-bottom: 7px;
      line-height: 1.35;
      max-height: 2.7em;
      overflow: hidden;
      text-overflow: ellipsis;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      display: -webkit-box;
    }
    .item-details-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      gap: 10px;
    }
    .item-tag-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1em;
    }
    .item-tag {
      display: inline-block;
      background: linear-gradient(90deg, #e8f5e9 70%, #e3f3fb 100%);
      border-radius: 8px;
      padding: 3px 13px;
      font-size: 1em;
      color: #388e3c;
      font-weight: 600;
      letter-spacing: .4px;
      margin: 0;
      box-shadow: 0 1px 3px #0001;
    }
    /* ...Modal/Popup styles from before... */
    .modal-bg,
    .popup-bg {
      position: fixed;
      z-index: 99;
      inset: 0;
      background: #0007;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-bg.active,
    .popup-bg.active { display: flex; }
    .modal,
    .popup {
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 18px 15px 14px 15px;
      width: 100vw;
      max-width: 480px;
      box-shadow: 0 -2px 18px #0003;
      font-size: 1.09em;
      animation: modalIn 0.22s;
      position: relative;
    }
    @keyframes modalIn {
      from { transform: translateY(60px); opacity: 0; }
      to { transform: none; opacity: 1; }
    }
    .modal h2 {
      margin: 0 0 10px 0;
      font-size: 1.18em;
      font-weight: bold;
      color: #388e3c;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .modal label {
      display: flex;
      align-items: center;
      gap: 7px;
      margin: 7px 0 2px 0;
      font-size: 1.08em;
      color: #444;
      font-weight: 500;
    }
    .modal label .material-icons { color: #388e3c; }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      font-size: 1em !important;
      padding: 9px 9px;
      border: 1.2px solid var(--border);
      border-radius: 6px;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .modal textarea {
      resize: vertical;
      min-height: 44px;
      max-height: 120px;
    }
    .modal .modal-actions {
      display: flex;
      gap: 14px;
      justify-content: flex-end;
      margin-top: 8px;
    }
    .modal button {
      padding: 9px 22px;
      border-radius: 7px;
      border: none;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
      background: var(--primary);
      color: #fff;
      transition: background 0.2s;
      letter-spacing: .2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal button.cancel {
      background: #eee;
      color: #333;
      font-weight: normal;
    }
    .modal .img-preview {
      display: flex;
      gap: 8px;
      margin-bottom: 7px;
      flex-wrap: wrap;
    }
    .modal .img-preview img {
      width: 56px;
      height: 56px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid var(--border);
    }
    .camera-preview {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 7px;
      background: #000;
      border-radius: 12px;
      min-height: 180px;
      max-height: 280px;
      overflow: hidden;
      position: relative;
    }
    .camera-preview video {
      border-radius: 12px;
      border: none;
      width: 100vw;
      max-width: 440px;
      max-height: 270px;
      object-fit: cover;
      background: #000;
      aspect-ratio: 16/9;
      min-height: 180px;
    }
    .capture-btn-row {
      display: flex;
      justify-content: center;
      margin: 13px 0 0 0;
      gap: 12px;
    }
    .capture-btn {
      background: #388e3c;
      color: #fff;
      border: none;
      font-size: 2em;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
    }
    .capture-btn:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }
    /* Fullscreen Image Popup Improved */
    .popup-bg {
      align-items: center !important;
      justify-content: center !important;
      background: #111c;
      animation: fadeIn 0.21s;
    }
    .popup-img-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #222;
      border-radius: 20px;
      padding: 0;
      max-width: 99vw;
      max-height: 93vh;
      position: relative;
      box-shadow: 0 6px 32px #0005;
      animation: popupZoomIn 0.21s;
    }
    @keyframes popupZoomIn {
      from { transform: scale(0.97) translateY(30px); opacity: 0.7; }
      to { transform: none; opacity: 1; }
    }
    .popup-img {
      max-width: 93vw;
      max-height: 85vh;
      border-radius: 16px;
      display: block;
      background: #222;
      margin: 0;
      box-shadow: 0 4px 24px #0005;
      transition: box-shadow 0.22s;
    }
    .popup-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      color: #388e3c;
      border: none;
      border-radius: 50%;
      width: 49px;
      height: 49px;
      font-size: 2.2em;
      box-shadow: 0 2px 8px #0003;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.95;
      z-index: 11;
      transition: background 0.13s;
    }
    .popup-arrow:active { background: #d0f2e4; }
    .popup-arrow.left { left: -58px; }
    .popup-arrow.right { right: -58px; }
    @media (max-width: 700px) {
      .popup-arrow.left { left: 7px; }
      .popup-arrow.right { right: 7px; }
    }
    .popup-close {
      position: absolute;
      top: 10px;
      right: 12px;
      background: #fff;
      border: none;
      border-radius: 50%;
      width: 43px;
      height: 43px;
      font-size: 2em;
      color: #c62828;
      cursor: pointer;
      box-shadow: 0 2px 10px #0003;
      z-index: 15;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.17s;
    }
    .popup-close:active { background: #fbe9e7; }
    @media (max-width: 500px) {
      .popup-arrow.left { left: 3px; }
      .popup-arrow.right { right: 3px; }
      .popup-img { max-width: 97vw; }
      .popup-img-wrap { border-radius: 12px; }
      .popup-close { top: 6px; right: 7px; width: 37px; height: 37px; font-size: 1.67em;}
    }
    @media (max-width: 385px) {
      .popup-img { max-width: 99vw; }
    }
  </style>
</head>
<body>
  <!-- Landing actions, shown first -->
  <div class="landing-actions" id="landingActions">
    <button class="landing-btn" id="landingBuyBtn">
      <span class="material-icons">search</span> Buy
    </button>
    <button class="landing-btn" id="landingSellBtn">
      <span class="material-icons">photo_camera</span> Sell
    </button>
  </div>
  <!-- HEADER -->
  <div class="header" id="mainHeader" style="display:none;">
    <span class="header-title"><span class="material-icons">restaurant</span> FOODPHOTO</span>
    <span class="header-actions">
      <button class="icon-btn" id="openSearchBtn" aria-label="Search" title="Buy">
        <span class="material-icons">search</span>
        <span style="font-size:0.83em;margin-left:2px;">Buy</span>
      </button>
      <button class="icon-btn" id="openModalBtn" aria-label="Sell" title="Sell">
        <span class="material-icons">photo_camera</span>
        <span style="font-size:0.83em;margin-left:2px;">Sell</span>
      </button>
    </span>
  </div>
  <!-- SEARCH BAR -->
  <div class="search-bar-container" id="searchBarContainer" style="display:none;">
    <form class="search-bar" id="searchForm" autocomplete="off">
      <span class="material-icons">search</span>
      <input type="text" id="searchInput" placeholder="Search foods, brands, tags, descriptions..." maxlength="40" />
      <button type="button" class="icon-btn" id="closeSearchBtn" aria-label="Close Search" style="color:#c62828;">
        <span class="material-icons">close</span>
      </button>
    </form>
  </div>
  <!-- TAGS AS TABS -->
  <div class="tabs" id="tagsTabs" style="display:none;"></div>
  <!-- MAIN GRID -->
  <div class="main" id="mainContent" style="display:none;">
    <div class="grid" id="itemsGrid"></div>
  </div>
  <!-- MODAL FOR ADDING ITEM -->
  <div class="modal-bg" id="modalBg">
    <form class="modal" id="itemForm" autocomplete="off">
      <h2><span class="material-icons">add_a_photo</span> Add Food Photo</h2>
      <div class="camera-preview" id="cameraPreview">
        <video id="video" autoplay playsinline></video>
      </div>
      <div class="capture-btn-row">
        <button type="button" class="capture-btn" id="captureBtn" title="Take Photo">
          <span class="material-icons">camera_alt</span>
        </button>
        <button type="button" class="capture-btn" id="clearPhotosBtn" title="Clear Photos" style="background:#c62828;">
          <span class="material-icons">delete</span>
        </button>
      </div>
      <div class="img-preview" id="imgPreview"></div>
      <label for="foodName"><span class="material-icons">fastfood</span> Food Name</label>
      <input id="foodName" name="foodName" type="text" maxlength="30" required autocomplete="off">
      <label for="brandName"><span class="material-icons">business</span> Brand Name</label>
      <input id="brandName" name="brandName" type="text" maxlength="30" required autocomplete="off">
      <label for="desc"><span class="material-icons">description</span> Description</label>
      <textarea id="desc" name="desc" maxlength="120" required placeholder="Describe the food, expiry, etc." autocomplete="off"></textarea>
      <label for="whatsapp"><span class="material-icons">whatsapp</span> WhatsApp Number</label>
      <input id="whatsapp" name="whatsapp" type="tel" pattern="^(\+?\d{10,15})$" maxlength="16" required placeholder="+919999999999" autocomplete="off">
      <label for="foodTag"><span class="material-icons">category</span> Food Tag</label>
      <select id="foodTag" name="foodTag" required>
        <!-- Populated by JS -->
      </select>
      <div class="modal-actions">
        <button type="button" class="cancel" id="cancelBtn"><span class="material-icons">close</span> Cancel</button>
        <button type="submit"><span class="material-icons">add</span> Add</button>
      </div>
    </form>
  </div>
  <!-- IMAGE POPUP FULLSCREEN -->
  <div class="popup-bg" id="popupBg">
    <div class="popup-img-wrap" id="popupImgWrap">
      <button class="popup-arrow left" id="popupArrowLeft" aria-label="Previous" style="display:none;"><span class="material-icons">chevron_left</span></button>
      <img class="popup-img" id="popupImg" src="" alt="Food photo">
      <button class="popup-arrow right" id="popupArrowRight" aria-label="Next" style="display:none;"><span class="material-icons">chevron_right</span></button>
      <button class="popup-close" id="popupCloseBtn" aria-label="Close"><span class="material-icons">close</span></button>
    </div>
  </div>
  <script>
    // 10 Food Tags
    const TAGS = [
      "Fruits", "Vegetables", "Snacks", "Bakery", "Dairy",
      "Meat", "Seafood", "Beverages", "Frozen", "Grains"
    ];
    // Tag Icons
    const TAG_ICONS = {
      "Fruits": "local_florist",
      "Vegetables": "eco",
      "Snacks": "local_pizza",
      "Bakery": "cake",
      "Dairy": "local_cafe",
      "Meat": "set_meal",
      "Seafood": "waves",
      "Beverages": "emoji_food_beverage",
      "Frozen": "ac_unit",
      "Grains": "spa"
    };
    // UI Elements
    const landingActions = document.getElementById('landingActions');
    const landingBuyBtn = document.getElementById('landingBuyBtn');
    const landingSellBtn = document.getElementById('landingSellBtn');
    const mainHeader = document.getElementById('mainHeader');
    const tagsTabs = document.getElementById('tagsTabs');
    const itemsGrid = document.getElementById('itemsGrid');
    const mainContent = document.getElementById('mainContent');
    const modalBg = document.getElementById('modalBg');
    const openModalBtn = document.getElementById('openModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const itemForm = document.getElementById('itemForm');
    const foodTagSelect = document.getElementById('foodTag');
    const imgPreview = document.getElementById('imgPreview');
    const cameraPreview = document.getElementById('cameraPreview');
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('captureBtn');
    const clearPhotosBtn = document.getElementById('clearPhotosBtn');
    // Popup
    const popupBg = document.getElementById('popupBg');
    const popupImg = document.getElementById('popupImg');
    const popupImgWrap = document.getElementById('popupImgWrap');
    const popupCloseBtn = document.getElementById('popupCloseBtn');
    const popupArrowLeft = document.getElementById('popupArrowLeft');
    const popupArrowRight = document.getElementById('popupArrowRight');
    // Search
    const openSearchBtn = document.getElementById('openSearchBtn');
    const closeSearchBtn = document.getElementById('closeSearchBtn');
    const searchBarContainer = document.getElementById('searchBarContainer');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    // State
    let items = [];
    let activeTag = 'All';
    let capturedImages = [];
    let cameraStream = null;
    let searchQuery = '';
    // Popup State
    let popupItemIdx = 0;
    let popupImgIdx = 0;
    let popupImages = [];

    function showMain(forBuy) {
      landingActions.style.display = "none";
      mainHeader.style.display = "";
      mainContent.style.display = "";
      tagsTabs.style.display = "";
      if (forBuy) {
        searchBarContainer.style.display = "flex";
        setTimeout(() => searchInput.focus(), 100);
      } else {
        searchBarContainer.style.display = "none";
      }
      renderTags();
      renderItems();
    }
    landingBuyBtn.onclick = () => showMain(true);
    landingSellBtn.onclick = () => {
      showMain(false);
      openModal();
    }

    // Populate tags as tabs w/icons
    function renderTags() {
      tagsTabs.innerHTML = '';
      const allTab = document.createElement('button');
      allTab.innerHTML = `<span class="material-icons">view_module</span> All`;
      allTab.className = 'tab' + (activeTag === 'All' ? ' active' : '');
      allTab.onclick = () => { setActiveTag('All'); };
      tagsTabs.appendChild(allTab);
      TAGS.forEach(tag => {
        const icon = TAG_ICONS[tag] || "category";
        const btn = document.createElement('button');
        btn.innerHTML = `<span class="material-icons">${icon}</span> ${tag}`;
        btn.className = 'tab' + (activeTag === tag ? ' active' : '');
        btn.onclick = () => { setActiveTag(tag); };
        tagsTabs.appendChild(btn);
      });
    }
    function setActiveTag(tag) {
      activeTag = tag;
      renderTags();
      renderItems();
    }
    // Populate select options for tags
    function renderTagOptions() {
      foodTagSelect.innerHTML = TAGS.map(tag =>
        `<option value="${tag}">${tag}</option>`
      ).join('');
    }
    // Render grid items
    function renderItems() {
      let filtered = items;
      if (activeTag !== 'All') {
        filtered = filtered.filter(item => item.foodTag === activeTag);
      }
      if (searchQuery.trim() !== '') {
        const q = searchQuery.trim().toLowerCase();
        filtered = filtered.filter(item =>
          (item.foodName && item.foodName.toLowerCase().includes(q)) ||
          (item.brandName && item.brandName.toLowerCase().includes(q)) ||
          (item.desc && item.desc.toLowerCase().includes(q)) ||
          (item.whatsapp && item.whatsapp.toLowerCase().includes(q)) ||
          (item.foodTag && item.foodTag.toLowerCase().includes(q))
        );
      }
      itemsGrid.innerHTML = filtered.map((item, idx) => {
        const mainImg = item.images[0];
        const thumbs = item.images.length > 1
          ? `<div class="img-thumbs">${
              item.images.map((img, j) =>
                `<img src="${img}" class="${j === 0 ? 'selected' : ''}" data-item="${idx}" data-img="${j}" tabindex="0">`
              ).join('')
            }</div>`
          : '';
        // WhatsApp row under title
        return `
        <div class="item-card" data-item="${idx}">
          <div class="item-imgs" data-item="${idx}">
            <img src="${mainImg}" alt="Food image" data-item="${idx}" data-img="0">
            ${thumbs}
          </div>
          <div class="item-content">
            <div class="item-title-row">
              <span class="material-icons" style="color:#2a7f2a;">fastfood</span>
              <span class="item-title">${item.foodName}</span>
            </div>
            <div class="item-whatsapp-row">
              <span class="material-icons">whatsapp</span>
              <a href="https://wa.me/${item.whatsapp.replace(/\D/g,'')}" target="_blank">${item.whatsapp}</a>
            </div>
            <div class="item-brand-row"><span class="material-icons">business</span> ${item.brandName}</div>
            <div class="item-desc-row"><span class="material-icons">description</span> ${item.desc}</div>
            <div class="item-details-row">
              <div class="item-tag-row">
                <span class="material-icons">${TAG_ICONS[item.foodTag] || "category"}</span>
                <span class="item-tag">${item.foodTag}</span>
              </div>
              <div class="item-details-icons" style="display:flex;gap:9px;">
                <span class="material-icons" title="Fresh">eco</span>
                <span class="material-icons" title="Food">restaurant_menu</span>
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');
      setTimeout(() => {
        // Add click listeners for main image and thumbs
        document.querySelectorAll('.item-imgs').forEach(imgsDiv => {
          const idx = parseInt(imgsDiv.getAttribute('data-item'));
          const item = filtered[idx];
          const mainImgEl = imgsDiv.querySelector('img[alt="Food image"]');
          mainImgEl.onclick = () => openImagePopup(item, 0, filtered, idx);
        });
        document.querySelectorAll('.img-thumbs img').forEach(thumbEl => {
          thumbEl.onclick = e => {
            const itemIdx = parseInt(thumbEl.getAttribute('data-item'));
            const imgIdx = parseInt(thumbEl.getAttribute('data-img'));
            openImagePopup(filtered[itemIdx], imgIdx, filtered, itemIdx);
            e.stopPropagation();
          };
          thumbEl.onkeydown = e => {
            if (e.key === "Enter" || e.key === " ") thumbEl.onclick(e);
          };
        });
        document.querySelectorAll('.item-card').forEach(cardEl => {
          const idx = parseInt(cardEl.getAttribute('data-item'));
          cardEl.onclick = (e) => {
            if (e.target.tagName === "IMG") return;
            openImagePopup(filtered[idx], 0, filtered, idx);
          };
        });
      }, 15);
    }
    // Modal functions
    function openModal() {
      modalBg.classList.add('active');
      itemForm.reset();
      imgPreview.innerHTML = '';
      capturedImages = [];
      startCamera();
      setTimeout(() => {
        itemForm.foodName.focus();
      }, 200);
    }
    function closeModal() {
      modalBg.classList.remove('active');
      stopCamera();
      itemForm.reset();
      imgPreview.innerHTML = '';
      capturedImages = [];
    }
    // Camera Functions (no upload, only camera)
    async function startCamera() {
      stopCamera();
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: {ideal: 1280}, height: {ideal: 720} },
          audio: false
        });
        video.srcObject = cameraStream;
        captureBtn.disabled = false;
      } catch (e) {
        cameraPreview.innerHTML = '<div style="color:#c62828;text-align:center;">Camera access denied/unavailable.</div>';
        captureBtn.disabled = true;
      }
    }
    function stopCamera() {
      video.srcObject = null;
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      captureBtn.disabled = true;
    }
    function updateImgPreview() {
      imgPreview.innerHTML = '';
      capturedImages.forEach((url, i) => {
        const img = document.createElement('img');
        img.src = url;
        imgPreview.appendChild(img);
      });
    }
    captureBtn.onclick = function(e) {
      e.preventDefault();
      if (!cameraStream) return;
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imgDataUrl = canvas.toDataURL('image/jpeg', 0.92);
      capturedImages.push(imgDataUrl);
      updateImgPreview();
    };
    clearPhotosBtn.onclick = function(e) {
      e.preventDefault();
      capturedImages = [];
      updateImgPreview();
    };
    itemForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const foodName = this.foodName.value.trim();
      const brandName = this.brandName.value.trim();
      const desc = this.desc.value.trim();
      const whatsapp = this.whatsapp.value.trim();
      const foodTag = this.foodTag.value;
      if (!foodName || !brandName || !desc || !whatsapp || !foodTag || !capturedImages.length) {
        alert('Please fill all fields and capture at least one photo.');
        return;
      }
      items.unshift({
        images: [...capturedImages],
        foodName,
        brandName,
        desc,
        whatsapp,
        foodTag,
      });
      closeModal();
      renderItems();
    });
    openModalBtn.onclick = openModal;
    cancelBtn.onclick = closeModal;
    modalBg.onclick = function(e) {
      if (e.target === modalBg) closeModal();
    };

    // Fullscreen Image Popup Improved
    function openImagePopup(item, imgIdx, filtered, filteredIdx) {
      popupImages = item.images;
      popupItemIdx = filteredIdx;
      popupImgIdx = imgIdx;
      showPopupImage();
      popupBg.classList.add('active');
      popupImgWrap.style.animation = "popupZoomIn 0.23s";
      setTimeout(() => { popupImgWrap.style.animation = ""; }, 250);
    }
    function showPopupImage() {
      if (!popupImages.length) return;
      popupImg.src = popupImages[popupImgIdx];
      popupImg.alt = "Food photo";
      popupArrowLeft.style.display = popupImgIdx > 0 ? 'flex' : 'none';
      popupArrowRight.style.display = popupImgIdx < popupImages.length - 1 ? 'flex' : 'none';
    }
    popupArrowLeft.onclick = function(e) {
      if (popupImgIdx > 0) {
        popupImgIdx--;
        showPopupImage();
      }
    };
    popupArrowRight.onclick = function(e) {
      if (popupImgIdx < popupImages.length - 1) {
        popupImgIdx++;
        showPopupImage();
      }
    };
    popupCloseBtn.onclick = function() {
      popupBg.classList.remove('active');
      popupImg.src = '';
      popupImages = [];
      popupImgIdx = 0;
    };
    popupBg.onclick = function(e) {
      if (e.target === popupBg) popupCloseBtn.onclick();
    };
    document.addEventListener('keydown', function(e) {
      if (!popupBg.classList.contains('active')) return;
      if (e.key === "ArrowLeft" && popupImgIdx > 0) {
        popupArrowLeft.onclick();
      }
      if (e.key === "ArrowRight" && popupImgIdx < popupImages.length - 1) {
        popupArrowRight.onclick();
      }
      if (e.key === "Escape") {
        popupCloseBtn.onclick();
      }
    });

    // Search Bar Logic
    openSearchBtn.onclick = function() {
      searchBarContainer.style.display = 'flex';
      searchInput.value = '';
      searchQuery = '';
      renderItems();
      setTimeout(() => searchInput.focus(), 100);
    };
    closeSearchBtn.onclick = function() {
      searchBarContainer.style.display = 'none';
      searchInput.value = '';
      searchQuery = '';
      renderItems();
    };
    searchForm.onsubmit = function(e) {
      e.preventDefault();
      searchQuery = searchInput.value || '';
      renderItems();
    };
    searchInput.oninput = function() {
      searchQuery = searchInput.value || '';
      renderItems();
    };

    // Initial render (populate tag select)
    renderTagOptions();
    mainHeader.style.display = "none";
    mainContent.style.display = "none";
    tagsTabs.style.display = "none";
    searchBarContainer.style.display = "none";
    landingActions.style.display = "";
  </script>
</body>
</html>
