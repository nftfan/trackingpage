
<!DOCTYPE html>
<html>
<head>
  <title>Zone Completion Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Material Icons (Outlined) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">
  <!-- Inter Font for professional look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --success: #059669;
      --danger: #dc2626;
      --warning: #d97706;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 10px;
      line-height: 1.4;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Map Styles */
    #map {
      width: 100vw;
      height: 480px;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin-bottom: 12px;
      background: var(--bg-tertiary);
      position: relative;
      z-index: 1;
    }

    /* Container */
    .container {
      max-width: 768px;
      margin: 0 auto;
      padding: 12px 16px 24px;
      background: var(--bg-primary);
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius-lg);
      margin-top: -20px;
      position: relative;
      z-index: 2;
    }

    /* Header */
    h2 {
      font-size: 14px;
      font-weight: 700;
      margin: 0 0 16px 0;
      color: var(--primary);
      letter-spacing: -0.025em;
      text-align: center;
    }

    /* Campaign Input Section */
    .campaign-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid var(--border-light);
    }

    .campaign-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 10px;
      white-space: nowrap;
    }

    #campaignIdInput {
      flex: 1;
      min-width: 120px;
      padding: 8px 10px;
      font-size: 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.15s ease;
    }

    #campaignIdInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
      background: var(--bg-primary);
    }

    #campaignIdInput::placeholder {
      color: var(--text-muted);
    }

    /* Table Styles */
    .table-container {
      background: var(--bg-primary);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-light);
      margin-bottom: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    th {
      background: var(--bg-tertiary);
      padding: 8px 4px;
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    td {
      padding: 8px 4px;
      text-align: center;
      border-bottom: 1px solid var(--border-light);
      font-size: 9px;
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Status Buttons */
    .status-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      font-size: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
      min-width: 60px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .status-btn.completed {
      background: var(--success);
      color: white;
    }

    .status-btn.pending {
      background: var(--danger);
      color: white;
    }

    .status-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .status-btn:active {
      transform: translateY(0);
    }

    .status-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Input Fields */
    .flyer-input, .gps-url-input {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 9px;
      background: var(--bg-primary);
      transition: border-color 0.15s ease;
    }

    .flyer-input {
      width: 45px;
      text-align: center;
    }

    .gps-url-input {
      width: 80px;
      text-align: left;
    }

    .flyer-input:focus, .gps-url-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgb(37 99 235 / 0.1);
    }

    /* Action Buttons */
    .save-btn, .proof-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      letter-spacing: 0.025em;
      text-transform: uppercase;
      width: 100%;
      margin-bottom: 8px;
    }

    .save-btn {
      background: var(--primary);
      color: white;
    }

    .proof-btn {
      background: var(--success);
      color: white;
    }

    .save-btn:hover, .proof-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .save-btn:active, .proof-btn:active {
      transform: translateY(0);
      background: var(--primary-dark);
    }

    .proof-btn:active {
      background: #047857;
    }

    /* Status Indicators */
    .status-text {
      font-weight: 600;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .status-completed {
      color: var(--success);
    }

    .status-pending {
      color: var(--danger);
    }

    /* Messages */
    #saveMsg, #campaignMsg {
      font-size: 9px;
      font-weight: 500;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }

    #saveMsg {
      background: rgb(5 150 105 / 0.1);
      color: var(--success);
      border: 1px solid rgb(5 150 105 / 0.2);
    }

    #campaignMsg {
      background: rgb(220 38 38 / 0.1);
      color: var(--danger);
      border: 1px solid rgb(220 38 38 / 0.2);
    }

    #campaignMsg.success {
      background: rgb(5 150 105 / 0.1);
      color: var(--success);
      border: 1px solid rgb(5 150 105 / 0.2);
    }

    /* GPS Link */
    .gps-url-link {
      color: var(--primary);
      text-decoration: none;
      font-size: 12px;
      margin-left: 4px;
      opacity: 0.8;
      transition: opacity 0.15s ease;
    }

    .gps-url-link:hover {
      opacity: 1;
    }

    /* Map Labels */
    .leaflet-label-zone {
      background: rgba(37, 99, 235, 0.95);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 8px;
      pointer-events: none;
      box-shadow: var(--shadow);
      text-align: center;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.025em;
    }

    /* Modal Styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .modal {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 20px;
      min-width: 280px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h3 {
      margin: 0 0 16px 0;
      color: var(--primary);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: -0.025em;
      text-align: center;
    }

    .modal label {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 10px;
      display: block;
      margin-bottom: 4px;
    }

    .modal input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      font-size: 10px;
      background: var(--bg-secondary);
      transition: all 0.15s ease;
    }

    .modal input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
      background: var(--bg-primary);
    }

    .modal button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      width: 100%;
    }

    .modal button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .close-btn {
      position: absolute;
      right: 12px;
      top: 12px;
      font-size: 18px;
      background: transparent !important;
      color: var(--text-muted) !important;
      border: none;
      cursor: pointer;
      width: auto !important;
      padding: 4px !important;
      transform: none !important;
    }

    .close-btn:hover {
      color: var(--text-primary) !important;
      background: transparent !important;
    }

    .modal-error {
      color: var(--danger);
      font-size: 9px;
      margin-bottom: 8px;
      padding: 6px 8px;
      background: rgb(220 38 38 / 0.1);
      border-radius: 4px;
      border: 1px solid rgb(220 38 38 / 0.2);
    }

    .modal-success {
      color: var(--success);
      font-weight: 600;
      font-size: 9px;
      text-align: center;
      margin-top: 8px;
      padding: 6px 8px;
      background: rgb(5 150 105 / 0.1);
      border-radius: 4px;
      border: 1px solid rgb(5 150 105 / 0.2);
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .container {
        margin: 0 8px;
        margin-top: -20px;
        padding: 12px;
        border-radius: var(--radius);
      }

      #map {
        height: 240px;
        border-radius: 0 0 var(--radius) var(--radius);
      }

      th, td {
        padding: 6px 2px;
        font-size: 8px;
      }

      .flyer-input {
        width: 35px;
        font-size: 8px;
      }

      .gps-url-input {
        width: 60px;
        font-size: 8px;
      }

      .status-btn {
        font-size: 7px;
        padding: 3px 6px;
        min-width: 50px;
      }

      #campaignIdInput {
        font-size: 9px;
        min-width: 100px;
      }

      h2 {
        font-size: 12px;
      }

      .campaign-row {
        justify-content: center;
      }

      .modal {
        margin: 8px;
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 0 4px;
        margin-top: -20px;
        padding: 8px;
      }

      #map {
        height: 200px;
      }

      th, td {
        padding: 4px 1px;
        font-size: 7px;
      }

      .flyer-input, .gps-url-input {
        font-size: 7px;
      }

      .flyer-input {
        width: 30px;
      }

      .gps-url-input {
        width: 50px;
      }

      .status-btn {
        font-size: 6px;
        padding: 2px 4px;
        min-width: 40px;
      }

      h2 {
        font-size: 11px;
        margin-bottom: 12px;
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Smooth Animations */
    * {
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="container">
    <h2>Zone Completion & Flyers Entry</h2>
    
    <form id="zoneForm" autocomplete="off">
      <div class="campaign-section">
        <div class="campaign-row">
          <label for="campaignIdInput">Campaign ID:</label>
          <input type="text" id="campaignIdInput" placeholder="Enter Campaign ID" required />
        </div>
        <div id="campaignMsg"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Zone</th>
              <th>Status</th>
              <th>Action</th>
              <th>Flyers</th>
              <th>GPS URL</th>
            </tr>
          </thead>
          <tbody id="zoneTableBody"></tbody>
        </table>
      </div>

      <button type="submit" class="save-btn">Save All Changes</button>
      <div id="saveMsg">Changes saved successfully!</div>
    </form>

    <button id="openProofModalBtn" class="proof-btn">Submit Photo Proof</button>
  </div>

  <!-- Proof Modal -->
  <div class="modal-backdrop" id="proofModalBackdrop">
    <div class="modal">
      <button class="close-btn" id="closeProofModalBtn" title="Close">&times;</button>
      <h3>Submit Image Proof</h3>
      <form id="proofForm" autocomplete="off">
        <label for="proofUrlInput">Image URL:</label>
        <input type="text" id="proofUrlInput" placeholder="Paste image URL (https://...)" required />
        <div class="modal-error" id="proofErrorMsg"></div>
        <button type="submit">Submit Proof</button>
      </form>
      <div class="modal-success" id="proofSuccessMsg" style="display:none;">Proof submitted successfully!</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Map config ---
    const polygonCoordinates = [
  [[50.86919046876775, 4.708000636494646], [50.86740291875487, 4.70928780972253], [50.866360149592126, 4.711068399354429], [50.86491106800252, 4.711218569564376], [50.865141298928215, 4.712484289905113], [50.86818836583931, 4.716195639378897], [50.870991491499375, 4.717826058800889], [50.872778903902045, 4.718233663656397], [50.873293449311475, 4.716259998040298], [50.87369966535897, 4.714436502634106], [50.87162792650076, 4.7120552321624976], [50.86955609555329, 4.7089016577541685]],
  [[50.84834029714184, 4.695490523041089], [50.8549782674543, 4.695662146138143], [50.8559806543361, 4.692186778422852], [50.85264831200613, 4.69094251096922], [50.850968504477805, 4.689741149289844], [50.849451206969874, 4.69081379364642]],
  [[50.85239544080322, 4.690937343182623], [50.85597162310055, 4.692138704861999], [50.85922245996537, 4.688320090952601], [50.85556525255834, 4.68063995735947], [50.852856025119095, 4.68162679016754], [50.85548397802501, 4.686732577304862]],
  [[50.8760960812432, 4.725827173529252], [50.87820823900632, 4.719777459358152], [50.880509840385415, 4.718704815001575], [50.88373189132901, 4.717246018676638], [50.88430046542476, 4.724840340721222], [50.8819178228291, 4.72518358691529], [50.88156583120689, 4.721407878780144], [50.88018491531784, 4.724368377204313], [50.87858733411251, 4.7231241097506835], [50.87715217209129, 4.727586310274044]],
  [[50.86873023330397, 4.698715209960938], [50.874200848247476, 4.700088500976563], [50.872088508674054, 4.703822135925294], [50.86921773990198, 4.707813262939454], [50.86826980572436, 4.704122543334962]],
  [[50.86938024096832, 4.707899093627931], [50.87149270328007, 4.711847305297852], [50.87357798883879, 4.714207649230958], [50.87452581506935, 4.711375236511231], [50.87593397844703, 4.707598686218263], [50.87620477421866, 4.706311225891114], [50.87536530220481, 4.7041654586792], [50.87452581506935, 4.702062606811524], [50.87401128322168, 4.700689315795899], [50.8712760448849, 4.705195426940919]],
  [[50.876421409703035, 4.706482887268067], [50.87352382675771, 4.713821411132813], [50.87780243724243, 4.715924263000489], [50.881078829039495, 4.714937210083009], [50.880293599103126, 4.710216522216798], [50.878046143736235, 4.70691204071045]],
  [[50.8811600589673, 4.714722633361817], [50.87912926828837, 4.702448844909669], [50.879968672500084, 4.700818061828614], [50.88243264268154, 4.705839157104493], [50.882378490891114, 4.7071266174316415], [50.884517438756795, 4.711289405822755]],
  [[50.87910219048138, 4.7008609771728525], [50.880347753316656, 4.70991611480713], [50.87788367288198, 4.706783294677735], [50.87677344021729, 4.706225395202638], [50.87449873458739, 4.700946807861329], [50.87441749304715, 4.6999597549438485]],
  [[50.882486794409026, 4.707083702087403], [50.884625737302635, 4.7112464904785165], [50.88689994861239, 4.708328247070313], [50.8881182304318, 4.704895019531251], [50.889580126558656, 4.70017433166504], [50.888659678791235, 4.70043182373047], [50.88746848409305, 4.699144363403321], [50.8872518999662, 4.702792167663575], [50.886791655353164, 4.701976776123048]],
  [[50.86046892970548, 4.706611633300782], [50.862690145372106, 4.709358215332032], [50.862608883249116, 4.711976051330567], [50.86179625422952, 4.712276458740235], [50.86157955076561, 4.718027114868165], [50.85992715373515, 4.7178125381469735], [50.85889776204928, 4.721159934997559], [50.85770580644422, 4.718542098999024], [50.85832887794741, 4.71789836883545], [50.857759986905414, 4.715280532836915], [50.857759986905414, 4.712576866149903], [50.85962917426831, 4.71240520477295], [50.860035509432805, 4.708628654479981]],
  [[50.87250827608297, 4.719250202178956], [50.87225099973244, 4.720237255096436], [50.86962399150566, 4.720816612243653], [50.8684458521006, 4.7222328186035165], [50.8687844009555, 4.725837707519532], [50.868648981708596, 4.72663164138794], [50.87058543952914, 4.727790355682373]],
  [[50.86847293609949, 4.722254276275636], [50.864802910857854, 4.724743366241456], [50.86715934402803, 4.731824398040772], [50.869258365221654, 4.733283519744874], [50.87050419116752, 4.727833271026612], [50.86859481389967, 4.726588726043702], [50.868892736069775, 4.724271297454835]],
  [[50.86478936779425, 4.724743366241456], [50.867240598219865, 4.731824398040772], [50.869258365221654, 4.733262062072755], [50.86799896384729, 4.7388625144958505], [50.86644159251613, 4.735536575317383], [50.86588634319952, 4.737446308135987], [50.86263597063919, 4.733777046203614], [50.864653936941835, 4.733347892761231], [50.86519565799099, 4.730086326599122], [50.864017406665795, 4.726288318634033]],
  [[50.87265722490001, 4.7194862365722665], [50.87417376757672, 4.722404479980469], [50.875961058095015, 4.726009368896485], [50.877423335718774, 4.727811813354493], [50.875690260907206, 4.730558395385743], [50.874661217243, 4.728584289550782], [50.87434979165544, 4.728240966796876], [50.87348320515557, 4.725687503814698], [50.87306344652707, 4.722340106964111], [50.872345785921524, 4.720451831817628]],
  [[50.88180989329177, 4.7239065170288095], [50.88151205368475, 4.721546173095704], [50.880320676217764, 4.724464416503907], [50.87858770915927, 4.723348617553712], [50.877315020431254, 4.7274255752563485], [50.87704423111104, 4.728584289550782], [50.878127378950914, 4.730429649353027], [50.87942712312659, 4.728498458862306], [50.87999574980355, 4.7274255752563485], [50.8813902096604, 4.723820686340333]],
  [[50.88427376610816, 4.725022315979004], [50.884517438756795, 4.727983474731446], [50.88394886726078, 4.728498458862306], [50.88329906276881, 4.727554321289063], [50.88221603514223, 4.731931686401368], [50.88088929199056, 4.73012924194336], [50.881214212173845, 4.72914218902588], [50.88002282709126, 4.727597236633301], [50.88145790082436, 4.7239065170288095], [50.88180989329177, 4.723863601684571], [50.88197235045677, 4.7252798080444345]],
  [[50.87992805651539, 4.7275757789611825], [50.8811600589673, 4.729099273681641], [50.88095698388226, 4.730386734008789], [50.88222957314292, 4.73188877105713], [50.881024675675604, 4.735450744628907], [50.88061852344034, 4.735708236694336], [50.87912926828837, 4.732489585876466], [50.87815445732434, 4.730386734008789]],
  [[50.87246765359574, 4.7206449508667], [50.87038231835953, 4.729185104370118], [50.872630143332316, 4.7316741943359375], [50.87403836398688, 4.73287582397461], [50.87457997598601, 4.7304725646972665], [50.87455289553552, 4.732961654663086], [50.875581941591506, 4.735279083251954], [50.87709838910096, 4.732961654663086], [50.87449873458739, 4.728584289550782], [50.87344258351806, 4.725408554077149], [50.87306344652707, 4.722447395324707]],
  [[50.87701715209247, 4.728841781616212], [50.875690260907206, 4.730558395385743], [50.87940004549268, 4.735407829284669], [50.88021236766478, 4.737296104431153], [50.880943445511775, 4.736394882202149], [50.87872309953162, 4.731631278991699], [50.87774828007073, 4.729785919189454]],
  [[50.877260862693085, 4.733026027679443], [50.87548716198373, 4.735558032989502], [50.87646202874424, 4.738583564758302], [50.87792429064866, 4.736330509185792], [50.879075112658704, 4.7382402420043945], [50.88015821329388, 4.736609458923341], [50.878736638547224, 4.734549522399903], [50.87773474076796, 4.733691215515138]],
  [[50.88019882907795, 4.736845493316651], [50.88053729256846, 4.738454818725587], [50.87740979632161, 4.74311113357544], [50.876475568416794, 4.738647937774659], [50.87799198684776, 4.73637342453003], [50.87910219048138, 4.738261699676514]],
  [[50.8506076217602, 4.695625305175782], [50.850634716121945, 4.696784019470216], [50.86071272683848, 4.697384834289552], [50.85897903064014, 4.700131416320802], [50.85654091130268, 4.703135490417481], [50.856080363336936, 4.705066680908204], [50.86055019555811, 4.706611633300782], [50.86079399226619, 4.700388908386231], [50.86155246276182, 4.696226119995118]],
  [[50.89212442338841, 4.718190692168469], [50.88592492481821, 4.719434959622101], [50.88497733051223, 4.718190692168469], [50.88427339083629, 4.716946424714839], [50.88348821480356, 4.718019069071416], [50.88451706346628, 4.728059020249008], [50.8856271115418, 4.726214071955668], [50.88779298285344, 4.723425196628593], [50.88979632416518, 4.727200904763738], [50.89177250887832, 4.724540746759423], [50.88985046732921, 4.721022473269839]],
  [[50.87986036312891, 4.700646400451661], [50.88151205368475, 4.703865051269532], [50.88251387024918, 4.7057533264160165], [50.88243264268154, 4.70716953277588], [50.886683361842216, 4.701848030090333], [50.8872518999662, 4.702577590942384], [50.88749555703811, 4.698758125305177], [50.887278973037105, 4.696226119995118], [50.88427376610816, 4.698200225830079], [50.882920005963165, 4.69841480255127], [50.88164743556031, 4.699358940124513], [50.880943445511775, 4.699401855468751], [50.880266521972736, 4.7005605697631845]],
  [[50.88925526471759, 4.694809913635255], [50.8883077380735, 4.694552421569825], [50.88708946121023, 4.696612358093263], [50.88275755210239, 4.698629379272462], [50.88118713557842, 4.699401855468751], [50.87991451784596, 4.700732231140138], [50.88018529048719, 4.699702262878419], [50.88129544186563, 4.6972131729125985], [50.88229726308748, 4.697084426879884], [50.88302830822234, 4.6939945220947275], [50.883840567141505, 4.6923208236694345], [50.886168964227345, 4.691419601440431], [50.88833481053079, 4.691848754882813], [50.88917404890332, 4.692277908325196]],
  [[50.88132251839807, 4.690217971801759], [50.88386764219492, 4.6923208236694345], [50.882486794409026, 4.696784019470216], [50.88134959491482, 4.697384834289552], [50.87986036312891, 4.700646400451661], [50.87921050161489, 4.700517654418946]],
  [[50.88300123268116, 4.683995246887208], [50.8849235570057, 4.685025215148927], [50.88749555703811, 4.688029289245606], [50.88863260652272, 4.6920204162597665], [50.88643970052214, 4.691376686096192], [50.88392179225454, 4.692363739013673], [50.881214212173845, 4.690518379211427], [50.88256802188226, 4.685325622558595]],
  [[50.88294708155157, 4.683609008789063], [50.88002282709126, 4.682922363281251], [50.877206704892, 4.684038162231446], [50.878398161977145, 4.687771797180177], [50.879562511060016, 4.68918800354004], [50.88040190746729, 4.689316749572755], [50.881241288753486, 4.690132141113282]],
  [[50.877152547027954, 4.6840810775756845], [50.87831692723451, 4.687514305114747], [50.8795895885995, 4.689359664916993], [50.879048034820244, 4.69219207763672], [50.87758580817798, 4.691033363342286], [50.875852739408714, 4.690561294555665], [50.87355090780611, 4.69167709350586], [50.87230516329265, 4.691076278686524], [50.87390296000361, 4.687385559082032], [50.8752569821338, 4.685497283935548]],
  [[50.87908865157202, 4.6921706199646005], [50.879603127363325, 4.689166545867921], [50.8805102155797, 4.689338207244874], [50.88122775046563, 4.689981937408448], [50.88061852344034, 4.693737030029298], [50.88018529048719, 4.697320461273194], [50.879508355933844, 4.699616432189942], [50.87922404048887, 4.70043182373047], [50.879020956966066, 4.700882434844972], [50.87707131011386, 4.700453281402589], [50.877423335718774, 4.698286056518556], [50.877694122836104, 4.695475101470948], [50.87761288686611, 4.69268560409546], [50.87788367288198, 4.69144105911255]],
  [[50.87577150022877, 4.690861701965333], [50.873984202440774, 4.691548347473145], [50.87409252547001, 4.693865776062013], [50.874850779625284, 4.694638252258302], [50.874850779625284, 4.696483612060548], [50.875284062175155, 4.697728157043458], [50.87601521734375, 4.6978139877319345], [50.87639433032257, 4.700603485107423], [50.87712546807231, 4.7005605697631845], [50.87753165075451, 4.693908691406251], [50.87796490837991, 4.691462516784669], [50.87666512341922, 4.690861701965333]],
  [[50.86881148475767, 4.699058532714845], [50.87628601264333, 4.700367450714112], [50.87613707542327, 4.6987366676330575], [50.875974597913086, 4.6978139877319345], [50.8752569821338, 4.697771072387696], [50.874796619023314, 4.6964406967163095], [50.87486431976593, 4.694638252258302], [50.87421438857698, 4.694273471832276], [50.87401128322168, 4.693372249603272], [50.873984202440774, 4.691505432128907], [50.872386408515005, 4.691205024719239], [50.86913648915637, 4.69442367553711]],
  [[50.87374047470445, 4.71489429473877], [50.87766704419516, 4.716138839721681], [50.88159328285729, 4.714465141296387], [50.88622311161217, 4.709701538085938], [50.88489648256591, 4.713435173034669], [50.88440913995918, 4.71639633178711], [50.883623966147674, 4.717297554016114], [50.87815445732434, 4.719614982604981], [50.87604229694451, 4.725708961486817], [50.87317177169636, 4.719786643981934], [50.8724405719179, 4.719099998474122]],
  [[50.86599468504891, 4.696354866027833], [50.86539880176159, 4.698071479797364], [50.86596759961018, 4.7019338607788095], [50.86496542731422, 4.706525802612306], [50.86469456623886, 4.709057807922364], [50.86436953087126, 4.709272384643556], [50.8649925133352, 4.711332321166993], [50.86244635857825, 4.711890220642091], [50.86244635857825, 4.709358215332032], [50.86060437271451, 4.706611633300782], [50.86046892970548, 4.703264236450196], [50.86109196428943, 4.699015617370606], [50.86098361104675, 4.69717025756836], [50.861471198656, 4.696054458618165]],
  [[50.86141702250675, 4.685926437377931], [50.868459394102004, 4.69841480255127], [50.867240598219865, 4.69742774963379], [50.86553423045024, 4.696097373962403], [50.861471198656, 4.69592571258545], [50.85502379493606, 4.695625305175782], [50.85553853637791, 4.693307876586915], [50.85721817946077, 4.690861701965333], [50.85971044158446, 4.6876859664917]],
  [[50.86491125522505, 4.7112464904785165], [50.86675307094459, 4.71090316772461], [50.86726768291898, 4.709358215332032], [50.869001070932285, 4.707899093627931], [50.86821563747484, 4.704809188842774], [50.867944795283044, 4.701805114746095], [50.86835105798063, 4.6988868713378915], [50.86745727537231, 4.6975135803222665], [50.86596759961018, 4.696269035339356], [50.86529045852743, 4.697341918945313], [50.865642573117896, 4.699058532714845], [50.86594051415569, 4.701976776123048], [50.86512794320409, 4.705495834350587], [50.86474873857985, 4.708585739135743], [50.864071579793574, 4.709272384643556]]
];

    // --- App State ---
    const ZONES = polygonCoordinates.length;
    let zoneData = Array.from({length: ZONES}, (_,i) => ({
      status: "pending", // pending | completed
      flyers: "",
      gpsUrl: ""
    }));

    let currentCampaignId = '';
    let loadedCampaignId = '';

    // --- DOM refs ---
    const campaignIdInput = document.getElementById('campaignIdInput');
    const zoneTableBody = document.getElementById('zoneTableBody');
    const saveBtn = document.querySelector('.save-btn');
    const saveMsg = document.getElementById('saveMsg');
    const campaignMsg = document.getElementById('campaignMsg');

    // --- Map logic ---
    let map = L.map('map').setView(polygonCoordinates[0][0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    // Draw polygons and keep references
    let zonePolys = [];
    polygonCoordinates.forEach((coords, idx) => {
      let poly = L.polygon(coords, {
        color: '#dc2626',
        fillColor: '#dc2626',
        fillOpacity: 0.3,
        weight: 2
      }).addTo(map);
      zonePolys.push(poly);
      // Label
      let center = poly.getBounds().getCenter();
      L.marker(center, {
        icon: L.divIcon({
          className: 'leaflet-label-zone',
          html: `Zone ${idx+1}`,
          iconSize: [60, 16], iconAnchor: [30, 8]
        }),
        interactive: false
      }).addTo(map);
    });

    function colorPolygons() {
      zoneData.forEach((zone, idx) => {
        const color = zone.status === "completed" ? "#2563eb" : "#dc2626";
        zonePolys[idx].setStyle({
          fillColor: color,
          color: color,
          fillOpacity: zone.status === "completed" ? 0.4 : 0.3
        });
      });
    }

    function isValidUrl(str) {
      try {
        if (!str) return false;
        let url = new URL(str);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch (e) {
        return false;
      }
    }

    function renderZoneTable() {
      zoneTableBody.innerHTML = "";
      zoneData.forEach((zone, i) => {
        const statusClass = zone.status === 'completed' ? 'status-completed' : 'status-pending';
        const statusText = zone.status.charAt(0).toUpperCase() + zone.status.slice(1);
        
        zoneTableBody.innerHTML += `
          <tr>
            <td><strong>Zone ${i+1}</strong></td>
            <td>
              <span class="status-text ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>
              <button type="button" class="status-btn ${zone.status}" data-zone="${i}">
                ${zone.status === 'completed' ? 'Pending' : 'Complete'}
              </button>
            </td>
            <td>
              <input class="flyer-input" type="number" min="0" data-flyer="${i}" value="${zone.flyers||''}" placeholder="0">
            </td>
            <td>
              <input class="gps-url-input" type="text" data-gps="${i}" value="${zone.gpsUrl||''}" placeholder="GPS URL">
              ${
                isValidUrl(zone.gpsUrl)
                  ? `<a href="${zone.gpsUrl}" target="_blank" class="gps-url-link" title="Open GPS URL">üìç</a>`
                  : ""
              }
            </td>
          </tr>
        `;
      });
      
      // Add listeners
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.onclick = () => {
          const idx = parseInt(btn.getAttribute('data-zone'));
          zoneData[idx].status = (zoneData[idx].status==='completed') ? 'pending' : 'completed';
          colorPolygons();
          renderZoneTable();
        };
      });
      
      document.querySelectorAll('.flyer-input').forEach(input => {
        input.oninput = () => {
          const idx = parseInt(input.getAttribute('data-flyer'));
          zoneData[idx].flyers = input.value;
        }
      });
      
      document.querySelectorAll('.gps-url-input').forEach(input => {
        input.oninput = () => {
          const idx = parseInt(input.getAttribute('data-gps'));
          zoneData[idx].gpsUrl = input.value;
        }
      });
    }

    // --- Save to Firebase ---
    document.getElementById('zoneForm').onsubmit = async function(e) {
      e.preventDefault();
      currentCampaignId = campaignIdInput.value.trim();
      if (!currentCampaignId) {
        campaignMsg.textContent = "Enter a Campaign ID to save!";
        campaignMsg.className = "";
        campaignMsg.style.display = "block";
        campaignIdInput.focus();
        return;
      }
      
      saveBtn.classList.add('loading');
      campaignMsg.style.display = "none";
      
      try {
        const campaignRef = ref(db, `campaigns/${currentCampaignId}/zone_statuses`);
        await set(campaignRef, zoneData);
        saveMsg.style.display = "block";
        setTimeout(()=>saveMsg.style.display="none", 3000);
        loadedCampaignId = currentCampaignId;
      } catch (error) {
        console.error('Save error:', error);
      } finally {
        saveBtn.classList.remove('loading');
      }
    };

    // --- Load zoneData from Firebase by Campaign ID ---
    async function loadCampaignZones(campaignId) {
      if (!campaignId) return;
      const campaignRef = ref(db, `campaigns/${campaignId}/zone_statuses`);
      const snap = await get(campaignRef);
      if (snap.exists()) {
        const data = snap.val();
        zoneData = zoneData.map((z,i) => ({
          ...z,
          ...(data[i]||{})
        }));
        renderZoneTable();
        colorPolygons();
        campaignMsg.textContent = "Campaign loaded successfully!";
        campaignMsg.className = "success";
        campaignMsg.style.display = "block";
        setTimeout(()=>{campaignMsg.style.display="none"}, 2000);
        loadedCampaignId = campaignId;
      } else {
        zoneData = Array.from({length: ZONES}, (_,i) => ({
          status: "pending",
          flyers: "",
          gpsUrl: ""
        }));
        renderZoneTable();
        colorPolygons();
        campaignMsg.textContent = "New campaign - no existing data found";
        campaignMsg.className = "";
        campaignMsg.style.display = "block";
        setTimeout(()=>{campaignMsg.style.display="none"}, 2000);
        loadedCampaignId = '';
      }
    }

    // --- Campaign ID Input logic ---
    let loadTimeout = null;
    campaignIdInput.addEventListener('input', () => {
      const val = campaignIdInput.value.trim();
      if (val === loadedCampaignId) return;
      if (loadTimeout) clearTimeout(loadTimeout);
      loadTimeout = setTimeout(() => {
        loadCampaignZones(val);
      }, 800);
    });

    campaignIdInput.addEventListener('keydown', (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const val = campaignIdInput.value.trim();
        loadCampaignZones(val);
      }
    });

    // --- Initial render ---
    renderZoneTable();

    // --- Geolocation: show moving user dot ---
    let userMarker = null;
    let userLatLng = null;
    function showUserLocation(lat, lng) {
      userLatLng = [lat, lng];
      if (!userMarker) {
        userMarker = L.circleMarker([lat, lng], {
          radius: 8, 
          color: '#2563eb', 
          fillColor: '#2563eb', 
          fillOpacity: 0.8, 
          weight: 2
        }).addTo(map);
      } else {
        userMarker.setLatLng([lat, lng]);
      }
    }
    
    function errorLoc(err) { 
      console.warn("Location error:", err.message); 
    }
    
    function askLocation() {
      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
          pos => showUserLocation(pos.coords.latitude, pos.coords.longitude),
          errorLoc,
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 }
        );
      }
    }
    askLocation();

    // --- Load proofs as pins on map ---
    let proofMarkers = [];
    function clearProofMarkers() {
      proofMarkers.forEach(m => map.removeLayer(m));
      proofMarkers = [];
    }
    
    function renderProofsOnMap(proofs) {
      clearProofMarkers();
      proofs.forEach((proof, idx) => {
        let marker = L.marker([proof.lat, proof.lng], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61168.png',
            iconSize: [24, 24],
            iconAnchor: [12, 24],
            popupAnchor: [0, -20]
          })
        });
        marker.bindPopup(`
          <div style="text-align:center;font-size:10px;">
            <b>Proof #${idx+1}</b><br/>
            <a href="${proof.url}" target="_blank">
              <img src="${proof.url}" style="max-width:120px;max-height:80px;display:block;margin:4px auto;border-radius:4px;border:1px solid #2563eb;" loading="lazy"/>
            </a>
            <a href="${proof.url}" target="_blank" style="font-size:9px;color:#2563eb;text-decoration:underline;">Open Image</a>
          </div>
        `);
        marker.addTo(map);
        proofMarkers.push(marker);
      });
    }

    // --- Fetch proofs from Firebase and render as pins ---
    async function fetchAndRenderProofs() {
      currentCampaignId = campaignIdInput.value.trim();
      if (!currentCampaignId) {
        clearProofMarkers();
        return;
      }
      const proofsRef = ref(db, `campaigns/${currentCampaignId}/proofs`);
      onValue(proofsRef, (snap) => {
        let proofs = [];
        snap.forEach(childSnap => {
          const {lat, lng, url, timestamp} = childSnap.val();
          if (lat && lng && url) {
            proofs.push({lat, lng, url, timestamp});
          }
        });
        proofs.sort((a,b) => (b.timestamp||0)-(a.timestamp||0));
        renderProofsOnMap(proofs);
      });
    }

    // --- Watch campaignIdInput for proof fetch ---
    campaignIdInput.addEventListener('input', () => {
      setTimeout(fetchAndRenderProofs, 1000);
    });
    
    document.getElementById('zoneForm').addEventListener('submit', () => {
      setTimeout(fetchAndRenderProofs, 500);
    });

    // --- Modal for Proof submission ---
    const openProofModalBtn = document.getElementById('openProofModalBtn');
    const proofModalBackdrop = document.getElementById('proofModalBackdrop');
    const closeProofModalBtn = document.getElementById('closeProofModalBtn');
    const proofForm = document.getElementById('proofForm');
    const proofUrlInput = document.getElementById('proofUrlInput');
    const proofErrorMsg = document.getElementById('proofErrorMsg');
    const proofSuccessMsg = document.getElementById('proofSuccessMsg');

    // Show modal
    openProofModalBtn.addEventListener('click', () => {
      proofModalBackdrop.style.display = "flex";
      proofErrorMsg.textContent = "";
      proofSuccessMsg.style.display = "none";
      proofUrlInput.value = "";
      setTimeout(() => proofUrlInput.focus(), 100);
    });
    
    // Close modal
    closeProofModalBtn.addEventListener('click', () => {
      proofModalBackdrop.style.display = "none";
    });
    
    proofModalBackdrop.addEventListener('click', (e) => {
      if (e.target === proofModalBackdrop) {
        proofModalBackdrop.style.display = "none";
      }
    });

    // --- Submit proof ---
    proofForm.onsubmit = async function(e) {
      e.preventDefault();
      proofErrorMsg.textContent = "";
      proofSuccessMsg.style.display = "none";
      
      const url = proofUrlInput.value.trim();
      if (!isValidUrl(url)) {
        proofErrorMsg.textContent = "Please enter a valid image URL (http/https)";
        return;
      }
      
      if (!userLatLng) {
        proofErrorMsg.textContent = "Waiting for your location. Please allow location access.";
        return;
      }
      
      currentCampaignId = campaignIdInput.value.trim();
      if (!currentCampaignId) {
        proofErrorMsg.textContent = "Enter a Campaign ID above before submitting proof.";
        return;
      }
      
      try {
        const proofsRef = ref(db, `campaigns/${currentCampaignId}/proofs`);
        await push(proofsRef, {
          url,
          lat: userLatLng[0],
          lng: userLatLng[1],
          timestamp: Date.now()
        });
        proofSuccessMsg.style.display = "block";
        proofErrorMsg.textContent = "";
        proofUrlInput.value = "";
        fetchAndRenderProofs();
        setTimeout(() => {
          proofModalBackdrop.style.display = "none";
        }, 1500);
      } catch (err) {
        proofErrorMsg.textContent = "Failed to save proof: " + err.message;
      }
    };

    // --- Initial coloring ---
    colorPolygons();

    // --- Optionally: Load last entered campaign from localStorage ---
    if (localStorage.getItem('lastCampaignId')) {
      campaignIdInput.value = localStorage.getItem('lastCampaignId');
      loadCampaignZones(campaignIdInput.value.trim());
      setTimeout(fetchAndRenderProofs, 1000);
    }
    
    // Save campaign ID to localStorage on save
    document.getElementById('zoneForm').addEventListener('submit', () => {
      localStorage.setItem('lastCampaignId', campaignIdInput.value.trim());
    });
  </script>
</body>
</html>
